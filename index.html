<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PhotoBrick v2.3.5</title>

<link rel="manifest" href="manifest.json">
<link rel="icon" type="image/png" href="icon.png">

<meta name="theme-color" content="#1e1e24">

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="PhotoBrick">
<link rel="apple-touch-icon" href="icon.png">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <style>

/* –°–¢–ò–õ–ò –≠–ö–†–ê–ù–ê –ó–ê–ì–†–£–ó–ö–ò */
        .loading-overlay {
            position: fixed;
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%;
            background: rgba(0, 0, 0, 0.85); /* –¢–µ–º–Ω—ã–π —Ñ–æ–Ω */
            z-index: 20000; /* –ü–æ–≤–µ—Ä—Ö –≤—Å–µ–≥–æ */
            display: none; /* –°–∫—Ä—ã—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
            justify-content: center; 
            align-items: center;
            backdrop-filter: blur(8px); /* –†–∞–∑–º—ã—Ç–∏–µ —Ñ–æ–Ω–∞ */
            flex-direction: column;
        }

        .loading-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 5px solid rgba(255, 255, 255, 0.1);
            border-top: 5px solid var(--primary); /* –í–∞—à –∂–µ–ª—Ç—ã–π —Ü–≤–µ—Ç */
            border-radius: 50%;
            animation: spin 1s cubic-bezier(0.68, -0.55, 0.27, 1.55) infinite;
        }

        .loading-text {
            color: var(--primary);
            font-size: 18px;
            font-weight: bold;
            letter-spacing: 2px;
            text-transform: uppercase;
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(0.95); }
        }

        :root {
            --bg-gradient: radial-gradient(circle at top left, #1e1e24, #121212);
            --glass-bg: rgba(30, 30, 30, 0.95);
            --glass-border: rgba(255, 255, 255, 0.15);
            --primary: #ffd700; /* Yellow for Dark Mode */
            --on-primary: #000;
            --text-main: #ffffff;
            --text-sec: #aaa;
            --radius-lg: 20px;
            --radius-md: 12px;
            --modal-bg: #1e1e24;
            --modal-text: #ddd;
            --btn-sec-bg: rgba(255,255,255,0.1);
            --option-bg: #2a2a2a;
            --option-text: #fff;
            --input-bg: rgba(0, 0, 0, 0.6);
            
            --btn-collapsed-bg: #ffd700;
            --btn-collapsed-text: #000;
            --btn-refresh-color: #d4a000;
            --btn-refresh-bg: rgba(255, 215, 0, 0.1);
        }

        [data-theme="light"] {
            --bg-gradient: #D3E3FD;
            --glass-bg: #E9EEF6;
            --glass-border: rgba(0, 0, 0, 0.05);
            --primary: #0b57d0; /* Blue for Light Mode */
            --on-primary: #fff;
            --text-main: #1f1f1f;
            --text-sec: #444746;
            --modal-bg: #E9EEF6;
            --modal-text: #1f1f1f;
            --btn-sec-bg: rgba(0, 0, 0, 0.05);
            --option-bg: #ffffff;
            --option-text: #000;
            --input-bg: rgba(255, 255, 255, 0.9);
            
            --btn-collapsed-bg: #0b57d0; 
            --btn-collapsed-text: #fff;
            --btn-refresh-color: #0b57d0;
            --btn-refresh-bg: rgba(11, 87, 208, 0.1);
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; touch-action: manipulation; }
        body { margin: 0; height: 100dvh; overflow: hidden; font-family: 'Inter', system-ui, sans-serif; background: var(--bg-gradient); color: var(--text-main); transition: 0.3s; }

        #dropOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 9999;
            display: none; align-items: center; justify-content: center;
            font-size: 24px; font-weight: bold; color: var(--primary);
            border: 5px dashed var(--primary);
            backdrop-filter: blur(5px);
        }

        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(128,128,128,0.4); border-radius: 3px; }

        .app-container { display: grid; grid-template-columns: 340px 1fr; height: 100dvh; padding: 15px; gap: 15px; }
        .sidebar { 
            background: var(--glass-bg); 
            backdrop-filter: blur(20px); 
            border: 1px solid var(--glass-border); 
            border-radius: var(--radius-lg); 
            padding: 20px; 
            display: flex; 
            flex-direction: column; 
            gap: 12px; 
            
            overflow-y: auto;       /* –°–∫—Ä–æ–ª–ª –ø–æ—è–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ */
            
            /* --- –í–û–¢ –≠–¢–ê –°–¢–†–û–ö–ê –†–ï–®–ê–ï–¢ –ü–†–û–ë–õ–ï–ú–£ --- */
            scrollbar-gutter: stable; 
        }
        
        .card { background: rgba(0, 0, 0, 0.05); border-radius: var(--radius-md); padding: 8px 10px; border: 1px solid var(--glass-border); }
        [data-theme="dark"] .card { background: rgba(0, 0, 0, 0.15); }

        .card-header { font-size: 10px; font-weight: 800; text-transform: uppercase; color: var(--text-sec); margin-bottom: 6px; display: flex; justify-content: space-between; align-items: center; }
        
        .modern-select, .modern-input { width: 100%; padding: 8px; background: var(--input-bg); border: 1px solid var(--glass-border); border-radius: 6px; color: var(--text-main); font-size: 13px; margin-bottom: 4px; }
        .modern-select option { background-color: var(--option-bg); color: var(--option-text); }

        .btn { width: 100%; padding: 12px; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; font-size: 11px; transition: 0.2s; text-align: center; text-transform: uppercase; display: block; }
        .btn-primary { background: var(--primary); color: var(--on-primary); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .btn-sec { background: var(--btn-sec-bg); color: var(--text-main); border: 1px solid var(--glass-border); }
        
        .btn-toggle-panel {
            width: 100%; padding: 8px; font-size: 10px; font-weight: 700; text-transform: uppercase;
            border-radius: 6px; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 5px;
            border: 1px solid var(--glass-border);
            background: var(--btn-collapsed-bg); 
            color: var(--btn-collapsed-text);
            transition: 0.3s;
        }
        .btn-toggle-panel.expanded {
            background: rgba(128,128,128,0.3);
            color: var(--text-main);
        }
        .panel-content { 
            /* –°–∫—Ä—ã—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
            display: block;      /* –í–∞–∂–Ω–æ! –ë–æ–ª—å—à–µ –Ω–µ none */
            max-height: 0;       /* –í—ã—Å–æ—Ç–∞ 0 */
            opacity: 0;          /* –ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å 0 */
            overflow: hidden;    /* –û–±—Ä–µ–∑–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ */
            
            /* –£–±–∏—Ä–∞–µ–º –æ—Ç—Å—Ç—É–ø—ã –∏ —Ä–∞–º–∫–∏, —á—Ç–æ–±—ã –æ–Ω–∏ –Ω–µ –∑–∞–Ω–∏–º–∞–ª–∏ –º–µ—Å—Ç–æ */
            margin-top: 0;       
            padding: 0;          
            border: 0px solid transparent; 
            
            background: rgba(0,0,0,0.1); 
            border-radius: 6px; 
            
            /* –ú–∞–≥–∏—è –ø–ª–∞–≤–Ω–æ–π –∞–Ω–∏–º–∞—Ü–∏–∏ */
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
        }
.panel-content.show { 
            max-height: 500px;   /* –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–æ–ª—å—à–∞—è –≤—ã—Å–æ—Ç–∞, —á—Ç–æ–±—ã –≤–ª–µ–∑–ª–æ –≤—Å—ë */
            opacity: 1; 
            
            /* –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—Ç—Å—Ç—É–ø—ã –∏ —Ä–∞–º–∫–∏ */
            margin-top: 8px; 
            padding: 8px; 
            border: 1px solid var(--glass-border); 
        }
        .btn-active-state { background-color: var(--primary) !important; color: var(--on-primary) !important; border-color: var(--primary) !important; opacity: 1 !important; }

        .palette-actions { display: flex; gap: 10px; margin-top: 8px; }
        .btn-action { flex: 1; padding: 0; border-radius: 8px; font-size: 10px; font-weight: 700; text-transform: uppercase; cursor: pointer; display: flex; align-items: center; justify-content: center; height: 28px; border: 1px solid transparent; }
        
        .btn-refresh { background: var(--btn-refresh-bg); color: var(--btn-refresh-color); border-color: var(--btn-refresh-color); display: none; }
        
        .btn-danger-small { background: rgba(255, 50, 50, 0.1); color: #ff5555; border-color: rgba(255, 50, 50, 0.3); }

        .slider-group { margin-bottom: 6px; }
        .slider-group.locked input { opacity: 0.3; cursor: not-allowed; } 
        .slider-header-compact { display: flex; justify-content: space-between; font-size: 9px; font-weight: 700; text-transform: uppercase; color: var(--text-sec); margin-bottom: 2px; padding-left: 2px; align-items: center;}
        .val-display { color: var(--primary); }
        
        .smart-toggle-btn {
            font-size: 9px; padding: 1px 4px; border: 1px solid var(--glass-border); border-radius: 4px; cursor: pointer; margin-left: 5px; opacity: 0.5;
        }
        .smart-toggle-btn.active { opacity: 1; background: var(--primary); color: var(--on-primary); border-color: var(--primary); }

        .slider-row { display: flex; align-items: center; gap: 6px; }
        .icon-btn-side { width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; cursor: pointer; opacity: 0.7; font-size: 11px; border: 1px solid var(--glass-border); border-radius: 4px; background: rgba(0,0,0,0.1); flex-shrink: 0; color: var(--text-main); }
        .icon-btn-side:active { transform: scale(0.95); opacity: 1; }
        
        input[type="range"] { -webkit-appearance: none; flex: 1; background: transparent; height: 24px; cursor: pointer; width: 100%; }
        input[type="range"]::-webkit-slider-runnable-track { height: 4px; background: rgba(128,128,128,0.3); border-radius: 2px; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: var(--primary); margin-top: -6px; border: 2px solid var(--glass-border); box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
        
        .num-input-small { width: 40px; background: var(--input-bg); border: 1px solid var(--glass-border); color: var(--text-main); font-size: 11px; text-align: center; border-radius: 4px; padding: 2px; -moz-appearance: textfield; }
        .num-input-small::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .num-ctrl-btn { width: 20px; height: 20px; background: rgba(255,255,255,0.1); border: 1px solid var(--glass-border); color: var(--text-main); display: flex; align-items: center; justify-content: center; cursor: pointer; border-radius: 4px; font-weight: bold; }

        .palette-row { display: flex; align-items: center; gap: 10px; margin-top: 5px; }
        .palette-grid { display: flex; gap: 8px; flex-wrap: wrap; flex: 1; }
        
        .palette-item { position: relative; width: 32px; height: 32px; border-radius: 50%; border: 2px solid var(--glass-border); cursor: pointer; overflow: hidden; flex-shrink: 0; box-shadow: 0 2px 5px rgba(0,0,0,0.2); display:flex; align-items:center; justify-content:center; transition: transform 0.1s; }
        .palette-item.active-brush { border: 3px solid #fff !important; transform: scale(1.15); z-index: 10; box-shadow: 0 0 15px var(--primary); }
        .palette-item input { position: absolute; top:0; left:0; width:1px; height:1px; opacity:0; pointer-events:none; } 
        .pal-sym { position:relative; z-index:5; font-weight:900; font-size:11px; pointer-events:none; text-shadow: 0 0 2px rgba(0,0,0,0.5); color: #fff; }

        .stage { position: relative; background: var(--glass-bg); backdrop-filter: blur(20px); border: 1px solid var(--glass-border); border-radius: var(--radius-lg); display: flex; flex-direction: column; overflow: hidden; }
        .header-bar { display: flex; justify-content: space-between; padding: 10px; flex-shrink: 0; z-index: 100; background: transparent; }
        .header-left { display: flex; gap: 5px; align-items: center; overflow: visible !important; flex: 1; position: relative; }
        .header-right { display: flex; gap: 5px; flex-shrink: 0; }
        
        .viewport { flex: 1; display: flex; align-items: center; justify-content: center; overflow: hidden; padding: 20px; position: relative; touch-action: none; cursor: grab; }
        .viewport:active { cursor: grabbing; }
        .viewport.pencil-mode { cursor: crosshair !important; }
        
        #instructionView { display: none; flex: 1; width: 100%; overflow: auto; padding: 20px; text-align: center; position: relative; touch-action: pan-x pan-y; -webkit-overflow-scrolling: touch; }
        #gridContainer { display: inline-block; text-align: left; padding-bottom: 50px; transform-origin: top left; }
        
        .instruction-grid { 
            display: inline-grid; 
            background: white; 
            color: black; 
            border: 1px solid #999; 
            position: relative; 
            
            /* --- –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø --- */
            transform-origin: 0 0; /* –¢–æ—á–∫–∞ –∑—É–º–∞ –≤—Å–µ–≥–¥–∞ –ª–µ–≤—ã–π –≤–µ—Ä—Ö */
            will-change: transform; /* –°–æ–æ–±—â–∞–µ–º –±—Ä–∞—É–∑–µ—Ä—É, —á—Ç–æ –±—É–¥–µ–º –º–µ–Ω—è—Ç—å –º–∞—Å—à—Ç–∞–± */
            /* –≠—Ç–æ –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç —Å–ª–æ–π –Ω–∞ –≤–∏–¥–µ–æ–∫–∞—Ä—Ç—É */
        }
        .cell, .ruler-cell { display: flex; justify-content: center; align-items: center; border-top: 1px solid #ccc; border-left: 1px solid #ccc; width: 20px !important; height: 20px !important; min-width: 20px; min-height: 20px; font-weight: bold; font-size: 9px; cursor: pointer; box-sizing: border-box; transition: opacity 0.2s, filter 0.2s; }
        
        .ruler-cell { background: #eee; color: #333; transition: background 0.2s; }
        .ruler-cell:hover { background: #ddd; }
.info-header { 
            background: #eee; 
            color: #333; 
            border-top: 1px solid #ccc; 
            border-left: 1px solid #ccc; 
            font-weight: bold; 
            font-size: 10px; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            width: 350px; /* –£–±—Ä–∞–ª–∏ —Ç–µ–ø–µ—Ä—å —à–∏—Ä–∏–Ω–∞ –∞–≤—Ç–æ */
            height: 25px; 
            cursor: pointer; 
            padding: 0 10px;
            white-space: nowrap;
        }
.row-info { 
            display: flex; 
            align-items: center; 
            padding-left: 5px; /* –£–º–µ–Ω—å—à–∏–ª–∏ –æ—Ç—Å—Ç—É–ø */
            border-top: 1px solid #ccc; 
            height: 20px; 
            width: 350px; /* –£–±—Ä–∞–ª–∏ */
            font-size: 10px; 
            background: #f4f4f4; 
            color: #111; 
            font-family: monospace; 
            cursor: pointer; 
            transition: background 0.2s; 
            
            /* --- –í–ê–ñ–ù–´–ï –î–û–ë–ê–í–õ–ï–ù–ò–Ø --- */
            overflow-x: auto; /* –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞, –µ—Å–ª–∏ –Ω–µ –≤–ª–µ–∑–ª–æ */
            overflow-y: hidden;
            white-space: nowrap; /* –ó–∞–ø—Ä–µ—Ç –ø–µ—Ä–µ–Ω–æ—Å–∞ —Å—Ç—Ä–æ–∫ (—á—Ç–æ–±—ã –≤—ã—Å–æ—Ç–∞ –Ω–µ —Å–∫–∞–∫–∞–ª–∞) */
            scrollbar-width: none; /* –°–∫—Ä—ã–≤–∞–µ–º —Å–∫—Ä–æ–ª–ª–±–∞—Ä (Firefox) */
            -ms-overflow-style: none;  /* –°–∫—Ä—ã–≤–∞–µ–º —Å–∫—Ä–æ–ª–ª–±–∞—Ä (IE) */
        }
        
        /* –°–∫—Ä—ã–≤–∞–µ–º —Å–∫—Ä–æ–ª–ª–±–∞—Ä –¥–ª—è Chrome/Safari */
        .row-info::-webkit-scrollbar { 
            display: none; 
        }
        .row-info:hover { background: #e0e0e0; }
        
        .shade-layer { position: absolute; background: rgba(0,0,0,0.7); pointer-events: none; z-index: 50; left: 0; right: 0; }

        .preview-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            max-width: 100%;
            max-height: 100%;
            flex-wrap: nowrap;
        }

        #resultBox { 
            position: relative; 
            pointer-events: none; 
            line-height: 0; 
            flex: 0 1 auto; 
            display: flex; 
            justify-content: center;
            align-items: center;
        }

        #origBox { 
            max-width: 15%; 
            max-height: 100%; 
            position: relative; 
            pointer-events: none; 
            flex: 0 0 auto;
        }

        .preview-content {  
            max-width: 100%;  
            max-height: 65vh;  
            border-radius: 8px;  
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);  
            border: 1px solid var(--primary);
            padding: 1px;
            background: var(--glass-bg);
            object-fit: contain !important; /* –ö–∞—Ä—Ç–∏–Ω–∫–∞ –≤—Å–µ–≥–¥–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –ø—Ä–æ–ø–æ—Ä—Ü–∏–∏ */
            display: block;  
            pointer-events: none;
            aspect-ratio: auto; /* –ó–∞–ø—Ä–µ—â–∞–µ—Ç –±—Ä–∞—É–∑–µ—Ä—É –≤—ã–¥—É–º—ã–≤–∞—Ç—å —Å–≤–æ–∏ –ø—Ä–æ–ø–æ—Ä—Ü–∏–∏ */
            transition: transform 0.2s ease-out; 
        }

        .preview-label { margin: 0; background: rgba(0,0,0,0.6); padding: 4px 8px; border-radius: 6px; font-size: 9px; color: #fff; text-transform: uppercase; position: absolute; top: 10px; left: 50%; transform: translateX(-50%); z-index: 5; pointer-events: none; border: 1px solid rgba(255,255,255,0.2); white-space: nowrap; line-height: normal; }

        /* --- –°–¢–ê–ë–ò–õ–¨–ù–´–ô CSS –° –ü–õ–ê–í–ù–´–ú –ó–ê–¢–£–•–ê–ù–ò–ï–ú --- */
.mode-toggle { 
    background: var(--glass-bg); 
    padding: 2px; 
    border-radius: 30px; 
    border: 1px solid var(--glass-border); 
    height: 28px; 
    display: flex; 
    align-items: center; 
    flex-shrink: 0; 
}

.toggle-opt { 
    padding: 0 10px; 
    height: 22px; 
    display: flex; 
    align-items: center; 
    border-radius: 24px; 
    cursor: pointer; 
    font-size: 9px; 
    font-weight: 700; 
    color: var(--text-sec); 
    text-transform: uppercase;
    background: transparent; /* –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Ñ–æ–Ω–∞ –Ω–µ—Ç */
    
    /* –í–û–¢ –≠–¢–ê –°–¢–†–û–ö–ê –î–ï–õ–ê–ï–¢ –ü–õ–ê–í–ù–û–°–¢–¨ (0.3 —Å–µ–∫—É–Ω–¥—ã) */
    transition: background-color 0.3s ease, color 0.3s ease;
}

.toggle-opt.active { 
    background: var(--primary); 
    color: var(--on-primary); 
}
        
        .lock-btn { height: 36px; padding: 0 10px; border-radius: 20px; background: var(--glass-bg); border: 1px solid var(--glass-border); color: var(--text-sec); cursor: pointer; font-size: 12px; font-weight: 700; text-transform: uppercase; display: flex; align-items: center; gap: 4px; flex-shrink: 0; }
        .lock-btn.active { background-color: #28a745 !important; color: #fff !important; border-color: #28a745 !important; }
        
        .top-btn { height: 28px; padding: 0 10px; border-radius: 20px; background: var(--glass-bg); border: 1px solid var(--glass-border); color: var(--text-main); cursor: pointer; font-size: 9px; font-weight: 700; flex-shrink: 0;}
        
        .zoom-display-btn { 
height: 28px; 
padding: 0 10px; 
border-radius: 30px; 
border: 1px solid var(--glass-border); 
background: var(--glass-bg); 
color: var(--text-main); 
font-size: 9px; 
font-weight: 700; 
cursor: pointer; 
display: flex; 
align-items: center; 
justify-content: center; 
margin-left: 5px; 
min-width: 30px; /* –ß—Ç–æ–±—ã –Ω–µ —Å–∂–∏–º–∞–ª–∞—Å—å —Å–ª–∏—à–∫–æ–º —Å–∏–ª—å–Ω–æ */
    white-space: nowrap; /* –ß—Ç–æ–±—ã —Ç–µ–∫—Å—Ç –Ω–µ –ø–µ—Ä–µ–Ω–æ—Å–∏–ª—Å—è */}
        .zoom-display-btn span { color: var(--text-main); }
        .zoom-display-btn.btn-active-state span { color: var(--on-primary); }

        .floating-nav { position: absolute; top: 55px; left: 10px; background: transparent; backdrop-filter: none; border: none; box-shadow: none; padding: 8px; border-radius: 12px; display: none; z-index: 1000; width: 100px; height: 100px; }
        
        .nav-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; grid-template-rows: 1fr 1fr 1fr; width: 100%; height: 100%; gap: 4px; }
        .nav-btn { background: rgba(0, 0, 0, 0.6); border: 1px solid var(--glass-border); border-radius: 4px; color: var(--text-main); font-size: 14px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; padding: 0; }
        [data-theme="light"] .nav-btn { background: rgba(255, 255, 255, 0.8); color: #000; }
        .nav-btn.active { background: var(--primary); color: var(--on-primary); border-color: var(--primary); }
        .nav-all { grid-column: 2; grid-row: 2; background: rgba(0, 0, 0, 0.6); font-size: 9px; border-radius: 50%; box-shadow: 0 0 10px rgba(0,0,0,0.3); }

        .zoom-popup-unified {
            display: none; position: absolute; height: 40px; width: 140px; background: transparent; border: none; backdrop-filter: none; box-shadow: none; align-items: center; justify-content: center; padding: 0 10px; z-index: 9999;
        }
        .zoom-popup-unified.show { display: flex; }
        #zoomPopup { top: 45px; left: -30px; }
        #fsZoomPopup { top: 45px; left: 0; }
        .horizontal-range { width: 100%; height: 24px; cursor: pointer; background: transparent; }
        
        .settings-arrow { display:inline-block; transition: transform 0.3s; margin-left: 5px; }
        .settings-arrow.rotated { transform: rotate(180deg); }
        
        .custom-size-inputs { display:flex; gap: 5px; }

        /* –ù–ê–ô–î–ò–¢–ï –ò –ó–ê–ú–ï–ù–ò–¢–ï –≠–¢–û–¢ –ë–õ–û–ö */
.icon-small { 
    width: 36px;         /* –®–∏—Ä–∏–Ω–∞ 28px */
    height: 36px;        /* –í—ã—Å–æ—Ç–∞ 28px */
    font-size: 20px;     /* –†–∞–∑–º–µ—Ä —Å–∞–º–æ–π —Å—Ç—Ä–µ–ª–æ—á–∫–∏ –≤–Ω—É—Ç—Ä–∏ */
    
    display: flex; 
    align-items: center; 
    justify-content: center; 
    cursor: pointer; 
    background: var(--glass-bg); 
    border-radius: 50%; /* –ö—Ä—É–≥–ª–∞—è —Ñ–æ—Ä–º–∞ */
    border: 1px solid var(--glass-border); 
    margin-left: 0px; 
    color: var(--text-main); 
    transition: transform 0.1s; /* –î–æ–±–∞–≤–∏–º –ª–µ–≥–∫—É—é –∞–Ω–∏–º–∞—Ü–∏—é –Ω–∞–∂–∞—Ç–∏—è */
}

/* –≠—Ñ—Ñ–µ–∫—Ç –Ω–∞–∂–∞—Ç–∏—è */
.icon-small:active {
    transform: scale(0.9);
}

/* –°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞ (—É–∂–µ –µ—Å—Ç—å –≤ –∫–æ–¥–µ, –Ω–æ –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏) */
[data-theme="light"] .icon-small { 
    background: rgba(0,0,0,0.05); 
}
        
        .icon-small.active { background-color: var(--primary) !important; color: var(--on-primary) !important; border-color:var(--primary) !important; opacity: 1; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 9999; display: none; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal { background: var(--modal-bg); color: var(--modal-text); width: 90%; max-width: 600px; max-height: 85vh; border-radius: 12px; display: flex; flex-direction: column; overflow: hidden; border: 1px solid var(--glass-border); box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .modal-header { padding: 15px 20px; border-bottom: 1px solid var(--glass-border); display: flex; justify-content: space-between; align-items: center; background: rgba(128,128,128,0.1); }
        .modal-body { padding: 20px; overflow-y: auto; flex: 1; color: var(--modal-text); font-size: 14px; line-height: 1.6; }
        
        .algo-box { background: rgba(255, 215, 0, 0.1); border: 1px solid var(--primary); padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .algo-title { font-weight: bold; color: var(--primary); margin-bottom: 10px; display: block; font-size: 16px; }
        .algo-box ol { color: var(--modal-text) !important; }
        [data-theme="light"] .algo-box ol { color: #000 !important; }

        #fsGridControls { 
            display: none; position: fixed; top: 20px; left: 20px; background: transparent; padding: 0; border: none; z-index: 6000; flex-direction: row; align-items: flex-start; justify-content: flex-start; gap: 10px; height: auto; width: auto; 
            opacity: 1; pointer-events: auto;
        }
        .reset-vis-btn { 
            width: 30px; height: 30px; border-radius: 50%; background: var(--primary); color:var(--on-primary); border:none; margin: 0; display: flex; align-items: center; justify-content: center; cursor: pointer; font-weight: bold; font-size: 14px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); pointer-events: auto; 
        }

        body.fullscreen-mode #fsGridControls { display: flex; }
        
        @media (min-width: 1024px) {
            .sidebar { padding: 30px; gap: 20px; }
            .header-bar { padding: 20px 30px; } 
            .mode-toggle { height: 40px; padding: 4px; border-radius: 40px; }
            .toggle-opt { height: 32px; padding: 0 20px; font-size: 12px; border-radius: 30px; }
            .top-btn, .zoom-display-btn { height: 40px; width: 40px; font-size: 18px; border-radius: 30px; }
            .zoom-display-btn { width: 60px; font-size: 12px; }
            .floating-nav { top: 70px; left: 30px; width: 120px; height: 120px; }
        }

        /* --- –ú–û–ë–ò–õ–¨–ù–´–ô –†–ï–ñ–ò–ú: "–ö–ê–ö –ù–ê –ü–ö" (–ö–ê–†–¢–û–ß–ö–ò) --- */
        @media (max-width: 768px) and (orientation: portrait) {
            /* 1. –ì–ª–∞–≤–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä: –î–µ–ª–∞–µ–º –æ—Ç—Å—Ç—É–ø—ã –æ—Ç –∫—Ä–∞–µ–≤ —ç–∫—Ä–∞–Ω–∞ –∏ –∑–∞–∑–æ—Ä –º–µ–∂–¥—É –æ–∫–Ω–∞–º–∏ */
            .app-container { 
                display: flex; 
                flex-direction: column; 
                height: 100dvh; 
                padding: 4px; /* –û—Ç—Å—Ç—É–ø –æ—Ç –∫—Ä–∞—è —ç–∫—Ä–∞–Ω–∞ */
                gap: 10px !important; /* –ó–ê–ó–û–† –ú–ï–ñ–î–£ –í–ï–†–•–ù–ò–ú –ò –ù–ò–ñ–ù–ò–ú –û–ö–ù–û–ú */
                overflow: hidden; 
/* --- –£–ú–ï–ù–¨–®–ï–ù–ò–ï –ö–ù–û–ü–û–ö "–ù–ê–ó–ê–î" –ò "–ö–ê–†–ê–ù–î–ê–®" (–¢–û–õ–¨–ö–û –ú–û–ë–ò–õ–¨–ù–´–ï) --- */
    .header-left .icon-small {
        width: 28px !important;       /* –®–∏—Ä–∏–Ω–∞ –∫–∞–∫ —É –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—è –í–∏–¥/–°—Ö–µ–º–∞ */
        height: 28px !important;      /* –í—ã—Å–æ—Ç–∞ –∫–∞–∫ —É –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—è –í–∏–¥/–°—Ö–µ–º–∞ */
        font-size: 14px !important;   /* –£–º–µ–Ω—å—à–∞–µ–º –∏–∫–æ–Ω–∫—É –≤–Ω—É—Ç—Ä–∏ */
        line-height: 28px !important; /* –¶–µ–Ω—Ç—Ä–æ–≤–∫–∞ –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏ */
    }
/* --- –£–ú–ï–ù–¨–®–ï–ù–ò–ï –ö–ù–û–ü–ö–ò "–ë–õ–û–ö" (–¢–û–õ–¨–ö–û –ú–û–ë–ò–õ–¨–ù–´–ï) --- */
    .header-left .lock-btn {
        height: 28px !important;      /* –í—ã—Å–æ—Ç–∞ –∫–∞–∫ —É –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—è */
        font-size: 9px !important;    /* –®—Ä–∏—Ñ—Ç –ø–æ–º–µ–Ω—å—à–µ, —á—Ç–æ–±—ã –≤–ª–µ–∑–ª–æ */
        padding: 0 8px !important;    /* –ß—É—Ç—å –º–µ–Ω—å—à–µ –æ—Ç—Å—Ç—É–ø—ã –ø–æ –±–æ–∫–∞–º */
        line-height: 26px !important; /* –¶–µ–Ω—Ç—Ä–æ–≤–∫–∞ —Ç–µ–∫—Å—Ç–∞ */
    }            
}
            
            /* 2. –í–µ—Ä—Ö–Ω—è—è –∫–∞—Ä—Ç–∞ (–°—Ü–µ–Ω–∞): –°–∫—Ä—É–≥–ª–µ–Ω–Ω–∞—è, —Å —Ä–∞–º–∫–æ–π, –≥–∏–±–∫–∞—è */
            .stage { 
                order: 1; 
                flex: 1; /* –ó–∞–Ω–∏–º–∞–µ—Ç –≤—Å—ë —Å–≤–æ–±–æ–¥–Ω–æ–µ –º–µ—Å—Ç–æ —Å–≤–µ—Ä—Ö—É */
                width: 100%; 
                border-radius: 20px; /* –í–û–ó–í–†–ê–©–ê–ï–ú –°–ö–†–£–ì–õ–ï–ù–ò–Ø */
                border: 1px solid var(--glass-border); 
                display: flex; 
                flex-direction: column; 
                overflow: hidden;
                min-height: 0; /* –ú–∞–≥–∏—è CSS: –ø–æ–∑–≤–æ–ª—è–µ—Ç –∫–∞—Ä—Ç–∏–Ω–∫–µ —Å–∂–∏–º–∞—Ç—å—Å—è, –∞ –Ω–µ —Ä–∞—Å–ø–∏—Ä–∞—Ç—å –±–ª–æ–∫ */
                background: var(--glass-bg);
            }
            
            /* 3. –®–∞–ø–∫–∞ —Å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–º–∏: –ë–æ–ª—å—à–µ –Ω–µ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞–µ—Ç –∫–∞—Ä—Ç–∏–Ω–∫—É! */
            .header-bar { 
                position: relative; /* –û–Ω–∞ —Ç–µ–ø–µ—Ä—å —á–∞—Å—Ç—å –ø–æ—Ç–æ–∫–∞ */
                width: 100%;
                padding: 6px 8px;
                background: rgba(0,0,0,0.1); /* –õ–µ–≥–∫–æ–µ –∑–∞—Ç–µ–º–Ω–µ–Ω–∏–µ –¥–ª—è —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è */
                flex-shrink: 0; /* –ù–µ —Å–∂–∏–º–∞—Ç—å —à–∞–ø–∫—É */
                z-index: 20;
            }
            
            /* 4. –û–±–ª–∞—Å—Ç—å –ø—Ä–æ—Å–º–æ—Ç—Ä–∞: –ó–∞–Ω–∏–º–∞–µ—Ç –æ—Å—Ç–∞—Ç–æ–∫ –º–µ—Å—Ç–∞ –≤ –∫–∞—Ä—Ç–µ */
            .viewport { 
                flex: 1; 
                width: 100%;
                height: 100%; /* –í–∞–∂–Ω–æ –¥–ª—è flex-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ */
                padding: 10px !important; /* –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –æ—Ç—Å—Ç—É–ø, —á—Ç–æ–±—ã –Ω–µ –ø—Ä–∏–ª–∏–ø–∞–ª–æ –∫ –∫—Ä–∞—è–º */
                display: flex; 
                align-items: center; 
                justify-content: center; 
                overflow: hidden; 
                position: relative;
            }

            /* 5. –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –ø—Ä–µ–≤—å—é */
            .preview-row {
                width: 100%;
                height: 100%; /* –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –≤—ã—Å–æ—Ç–æ–π —Ä–æ–¥–∏—Ç–µ–ª—è */
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 10px;
            }

            /* 1. –°—Ç–∏–ª–∏ –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ (–Ω–µ–º–Ω–æ–≥–æ —É–ø—Ä–æ—Å—Ç–∏–º) */
        #resultBox, #origBox {
            position: relative;
            pointer-events: none;
            flex: 0 1 auto;
            display: flex;
            justify-content: center;
            align-items: center;
            /* –£–±–∏—Ä–∞–µ–º line-height: 0 –æ—Ç—Å—é–¥–∞, –æ–Ω –º–µ—à–∞–µ—Ç */
        }
        #origBox { max-width: 15%; }
       .image-wrapper {
            position: relative; /* –ß—Ç–æ–±—ã –º–µ—Ç–∫–∞ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–ª–∞—Å—å –≤–Ω—É—Ç—Ä–∏ */
            display: inline-block; /* –û–±–µ—Ä—Ç–∫–∞ —Å–∂–∏–º–∞–µ—Ç—Å—è –ø–æ —Ä–∞–∑–º–µ—Ä—É —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ */
            line-height: 0; /* –£–±–∏—Ä–∞–µ–º –ø–∞—Ä–∞–∑–∏—Ç–Ω—ã–µ –æ—Ç—Å—Ç—É–ø—ã –ø–æ–¥ –∫–∞—Ä—Ç–∏–Ω–∫–æ–π */

            /* –°–¢–ò–õ–ò –†–ê–ú–ö–ò (–ø–µ—Ä–µ–Ω–µ—Å–µ–Ω—ã —Å .preview-content) */
            border-radius: 8px;

/* --- –í–û–¢ –≠–¢–ê –°–¢–†–û–ö–ê –†–ï–®–ê–ï–¢ –ü–†–û–ë–õ–ï–ú–£ --- */
            overflow: hidden; /* –û–±—Ä–µ–∑–∞–µ—Ç –≤—Å—ë, —á—Ç–æ –≤—ã–ª–µ–∑–∞–µ—Ç –∑–∞ —Ä–∞–¥–∏—É—Å */
            /* -------------------------------------- */

            /* box-shadow: 0 10px 30px rgba(0,0,0,0.3); */
            /* border: 1px solid var(--primary); */
            padding: 1px;
            background: var(--glass-bg);
            
            /* –ü–ª–∞–≤–Ω–æ—Å—Ç—å –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–µ–ø–µ—Ä—å –∑–¥–µ—Å—å */
            transition: transform 0.2s ease-out;
            transform-origin: center center;
            
            /* --- –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø –ú–û–ë–ò–õ–¨–ù–û–ì–û –í–ò–î–ê (–¶–µ–Ω—Ç—Ä–æ–≤–∫–∞ –∏ –†–∞–º–∫–∏) --- */
             border: 1px solid var(--primary) !important;
             box-shadow: 0 4px 15px rgba(0,0,0,0.3) !important;
             padding: 0 !important;       /* –£–±–∏—Ä–∞–µ–º –∑–∞–∑–æ—Ä—ã */
             background: transparent !important; /* –£–±–∏—Ä–∞–µ–º —Ñ–æ–Ω —Å—Ç–µ–∫–ª–∞, —á—Ç–æ–±—ã –Ω–µ —Å–≤–µ—Ç–∏–ª—Å—è */
        }

            .preview-content {
            max-width: 100%;
            max-height: 65vh;
            /* –£–±—Ä–∞–ª–∏ border, padding, radius, shadow, background, transition */
            object-fit: contain !important;
            display: block;
            pointer-events: none;
            aspect-ratio: auto;
             
             /* --- –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø –ú–û–ë–ò–õ–¨–ù–û–ì–û –í–ò–î–ê --- */
             border: none !important;
             box-shadow: none !important;
             background: transparent !important;
             border-radius: 9px !important; /* –°–∫—Ä—É–≥–ª–µ–Ω–∏–µ –±–µ—Ä–µ—Ç—Å—è –æ—Ç –æ–±–µ—Ä—Ç–∫–∏ */
        }
        
.preview-label {
            margin: 0;
            background: rgba(0,0,0,0.6);
            padding: 4px 8px;
            border-radius: 4px; /* –ß—É—Ç—å –º–µ–Ω—å—à–µ —Ä–∞–¥–∏—É—Å, —á—Ç–æ–±—ã –≤–ø–∏—Å–∞—Ç—å—Å—è –≤ —É–≥–æ–ª */
            font-size: 9px;
            color: #fff;
            text-transform: uppercase;
            
            position: absolute;
            z-index: 5;
            pointer-events: none;
            border: 1px solid rgba(255,255,255,0.2);
            white-space: nowrap;
            line-height: normal;
            
            /* --- –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø –ú–û–ë–ò–õ–¨–ù–û–ì–û –í–ò–î–ê (–¶–µ–Ω—Ç—Ä–æ–≤–∫–∞) --- */
            left: 50% !important;        /* –°–¥–≤–∏–≥ –Ω–∞ —Å–µ—Ä–µ–¥–∏–Ω—É */
            transform: translateX(-50%) !important; /* –¢–æ—á–Ω–∞—è —Ü–µ–Ω—Ç—Ä–æ–≤–∫–∞ */
            top: 6px !important;         /* –û—Ç—Å—Ç—É–ø —Å–≤–µ—Ä—Ö—É */
            right: auto !important;      /* –°–±—Ä–æ—Å –ø—Ä–∏–≤—è–∑–∫–∏ –∫ –ø—Ä–∞–≤–æ–º—É –∫—Ä–∞—é */
            font-size: 7px !important;   /* –£–º–µ–Ω—å—à–µ–Ω–Ω—ã–π —à—Ä–∏—Ñ—Ç (–±—ã–ª–æ 9px) */
            padding: 2px 5px !important; /* –ë–æ–ª–µ–µ –∫–æ–º–ø–∞–∫—Ç–Ω–∞—è –ø–æ–¥–ª–æ–∂–∫–∞ */
            letter-spacing: 0.5px;       /* –ß—É—Ç—å —Ä–∞–∑—Ä—è–¥–∏–º –±—É–∫–≤—ã –¥–ª—è —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏ */
        }
            /* 7. –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è (–°—Ö–µ–º–∞) */
            #instructionView { 
                padding-top: 10px; 
                overflow: auto; 
                height: 100%; 
            }
            
            /* 8. –ù–∏–∂–Ω—è—è –ø–∞–Ω–µ–ª—å (–ù–∞—Å—Ç—Ä–æ–π–∫–∏): –¢–æ–∂–µ –∫–∞—Ä—Ç–æ—á–∫–∞ */
            .sidebar { 
                order: 2; 
                height: 40vh; /* –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤—ã—Å–æ—Ç–∞ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ */
                flex-shrink: 0; 
                border-radius: 20px; /* –°–∫—Ä—É–≥–ª–µ–Ω–∏—è */
                border: 1px solid var(--glass-border); 
                padding: 15px; 
                padding-bottom: 80px; 
                z-index: 20;
            }
            
            /* –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –ø–ª–∞–≤–∞—é—â–∏—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ */
            #resultBox { max-width: 75%; } 
            #origBox { max-width: 25%; }
            .floating-nav { top: 60px; left: 10px; }
            
            #sectorNav { display: none !important; }
            .stage.expanded-mode #sectorNav { display: block !important; }
            
            body.fullscreen-mode #sectorNav,
            body.fullscreen-mode .stage.expanded-mode #sectorNav { 
                display: none !important; 
            }
        }
        
        body.fullscreen-mode .app-container { display: block !important; padding: 0 !important; }
        body.fullscreen-mode .sidebar, body.fullscreen-mode .header-bar { display: none !important; }
        body.fullscreen-mode .stage { 
            height: 100dvh !important; width: 100vw !important; border-radius: 0 !important; border: none !important; position: fixed; top: 0; left: 0; z-index: 5000; background: var(--bg-gradient);
        }
        #fsExitBtn { display: none; position: fixed; top: 20px; right: 20px; width: 50px; height: 50px; border-radius: 50%; background: rgba(255, 50, 50, 0.9); color: white; font-size: 24px; border: 2px solid white; z-index: 6000; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.5); align-items: center; justify-content: center; }
        body.fullscreen-mode #fsExitBtn { display: flex; }
        body.fullscreen-mode #sectorNav, body.fullscreen-mode #gridZoomControl { display: none !important; }

        @media print {
            body { display: none; }
        }
/* --- –ê–ù–ò–ú–ê–¶–ò–Ø –ù–ê–ñ–ê–¢–ò–Ø –î–õ–Ø –í–°–ï–• –ö–ù–û–ü–û–ö --- */
        .btn:active,
        .btn-action:active,
        .btn-toggle-panel:active,
        .icon-small:active,
        .top-btn:active,
        .reset-vis-btn:active,
        .nav-btn:active,
        .zoom-display-btn:active,
        .lock-btn:active {
            transform: scale(0.95); /* –õ–µ–≥–∫–æ–µ —É–º–µ–Ω—å—à–µ–Ω–∏–µ –ø—Ä–∏ –∫–ª–∏–∫–µ */
            transition: transform 0.05s ease-out; /* –û—á–µ–Ω—å –±—ã—Å—Ç—Ä–∞—è —Ä–µ–∞–∫—Ü–∏—è */
        }
        
        /* –ü–ª–∞–≤–Ω–æ—Å—Ç—å –ø–æ–≤–æ—Ä–æ—Ç–∞ —Å—Ç—Ä–µ–ª–æ—á–∫–∏ –¥–ª—è —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞—é—â–∏—Ö—Å—è –º–µ–Ω—é */
        .settings-arrow {
            transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
        }
/* –°—Ç–∏–ª–∏ –¥–ª—è –≤–≤–æ–¥–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –±–ª–æ–∫–æ–≤ –≤ —Ä–µ–∂–∏–º–µ –°–≤–æ–π AI */
        .stock-input-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 6px;
            font-size: 11px;
            padding: 4px;
            background: rgba(0,0,0,0.1);
            border-radius: 4px;
            border: 1px solid var(--glass-border);
        }
        
        .stock-info {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
        }

        .stock-color-preview {
            width: 16px;
            height: 16px;
            border-radius: 4px;
            border: 1px solid rgba(255,255,255,0.3);
            flex-shrink: 0;
        }

        .stock-input-field {
            width: 60px;
            background: var(--input-bg);
            border: 1px solid var(--glass-border);
            color: var(--text-main);
            border-radius: 4px;
            padding: 4px;
            font-size: 11px;
            text-align: right;
        }

        .stock-input-field:focus {
            border-color: var(--primary);
        }

        /* –ö–æ–≥–¥–∞ –º—ã –≤ —Ä–µ–∂–∏–º–µ –≤–≤–æ–¥–∞, —Å–∫—Ä—ã–≤–∞–µ–º –æ–±—ã—á–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É */
        .algo-box.stock-mode-active {
            border-color: var(--primary);
            background: rgba(var(--primary-rgb), 0.1);
        }

/* --- –í–°–¢–ê–í–ò–¢–¨ –í –ö–û–ù–ï–¶ –ë–õ–û–ö–ê <style> --- */

/* –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–Ω–∏–º–∞—Ü–∏–∏ –º–µ–Ω—é —Ä–∞–º–∫–∏ */
#borderControl {
    display: block !important; /* –£–±–∏—Ä–∞–µ–º display:none */
    overflow: hidden;          /* –°–∫—Ä—ã–≤–∞–µ–º –≤—Å—ë, —á—Ç–æ –Ω–µ –≤–ª–µ–∑–∞–µ—Ç */
    
    /* –ù–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (—Å–∫—Ä—ã—Ç–æ) */
    max-height: 0;
    opacity: 0;
    margin-top: 0;
    padding: 0;
    border: 0px solid transparent;

    background: rgba(0,0,0,0.1);
    border-radius: 6px;
    
    /* –ú–∞–≥–∏—è –ø–ª–∞–≤–Ω–æ—Å—Ç–∏ (–∫–∞–∫ —É –¥—Ä—É–≥–∏—Ö –ø–∞–Ω–µ–ª–µ–π) */
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

/* –°–æ—Å—Ç–æ—è–Ω–∏–µ (—Ä–∞—Å–∫—Ä—ã—Ç–æ) - –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –∫–ª–∞—Å—Å–æ–º .show */
#borderControl.show {
    max-height: 150px; /* –í—ã—Å–æ—Ç–∞ —Å –∑–∞–ø–∞—Å–æ–º */
    opacity: 1;
    margin-top: 10px;
    padding: 8px;
}
/* --- –°–¢–ò–õ–ò –î–õ–Ø –ú–û–ë–ò–õ–¨–ù–û–ì–û –ì–û–†–ò–ó–û–ù–¢–ê–õ–¨–ù–û–ì–û –†–ï–ñ–ò–ú–ê --- */
@media (max-width: 1023px) and (orientation: landscape) {
    
    /* 1. –ö–Ω–æ–ø–∫–∏ "–ù–∞–∑–∞–¥" (Undo) –∏ "–ö–∞—Ä–∞–Ω–¥–∞—à" */
    .header-left .icon-small {
        width: 28px !important;       /* –®–∏—Ä–∏–Ω–∞ –∫–∞–∫ —É –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—è */
        height: 28px !important;      /* –í—ã—Å–æ—Ç–∞ –∫–∞–∫ —É –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—è */
        font-size: 14px !important;   /* –£–º–µ–Ω—å—à–∞–µ–º —Ä–∞–∑–º–µ—Ä –∑–Ω–∞—á–∫–∞ */
        line-height: 28px !important; /* –¶–µ–Ω—Ç—Ä–æ–≤–∫–∞ */
    }

    /* 2. –ö–Ω–æ–ø–∫–∞ "–ë–õ–û–ö" */
    .header-left .lock-btn {
        height: 28px !important;      /* –í—ã—Å–æ—Ç–∞ –∫–∞–∫ —É –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—è */
        font-size: 9px !important;    /* –®—Ä–∏—Ñ—Ç –ø–æ–º–µ–Ω—å—à–µ */
        padding: 0 8px !important;    /* –ö–æ–º–ø–∞–∫—Ç–Ω—ã–µ –æ—Ç—Å—Ç—É–ø—ã */
        line-height: 26px !important; /* –¶–µ–Ω—Ç—Ä–æ–≤–∫–∞ —Ç–µ–∫—Å—Ç–∞ */
    }
}
/* --- –≠–§–§–ï–ö–¢ –ü–ï–†–ï–•–û–î–ê (–®–¢–û–†–ö–ê) --- */
#transitionOverlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: #000; /* –ß–µ—Ä–Ω—ã–π —Ü–≤–µ—Ç */
    z-index: 100000;        /* –ü–æ–≤–µ—Ä—Ö –≤—Å–µ–≥–æ, –¥–∞–∂–µ –∑–∞–≥—Ä—É–∑–∫–∏ */
    opacity: 0;             /* –ü—Ä–æ–∑—Ä–∞—á–Ω—ã–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
    pointer-events: none;   /* –ü—Ä–æ–ø—É—Å–∫–∞–µ—Ç –∫–ª–∏–∫–∏ —Å–∫–≤–æ–∑—å —Å–µ–±—è */
    
    /* –ü–ª–∞–≤–Ω–æ—Å—Ç—å: 0.95 —Å–µ–∫—É–Ω–¥—ã */
    transition: opacity 0.91s ease-in-out;
}

#transitionOverlay.active {
    opacity: 1;             /* –ü–æ–ª–Ω–æ—Å—Ç—å—é —á–µ—Ä–Ω—ã–π */
    pointer-events: auto;   /* –ë–ª–æ–∫–∏—Ä—É–µ—Ç –∫–ª–∏–∫–∏ –≤–æ –≤—Ä–µ–º—è –ø–µ—Ä–µ—Ö–æ–¥–∞ */
}
    </style>
</head>
<body data-theme="dark">
<div id="transitionOverlay"></div>
    <div id="dropOverlay">–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª —Å—é–¥–∞</div>
    <div id="fsExitBtn" onclick="toggleFullscreen()">‚úñ</div>

    <div id="fsGridControls">
        <button class="reset-vis-btn" onclick="resetGridVisibility()" title="–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å—ë">üëÅ</button>
        <button id="fsZoomBtn" class="reset-vis-btn" onclick="toggleZoomPopupFS()" style="background:var(--glass-bg); border: 1px solid var(--glass-border);" title="–ú–∞—Å—à—Ç–∞–±">üîç</button>
        <div id="fsZoomPopup" class="zoom-popup-unified">
            <input type="range" class="horizontal-range" id="fsGridZoom" min="3" max="800" value="100" oninput="updateGridScale(this.value)">
        </div>
    </div>

    <div id="instructionModal" class="modal-overlay" onclick="closeInstruction(event)">
        <div class="modal">
            <div class="modal-header">
                <span>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –ü—Ä–∏—è—Ç–Ω–æ–π —Å–±–æ—Ä–∫–∏!</span>
                <button class="top-btn" onclick="document.getElementById('instructionModal').style.display='none'">‚úñ</button>
            </div>
            <div class="modal-body">
    <div class="algo-box" style="background: rgba(255, 215, 0, 0.15); border: 2px solid #ffd700; margin-bottom: 25px;">
        <span class="algo-title" style="color: #d4a000; font-size: 18px;">üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç:</span>
        
        <ul style="margin-top: 5px; padding-left: 20px;">
            <li>–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ (–∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –µ–≥–æ –≤ –æ–∫–Ω–æ).</li>
            <li>–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–º–µ—Ä —Å—Ö–µ–º—ã (S, M, L, XL –∏–ª–∏ —Å–≤–æ–π). –û—Ç–º–∞—Å—à—Ç–∞–±–∏—Ä—É–π—Ç–µ –ø–æ —à–∏—Ä–∏–Ω–µ –∏ –≤—ã—Å–æ—Ç–µ.</li>
            <li>–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∏–ª—å –æ–±—Ä–∞–±–æ—Ç–∫–∏.</li>
            <li>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤ —Ä–µ–∂–∏–º–µ <b>–°—Ö–µ–º—ã</b>. 
            <li>–í –ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–º —Ä–µ–∂–∏–º–µ –Ω–∞–∂–∏–º–∞–π—Ç–µ –Ω–∞ —Ü–∏—Ñ—Ä—ã —Ä—è–¥–æ–≤ –∏–ª–∏ —Å—Ç—Ä–æ–∫ –¥–ª—è –æ—Ç–º–µ—Ç–∫–∏ –∏ —Å–æ–±–∏—Ä–∞–π—Ç–µ.</li>
        </ul>
    </div>

    <p>–≠—Ç–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å—Ö–µ–º —Å–±–æ—Ä–∫–∏ –∫–∞—Ä—Ç–∏–Ω –∏–∑ –±–ª–æ–∫–æ–≤ –ø–æ –ª—é–±–æ–π —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏.</p>

    <div class="algo-box">
        <span class="algo-title">üí° –°–æ–≤–µ—Ç 1: –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ</span>
        –ß–µ–º –º–µ–Ω—å—à–µ –±–ª–æ–∫–æ–≤/–ø–∏–∫—Å–µ–ª–µ–π –ø–æ —à–∏—Ä–∏–Ω–µ, —Ç–µ–º –∫—Ä—É–ø–Ω–µ–µ –∫–∞–¥—Ä–∏—Ä—É–π—Ç–µ –æ–±—ä–µ–∫—Ç (–ª–∏—Ü–æ, –º–æ—Ä–¥–∞ –∂–∏–≤–æ—Ç–Ω–æ–≥–æ –∏ —Ç. –¥.) ‚Äî –ø—Ä–∏ 50—Ö50 –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ –¥–µ–ª–∞—Ç—å –ª–∏—Ü–æ –ø–æ –≤—Å–µ–π —à–∏—Ä–∏–Ω–µ.
    </div>

    <h3>1. –û—Å–Ω–æ–≤–Ω–æ–π —Ä–∞–±–æ—á–∏–π –ø—Ä–æ—Ü–µ—Å—Å</h3>
    <p>–ü—Ä–æ—Ü–µ—Å—Å —Å–æ–∑–¥–∞–Ω–∏—è —à–µ–¥–µ–≤—Ä–∞ —Å–æ—Å—Ç–æ–∏—Ç –∏–∑ 5 –ø—Ä–æ—Å—Ç—ã—Ö —à–∞–≥–æ–≤:</p>
    <ul>
        <li><b>–ó–∞–≥—Ä—É–∑–∫–∞:</b> –ù–∞–∂–º–∏—Ç–µ ¬´–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ¬ª –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ –æ–∫–Ω–æ –±—Ä–∞—É–∑–µ—Ä–∞.</li>
        <li><b>–ì–µ–æ–º–µ—Ç—Ä–∏—è:</b> –í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–º–µ—Ä (S, M, L, XL) –∏ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ –∫–∞–¥—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ (–∑—É–º –∏ —Å–¥–≤–∏–≥), —á—Ç–æ–±—ã –≤ —Ñ–æ–∫—É—Å–µ –æ—Å—Ç–∞–ª–æ—Å—å —Å–∞–º–æ–µ –≤–∞–∂–Ω–æ–µ.</li>
        <li><b>–°—Ç–∏–ª—å:</b> –í—ã–±–µ—Ä–∏—Ç–µ —Ü–≤–µ—Ç–æ–≤—É—é —Å—Ö–µ–º—É. –î–ª—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ –ø–æ—Ä—Ç—Ä–µ—Ç–æ–≤ –∏–¥–µ–∞–ª—å–Ω–æ –ø–æ–¥—Ö–æ–¥–∏—Ç ¬´–ß–µ—Ä–Ω–æ-–±–µ–ª—ã–π¬ª –∏–ª–∏ ¬´–õ–ï–ì–û¬ª.</li>
        <li><b>–¢–æ–Ω–∫–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞:</b> –ü–æ–¥–∫—Ä—É—Ç–∏—Ç–µ –∫–æ–Ω—Ç—Ä–∞—Å—Ç, —Ä–µ–∑–∫–æ—Å—Ç—å –∏ —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ.</li>
        <li><b>–°–±–æ—Ä–∫–∞:</b> –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤–æ –≤–∫–ª–∞–¥–∫—É ¬´–°—Ö–µ–º–∞¬ª –∏ –≤–∫–ª—é—á–∏—Ç–µ –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º –¥–ª—è —É–¥–æ–±–Ω–æ–π —Ä–∞–±–æ—Ç—ã.</li>
    </ul>

    <h3>2. –û–ø–∏—Å–∞–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –∏ –ø–∞–Ω–µ–ª–µ–π</h3>

    <h4>üìç –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å (–ù–∞—Å—Ç—Ä–æ–π–∫–∏)</h4>
    <ul>
        <li><b>–†–ê–ó–ú–ï–†:</b>
            <ul><li><b>–ü—Ä–µ—Å–µ—Ç—ã:</b> –û—Ç 50x50 (S) –¥–æ 150x150 (XL) –∫—É–±–∏–∫–æ–≤.</li></ul>
        </li>
        <li><b>–†–∞–º–∫–∞:</b> –ü–æ–∑–≤–æ–ª—è–µ—Ç –¥–æ–±–∞–≤–∏—Ç—å –æ–∫–∞–Ω—Ç–æ–≤–∫—É (–æ—Ç 1 –¥–æ 5 —Ä—è–¥–æ–≤) –ª—é–±–æ–≥–æ —Ü–≤–µ—Ç–∞ –∏–∑ –ø–∞–ª–∏—Ç—Ä—ã.</li>
        <li><b>–ö–ê–î–†–ò–†–û–í–ê–ù–ò–ï:</b> –ü–æ–∑–≤–æ–ª—è–µ—Ç –ø—Ä–∏–±–ª–∏–∑–∏—Ç—å –ª–∏—Ü–æ –∏–ª–∏ –æ–±—ä–µ–∫—Ç –∏ —Å–¥–≤–∏–Ω—É—Ç—å –µ–≥–æ –ø–æ –æ—Å—è–º X –∏ Y, –Ω–µ –æ–±—Ä–µ–∑–∞—è –∏—Å—Ö–æ–¥–Ω—ã–π —Ñ–∞–π–ª –≤—Ä—É—á–Ω—É—é.</li>
        <li><b>–°–¢–ò–õ–ò –ü–ê–õ–ò–¢–†–´:</b> (–°–º. —Ä–∞–∑–¥–µ–ª 3).</li>
    </ul>

    <div class="algo-box" style="border-color: #28a745; background: rgba(40, 167, 69, 0.1);">
        <span class="algo-title" style="color: #28a745;">üí° –°–æ–≤–µ—Ç 2</span>
        –ù–µ –∑–∞–±—ã–≤–∞–π—Ç–µ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –ø—Ä–æ–µ–∫—Ç!
    </div>

    <ul>
        <li><b>–ù–ê–°–¢–†–û–ô–ö–ò –§–û–¢–û:</b>
            <ul>
                <li><i>–ü–æ—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—è:</i> –£–ø—Ä–æ—â–∞–µ—Ç –ø–µ—Ä–µ—Ö–æ–¥—ã —Ü–≤–µ—Ç–æ–≤, –¥–µ–ª–∞—è –∫–∞—Ä—Ç–∏–Ω–∫—É –±–æ–ª–µ–µ ¬´–ø–ª–∞–∫–∞—Ç–Ω–æ–π¬ª.</li>
                <li><i>–°–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ:</i> –£–±–∏—Ä–∞–µ—Ç –ª–∏—à–Ω–∏–π ¬´—à—É–º¬ª –∏ –º–µ–ª–∫–∏–µ —Ç–æ—á–∫–∏ –Ω–∞ –∫–æ–∂–µ.</li>
                <li><i>–†–µ–∑–∫–æ—Å—Ç—å:</i> <b>–°–∞–º—ã–π –≤–∞–∂–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç.</b> –í—ã—Å–æ–∫–∞—è —Ä–µ–∑–∫–æ—Å—Ç—å –¥–µ–ª–∞–µ—Ç –≥—Ä–∞–Ω–∏—Ü—ã –∫—É–±–∏–∫–æ–≤ —á–µ—Ç–∫–∏–º–∏. –í—ã –º–æ–∂–µ—Ç–µ –º–µ–Ω—è—Ç—å —Å–∏–ª—É (%) –∏ —Ä–∞–¥–∏—É—Å.</li>
                <li><i>–Ø—Ä–∫–æ—Å—Ç—å/–ö–æ–Ω—Ç—Ä–∞—Å—Ç:</i> –ë–∞–∑–æ–≤–∞—è –∫–æ—Ä—Ä–µ–∫—Ü–∏—è –æ—Å–≤–µ—â–µ–Ω–∏—è.</li>
            </ul>
        </li>
        <li><b>–î–ï–¢–ê–õ–ò –°–ë–û–†–ö–ò:</b>
            <ul>
                <li>–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–¥—Å—á–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∫—É–±–∏–∫–æ–≤ –∫–∞–∂–¥–æ–≥–æ —Ü–≤–µ—Ç–∞.</li>
                <li><b>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –±—é–¥–∂–µ—Ç–∞:</b> –≤–≤–µ–¥–∏—Ç–µ —Ü–µ–Ω—É –∑–∞ 1 –∫—É–±–∏–∫.</li>
            </ul>
        </li>
    </ul>

    <div class="algo-box" style="border-color: #ffd700;">
        <span class="algo-title">üí° –°–æ–≤–µ—Ç 3</span>
        –ù–µ –±–æ–π—Ç–µ—Å—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å <b>‚úèÔ∏è –ö–∞—Ä–∞–Ω–¥–∞—à</b> ‚Äî –¥–æ–±–∞–≤–ª—è–π—Ç–µ –∏–ª–∏ —É–¥–∞–ª—è–π—Ç–µ –ª–∏—à–Ω–∏–µ –ø–∏–∫—Å–µ–ª–∏ –Ω—É–∂–Ω—ã–º —Ü–≤–µ—Ç–æ–º.
    </div>

    <h4> –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å (–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ)</h4>
    <ul>
        <li><b>‚Ü∂ –û—Ç–º–µ–Ω–∞:</b> –û—Ç–º–µ–Ω—è–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 –¥–µ–π—Å—Ç–≤–∏–π (–≤–∫–ª—é—á–∞—è —Ä–∏—Å–æ–≤–∞–Ω–∏–µ –∫–∞—Ä–∞–Ω–¥–∞—à–æ–º).</li>
        <li><b>‚úèÔ∏è –ö–∞—Ä–∞–Ω–¥–∞—à:</b> –ü–æ–∑–≤–æ–ª—è–µ—Ç –≤—Ä—É—á–Ω—É—é –ø–µ—Ä–µ–∫—Ä–∞—à–∏–≤–∞—Ç—å –ø–∏–∫—Å–µ–ª–∏ –ø—Ä—è–º–æ –Ω–∞ –ø—Ä–µ–≤—å—é.</li>
        <li><b>üîì –ë–õ–û–ö:</b> –û—Ç–∫–ª—é—á–∞–µ—Ç –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —Å–¥–≤–∏–≥ —Ñ–æ—Ç–æ –ø–∞–ª—å—Ü–∞–º–∏ (–ø–æ–ª–µ–∑–Ω–æ –Ω–∞ —Å–º–∞—Ä—Ç—Ñ–æ–Ω–∞—Ö).</li>
        <li><b>üîç –ó—É–º —Å—Ö–µ–º—ã:</b> –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º–∞—Å—à—Ç–∞–±–∞ —Å–µ—Ç–∫–∏ –≤ —Ä–µ–∂–∏–º–µ ¬´–°—Ö–µ–º–∞¬ª.</li>
        <li><b>‚õ∂ –ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º:</b> –£–±–∏—Ä–∞–µ—Ç –≤—Å—ë –ª–∏—à–Ω–µ–µ. –í —ç—Ç–æ–º —Ä–µ–∂–∏–º–µ –Ω–∞–∂–∞—Ç–∏–µ –Ω–∞ —Ü–∏—Ñ—Ä—É —Ä—è–¥–∞ –∏–ª–∏ –∫–æ–ª–æ–Ω–∫–∏ –∑–∞–∫—Ä–∞—à–∏–≤–∞–µ—Ç –∏—Ö —Ç–µ–Ω—å—é.</li>
    </ul>

    <div class="algo-box">
        <span class="algo-title">üí° –°–æ–≤–µ—Ç 4</span>
        –ï—Å–ª–∏ –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –∫–Ω–æ–ø–∫–∏ <b>¬´–û–ë–ù–û–í–ò–¢–¨¬ª</b> –≤—ã –ø—Ä–æ—Å–∫–æ—á–∏–ª–∏ –ª—É—á—à—É—é –≥–µ–Ω–µ—Ä–∞—Ü–∏—é, –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É <b>¬´‚Ü∂ –û—Ç–º–µ–Ω–∞¬ª</b> ‚Äî –æ–Ω–∞ —Ö—Ä–∞–Ω–∏—Ç –≤ –ø–∞–º—è—Ç–∏ 10 –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —à–∞–≥–æ–≤.
    </div>

    <h3>3. –ì–∏–¥ –ø–æ —Å—Ç–∏–ª—è–º –ø–∞–ª–∏—Ç—Ä—ã</h3>
    <ul>
        <li><b>–ß–µ—Ä–Ω–æ-–±–µ–ª—ã–π:</b> –ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–µ 5 –æ—Ç—Ç–µ–Ω–∫–æ–≤ —Å–µ—Ä–æ–≥–æ. –ò–¥–µ–∞–ª—å–Ω–æ –¥–ª—è —Å—Ç–∏–ª—å–Ω—ã—Ö –ø–æ—Ä—Ç—Ä–µ—Ç–æ–≤.</li>
        <li><b>–õ–ï–ì–û:</b> 5 —è—Ä–∫–∏—Ö –±–∞–∑–æ–≤—ã—Ö —Ü–≤–µ—Ç–æ–≤. –î–ª—è –∫–æ–Ω—Ç—Ä–∞—Å—Ç–Ω—ã—Ö –∏ –≤–µ—Å–µ–ª—ã—Ö –∫–∞—Ä—Ç–∏–Ω–æ–∫.</li>
        <li><b>–û—Ä–∏–≥–∏–Ω–∞–ª (Smart AI):</b> –ü—Ä–æ–≥—Ä–∞–º–º–∞ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ñ–æ—Ç–æ –∏ –≤—ã–±–∏—Ä–∞–µ—Ç —Å–∞–º—ã–µ —á–∞—Å—Ç—ã–µ —Ü–≤–µ—Ç–∞.</li>
        <li><b>–£–º–Ω—ã–π –ù–µ–æ–Ω:</b> –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —è—Ä–∫—É—é —Å–≤–µ—Ç—è—â—É—é—Å—è –ø–∞–ª–∏—Ç—Ä—É —Å –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–≤–µ—Ä–µ–Ω–Ω–æ–π —è—Ä–∫–æ—Å—Ç—å—é.</li>
        <li><b>–°–≤–æ–π AI (–†–µ–∫–æ–ª–æ—Ä):</b> <small>!!!–ê–ª—å—Ñ–∞ –≤–µ—Ä—Å–∏—è!!!</small> (–í—ã –∑–∞–¥–∞–µ—Ç–µ —Å–≤–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–ª–æ–∫–æ–≤, –∞ –ø—Ä–æ–≥—Ä–∞–º–º–∞ –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –≤–∞—Ä–∏–∞–Ω—Ç).</li>
        <li><b>–°–ª—É—á–∞–π–Ω—ã–π (–•–∞–æ—Å):</b> –ü–æ–ª–Ω—ã–π —Ä–∞–Ω–¥–æ–º —Ü–≤–µ—Ç–æ–≤. –ù–µ –±–æ–π—Ç–µ—Å—å –µ–≥–æ ‚Äî –∏ –≤ –•–∞–æ—Å–µ –ø—Ä–æ—Å–∫–∞–∫–∏–≤–∞—é—Ç —à–µ–¥–µ–≤—Ä—ã!</li>
        <li><b>–°–≤–æ–π (–ì—Ä–∞–¥–∏–µ–Ω—Ç):</b> –í—ã —Å–∞–º–∏ –∑–∞–¥–∞—ë—Ç–µ –ø–∞–ª–∏—Ç—Ä—É —Ü–≤–µ—Ç–∞ –∏ –∂–º—ë—Ç–µ ¬´–û–ë–ù–û–í–ò–¢–¨¬ª (–æ—Ç —Ç–µ–º–Ω–æ–≥–æ –∫ —Å–≤–µ—Ç–ª–æ–º—É).</li>
    </ul>

    <h3>4. –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã "–•–∏—Ä—É—Ä–≥–∏—á–µ—Å–∫–æ–π" –ø—Ä–∞–≤–∫–∏</h3>
    <ul>
        <li><b>–†—É—á–Ω–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:</b> –ï—Å–ª–∏ –æ—Å—Ç–∞–ª—Å—è "–æ–¥–∏–Ω–æ–∫–∏–π" –∫—É–±–∏–∫ ‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ —Ü–≤–µ—Ç –∏ –∫–ª–∏–∫–Ω–∏—Ç–µ –ø–æ –Ω–µ–º—É –ö–∞—Ä–∞–Ω–¥–∞—à–æ–º.</li>
        <li><b>–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞–ª–∏—Ç—Ä—ã (‚Üª):</b> –í —Å—Ç–∏–ª—è—Ö AI –∫–Ω–æ–ø–∫–∞ ¬´–û–±–Ω–æ–≤–∏—Ç—å¬ª –ø–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç—Ç–µ–Ω–∫–∏, –Ω–µ –º–µ–Ω—è—è —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ñ–æ—Ç–æ.</li>
    </ul>

    <h3>5. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏ –ü–µ—á–∞—Ç—å</h3>
    <ul>
        <li><b>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ–µ–∫—Ç:</b> –°–∫–∞—á–∏–≤–∞–µ—Ç .json —Ñ–∞–π–ª —Å–æ –≤—Å–µ–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º.</li>
        <li><b>–ó–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ–µ–∫—Ç:</b> –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Ä–∞–±–æ—Ç—É —Å —Ç–æ–≥–æ –∂–µ –º–µ—Å—Ç–∞.</li>
        <li><b>–ü–µ—á–∞—Ç—å (üñ®):</b> –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç PDF —Å –æ–±—â–∏–º –≤–∏–¥–æ–º, —Å–ø–∏—Å–∫–æ–º —Ü–≤–µ—Ç–æ–≤ –∏ —Å–µ–∫—Ç–æ—Ä–∞–º–∏ —Å—Ö–µ–º—ã.</li>
    </ul>

    <div class="algo-box" style="border-color: #ff5555; background: rgba(255, 85, 85, 0.1);">
        <span class="algo-title" style="color: #ff5555;">üí° –°–æ–≤–µ—Ç 5</span>
        –ü–µ—Ä–µ–¥ –ø–µ—á–∞—Ç—å—é –∏–ª–∏ —Å–±–æ—Ä–∫–æ–π –≤—Å–µ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ ¬´–†–µ–∑–∫–æ—Å—Ç—å¬ª (–æ–ø—Ç–∏–º–∞–ª—å–Ω–æ 150-200%), —á—Ç–æ–±—ã –¥–µ—Ç–∞–ª–∏ –Ω–µ –ø—Ä–µ–≤—Ä–∞—Ç–∏–ª–∏—Å—å –≤ ¬´–∫–∞—à—É¬ª.
    </div>
</div>
        </div>
    </div>

    <div class="app-container">
        <aside class="sidebar">
            <button class="btn btn-sec" onclick="showInstruction()" style="margin-bottom:0px; font-weight:bold; border-color:var(--primary); color:var(--primary); border-width:1px; background: rgba(255, 215, 0, 0.05);">üìñ –ò–ù–°–¢–†–£–ö–¶–ò–Ø</button>
            
            <label class="btn btn-primary" for="upload">–ó–ê–ì–†–£–ó–ò–¢–¨ –§–û–¢–û</label>
            <input type="file" id="upload" accept="image/*" hidden>

            <div style="display:flex; gap:5px">
                <button class="btn btn-sec" onclick="saveProject()">–°–û–•–†–ê–ù–ò–¢–¨</button>
                <label class="btn btn-sec" for="loadProject" style="text-align:center; display:block; padding-top:12px;">–ó–ê–ì–†–£–ó–ò–¢–¨</label>
                <input type="file" id="loadProject" accept=".json" hidden>
            </div>

            <div class="card">
                <button class="btn-toggle-panel" id="sizeToggleBtn" onclick="togglePanel('sizePanel', 'sizeToggleBtn')">
                    –†–ê–ó–ú–ï–† <span class="settings-arrow">‚ñº</span>
                </button>
                <div id="sizePanel" class="panel-content">
    <div style="display:flex; gap:5px; margin-bottom:5px;">
        <select class="modern-select" id="setSize" style="margin:0;">
            <option value="50" selected>S (50x50)</option>
            <option value="75">M (75x75)</option>
            <option value="100">L (100x100)</option>
            <option value="150">XL (150x150)</option>
            <option value="custom">–°–≤–æ–π —Ä–∞–∑–º–µ—Ä...</option>
        </select>
        <button id="borderBtn" class="btn btn-sec" style="width:auto; padding:0 8px; white-space: nowrap;" onclick="toggleBorderControl()">–†–ê–ú–ö–ê</button>
    </div>
    
    <div id="borderControl">
        <div class="slider-header-compact"><span class="slider-label">–¢–æ–ª—â–∏–Ω–∞ —Ä–∞–º–∫–∏: <span class="val-display" id="borderWidthVal">0</span></span></div>
        <input type="range" id="borderWidth" min="0" max="5" value="0" oninput="updateBorderSettings()">
        <select class="modern-select" id="borderColor" style="margin-top:5px; padding:6px;" onchange="updateBorderSettings()"></select>
    </div>
    
    <div id="customSizeGroup" class="custom-size-inputs" style="display:none; margin-top: 5px;">
        <input type="number" id="customWidth" class="modern-input" placeholder="W" min="10" value="50">
        <input type="number" id="customHeight" class="modern-input" placeholder="H" min="10" value="50">
    </div>
</div>
            </div>

            <div class="card">
                <button class="btn-toggle-panel" id="cropToggleBtn" onclick="togglePanel('cropPanel', 'cropToggleBtn')">
                    –ö–ê–î–†–ò–†–û–í–ê–ù–ò–ï <span class="settings-arrow">‚ñº</span>
                </button>
                <div id="cropPanel" class="panel-content">
                    <div class="slider-group" id="group-zoom">
                        <div class="slider-header-compact">–ú–∞—Å—à—Ç–∞–± <span class="val-display" id="zoomVal">100%</span></div>
                        <div class="slider-row"><span class="icon-btn-side reset-btn" onclick="resetSlider('zoom', 100)">‚Ü∫</span><input type="range" id="zoom" min="1" max="300" value="100"><span class="icon-btn-side lock-toggle" onclick="toggleLock('group-zoom', 'zoom')">üîì</span></div>
                    </div>
                    <div class="slider-group" id="group-panX">
                        <div class="slider-header-compact">–°–¥–≤–∏–≥ X <span class="val-display" id="panXVal">0%</span></div>
                        <div class="slider-row"><span class="icon-btn-side reset-btn" onclick="resetSlider('panX', 0)">‚Ü∫</span><input type="range" id="panX" min="-100" max="100" value="0"><span class="icon-btn-side lock-toggle" onclick="toggleLock('group-panX', 'panX')">üîì</span></div>
                    </div>
                    <div class="slider-group" id="group-panY">
                        <div class="slider-header-compact">–°–¥–≤–∏–≥ Y <span class="val-display" id="panYVal">0%</span></div>
                        <div class="slider-row"><span class="icon-btn-side reset-btn" onclick="resetSlider('panY', 0)">‚Ü∫</span><input type="range" id="panY" min="-100" max="100" value="0"><span class="icon-btn-side lock-toggle" onclick="toggleLock('group-panY', 'panY')">üîì</span></div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">–°—Ç–∏–ª–∏ –ø–∞–ª–∏—Ç—Ä—ã</div>
                <select class="modern-select" id="palettePreset">
                    <option value="bw" selected>–ß–µ—Ä–Ω–æ-–±–µ–ª—ã–π</option>
                    <option value="original">–û—Ä–∏–≥–∏–Ω–∞–ª (Smart AI)</option>
                    <option value="custom">–°–≤–æ–π (–ì—Ä–∞–¥–∏–µ–Ω—Ç)</option>
                    <option value="popart">–õ–ï–ì–û</option>
                    <option value="smart_neon">–£–º–Ω—ã–π –ù–µ–æ–Ω</option>
                    <option value="random_chaos">–°–ª—É—á–∞–π–Ω—ã–π (–•–∞–æ—Å)</option>
                    <option value="pixelart">Pixel Art</option>
                    <option value="custom_ai">–°–≤–æ–π AI (–†–µ–∫–æ–ª–æ—Ä)</option>
    </select>
                </select>

                <div class="slider-group" id="colorCountGroup" style="display:none; margin-bottom:10px;">
                    <div class="slider-header-compact">
                        <span class="slider-label">–ö–æ–ª-–≤–æ —Ü–≤–µ—Ç–æ–≤: <span class="val-display" id="colorCountVal" style="margin-left:5px;">5</span></span>
                    </div>
                    <div class="slider-row">
                        <input type="range" id="colorCount" min="3" max="12" value="12">
                        <span class="icon-btn-side lock-toggle" onclick="toggleLock('colorCountGroup', 'colorCount')">üîì</span>
                    </div>
                </div>

                <div class="palette-row">
                    <div class="palette-grid" id="paletteContainer"></div>
                </div>
                
                <div class="palette-actions">
                    <button id="refreshPaletteBtn" class="btn-action btn-refresh" onclick="refreshSmartPalette()">‚Üª –û–±–Ω–æ–≤–∏—Ç—å</button>
                    <button class="btn-action btn-danger-small" onclick="resetStylesOnly()">‚Ü∫ –°–±—Ä–æ—Å</button>
                </div>
            </div>

            <div class="card">
                <button class="btn-toggle-panel" id="settingsToggleBtn" onclick="togglePanel('settingsPanel', 'settingsToggleBtn')">
                    –ù–ê–°–¢–†–û–ô–ö–ò –§–û–¢–û <span class="settings-arrow">‚ñº</span>
                </button>
                
                <div id="settingsPanel" class="panel-content">
                    
                    <div class="slider-group" id="group-posterize">
                        <div class="slider-header-compact">–ü–æ—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—è <span class="val-display" id="posterizeVal">0</span></div>
                        <div class="slider-row">
                            <span class="icon-btn-side reset-btn" onclick="resetSlider('posterize', 0)">‚Ü∫</span>
                            <input type="range" id="posterize" min="0" max="10" step="1" value="0">
                            <span class="icon-btn-side lock-toggle" onclick="toggleLock('group-posterize', 'posterize')">üîì</span>
                        </div>
                    </div>

                    <div class="slider-group" id="group-smartBlur">
                        <div class="slider-header-compact">–°–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ <span class="val-display" id="smartBlurVal">0</span></div>
                        <div class="slider-row">
                            <span class="icon-btn-side reset-btn" onclick="resetSlider('smartBlur', 0)">‚Ü∫</span>
                            <input type="range" id="smartBlur" min="0" max="60" value="0">
                            <span class="icon-btn-side lock-toggle" onclick="toggleLock('group-smartBlur', 'smartBlur')">üîì</span>
                        </div>
                    </div>

                    <div class="slider-group" id="group-sharpness">
                        <div class="slider-header-compact">
                            <span>–†–µ–∑–∫–æ—Å—Ç—å <span class="val-display" id="sharpnessVal">164%</span></span>
                            <div style="display:flex; align-items:center; gap:2px;">
                                <span style="font-size:9px; color:#aaa;">Radius:</span>
                                <div class="num-ctrl-btn" onclick="changeRadius(-1)">-</div>
                                <input type="number" id="usmRadius" class="num-input-small" value="23" min="0" max="50" onchange="processImage()">
                                <div class="num-ctrl-btn" onclick="changeRadius(1)">+</div>
                            </div>
                        </div>
                        <div class="slider-row">
                            <span class="icon-btn-side reset-btn" onclick="resetSlider('sharpness', 164)">‚Ü∫</span>
                            <input type="range" id="sharpness" min="0" max="500" value="164">
                            <span class="icon-btn-side lock-toggle" onclick="toggleLock('group-sharpness', 'sharpness')">üîì</span>
                        </div>
                    </div>

                    <div class="slider-group" id="group-contrast">
                        <div class="slider-header-compact">–ö–æ–Ω—Ç—Ä–∞—Å—Ç <span class="val-display" id="contrastVal">100%</span></div>
                        <div class="slider-row"><span class="icon-btn-side reset-btn" onclick="resetSlider('contrast', 100)">‚Ü∫</span><input type="range" id="contrast" min="0" max="250" value="100"><span class="icon-btn-side lock-toggle" onclick="toggleLock('group-contrast', 'contrast')">üîì</span></div>
                    </div>

                    <div class="slider-group" id="group-brightness">
                        <div class="slider-header-compact">–Ø—Ä–∫–æ—Å—Ç—å <span class="val-display" id="brightnessVal">100%</span></div>
                        <div class="slider-row"><span class="icon-btn-side reset-btn" onclick="resetSlider('brightness', 100)">‚Ü∫</span><input type="range" id="brightness" min="0" max="200" value="100"><span class="icon-btn-side lock-toggle" onclick="toggleLock('group-brightness', 'brightness')">üîì</span></div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">–î–µ—Ç–∞–ª–∏ —Å–±–æ—Ä–∫–∏</div>
                <select class="modern-select" id="symbolSet">
                    <option value="letters">–ë—É–∫–≤—ã (B, X, G...)</option>
                    <option value="numbers">–¶–∏—Ñ—Ä—ã (1, 2, 3...)</option>
                    <option value="shapes">–§–∏–≥—É—Ä—ã (‚ñ†, ‚ñ≤, ‚óè...)</option>
                    <option value="roman">–†–∏–º—Å–∫–∏–µ (I, II, III...)</option>
                </select>
                <div id="statsContent"></div>
                <div style="margin-top:5px;"><input type="number" id="brickPrice" class="modern-input" placeholder="–¶–µ–Ω–∞ –∑–∞ —à—Ç." oninput="updateStats()"></div>
                <div style="margin-top:8px; border-top:1px solid rgba(255,255,255,0.2); padding-top:5px; font-weight:bold; display:flex; justify-content:space-between; font-size:12px;"><span>–ò–¢–û–ì–û –®–¢:</span><span id="totalBricks">0</span></div>
                <div style="display:flex; justify-content:space-between; font-size:12px; margin-top:4px;"><span>–ë–Æ–î–ñ–ï–¢:</span><span id="totalCost">0 ‚ÇΩ</span></div>
            </div>
            
            <div id="versionLabel" onclick="cycleLayoutMode()" style="text-align:center; font-size:10px; color:var(--text-sec); margin-top:20px; opacity:0.6; cursor:pointer; user-select:none;" title="–ù–∞–∂–º–∏ –¥–ª—è —Å–º–µ–Ω—ã —Ä–µ–∂–∏–º–∞ (Auto/Mobile/PC)">
    PhotoBrick v2.3.5
</div>
        </aside>

        <main class="stage">
            <div class="header-bar">
                <div class="header-left">
                    <button class="icon-small" onclick="undo()" title="Undo">‚Ü∂</button>
                    <div class="mode-toggle">
                        <div class="toggle-opt active" id="tab-preview" onclick="switchTab('preview')">–í–∏–¥</div>
                        <div class="toggle-opt" id="tab-instruction" onclick="switchTab('instruction')">–°—Ö–µ–º–∞</div>
                    </div>
                    <button class="icon-small" id="pencilBtn" onclick="togglePencil()" title="–ö–∞—Ä–∞–Ω–¥–∞—à">‚úèÔ∏è</button>
                    <button id="gestureLockBtn" class="lock-btn" onclick="toggleGestureLock()">üîì –ë–õ–û–ö</button>
                    <div id="gridZoomControl" style="position:relative; display:none;">
                        <button class="zoom-display-btn" id="zoomDisplayBtn" onclick="toggleZoomPopup()"><span>üîç</span> <span id="zoomText">100%</span></button>
                        <div id="zoomPopup" class="zoom-popup-unified">
                             <input type="range" class="horizontal-range" id="gridZoom" min="3" max="800" value="100" oninput="updateGridScale(this.value)">
                        </div>
                    </div>
                </div>
                <div class="header-right">
                    <button class="top-btn" onclick="toggleFullscreen()">‚õ∂</button>
                    <button class="top-btn" onclick="toggleTheme()">‚òÄ</button>
                    <button class="top-btn" onclick="preparePrint()">üñ®</button>
                </div>
            </div>

            <div class="viewport" id="previewContainer">
                <div class="preview-row">
                    <div class="preview-box" id="resultBox" style="display:none">
                        <div class="image-wrapper">
                            <div class="preview-label" id="resultLabel">–†–ï–ó–£–õ–¨–¢–ê–¢</div>
                            <canvas id="mainCanvas" class="preview-content"></canvas>
                        </div>
                    </div>
                    
                    <div class="preview-box" id="origBox" style="display:none; flex-direction: column; align-items: center; gap: 8px;">
    <div class="image-wrapper">
        <div class="preview-label">–û–†–ò–ì–ò–ù–ê–õ</div>
        <img id="originalImageThumb" class="preview-content">
    </div>
    <button class="btn btn-sec" onclick="resetResultView()" style="pointer-events: auto; padding: 4px 10px; font-size: 10px; height: auto; width: 100%; border: 1px solid var(--glass-border); background: rgba(0,0,0,0.3); color: #fff;">
        –í –¶–ï–ù–¢–†
    </button>
</div>
                </div>
            </div>
            
            <div id="sectorNav" class="floating-nav">
                <div class="nav-grid">
                    <button class="nav-btn nav-1" onclick="setSector(1)">‚ñõ</button><div></div><button class="nav-btn nav-2" onclick="setSector(2)">‚ñú</button>
                    <div></div><button class="nav-btn nav-all active" id="sec-all" onclick="setSector('all')">–í–ï–°–¨</button><div></div>
                    <button class="nav-btn nav-3" onclick="setSector(3)">‚ñô</button><div></div><button class="nav-btn nav-4" onclick="setSector(4)">‚ñü</button>
                </div>
            </div>

            <div id="instructionView">
                <div id="gridContainer"></div>
            </div>
        </main>
    </div>

    <canvas id="procCanvas" style="display:none"></canvas>
<div id="helperSelectModal" class="modal-overlay" onclick="closeHelperModal(event)">
        <div class="modal" style="max-width: 300px;">
            <div class="modal-header">
                <span>–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ç—Ç–µ–Ω–æ–∫</span>
                <button class="top-btn" onclick="document.getElementById('helperSelectModal').style.display='none'">‚úñ</button>
            </div>
            <div class="modal-body" style="text-align: center;">
                <p style="font-size: 12px; color: var(--text-sec); margin-top: 0;">–ù–∞–∂–º–∏—Ç–µ –Ω–∞ —Ü–≤–µ—Ç, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –µ–≥–æ –∫–∞–∫ –ø–æ–º–æ—â–Ω–∏–∫–∞ –¥–ª—è —Å–º–µ—à–∏–≤–∞–Ω–∏—è.</p>
                <div id="helperPaletteGrid" style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; padding: 10px;">
                    </div>
            </div>
        </div>
    </div>
    <script>
        const SYMBOL_SETS = { 
    letters: ["B", "X", "G", "H", "W", "A", "C", "D", "E", "F", "K", "L"], 
    numbers: ["1", "2", "3", "4", "5", "6", "7", "8", "9", "10", "11", "12"], 
    shapes: ["‚ñ†", "‚ñ≤", "‚óè", "‚óÜ", "‚òÖ", "‚úö", "‚ñº", "‚¨ü", "‚¨¢", "‚¨•", "‚¨¶", "‚¨ß"], 
    roman: ["I", "II", "III", "IV", "V", "VI", "VII", "VIII", "IX", "X", "XI", "XII"] 
};
        let currentSymbolSet = SYMBOL_SETS.letters;
        const PRESETS = { 'bw': ["#141414", "#484848", "#7e7e7e", "#b4b4b4", "#ffffff"] };
        const LEGO_PALETTE = ["#111111", "#004d99", "#b80000", "#fdb927", "#ffffff"];

        let stockQuantities = [150, 150, 150, 150, 150, 150, 150, 150, 150, 150, 150, 150]; // –•—Ä–∞–Ω–∏—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–ª–æ–∫–æ–≤ (–º–∞–∫—Å 12 —Ü–≤–µ—Ç–æ–≤)
        let stockAssists = {}; // –•—Ä–∞–Ω–∏–ª–∏—â–µ –ø–æ–º–æ—â–Ω–∏–∫–æ–≤: { primaryIndex: [ {hex, qty, id}, ... ] }
        let displayPalette = []; // –ü–∞–ª–∏—Ç—Ä–∞ –¥–ª—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ (–û—Å–Ω–æ–≤–Ω–∞—è + –ü–æ–º–æ—â–Ω–∏–∫–∏)
        let displaySymbols = []; // –°–∏–º–≤–æ–ª—ã –¥–ª—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏
        let isStockMode = false; // –§–ª–∞–≥, –≤–∫–ª—é—á–µ–Ω –ª–∏ —Ä–µ–∂–∏–º "–°–≤–æ–π AI"
        let useMixMode = false;
        let activeHelperIdx = -1;
        let currentPalette = []; 
// --- –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï (–í–°–¢–ê–í–ò–¢–¨ –í –ù–ê–ß–ê–õ–û –°–ö–†–ò–ü–¢–ê) ---
        let gridBaseWidth = 0;
        let gridBaseHeight = 0;
        let isTicking = false;
        let zoomDebounceTimer = null;
        let aiBasePalette = []; 
        let sourceImage = null;
        let generatedMatrix = []; 
        let finalMatrix = []; 
        let currentSector = 'all';
        let gesturesLocked = false;
        let viewX = 0, viewY = 0;   // –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Å–¥–≤–∏–≥–∞ –æ–∫–Ω–∞ –†–ï–ó–£–õ–¨–¢–ê–¢
        let previewZoom = 100;      // –ú–∞—Å—à—Ç–∞–± –æ–∫–Ω–∞ –†–ï–ó–£–õ–¨–¢–ê–¢
        let schemeZoom = 100;       // –ú–∞—Å—à—Ç–∞–± –æ–∫–Ω–∞ –°–•–ï–ú–ê
        let historyStack = [];
        let isPencil = false;
        let selectedBrushIndex = 0;
        
        let hiddenRegions = new Set(); // –•—Ä–∞–Ω–∏—Ç —Å—Ç—Ä–æ–∫–∏ –≤–∏–¥–∞ "row_Y_startX_endX" –∏–ª–∏ "col_X_startY_endY"
        let currentGridBounds = { sX: 0, eX: 0, sY: 0, eY: 0 }; // –¢–µ–∫—É—â–∏–µ –≥—Ä–∞–Ω–∏—Ü—ã –ø—Ä–æ—Å–º–æ—Ç—Ä–∞

        window.addEventListener('popstate', (event) => { if(sourceImage){ if(!confirm("–ü—Ä–æ–µ–∫—Ç –±—É–¥–µ—Ç –∑–∞–∫—Ä—ã—Ç. –í—ã —É–≤–µ—Ä–µ–Ω—ã?")){ history.pushState({page: 1}, document.title, location.href); } } });
        window.addEventListener('beforeunload', (event) => { if (sourceImage) { event.preventDefault(); event.returnValue = '–ü—Ä–æ–µ–∫—Ç –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω!'; return '–ü—Ä–æ–µ–∫—Ç –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω!'; } });
        
        function activateHistoryTrap() { history.pushState({page: 1}, document.title, location.href); }

        window.onload = () => { 
    document.getElementById('palettePreset').value = 'bw';
    currentPalette = [...PRESETS['bw']]; 
    aiBasePalette = [...PRESETS['bw']];

    renderPaletteUI(); setupEvents(); setupTouchGestures(); setupGridGestures(); setupMouseGestures(); setupDragDrop(); 
    
    // --- –î–û–ë–ê–í–õ–ï–ù–ù–ê–Ø –°–¢–†–û–ö–ê: ---
    setupGridMouseNavigation(); 
    // ---------------------------

    document.getElementById('colorCountGroup').style.display = 'none'; 
    document.getElementById('refreshPaletteBtn').style.display = 'flex';
updateBrowserColor();
};

        function showInstruction() { document.getElementById('instructionModal').style.display = 'flex'; }
        function closeInstruction(e) { if(e.target.id === 'instructionModal') document.getElementById('instructionModal').style.display = 'none'; }
        function pushHistory() { if(historyStack.length > 9) historyStack.shift(); historyStack.push(JSON.stringify({ mat: generatedMatrix, pal: [...currentPalette], ai: [...aiBasePalette] })); }
        function undo() { if(!historyStack.length) return; const state = JSON.parse(historyStack.pop()); generatedMatrix = state.mat; currentPalette = state.pal; aiBasePalette = state.ai; finalizeMatrixWithBorder(); renderPaletteUI(); }
        function setupDragDrop() { const body = document.body; const overlay = document.getElementById('dropOverlay'); body.addEventListener('dragover', (e) => { e.preventDefault(); overlay.style.display = 'flex'; }); body.addEventListener('dragleave', (e) => { if(e.target === overlay) overlay.style.display = 'none'; }); body.addEventListener('drop', (e) => { e.preventDefault(); overlay.style.display = 'none'; if (e.dataTransfer.files && e.dataTransfer.files[0]) { const file = e.dataTransfer.files[0]; if (file.type.match('image.*')) { const reader = new FileReader(); reader.onload = (ev) => { sourceImage = new Image(); sourceImage.onload = () => { activateHistoryTrap(); document.getElementById('origBox').style.display = 'flex'; document.getElementById('resultBox').style.display = 'flex'; document.getElementById('originalImageThumb').src = sourceImage.src; 
                    resetStylesOnly(); 
                }; sourceImage.src = ev.target.result; }; reader.readAsDataURL(file); } else if (file.name.endsWith('.json')) { const reader = new FileReader(); reader.onload = (ev) => processLoadedProject(ev.target.result); reader.readAsText(file); } } }); }

        function togglePanel(panelId, btnId) {
            const panel = document.getElementById(panelId);
            const btn = document.getElementById(btnId);
            const arrow = btn.querySelector('.settings-arrow');
            
            // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –∫–ª–∞—Å—Å –∞–Ω–∏–º–∞—Ü–∏–∏
            panel.classList.toggle('show');
            
            // –£–ø—Ä–∞–≤–ª—è–µ–º —Å—Ç–∏–ª–µ–º –∫–Ω–æ–ø–∫–∏ –∏ —Å—Ç—Ä–µ–ª–æ—á–∫–∏
            if(panel.classList.contains('show')) { 
                btn.classList.add('expanded'); 
                arrow.classList.add('rotated'); 
            } else { 
                btn.classList.remove('expanded'); 
                arrow.classList.remove('rotated'); 
            }
        }

        function changeRadius(delta) {
            const input = document.getElementById('usmRadius');
            let val = parseInt(input.value) || 23;
            val = Math.max(0, Math.min(50, val + delta));
            input.value = val;
            processImage();
        }

        function setupEvents() {
            document.getElementById('upload').onchange = handleUpload; document.getElementById('loadProject').onchange = loadProject;
document.getElementById('symbolSet').onchange = (e) => { 
                // 1. –ó–∞–ø–æ–º–∏–Ω–∞–µ–º –Ω–æ–≤—ã–π –≤—ã–±–æ—Ä (–ë—É–∫–≤—ã, –¶–∏—Ñ—Ä—ã –∏ —Ç.–¥.)
                currentSymbolSet = SYMBOL_SETS[e.target.value]; 

                // 2. –°–†–ê–ó–£ –æ–±–Ω–æ–≤–ª—è–µ–º –º–∞—Å—Å–∏–≤ —Å–∏–º–≤–æ–ª–æ–≤ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
                // (–ë–µ–∑ —ç—Ç–æ–≥–æ —à–∞–≥–∞ —Å–µ—Ç–∫–∞ —Ä–∏—Å–æ–≤–∞–ª–∞ —Å—Ç–∞—Ä—ã–µ —Å–∏–º–≤–æ–ª—ã)
                displaySymbols = [...currentSymbolSet];

                if (isStockMode) {
                    // –ï—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω —Ä–µ–∂–∏–º –°–∫–ª–∞–¥–∞ (–°–≤–æ–π AI), –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Ä–∞—Å—á–µ—Ç,
                    // —á—Ç–æ–±—ã –æ–±–Ω–æ–≤–∏–ª–∏—Å—å —Å–ª–æ–∂–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã (—Ç–∏–ø–∞ A1, A2 –∏–ª–∏ 1-1, 1-2)
                    processStockImage();
                } else {
                    // –í –æ–±—ã—á–Ω–æ–º —Ä–µ–∂–∏–º–µ –ø—Ä–æ—Å—Ç–æ –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏ –ø–∞–ª–∏—Ç—Ä—É
                    updateStats(); 
                    renderPaletteUI(); 
                    
                    // 3. –ï—Å–ª–∏ –º—ã –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å —Å–º–æ—Ç—Ä–∏–º –Ω–∞ —Å—Ö–µ–º—É - –ü–ï–†–ï–†–ò–°–û–í–´–í–ê–ï–ú –ï–Å
                    if(document.getElementById('instructionView').style.display === 'block') {
                        drawGrid();
                    }
                }
            };
            ['zoom', 'contrast', 'brightness', 'panX', 'panY', 'smartBlur', 'sharpness', 'posterize'].forEach(id => { document.getElementById(id).oninput = (e) => { let suffix = '%'; if(id === 'smartBlur' || id === 'posterize') suffix = ''; document.getElementById(id+'Val').innerText = e.target.value + suffix; if(sourceImage) processImage(); }; });
            document.getElementById('palettePreset').onchange = (e) => { 
    pushHistory(); 
    const val = e.target.value; 
    
    // –î–û–ë–ê–í–ò–õ 'pixelart' –°–Æ–î–ê, —á—Ç–æ–±—ã –ø–æ—è–≤–ª—è–ª—Å—è –ø–æ–ª–∑—É–Ω–æ–∫ –∫–æ–ª-–≤–∞ —Ü–≤–µ—Ç–æ–≤
    const showCount = ['original', 'random_chaos', 'custom', 'custom_ai', 'smart_neon', 'pixelart'].includes(val); 
    document.getElementById('colorCountGroup').style.display = showCount ? 'block' : 'none'; 
    
    const showRefresh = ['smart_neon', 'original', 'random_chaos', 'custom_ai', 'bw', 'popart', 'custom', 'pixelart'].includes(val); 
    document.getElementById('refreshPaletteBtn').style.display = showRefresh ? 'flex' : 'none'; 
    
    applyPaletteLogic(val); 
};
            document.getElementById('colorCount').oninput = (e) => { document.getElementById('colorCountVal').innerText = e.target.value; };
            document.getElementById('colorCount').onchange = () => { 
                pushHistory(); 
                const val = document.getElementById('palettePreset').value; 
                if(val === 'original') { extractPaletteQuantized(); } 
                else if (val === 'random_chaos') { generateChaosPalette(); } 
                else if (val === 'custom') { updateCustomColorCount(parseInt(document.getElementById('colorCount').value)); } 
                else if (val === 'custom_ai') { extractPaletteQuantized(); aiBasePalette=[...currentPalette]; } 
                else if (val === 'smart_neon') { 
                    updateCustomColorCount(parseInt(document.getElementById('colorCount').value));
                    extractPaletteQuantized(); 
                    aiBasePalette=[...currentPalette]; 
                    generateSmartPalette(true); 
                } 
                else if (val === 'popart') { refreshSmartPalette(); } 
else if (val === 'pixelart') { 
        extractPaletteQuantized(); // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Ü–≤–µ—Ç–∞ –ø–æ –Ω–æ–≤–æ–º—É —á–∏—Å–ª—É
        aiBasePalette = [];        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∫—ç—à
    }
                renderPaletteUI(); processImage(); 
            };
            const setSizeSelect = document.getElementById('setSize'); setSizeSelect.onchange = () => { document.getElementById('customSizeGroup').style.display = (setSizeSelect.value === 'custom') ? 'flex' : 'none'; if(sourceImage) processImage(); }; document.getElementById('customWidth').oninput = () => { if(sourceImage) processImage(); }; document.getElementById('customHeight').oninput = () => { if(sourceImage) processImage(); };
            const gridZoom = document.getElementById('gridZoom'); gridZoom.oninput = (e) => { updateGridScale(e.target.value); };
            document.addEventListener('click', (e) => { if(!document.body.classList.contains('fullscreen-mode')) return; if(window.innerWidth >= 1024) return; if(e.target.closest('#fsGridControls')) return; if(e.target.closest('#fsExitBtn')) return; });
        }
function resetResultView() {
    // 1. –†–∞–±–æ—Ç–∞–µ–º —Ç–æ–ª—å–∫–æ —Å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –ü–†–ï–í–¨–Æ
    const startX = viewX;
    const startY = viewY;
    const startZoom = previewZoom; // –ë–µ—Ä–µ–º –∏–º–µ–Ω–Ω–æ previewZoom
    
    const targetX = 0;
    const targetY = 0;
    const targetZoom = 100;
    
    if (startX === targetX && startY === targetY && startZoom === targetZoom) return;

    const duration = 400; 
    const startTime = performance.now();
    
    const wrapper = document.querySelector('#resultBox .image-wrapper');
    if(wrapper) wrapper.style.transition = 'none';

    function animate(currentTime) {
        const timeElapsed = currentTime - startTime;
        let progress = timeElapsed / duration;
        if (progress > 1) progress = 1;

        const ease = 1 - Math.pow(1 - progress, 3);

        // –û–±–Ω–æ–≤–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
        viewX = startX + (targetX - startX) * ease;
        viewY = startY + (targetY - startY) * ease;
        
        // –í—ã—á–∏—Å–ª—è–µ–º —Ç–µ–∫—É—â–∏–π –∑—É–º –∞–Ω–∏–º–∞—Ü–∏–∏
        const currentAnimZoom = startZoom + (targetZoom - startZoom) * ease;
        
        // –í–ê–ñ–ù–û: –û–±–Ω–æ–≤–ª—è–µ–º previewZoom, —á—Ç–æ–±—ã updateGridScale –µ–≥–æ –ø–æ–¥—Ö–≤–∞—Ç–∏–ª
        previewZoom = currentAnimZoom;

        // –í—ã–∑—ã–≤–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ (–æ–Ω–æ —Å–∞–º–æ –ø–æ–π–º–µ—Ç, —á—Ç–æ –º—ã –≤ tab-preview)
        updateGridScale(currentAnimZoom);

        if (progress < 1) {
            requestAnimationFrame(animate);
        } else {
            viewX = 0; 
            viewY = 0;
            previewZoom = 100; // –§–∏–∫—Å–∏—Ä—É–µ–º 100%
            updateGridScale(100);
            if(wrapper) wrapper.style.transition = 'transform 0.1s ease-out';
        }
    }
    requestAnimationFrame(animate);
}
function updateGridScale(val) {
            const grid = document.querySelector('#gridContainer .instruction-grid');
            
            // 1. –í–ö–õ–Æ–ß–ê–ï–ú GPU
            if (grid) grid.style.willChange = 'transform';

            if (isTicking) return;
            isTicking = true;
            
            requestAnimationFrame(() => {
                const intVal = Math.round(val);
                const scale = intVal / 100;
                
                const zoomInput = document.getElementById('gridZoom');
                const fsZoomInput = document.getElementById('fsGridZoom');
                const zoomText = document.getElementById('zoomText');
                
                if(zoomInput) zoomInput.value = intVal;
                if(fsZoomInput) fsZoomInput.value = intVal;
                if(zoomText) zoomText.innerText = intVal + '%';

                const isPreviewActive = document.getElementById('tab-preview').classList.contains('active');

                if (isPreviewActive) {
                    previewZoom = intVal;
                    const resultWrapper = document.querySelector('#resultBox .image-wrapper');
                    if (resultWrapper) {
                        resultWrapper.style.transform = `translate(${viewX}px, ${viewY}px) scale(${scale})`;
                    }
                } else {
                    schemeZoom = intVal;
                    const container = document.getElementById('gridContainer');
                    
                    if (grid && container) {
                        grid.style.transform = `scale(${scale})`;
                        
                        // –ï–°–õ–ò –†–ê–ó–ú–ï–†–´ –ï–©–ï –ù–ï –ó–ê–ü–ò–°–ê–ù–´ - –ó–ê–ü–ò–°–´–í–ê–ï–ú –°–ï–ô–ß–ê–°
                        if (gridBaseWidth === 0 || gridBaseHeight === 0) {
                            gridBaseWidth = grid.offsetWidth;
                            gridBaseHeight = grid.offsetHeight;
                        }

                        if (gridBaseWidth > 0) {
                            container.style.width = (gridBaseWidth * scale) + 'px';
                            container.style.height = (gridBaseHeight * scale) + 'px';
                        }
                    }
                }
                
                isTicking = false;
            });

            // 2. DEBOUNCE (–ß–µ—Ç–∫–æ—Å—Ç—å)
            if (zoomDebounceTimer) clearTimeout(zoomDebounceTimer);
            zoomDebounceTimer = setTimeout(() => {
                if (grid) grid.style.willChange = 'auto'; 
            }, 300);
        }
        function toggleZoomPopup() { const p = document.getElementById('zoomPopup'); const btn = document.getElementById('zoomDisplayBtn'); p.classList.toggle('show'); btn.classList.toggle('btn-active-state'); }
        document.addEventListener('click', (e) => { const p = document.getElementById('zoomPopup'); const btn = document.getElementById('zoomDisplayBtn'); if(p.classList.contains('show') && !p.contains(e.target) && !btn.contains(e.target)) { p.classList.remove('show'); btn.classList.remove('btn-active-state'); } });
        function toggleZoomPopupFS() { const z = document.getElementById('fsZoomPopup'); if(z.classList.contains('show')) { z.classList.remove('show'); document.getElementById('fsZoomBtn').classList.remove('btn-active-state'); } else { z.classList.add('show'); document.getElementById('fsZoomBtn').classList.add('btn-active-state'); } }
        function toggleLock(groupId, inputId) { const group = document.getElementById(groupId); const input = document.getElementById(inputId); const btn = group.querySelector('.lock-toggle'); if(group.classList.contains('locked')) { group.classList.remove('locked'); input.disabled = false; btn.innerText = 'üîì'; } else { group.classList.add('locked'); input.disabled = true; btn.innerText = 'üîí'; } }
function toggleGestureLock() { 
    gesturesLocked = !gesturesLocked; 
    const btn = document.getElementById('gestureLockBtn'); 
    btn.classList.toggle('active'); 
    // –ï—Å–ª–∏ –∞–∫—Ç–∏–≤–Ω–æ (Green) -> üîì –ë–õ–û–ö, –∏–Ω–∞—á–µ -> üîí –ë–õ–û–ö
    btn.innerText = gesturesLocked ? 'üîì –ë–õ–û–ö' : 'üîí –ë–õ–û–ö'; 
}        
function setupTouchGestures() { 
    const el = document.getElementById('previewContainer'); 
    let isDragging = false, startX, startY, startPanX, startPanY;
    let startViewX, startViewY; 
    let initialDist = 0;
    
    // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –∑—É–º–∞
    let startZoom = 100; 
    let startGridZoom = 100; 

    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Ä–∏—Å–æ–≤–∞–Ω–∏—è
    const getCoord = (e) => { const r=document.getElementById('mainCanvas').getBoundingClientRect(); const sx=document.getElementById('mainCanvas').width/r.width; const sy=document.getElementById('mainCanvas').height/r.height; const cx=e.touches?e.touches[0].clientX:e.clientX; const cy=e.touches?e.touches[0].clientY:e.clientY; return {x:Math.floor((cx-r.left)*sx/10), y:Math.floor((cy-r.top)*sy/10)}; };
    const paint = (e) => { if(!finalMatrix.length)return; const {x,y}=getCoord(e); if(y>=0&&y<finalMatrix.length&&x>=0&&x<finalMatrix[0].length){ if(finalMatrix[y][x]!==selectedBrushIndex){ finalMatrix[y][x]=selectedBrushIndex; const bW=parseInt(document.getElementById('borderWidth').value); if(generatedMatrix.length && x>=bW && x<finalMatrix[0].length-bW && y>=bW && y<finalMatrix.length-bW){ generatedMatrix[y-bW][x-bW]=selectedBrushIndex; } drawPreview(finalMatrix[0].length,finalMatrix.length); updateStats(); } } };

    el.addEventListener('touchstart', (e) => { 
        if(isPencil){ pushHistory(); paint(e); return; } 
        if(!sourceImage) return; 

        // --- –§–ò–ö–°: –û–ë–ù–û–í–õ–Ø–ï–ú –ó–ù–ê–ß–ï–ù–ò–Ø –ü–†–ò –ö–ê–ñ–î–û–ú –ö–ê–°–ê–ù–ò–ò ---
        // –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç —Å–±—Ä–æ—Å –Ω–∞ 100% –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º –∫–∞—Å–∞–Ω–∏–∏
        startZoom = parseInt(document.getElementById('zoom').value) || 100;
        startGridZoom = parseInt(document.getElementById('gridZoom').value) || 100;
        // ---------------------------------------------------

        if (e.touches.length === 1) { 
            isDragging = true; 
            startX = e.touches[0].clientX; 
            startY = e.touches[0].clientY; 

            if (!gesturesLocked) {
                // –°–ï–†–´–ô –†–ï–ñ–ò–ú (–î–≤–∏–≥–∞–µ–º —Ñ–æ—Ç–æ)
                startPanX = parseInt(document.getElementById('panX').value); 
                startPanY = parseInt(document.getElementById('panY').value); 
            } else {
                // –ó–ï–õ–ï–ù–´–ô –†–ï–ñ–ò–ú (–î–≤–∏–≥–∞–µ–º –æ–∫–Ω–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞)
                startViewX = viewX;
                startViewY = viewY;
            }
        } else if (e.touches.length === 2) { 
            const dist = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY); 
            initialDist = dist; 
        }
    }, {passive: false}); 

    el.addEventListener('touchmove', (e) => { 
        if(isPencil){ paint(e); e.preventDefault(); return; } 
        if(!sourceImage) return; 
        e.preventDefault(); 

        // --- 1 –ü–ê–õ–ï–¶: –ü–ï–†–ï–ú–ï–©–ï–ù–ò–ï ---
        if (e.touches.length === 1 && isDragging) { 
            const dx = e.touches[0].clientX - startX; 
            const dy = e.touches[0].clientY - startY; 

            if (!gesturesLocked) {
                // –°–ï–†–´–ô
                const scaleFactor = 0.5; 
                if(!document.getElementById('group-panX').classList.contains('locked')) { 
                    let newPanX = startPanX + (dx * scaleFactor); 
                    newPanX = Math.max(-100, Math.min(100, newPanX)); 
                    document.getElementById('panX').value = newPanX; 
                    document.getElementById('panXVal').innerText = Math.round(newPanX) + '%'; 
                } 
                if(!document.getElementById('group-panY').classList.contains('locked')) { 
                    let newPanY = startPanY + (dy * scaleFactor); 
                    newPanY = Math.max(-100, Math.min(100, newPanY)); 
                    document.getElementById('panY').value = newPanY; 
                    document.getElementById('panYVal').innerText = Math.round(newPanY) + '%'; 
                } 
                processImage(); 
            } else {
                // –ó–ï–õ–ï–ù–´–ô (–û–∫–Ω–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞)
                viewX = startViewX + dx;
                viewY = startViewY + dy;
                // –ü—Ä–∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –¢–ï–ö–£–©–ò–ô –∑—É–º, –∫–æ—Ç–æ—Ä—ã–π –º—ã —Å—á–∏—Ç–∞–ª–∏ –≤ touchstart
                updateGridScale(startGridZoom);
            }
        } 
        // --- 2 –ü–ê–õ–¨–¶–ê: –ú–ê–°–®–¢–ê–ë ---
        else if (e.touches.length === 2) { 
            const dist = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY); 
            const ratio = dist / initialDist; 

            if (!gesturesLocked) {
                // –°–ï–†–´–ô
                let newZoom = startZoom * ratio; 
                newZoom = Math.max(1, Math.min(300, newZoom)); 
                document.getElementById('zoom').value = newZoom; 
                document.getElementById('zoomVal').innerText = Math.round(newZoom) + '%'; 
                processImage(); 
            } else {
                // –ó–ï–õ–ï–ù–´–ô
                let newGZ = startGridZoom * ratio;
                // --- –ó–î–ï–°–¨ –¢–ï–ü–ï–†–¨ 800% ---
                newGZ = Math.max(3, Math.min(800, newGZ)); 
                
                updateGridScale(newGZ);
            }
        } 
    }, {passive: false}); 

    el.addEventListener('touchend', () => { isDragging = false; }); 
}

function setupMouseGestures() { 
    const el = document.getElementById('previewContainer'); 
    
    // –†–∏—Å–æ–≤–∞–Ω–∏–µ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
    const getCoord = (e) => { const r=document.getElementById('mainCanvas').getBoundingClientRect(); const sx=document.getElementById('mainCanvas').width/r.width; const sy=document.getElementById('mainCanvas').height/r.height; return {x:Math.floor((e.clientX-r.left)*sx/10), y:Math.floor((e.clientY-r.top)*sy/10)}; }; 
    const paint = (e) => { if(!finalMatrix.length)return; const {x,y}=getCoord(e); if(y>=0&&y<finalMatrix.length&&x>=0&&x<finalMatrix[0].length){ if(finalMatrix[y][x]!==selectedBrushIndex){ finalMatrix[y][x]=selectedBrushIndex; const bW=parseInt(document.getElementById('borderWidth').value); if(generatedMatrix.length && x>=bW && x<finalMatrix[0].length-bW && y>=bW && y<finalMatrix.length-bW){ generatedMatrix[y-bW][x-bW]=selectedBrushIndex; } drawPreview(finalMatrix[0].length,finalMatrix.length); updateStats(); } } }; 

    // –ö–û–õ–ï–°–û –ú–´–®–ò (–ó–£–ú)
    el.addEventListener('wheel', (e) => { 
        if(isPencil || !sourceImage) return; 
        e.preventDefault(); 
        const delta = Math.sign(e.deltaY) * -10; 

        if (!gesturesLocked) {
            // –°–ï–†–´–ô –†–ï–ñ–ò–ú: –ó—É–º —Ñ–æ—Ç–æ
            if(document.getElementById('group-zoom').classList.contains('locked')) return;
            let val = parseInt(document.getElementById('zoom').value) + delta; 
            val = Math.max(1, Math.min(300, val)); 
            document.getElementById('zoom').value = val; 
            document.getElementById('zoomVal').innerText = val + '%'; 
            processImage(); 
        } else {
            // –ó–ï–õ–ï–ù–´–ô –†–ï–ñ–ò–ú: –ó—É–º –æ–∫–Ω–∞ (–†–ï–ó–£–õ–¨–¢–ê–¢)
            let currentVal = parseInt(document.getElementById('gridZoom').value);
            let val = currentVal + delta;
            
            // --- –í–ê–ñ–ù–û: –ó–î–ï–°–¨ –ë–´–õ–û 200, –°–¢–ê–í–ò–ú 800 ---
            val = Math.max(3, Math.min(800, val)); 
            // ----------------------------------------
            
            updateGridScale(val);
        }
    }, {passive: false}); 

    let isMouseDown = false, startX, startY, startPanX, startPanY, startViewX, startViewY; 

    // –ù–ê–ñ–ê–¢–ò–ï –ú–´–®–ò
    el.addEventListener('mousedown', (e) => { 
        if(isPencil) { pushHistory(); isMouseDown=true; paint(e); return; } 
        if(!sourceImage) return; 
        
        isMouseDown = true; 
        el.style.cursor = 'grabbing'; 
        startX = e.clientX; 
        startY = e.clientY; 

        if (!gesturesLocked) {
            // –°–ï–†–´–ô
            startPanX = parseFloat(document.getElementById('panX').value); 
            startPanY = parseFloat(document.getElementById('panY').value); 
        } else {
            // –ó–ï–õ–ï–ù–´–ô
            startViewX = viewX;
            startViewY = viewY;
        }
    }); 

    // –î–í–ò–ñ–ï–ù–ò–ï –ú–´–®–ò
    window.addEventListener('mousemove', (e) => { 
        if(!isMouseDown || !sourceImage) return; 
        e.preventDefault(); 
        if(isPencil) { paint(e); return; } 

        const dx = e.clientX - startX; 
        const dy = e.clientY - startY; 

        if (!gesturesLocked) {
            // –°–ï–†–´–ô: –î–≤–∏–≥–∞–µ–º —Ñ–æ—Ç–æ
            const sensitivity = 0.5; 
            if(!document.getElementById('group-panX').classList.contains('locked')) { 
                let nx = startPanX + (dx * sensitivity); 
                nx = Math.max(-100, Math.min(100, nx)); 
                document.getElementById('panX').value = nx; 
                document.getElementById('panXVal').innerText = Math.round(nx) + '%'; 
            } 
            if(!document.getElementById('group-panY').classList.contains('locked')) { 
                let ny = startPanY + (dy * sensitivity); 
                ny = Math.max(-100, Math.min(100, ny)); 
                document.getElementById('panY').value = ny; 
                document.getElementById('panYVal').innerText = Math.round(ny) + '%'; 
            } 
            processImage(); 
        } else {
            // –ó–ï–õ–ï–ù–´–ô: –î–≤–∏–≥–∞–µ–º –æ–∫–Ω–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
            viewX = startViewX + dx;
            viewY = startViewY + dy;
            updateGridScale(document.getElementById('gridZoom').value);
        }
    }); 

    window.addEventListener('mouseup', () => { 
        isMouseDown = false; 
        if(!isPencil) el.style.cursor = 'grab'; 
    }); 
}
        function setupGridGestures() { const el = document.getElementById('instructionView'); let startDist = 0, startZoom = 100; el.addEventListener('touchstart', (e) => { if (e.touches.length === 2) { e.preventDefault(); startDist = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY); startZoom = parseInt(document.getElementById('gridZoom').value); } }, {passive: false}); el.addEventListener('touchmove', (e) => { if (e.touches.length === 2) { e.preventDefault(); const dist = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY); updateGridScale(startZoom * (dist/startDist)); } }, {passive: false}); }
        function resetSlider(id, defVal) { if(document.getElementById('group-'+id).classList.contains('locked')) return; document.getElementById(id).value = defVal; let suffix = '%'; if(id === 'smartBlur' || id === 'posterize') suffix = ''; document.getElementById(id+'Val').innerText = defVal + suffix; if(sourceImage) processImage(); }
        function toggleFullscreen() { 
    // –û–±–æ—Ä–∞—á–∏–≤–∞–µ–º –ª–æ–≥–∏–∫—É —Ñ—É–ª—Å–∫—Ä–∏–Ω–∞ –≤ –∞–Ω–∏–º–∞—Ü–∏—é
    runTransition(() => {
        document.body.classList.toggle('fullscreen-mode'); 
        
        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º –º–∞—Å—à—Ç–∞–± –ø—Ä–∏ –≤—Ö–æ–¥–µ/–≤—ã—Ö–æ–¥–µ
        updateGridScale(document.getElementById('gridZoom').value);
        
        refreshGridVisibility(); 
    });
}
        function handleUpload(e) { 
            const file = e.target.files[0]; 
            if(!file) return; 
            const reader = new FileReader(); 
            reader.onload = (ev) => { 
                sourceImage = new Image(); 
                sourceImage.onload = () => { 
                    activateHistoryTrap(); 
                    document.getElementById('origBox').style.display = 'flex'; 
                    document.getElementById('resultBox').style.display = 'flex'; 
                    document.getElementById('originalImageThumb').src = sourceImage.src; 
                    resetStylesOnly(); 
                }; 
                sourceImage.src = ev.target.result; 
            }; 
            reader.readAsDataURL(file); 
        }

        function loadProject(e) { const file = e.target.files[0]; if(!file) return; if(file.type.match('image.*')) { alert("–û—à–∏–±–∫–∞: –í—ã –ø—ã—Ç–∞–µ—Ç–µ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É –≤ –º–µ–Ω—é –ø—Ä–æ–µ–∫—Ç–∞."); return; } const r = new FileReader(); r.onload = (ev) => processLoadedProject(ev.target.result); r.readAsText(file); }

        function processLoadedProject(jsonStr) {
            try { const d = JSON.parse(jsonStr); currentPalette = d.palette; if(d.aiBase) aiBasePalette = d.aiBase; document.getElementById('zoom').value = d.settings.zoom; document.getElementById('zoomVal').innerText = d.settings.zoom + '%'; document.getElementById('contrast').value = d.settings.contrast; document.getElementById('contrastVal').innerText = d.settings.contrast + '%'; document.getElementById('brightness').value = d.settings.brightness || 100; document.getElementById('brightnessVal').innerText = (d.settings.brightness || 100) + '%'; document.getElementById('panX').value = d.settings.panX; document.getElementById('panY').value = d.settings.panY; document.getElementById('setSize').value = d.settings.size; if(d.settings.size === 'custom') document.getElementById('customSizeGroup').style.display = 'flex'; document.getElementById('customWidth').value = d.settings.cW || 50; document.getElementById('customHeight').value = d.settings.cH || 50; document.getElementById('colorCount').value = d.settings.cc || 5; document.getElementById('colorCountVal').innerText = d.settings.cc || 5; if(d.settings.sharpness) { document.getElementById('sharpness').value = d.settings.sharpness; document.getElementById('sharpnessVal').innerText = d.settings.sharpness + '%'; } if(d.settings.smartBlur) { 
    document.getElementById('smartBlur').value = d.settings.smartBlur; 
    document.getElementById('smartBlurVal').innerText = d.settings.smartBlur; 
} 

if(d.stockAssists) stockAssists = d.stockAssists; else stockAssists = {};

if(d.hiddenRegions) {
    hiddenRegions = new Set(d.hiddenRegions);
} else {
    // –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Å—Ç–∞—Ä—ã—Ö —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–π (—Å–±—Ä–∞—Å—ã–≤–∞–µ–º, —Ç.–∫. —Ñ–æ—Ä–º–∞—Ç –Ω–µ—Å–æ–≤–º–µ—Å—Ç–∏–º)
    hiddenRegions = new Set();
}; const presetVal = d.settings.preset || 'custom_ai'; document.getElementById('palettePreset').value = presetVal; document.getElementById('colorCountGroup').style.display = (presetVal === 'original' || presetVal === 'random_chaos' || presetVal === 'custom' || presetVal === 'custom_ai' || presetVal === 'smart_neon') ? 'block' : 'none'; const showRefresh = ['smart_neon', 'original', 'random_chaos', 'custom_ai', 'bw', 'popart', 'custom'].includes(presetVal); document.getElementById('refreshPaletteBtn').style.display = showRefresh ? 'flex' : 'none'; renderPaletteUI(); sourceImage = new Image(); sourceImage.onload = () => { activateHistoryTrap(); document.getElementById('origBox').style.display = 'flex'; document.getElementById('resultBox').style.display = 'flex'; document.getElementById('originalImageThumb').src = sourceImage.src; processImage(); }; sourceImage.src = d.img; } catch (err) { alert("–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞ –ø—Ä–æ–µ–∫—Ç–∞."); console.error(err); }
        }

        function applyPaletteLogic(val) {
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ —Ä–µ–∂–∏–º–∞ —Å–∫–ª–∞–¥–∞
            isStockMode = false;
            
            // --- 1. –†–ï–ñ–ò–ú: –°–í–û–ô AI (v4.0 Default Palette) ---
            if (val === 'custom_ai') {
                isStockMode = true;
                finalMatrix = [];
                generatedMatrix = [];
                const cvs = document.getElementById('mainCanvas');
                const ctx = cvs.getContext('2d');
                ctx.clearRect(0, 0, cvs.width, cvs.height); 

                // –ó–¥–µ—Å—å —É–∂–µ –±—ã–ª–æ 12, –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å
                const targetCount = 12; 
                document.getElementById('colorCount').value = targetCount;
                document.getElementById('colorCountVal').innerText = targetCount;

                const idealPalette = [
                    "#000000", "#1A1A1A", "#333333", "#4D4D4D", 
                    "#666666", "#808080", "#999999", "#B3B3B3", 
                    "#CCCCCC", "#E6E6E6", "#F2F2F2", "#FFFFFF"
                ];

                currentPalette = [...idealPalette];
                aiBasePalette = [...idealPalette];

                while(stockQuantities.length < targetCount) stockQuantities.push(0);
                if (stockQuantities.length > targetCount) stockQuantities = stockQuantities.slice(0, targetCount);

                renderPaletteUI();
                renderStockInputs(); 
                return; 
            }

            // --- 2. –ñ–ï–°–¢–ö–ò–ï –ü–†–ï–°–ï–¢–´ (–ß–ë –∏ –õ–ï–ì–û) ---
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –Ω–∞ 5 —Ü–≤–µ—Ç–æ–≤
            if (val === 'bw') {
                 document.getElementById('colorCount').value = 5;
                 document.getElementById('colorCountVal').innerText = 5;
                 currentPalette = [...PRESETS['bw']];
                 aiBasePalette = []; 
                 renderPaletteUI(); 
                 if(sourceImage) processImage();
                 return;
            }

            if (val === 'popart') {
                 document.getElementById('colorCount').value = 5;
                 document.getElementById('colorCountVal').innerText = 5;
                 currentPalette = [...LEGO_PALETTE];
                 aiBasePalette = []; 
                 renderPaletteUI(); 
                 if(sourceImage) processImage();
                 return;
            }

            // --- 3. –ì–ï–ù–ï–†–ê–¢–ò–í–ù–´–ï –ü–†–ï–°–ï–¢–´ (–•–ê–û–° - —Ç–µ–ø–µ—Ä—å 12) ---
            
            if (val === 'random_chaos') {
                // !!! –£–°–¢–ê–ù–ê–í–õ–ò–í–ê–ï–ú 12 –¶–í–ï–¢–û–í –ü–û –£–ú–û–õ–ß–ê–ù–ò–Æ !!!
                document.getElementById('colorCount').value = 12;
                document.getElementById('colorCountVal').innerText = 12;

                generateChaosPalette(); // –§—É–Ω–∫—Ü–∏—è —Å–∞–º–∞ –≤–æ–∑—å–º–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ 12 –∏–∑ —ç–ª–µ–º–µ–Ω—Ç–∞ colorCount
                aiBasePalette = []; 
                renderPaletteUI(); 
                processImage(); 
                return;
            }

            if (val === 'smart_neon') { 
                if (aiBasePalette.length === 0) {
                     extractPaletteQuantized(); 
                     aiBasePalette = [...currentPalette]; 
                }
                updateCustomColorCount(parseInt(document.getElementById('colorCount').value));
                generateSmartPalette(true); 
                renderPaletteUI(); 
                processImage(); 
                return;
            } 

            if (val === 'custom') { 
                document.getElementById('colorCount').value = currentPalette.length; 
                document.getElementById('colorCountVal').innerText = currentPalette.length; 
                aiBasePalette = []; 
                renderPaletteUI(); 
                return; 
            }
            // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω Pixel Art, –º—ã —Ö–æ—Ç–∏–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ü–≤–µ—Ç–∞ —Å —Ñ–æ—Ç–æ (–∫–∞–∫ Original)
           if (val === 'pixelart') {
    // 1. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 16 —Ü–≤–µ—Ç–æ–≤ - –∫–ª–∞—Å—Å–∏–∫–∞ —Ä–µ—Ç—Ä–æ)
    let curVal = parseInt(document.getElementById('colorCount').value);
    if (curVal < 2) curVal = 16; 
    document.getElementById('colorCount').value = curVal;
    document.getElementById('colorCountVal').innerText = curVal;

    // 2. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø–∞–ª–∏—Ç—Ä—É –∏–∑ –∫–∞—Ä—Ç–∏–Ω–∫–∏ (–∏–Ω–∞—á–µ –æ–Ω–∞ –æ—Å—Ç–∞–Ω–µ—Ç—Å—è –ß–ë –∏–ª–∏ –ø—Ä–æ—à–ª–æ–π)
    extractPaletteQuantized(); 
    aiBasePalette = []; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –±–∞–∑—É, —á—Ç–æ–±—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–µ–∫—É—â—É—é
    
    renderPaletteUI();
    // –í–∞–∂–Ω–æ: –µ—Å–ª–∏ –µ—Å—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫–∞, –∑–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å
    if(sourceImage) processImage();
    return;
}
            // --- 4. –û–†–ò–ì–ò–ù–ê–õ (SMART AI - —Ç–µ–ø–µ—Ä—å 12) ---
            if (val === 'original') { 
                // !!! –£–°–¢–ê–ù–ê–í–õ–ò–í–ê–ï–ú 12 –¶–í–ï–¢–û–í –ü–û –£–ú–û–õ–ß–ê–ù–ò–Æ !!!
                document.getElementById('colorCount').value = 12;
                document.getElementById('colorCountVal').innerText = 12;

                extractPaletteQuantized(); // –§—É–Ω–∫—Ü–∏—è —Å–∞–º–∞ –≤–æ–∑—å–º–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ 12 –∏–∑ —ç–ª–µ–º–µ–Ω—Ç–∞ colorCount
                aiBasePalette=[]; 
            } 
            else if (PRESETS[val]) { 
                currentPalette = [...PRESETS[val]]; 
                aiBasePalette=[]; 
            } 
            
            renderPaletteUI(); 
            if(sourceImage) processImage(); 
        }
        function updateCustomColorCount(newCount) { while(currentPalette.length < newCount) currentPalette.push('#' + Math.floor(Math.random()*16777215).toString(16).padStart(6, '0')); while(currentPalette.length > newCount) currentPalette.pop(); }

        function generateChaosPalette() { 
            const count = parseInt(document.getElementById('colorCount').value); currentPalette = []; 
            for(let i=0; i<count; i++) currentPalette.push('#' + Math.floor(Math.random()*16777215).toString(16).padStart(6, '0')); 
            currentPalette.sort((a,b) => { const getLum = (hex) => { const r = parseInt(hex.slice(1,3), 16); const g = parseInt(hex.slice(3,5), 16); const b = parseInt(hex.slice(5,7), 16); return r+g+b; }; return getLum(a) - getLum(b); });
        }
        function extractPaletteQuantized() {
            if(!sourceImage) return; const count = parseInt(document.getElementById('colorCount').value); const canvas = document.getElementById('procCanvas'); const ctx = canvas.getContext('2d', { willReadFrequently: true }); const pixels = ctx.getImageData(0, 0, canvas.width, canvas.height).data; let pixelArray = []; for(let i=0; i<pixels.length; i+=40) pixelArray.push([pixels[i], pixels[i+1], pixels[i+2]]); if(pixelArray.length === 0) return; let centroids = []; for(let k=0; k<count; k++) centroids.push(pixelArray[Math.floor(Math.random()*pixelArray.length)]);
            for(let iter=0; iter<5; iter++) { let buckets = Array(count).fill().map(()=>[]); pixelArray.forEach(p => { let minDist = Infinity, idx = 0; centroids.forEach((c, i) => { const d = Math.sqrt((p[0]-c[0])**2 + (p[1]-c[1])**2 + (p[2]-c[2])**2); if(d < minDist) { minDist = d; idx = i; } }); buckets[idx].push(p); }); centroids = buckets.map(bucket => { if(bucket.length === 0) return [Math.random()*255, Math.random()*255, Math.random()*255]; let r=0, g=0, b=0; bucket.forEach(p => { r+=p[0]; g+=p[1]; b+=p[2]; }); return [Math.round(r/bucket.length), Math.round(g/bucket.length), Math.round(b/bucket.length)]; }); }
            centroids.sort((a,b) => (a[0]+a[1]+a[2]) - (b[0]+b[1]+b[2])); currentPalette = centroids.map(c => rgbToHex(c[0], c[1], c[2]));
        }

        function toggleBorderControl() {
    const panel = document.getElementById('borderControl');
    const btn = document.getElementById('borderBtn');
    
    // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –∫–ª–∞—Å—Å .show (–æ–Ω –∑–∞–ø—É—Å—Ç–∏—Ç CSS –∞–Ω–∏–º–∞—Ü–∏—é)
    panel.classList.toggle('show');
    
    // –ö—Ä–∞—Å–∏–º –∫–Ω–æ–ø–∫—É, –µ—Å–ª–∏ –º–µ–Ω—é –æ—Ç–∫—Ä—ã—Ç–æ
    if (panel.classList.contains('show')) {
        btn.classList.add('btn-active-state');
    } else {
        btn.classList.remove('btn-active-state');
    }
}
        function updateBorderSettings() { document.getElementById('borderWidthVal').innerText = document.getElementById('borderWidth').value; finalizeMatrixWithBorder(); }
        function finalizeMatrixWithBorder() {
            if(!generatedMatrix.length) return; 
            const bWidth = parseInt(document.getElementById('borderWidth').value); 
            const bColorIdx = parseInt(document.getElementById('borderColor').value || 0);
            
            let newMat = []; 
            const h = generatedMatrix.length; 
            const w = generatedMatrix[0].length;
            
            for(let y=0; y<h; y++) { 
                let row = []; 
                for(let x=0; x<w; x++) { 
                    if(x < bWidth || x >= w - bWidth || y < bWidth || y >= h - bWidth) { 
                        row.push(bColorIdx); 
                    } else { 
                        row.push(generatedMatrix[y][x]); 
                    }
                } 
                newMat.push(row); 
            }
            finalMatrix = newMat; 

            // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞–¥–ø–∏—Å—å —Å —Ä–∞–∑–º–µ—Ä–æ–º
            const finalH = finalMatrix.length;
            const finalW = finalMatrix.length > 0 ? finalMatrix[0].length : 0;
            const label = document.getElementById('resultLabel');
            if (label) {
                label.innerText = `–†–ï–ó–£–õ–¨–¢–ê–¢ ${finalW}x${finalH}`;
            }

            // –ï—Å–ª–∏ –ø–∞–ª–∏—Ç—Ä–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—É—Å—Ç–∞—è –ò–õ–ò –º—ã –≤—ã—à–ª–∏ –∏–∑ —Ä–µ–∂–∏–º–∞ —Å–∫–ª–∞–¥–∞ ‚Äî —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –Ω–∞ –¥–µ—Ñ–æ–ª—Ç
            if(displayPalette.length === 0 || !isStockMode) {
                displayPalette = [...currentPalette];
                displaySymbols = [...currentSymbolSet];
            }
            
            drawPreview(finalMatrix[0].length, finalMatrix.length); 
            updateStats(); 
            if(document.getElementById('instructionView').style.display === 'block') drawGrid();
        }

        function processImage() {
            // –†–µ–∂–∏–º "–°–≤–æ–π AI"
            if (isStockMode) {
                if (window.stockTimeout) clearTimeout(window.stockTimeout);
                window.stockTimeout = setTimeout(processStockImage, 50); 
                return;
            }

            if(!sourceImage) return; 
            const preset = document.getElementById('palettePreset').value; let w, h; if(document.getElementById('setSize').value === 'custom') { w = parseInt(document.getElementById('customWidth').value) || 50; h = parseInt(document.getElementById('customHeight').value) || 50; } else { w = h = parseInt(document.getElementById('setSize').value); }
            
            const resolutionFactor = 4;
            const workW = w * resolutionFactor; const workH = h * resolutionFactor; 
            const workCanvas = document.createElement('canvas'); workCanvas.width = workW; workCanvas.height = workH; const workCtx = workCanvas.getContext('2d', { willReadFrequently: true });
            
            const zoom = document.getElementById('zoom').value / 100; const contrast = document.getElementById('contrast').value; const brightness = document.getElementById('brightness').value;
            workCtx.filter = `contrast(${contrast}%) brightness(${brightness}%)`; const px = (document.getElementById('panX').value / 100) * workW; const py = (document.getElementById('panY').value / 100) * workH; 
            
            const imgAspect = sourceImage.width / sourceImage.height;
            const canvasAspect = workW / workH;
            let drawW, drawH;
            if(imgAspect > canvasAspect) {
                drawH = workH * zoom;
                drawW = workH * imgAspect * zoom;
            } else {
                drawW = workW * zoom;
                drawH = (workW / imgAspect) * zoom;
            }
            
            workCtx.drawImage(sourceImage, (workW - drawW) / 2 + px, (workH - drawH) / 2 + py, drawW, drawH);
            
            let workImgData = workCtx.getImageData(0,0,workW,workH); let data = workImgData.data;
            const smartBlur = parseInt(document.getElementById('smartBlur').value);
            
            // Smart Blur
            if(smartBlur > 0) { 
                const copy = new Uint8ClampedArray(data); 
                const radius = 2; 
                for(let y=0; y<workH; y++) { 
                    for(let x=0; x<workW; x++) { 
                        let rSum=0, gSum=0, bSum=0, count=0; 
                        const idx = (y*workW+x)*4; const r0 = copy[idx], g0=copy[idx+1], b0=copy[idx+2]; 
                        for(let dy=-radius; dy<=radius; dy++) { 
                            for(let dx=-radius; dx<=radius; dx++) { 
                                const nx=x+dx; const ny=y+dy; 
                                if(nx>=0 && nx<workW && ny>=0 && ny<workH) { 
                                    const nIdx = (ny*workW+nx)*4; 
                                    const r=copy[nIdx], g=copy[nIdx+1], b=copy[nIdx+2]; 
                                    const diff = Math.abs(r-r0) + Math.abs(g-g0) + Math.abs(b-b0); 
                                    if(diff <= smartBlur * 2.5) { rSum+=r; gSum+=g; bSum+=b; count++; } 
                                } 
                            } 
                        } 
                        if(count > 0) { data[idx] = rSum/count; data[idx+1] = gSum/count; data[idx+2] = bSum/count; } 
                    } 
                } 
            }

            // USM Algorithm
            const sharpAmount = parseInt(document.getElementById('sharpness').value);
            const usmRadius = parseInt(document.getElementById('usmRadius').value) || 0;

            if (sharpAmount > 0 && usmRadius > 0) {
                 const blurred = new Uint8ClampedArray(data);
                 const r = usmRadius; 
                 const w = workW;
                 const h_ = workH;
                 
                 const temp = new Uint8ClampedArray(data);
                 for(let y=0; y<h_; y++) {
                     for(let x=0; x<w; x++) {
                         let rS=0, gS=0, bS=0, cnt=0;
                         for(let i = -r; i <= r; i++) {
                             let nx = x + i;
                             if(nx >= 0 && nx < w) {
                                 let idx = (y * w + nx) * 4;
                                 rS += temp[idx]; gS += temp[idx+1]; bS += temp[idx+2]; cnt++;
                             }
                         }
                         let idx = (y * w + x) * 4;
                         blurred[idx] = rS/cnt; blurred[idx+1] = gS/cnt; blurred[idx+2] = bS/cnt;
                     }
                 }
                 const temp2 = new Uint8ClampedArray(blurred);
                 for(let x=0; x<w; x++) {
                     for(let y=0; y<h_; y++) {
                         let rS=0, gS=0, bS=0, cnt=0;
                         for(let i = -r; i <= r; i++) {
                             let ny = y + i;
                             if(ny >= 0 && ny < h_) {
                                 let idx = (ny * w + x) * 4;
                                 rS += temp2[idx]; gS += temp2[idx+1]; bS += temp2[idx+2]; cnt++;
                             }
                         }
                         let idx = (y * w + x) * 4;
                         blurred[idx] = rS/cnt; blurred[idx+1] = gS/cnt; blurred[idx+2] = bS/cnt;
                     }
                 }

                 const amount = sharpAmount / 100;
                 for (let i = 0; i < data.length; i += 4) {
                     data[i] = Math.min(255, Math.max(0, data[i] + (data[i] - blurred[i]) * amount));
                     data[i+1] = Math.min(255, Math.max(0, data[i+1] + (data[i+1] - blurred[i+1]) * amount));
                     data[i+2] = Math.min(255, Math.max(0, data[i+2] + (data[i+2] - blurred[i+2]) * amount));
                 }
            }
            
            // Posterize
            const levels = parseInt(document.getElementById('posterize').value);
            if (levels > 0) {
                const step = 255 / (levels); // Divide range
                for(let i=0; i < data.length; i+=4) {
                    data[i] = Math.floor(data[i] / step) * step;
                    data[i+1] = Math.floor(data[i+1] / step) * step;
                    data[i+2] = Math.floor(data[i+2] / step) * step;
                }
            }

            workCtx.putImageData(workImgData, 0, 0);
if (preset === 'pixelart') {
    // –ë–µ—Ä–µ–º –¥–∞–Ω–Ω—ã–µ, –∫–æ—Ç–æ—Ä—ã–µ —Ç–æ–ª—å–∫–æ —á—Ç–æ –æ–±—Ä–∞–±–æ—Ç–∞–ª–∏ (—É–∂–µ —Å —è—Ä–∫–æ—Å—Ç—å—é/–∫–æ–Ω—Ç—Ä–∞—Å—Ç–æ–º)
    let pxData = workCtx.getImageData(0, 0, workW, workH);
    
    // –ü—Ä–∏–º–µ–Ω—è–µ–º –Ω–∞—à —ç—Ñ—Ñ–µ–∫—Ç –∫–æ–Ω—Ç—É—Ä–∞ –∏ –Ω–∞—Å—ã—â–µ–Ω–Ω–æ—Å—Ç–∏
    applyPixelArtFilter(pxData.data, workW, workH);
    
    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ–±—Ä–∞—Ç–Ω–æ –Ω–∞ —Ö–æ–ª—Å—Ç
    workCtx.putImageData(pxData, 0, 0);
}

            const canvas = document.getElementById('procCanvas'); const ctx = canvas.getContext('2d', { willReadFrequently: true }); canvas.width = w; canvas.height = h; 
            ctx.drawImage(workCanvas, 0, 0, w, h);
            
            const imgData = ctx.getImageData(0,0,w,h); const finalData = imgData.data; 
            
            if (preset === 'custom' || preset === 'popart' || preset === 'bw' || preset === 'smart_neon') { 
                 if (aiBasePalette.length > 0) {
                      const structurePalette = aiBasePalette;
                      const paletteRGB = structurePalette.map(hex => { const r = parseInt(hex.slice(1,3), 16); const g = parseInt(hex.slice(3,5), 16); const b = parseInt(hex.slice(5,7), 16); return {r,g,b}; });
                      generatedMatrix = [];
                      for(let y=0; y<h; y++) {
                        let row = [];
                        for(let x=0; x<w; x++) {
                            const i = (y*w+x)*4; 
                            let r = finalData[i], g = finalData[i+1], b = finalData[i+2];
                            let bestIdx = 0, minDist = Infinity;
                            paletteRGB.forEach((c, idx) => { const dist = Math.sqrt(Math.pow(c.r-r,2) + Math.pow(c.g-g,2) + Math.pow(c.b-b,2)); if(dist < minDist) { minDist = dist; bestIdx = idx; } });
                            if (bestIdx >= currentPalette.length) bestIdx = currentPalette.length - 1;
                            row.push(bestIdx);
                        }
                        generatedMatrix.push(row);
                      }
                 } else {
                     generatedMatrix = []; const steps = currentPalette.length; const thresholdStep = 255 / steps; 
                     for(let y=0; y<h; y++) { let row = []; for(let x=0; x<w; x++) { const i = (y*w+x)*4; const r = finalData[i], g = finalData[i+1], b = finalData[i+2]; let lum = 0.299*r + 0.587*g + 0.114*b; let idx = Math.floor(lum / thresholdStep); if (idx >= steps) idx = steps - 1; if(idx < 0) idx = 0; row.push(idx); } generatedMatrix.push(row); }
                 }
            } else { 
                const structurePalette = (['custom_ai', 'random_chaos'].includes(preset) && aiBasePalette.length > 0) ? aiBasePalette : currentPalette; const paletteRGB = structurePalette.map(hex => { const r = parseInt(hex.slice(1,3), 16); const g = parseInt(hex.slice(3,5), 16); const b = parseInt(hex.slice(5,7), 16); return {r,g,b}; }); generatedMatrix = []; for(let y=0; y<h; y++) { let row = []; for(let x=0; x<w; x++) { const i = (y*w+x)*4; let oldR = finalData[i], oldG = finalData[i+1], oldB = finalData[i+2]; let bestIdx = 0, minDist = Infinity; paletteRGB.forEach((c, idx) => { const dist = Math.sqrt(Math.pow(c.r-oldR,2) + Math.pow(c.g-oldG,2) + Math.pow(c.b-oldB,2)); if(dist < minDist) { minDist = dist; bestIdx = idx; } }); row.push(bestIdx); } generatedMatrix.push(row); } }
            finalizeMatrixWithBorder();
        }
        function drawPreview() { 
            const cvs = document.getElementById('mainCanvas'); 
            const ctx = cvs.getContext('2d'); 
            const h = finalMatrix.length;
            const w = finalMatrix[0].length;
            const scale = 10; 
            cvs.width = w * scale; 
            cvs.height = h * scale; 
            finalMatrix.forEach((row, y) => { 
                row.forEach((idx, x) => { 
                    ctx.fillStyle = displayPalette[idx] || currentPalette[idx] || '#000'; 
                    ctx.fillRect(x*scale, y*scale, scale, scale); 
                }); 
            }); 
        }
        function renderPaletteUI() { 
            const c = document.getElementById('paletteContainer'); 
            c.innerHTML = ''; 
            currentPalette.forEach((col, i) => { 
                const d = document.createElement('div'); 
                const isActive = (selectedBrushIndex === i) && isPencil; 
                const preset = document.getElementById('palettePreset').value; 
                const isRestricted = ['bw', 'popart'].includes(preset); 
                const isEditable = !isRestricted; 
                
                d.className = 'palette-item' + (isActive ? ' active-brush' : '') + (isEditable ? ' editable' : ' disabled'); 
                d.style.background = col; 
                d.innerHTML = `<span class="pal-sym" style="color:${getContrastColor(col)}">${currentSymbolSet[i] || "?"}</span>`; 
                
                d.onclick = (e) => { 
                    if(e.target.tagName === 'INPUT') return; 
                    if (isPencil) { 
                        selectedBrushIndex = i; 
                        renderPaletteUI(); 
                    } else { 
                        if(isEditable) { 
                            const inp = d.querySelector('input'); 
                            if(inp) inp.click(); 
                        } 
                    } 
                }; 

                if(isEditable) { 
                    const inp = document.createElement('input'); 
                    inp.type = 'color'; 
                    inp.value = col; 
                    inp.onclick = (e) => { 
                        if(isPencil) { 
                            e.preventDefault(); 
                            e.stopPropagation(); 
                            selectedBrushIndex = i; 
                            renderPaletteUI(); 
                            return false; 
                        } 
                        e.stopPropagation(); 
                    }; 
                    
                    // --- –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ó–î–ï–°–¨ ---
                    inp.oninput = (e) => { 
                        e.stopPropagation(); 
                        const newVal = e.target.value;
                        
                        // 1. –û–±–Ω–æ–≤–ª—è–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –º–∞—Å—Å–∏–≤
                        currentPalette[i] = newVal; 
                        
                        // 2. –í–∏–∑—É–∞–ª—å–Ω–æ –º–µ–Ω—è–µ–º –∫—Ä—É–∂–æ–∫ –≤ –ø–∞–ª–∏—Ç—Ä–µ
                        d.style.background = newVal; 
                        
                        // 3. !–ì–õ–ê–í–ù–û–ï! –û–±–Ω–æ–≤–ª—è–µ–º –ø–∞–ª–∏—Ç—Ä—É –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è, —á—Ç–æ–±—ã –º–æ–∑–∞–∏–∫–∞ –ø–µ—Ä–µ–∫—Ä–∞—Å–∏–ª–∞—Å—å —Å—Ä–∞–∑—É
                        if (displayPalette && displayPalette.length > i) {
                            displayPalette[i] = newVal;
                        }

                        // 4. –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º
                        drawPreview(finalMatrix[0].length, finalMatrix.length); 
                        if(document.getElementById('instructionView').style.display === 'block') drawGrid(); 
                        updateStats(); 
                    }; 
                    // --------------------------

                    inp.onchange = (e) => pushHistory(); 
                    d.appendChild(inp); 
                } 
                c.appendChild(d); 
            }); 
        }
        function hexToRgb(hex) { const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex); return result ? { r: parseInt(result[1], 16), g: parseInt(result[2], 16), b: parseInt(result[3], 16) } : {r:0,g:0,b:0}; }
        function toggleTheme() { 
    const b = document.body; 
    b.setAttribute('data-theme', b.getAttribute('data-theme')==='light'?'dark':'light');
    
    // –í—ã–∑—ã–≤–∞–µ–º –ø–æ–∫—Ä–∞—Å–∫—É –±—Ä–∞—É–∑–µ—Ä–∞
    updateBrowserColor();
}
        function saveProject() { if(!sourceImage) return; 
const data = { palette: currentPalette, stockAssists: stockAssists, aiBase: aiBasePalette, hiddenRegions: Array.from(hiddenRegions), settings: { zoom: document.getElementById('zoom').value, contrast: document.getElementById('contrast').value, brightness: document.getElementById('brightness').value, panX: document.getElementById('panX').value, panY: document.getElementById('panY').value, size: document.getElementById('setSize').value, cW: document.getElementById('customWidth').value, cH: document.getElementById('customHeight').value, cc: document.getElementById('colorCount').value, preset: document.getElementById('palettePreset').value, sharpness: document.getElementById('sharpness').value, smartBlur: document.getElementById('smartBlur').value, posterize: document.getElementById('posterize').value, usmRadius: document.getElementById('usmRadius').value }, img: sourceImage.src }; let name = prompt("–í–≤–µ–¥–∏—Ç–µ –∏–º—è —Ñ–∞–π–ª–∞:", "photobrick_project"); if (name === null) return; if (!name) name = "photobrick_project"; if (!name.endsWith(".json")) name += ".json"; const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([JSON.stringify(data)],{type:'application/json'})); a.download = name; a.click(); }

        function resetStylesOnly() { 
            pushHistory(); 
            
            // --- 1. –°–ë–†–û–° –§–õ–ê–ì–û–í –†–ï–ñ–ò–ú–ê "–°–í–û–ô AI" (–ì–õ–ê–í–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï) ---
            isStockMode = false;           // –í—ã–∫–ª—é—á–∞–µ–º —Ä–µ–∂–∏–º —Å–∫–ª–∞–¥–∞
            useMixMode = false;            // –í—ã–∫–ª—é—á–∞–µ–º –º–∏–∫—Å–µ—Ä
            if (window.stockTimeout) clearTimeout(window.stockTimeout); // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞—Å—á–µ—Ç—ã, –µ—Å–ª–∏ —à–ª–∏
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –º–∞—Å—Å–∏–≤—ã —Å–∫–ª–∞–¥–∞ –Ω–∞ –¥–µ—Ñ–æ–ª—Ç
            stockQuantities = [150, 150, 150, 150, 150, 150, 150, 150, 150, 150, 150, 150]; 
            stockAssists = {}; 
            
            // –û—á–∏—â–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è, —á—Ç–æ–±—ã –Ω–µ –æ—Å—Ç–∞–ª–∏—Å—å —Å—Ç–∞—Ä—ã–µ —Ü–≤–µ—Ç–∞
            displayPalette = []; 
            displaySymbols = [];

            // --- 2. –°–ë–†–û–° –†–ê–ó–ú–ï–†–ê ---
            const sizeSelect = document.getElementById('setSize');
            sizeSelect.value = '50'; 
            document.getElementById('customSizeGroup').style.display = 'none';
            document.getElementById('customWidth').value = 50;
            document.getElementById('customHeight').value = 50;

            // --- 3. –°–ë–†–û–° –í–°–ï–• –ü–û–õ–ó–£–ù–ö–û–í ---
            document.getElementById('borderWidth').value = 0; 
            document.getElementById('borderWidthVal').innerText = 0; 
            
            document.getElementById('contrast').value = 100; 
            document.getElementById('contrastVal').innerText = "100%"; 
            document.getElementById('brightness').value = 100; 
            document.getElementById('brightnessVal').innerText = "100%"; 
            
            document.getElementById('sharpness').value = 164; 
            document.getElementById('sharpnessVal').innerText = "164%"; 
            document.getElementById('usmRadius').value = 23;

            document.getElementById('posterize').value = 0;
            document.getElementById('posterizeVal').innerText = "0";

            document.getElementById('smartBlur').value = 0; 
            document.getElementById('smartBlurVal').innerText = "0"; 

            document.getElementById('zoom').value = 100; 
            document.getElementById('zoomVal').innerText = "100%"; 
            document.getElementById('panX').value = 0;
            document.getElementById('panXVal').innerText = "0%";
            document.getElementById('panY').value = 0;
            document.getElementById('panYVal').innerText = "0%";

            // --- 4. "–ü–†–û–ì–†–ï–í" –ê–õ–ì–û–†–ò–¢–ú–ê (–ß–¢–û–ë–´ –°–ë–†–û–°–ò–¢–¨ –¶–í–ï–¢–ê) ---
            if(sourceImage) { 
                // –≠–º—É–ª–∏—Ä—É–µ–º –∑–∞–ø—É—Å–∫ "–û—Ä–∏–≥–∏–Ω–∞–ª–∞", —á—Ç–æ–±—ã —Å—Ç–µ—Ä–µ—Ç—å –ø–∞–º—è—Ç—å –æ –ø—Ä–µ–¥—ã–¥—É—â–µ–º —Å—Ç–∏–ª–µ
                document.getElementById('palettePreset').value = 'original';
                document.getElementById('colorCount').value = 12; 
                document.getElementById('colorCountVal').innerText = 12;
                
                extractPaletteQuantized(); 
                aiBasePalette = []; 
                currentPalette = [];
            } 
            
            // --- 5. –£–°–¢–ê–ù–û–í–ö–ê –°–¢–ê–ù–î–ê–†–¢–ù–û–ì–û –ß–ë ---
            document.getElementById('palettePreset').value = 'bw'; 
            document.getElementById('refreshPaletteBtn').style.display = 'flex'; 
            
            // –°–∫—Ä—ã–≤–∞–µ–º –ª–∏—à–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã (–≤—ã–±–æ—Ä –∫–æ–ª-–≤–∞ —Ü–≤–µ—Ç–æ–≤ –∏ –ø–∞–Ω–µ–ª—å —Å–∫–ª–∞–¥–∞)
            document.getElementById('colorCount').value = 5; 
            document.getElementById('colorCountVal').innerText = 5;
            document.getElementById('colorCountGroup').style.display = 'none'; 
            document.getElementById('statsContent').innerHTML = ''; // –û—á–∏—â–∞–µ–º –ø–∞–Ω–µ–ª—å —Å–∫–ª–∞–¥–∞ –≤–∏–∑—É–∞–ª—å–Ω–æ
            
            // –ü—Ä–∏–º–µ–Ω—è–µ–º –ø–∞–ª–∏—Ç—Ä—É
            currentPalette = [...PRESETS['bw']]; 
            aiBasePalette = []; 
            
            // --- 6. –°–ë–†–û–° –ò–ù–°–¢–†–£–ú–ï–ù–¢–û–í UI ---
            isPencil = false; 
            document.getElementById('pencilBtn').classList.remove('active'); 
            document.querySelector('.viewport').classList.remove('pencil-mode'); 
            
            // --- 7. –§–ò–ù–ê–õ–¨–ù–ê–Ø –û–¢–†–ò–°–û–í–ö–ê ---
            renderPaletteUI(); 
            if(sourceImage) processImage(); 
        }
        function refreshSmartPalette() { 
            pushHistory(); 
            const val = document.getElementById('palettePreset').value; 

            // --- –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –î–õ–Ø "–°–≤–æ–π AI" ---
            if (val === 'custom_ai') {
                isStockMode = true; 
                // –ü—Ä–æ—Å—Ç–æ –∑–∞–ø—É—Å–∫–∞–µ–º –ø–µ—Ä–µ—Å—á–µ—Ç –∫–∞—Ä—Ç–∏–Ω–∫–∏ —Å –¢–ï–ö–£–©–ò–ú–ò –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
                processStockImage(); 
                return;
            }
            // ----------------------------------

            const shift = (val, range) => Math.max(0, Math.min(200, val + (Math.random() * range * 2 - range)));
            
            if (val === 'bw') {
                 extractPaletteQuantized(); aiBasePalette = [...currentPalette]; currentPalette = [...PRESETS['bw']];
            }
            else if(val === 'custom') { 
                document.getElementById('colorCount').value = currentPalette.length;
                const savedColors = [...currentPalette];
                extractPaletteQuantized();
                aiBasePalette = [...currentPalette];
                currentPalette = savedColors;
            } 
            else if(val === 'original') extractPaletteQuantized(); 
            else if (val === 'random_chaos') { generateChaosPalette(); } 
            else if (val === 'smart_neon') { 
                updateCustomColorCount(parseInt(document.getElementById('colorCount').value));
                extractPaletteQuantized(); 
                aiBasePalette = [...currentPalette]; 
                generateSmartPalette(true); 
            } 
            else if (val === 'popart') { 
                extractPaletteQuantized(); aiBasePalette = [...currentPalette]; currentPalette = [...LEGO_PALETTE]; 
            }
else if (val === 'pixelart') {  // <<<<< –î–û–ë–ê–í–õ–ï–ù–û
        extractPaletteQuantized();  // <<<<< –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø–∞–ª–∏—Ç—Ä—É –∑–∞–Ω–æ–≤–æ
        aiBasePalette = [];         // <<<<< –°–±—Ä–∞—Å—ã–≤–∞–µ–º –±–∞–∑—É
    }
            renderPaletteUI(); 
            if(sourceImage) processImage(); 
        }
        function rgbToHex(r, g, b) { return "#" + [r, g, b].map(x => Math.round(x).toString(16).padStart(2, '0')).join(''); }
        function getContrastColor(hex) { const r = parseInt(hex.substr(1,2),16), g = parseInt(hex.substr(3,2),16), b = parseInt(hex.substr(5,2),16); return (r*0.299 + g*0.587 + b*0.114) > 186 ? '#000' : '#fff'; }
        function hslToHex(h, s, l) { l /= 100; const a = s * Math.min(l, 1 - l) / 100; const f = n => { const k = (n + h / 30) % 12; const color = l - a * Math.max(Math.min(k - 3, 9 - k, 1), -1); return Math.round(255 * color).toString(16).padStart(2, '0'); }; return `#${f(0)}${f(8)}${f(4)}`; }
        
        function generateSmartPalette(isNeon) { 
            const count = isNeon ? parseInt(document.getElementById('colorCount').value) : 5; 
            const hue = Math.floor(Math.random() * 360); 
            currentPalette = []; 
            for(let i=0; i<count; i++) {
                currentPalette.push(hslToHex((isNeon ? (hue + i*30)%360 : hue), isNeon ? 90 : 40, 10 + (i * (85 / (count > 1 ? count - 1 : 1))))); 
            }
        }
        
        function updateStats() {
            // –ï—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω —Ä–µ–∂–∏–º –°–≤–æ–π AI, —Ä–∏—Å—É–µ–º –ø–æ–ª—è –≤–≤–æ–¥–∞, –∞ –Ω–µ –æ–±—ã—á–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            if (isStockMode) {
                // –ï—Å–ª–∏ –º—ã —Å–µ–π—á–∞—Å –ø–µ—á–∞—Ç–∞–µ–º –≤ –∏–Ω–ø—É—Ç–µ, –Ω–µ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º DOM, —á—Ç–æ–±—ã –Ω–µ —Å–ª–µ—Ç–∞–ª —Ñ–æ–∫—É—Å
                if (document.activeElement && document.activeElement.classList.contains('stock-input-field')) {
                    return; 
                }
                
                renderStockInputs();
                return;
            }

            const flat = finalMatrix.flat(); 
            const counts = new Array(currentPalette.length).fill(0); 
            flat.forEach(i => { if(counts[i] !== undefined) counts[i]++; });
            
            const preset = document.getElementById('palettePreset').value; 
            const isRestricted = ['bw', 'popart'].includes(preset); 
            const isEditable = !isRestricted; 
            const borderSel = document.getElementById('borderColor'); 
            const oldBorder = borderSel.value; 
            borderSel.innerHTML = '';
            
            const statsContainer = document.getElementById('statsContent'); 
            
            statsContainer.innerHTML = ''; // –í—Å–µ–≥–¥–∞ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –¥–ª—è —á–∏—Å—Ç–æ—Ç—ã
            
            counts.forEach((c, i) => { 
                const sym = currentSymbolSet[i] || "?"; 
                const row = document.createElement('div'); 
                row.className = 'stat-row'; 
                row.style.display = 'flex'; 
                row.style.justifyContent = 'space-between'; 
                row.style.marginBottom = '2px'; 
                row.style.fontSize = '11px'; 
                
                const colorSpan = document.createElement('span'); 
                colorSpan.id = `stat-circle-${i}`; 
                colorSpan.style.display = 'inline-flex'; 
                colorSpan.style.justifyContent = 'center'; 
                colorSpan.style.alignItems = 'center'; 
                colorSpan.style.width = '14px'; 
                colorSpan.style.height = '14px'; 
                colorSpan.style.borderRadius = '50%'; 
                colorSpan.style.background = currentPalette[i]; 
                colorSpan.style.marginRight = '5px'; 
                colorSpan.style.position = 'relative'; 
                colorSpan.style.fontSize = '9px'; 
                colorSpan.style.fontWeight = '900'; 
                colorSpan.style.color = getContrastColor(currentPalette[i]); 
                colorSpan.innerText = sym; 
                
                if(isEditable) { 
                    const inp = document.createElement('input'); 
                    inp.type = 'color'; 
                    inp.value = currentPalette[i]; 
                    inp.style.position = 'absolute'; 
                    inp.style.top = '0'; 
                    inp.style.left = '0'; 
                    inp.style.opacity = '0'; 
                    inp.style.width = '100%'; 
                    inp.style.height = '100%'; 
                    inp.style.cursor = 'pointer'; 
                    inp.oninput = (e) => handleStatColorChange(i, e.target.value); 
                    inp.onchange = () => pushHistory(); 
                    colorSpan.appendChild(inp); 
                } 
                
                const textSpan = document.createElement('span'); 
                textSpan.appendChild(colorSpan); 
                const symText = document.createElement('span'); 
                symText.id = `stat-sym-text-${i}`; 
                symText.innerText = sym; 
                textSpan.appendChild(symText); 
                
                const countBold = document.createElement('b'); 
                countBold.id = `stat-count-${i}`; 
                countBold.innerText = c; 
                
                row.appendChild(textSpan); 
                row.appendChild(countBold); 
                statsContainer.appendChild(row); 
                
                const opt = document.createElement('option'); 
                opt.value = i; 
                opt.innerText = `–¶–≤–µ—Ç ${sym}`; 
                opt.style.background = currentPalette[i]; 
                opt.style.color = getContrastColor(currentPalette[i]); 
                borderSel.appendChild(opt); 
            });

            const total = flat.length; 
            document.getElementById('totalBricks').innerText = total; 
            const price = parseFloat(document.getElementById('brickPrice').value) || 0; 
            document.getElementById('totalCost').innerText = (total * price).toFixed(2) + " ‚ÇΩ"; 
            borderSel.value = oldBorder || 0;
        }

        function handleStatColorChange(i, val) { 
            currentPalette[i] = val; 
            drawPreview(finalMatrix[0].length, finalMatrix.length); 
            if(document.getElementById('instructionView').style.display === 'block') drawGrid(); 
            renderPaletteUI(); 
            const circleEl = document.getElementById(`stat-circle-${i}`); 
            if(circleEl) { 
                circleEl.style.background = val; 
                circleEl.style.color = getContrastColor(val); 
            } 
        }
// –§—É–Ω–∫—Ü–∏—è-–ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è –ø–ª–∞–≤–Ω–æ–≥–æ –ø–µ—Ä–µ—Ö–æ–¥–∞
function runTransition(callback) {
    const overlay = document.getElementById('transitionOverlay');
    
    // 1. –í–∫–ª—é—á–∞–µ–º –∑–∞—Ç–µ–º–Ω–µ–Ω–∏–µ
    overlay.classList.add('active');
    
    // 2. –ñ–¥–µ–º, –ø–æ–∫–∞ —ç–∫—Ä–∞–Ω —Å—Ç–∞–Ω–µ—Ç —á–µ—Ä–Ω—ã–º (250–º—Å –∫–∞–∫ –≤ CSS)
    setTimeout(() => {
        
        // 3. –í—ã–ø–æ–ª–Ω—è–µ–º "—Ä–µ–∑–∫–æ–µ" –¥–µ–π—Å—Ç–≤–∏–µ (–ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫ –∏–ª–∏ —Ñ—É–ª—Å–∫—Ä–∏–Ω–∞)
        callback();
        
        // 4. –î–∞–µ–º –±—Ä–∞—É–∑–µ—Ä—É –æ—Ç—Ä–∏—Å–æ–≤–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏ —É–±–∏—Ä–∞–µ–º –∑–∞—Ç–µ–º–Ω–µ–Ω–∏–µ
        requestAnimationFrame(() => {
            setTimeout(() => {
                overlay.classList.remove('active');
            }, 50);
        });
        
    }, 250);
}
       function switchTab(t) {
    // –û–±–æ—Ä–∞—á–∏–≤–∞–µ–º –≤—Å—é –ª–æ–≥–∏–∫—É –≤ –∞–Ω–∏–º–∞—Ü–∏—é
    runTransition(() => {
        // –ú–µ–Ω—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É –≤ –º–µ–Ω—é
        document.querySelectorAll('.toggle-opt').forEach(b => b.classList.remove('active')); 
        document.getElementById('tab-'+t).classList.add('active');

        const isPreview = (t === 'preview');

        // 1. –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–∞—Å—à—Ç–∞–±
        if (isPreview) {
            document.getElementById('gridZoom').value = previewZoom;
            document.getElementById('zoomText').innerText = previewZoom + '%';
            updateGridScale(previewZoom); 
        } else {
            document.getElementById('gridZoom').value = schemeZoom;
            document.getElementById('zoomText').innerText = schemeZoom + '%';
            updateGridScale(schemeZoom); 
        }

        // 2. –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∏–¥–∏–º–æ—Å—Ç–∏
        document.getElementById('previewContainer').style.display = isPreview ? 'flex' : 'none'; 
        document.getElementById('instructionView').style.display = isPreview ? 'none' : 'block';
        
        // 3. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∞–º–∏
        const pencilBtn = document.getElementById('pencilBtn'); 
        const lockBtn = document.getElementById('gestureLockBtn');
        
        if(isPreview) { 
            pencilBtn.style.display = 'flex'; 
            if(lockBtn) lockBtn.style.display = 'flex'; 
        } else { 
            pencilBtn.style.display = 'none'; 
            if(lockBtn) lockBtn.style.display = 'none'; 
            if(isPencil) togglePencil(); 
        }
        
        // 4. –ù–∞–≤–∏–≥–∞—Ü–∏—è
        const nav = document.getElementById('sectorNav'); 
        const zoomControl = document.getElementById('gridZoomControl'); 
        
        nav.style.display = isPreview ? 'none' : 'block'; 
        zoomControl.style.display = isPreview ? 'none' : 'flex'; 
        
        // 5. –†–µ–∂–∏–º –∫–∞—Ä—Ç–æ—á–∫–∏
        const stage = document.querySelector('.stage'); 
        if(t === 'instruction') { 
            stage.classList.add('expanded-mode'); 
        } else { 
            stage.classList.remove('expanded-mode'); 
        }
        
        if(!isPreview) drawGrid();
    });
}
        function togglePencil() { isPencil = !isPencil; document.getElementById('pencilBtn').classList.toggle('active', isPencil); document.querySelector('.viewport').classList.toggle('pencil-mode', isPencil); renderPaletteUI(); }
        function setSector(s) { currentSector = s; document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active')); if(s === 'all') document.getElementById('sec-all').classList.add('active'); else document.querySelector(`.nav-${s}`).classList.add('active'); drawGrid(); }
        
        /* === –í–°–¢–ê–í–ò–¢–¨ –í–ú–ï–°–¢–û –°–¢–ê–†–û–ô function drawGrid === */



function drawGrid(targetContainer = null, printMode = false) {
    const container = targetContainer || document.getElementById('gridContainer'); 
    if(!printMode) container.innerHTML = ''; 
    if(finalMatrix.length === 0) return;

    const fullH = finalMatrix.length; 
    const fullW = finalMatrix[0].length; 
    let sX = 0, eX = fullW, sY = 0, eY = fullH; 
    const midX = Math.ceil(fullW / 2); 
    const midY = Math.ceil(fullH / 2);

    if(currentSector === 1) { eX = midX; eY = midY; } 
    else if(currentSector === 2) { sX = midX; eY = midY; } 
    else if(currentSector === 3) { eX = midX; sY = midY; } 
    else if(currentSector === 4) { sX = midX; sY = midY; }

    // 1. –ó–ê–ü–û–ú–ò–ù–ê–ï–ú –ì–†–ê–ù–ò–¶–´
    currentGridBounds = { sX, eX, sY, eY };

    // 2. –†–∏—Å—É–µ–º —Å–µ—Ç–∫—É (—ç—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è —É —Ç–µ–±—è –µ—Å—Ç—å, –º—ã –µ—ë –Ω–µ —Ç—Ä–æ–≥–∞–µ–º)
    renderSingleGrid(container, sX, eX, sY, eY, printMode);
    
    // 3. –í—ã–∑—ã–≤–∞–µ–º –∑–∞—Ç–µ–º–Ω–µ–Ω–∏–µ –í–°–ï–ì–î–ê (–±–µ–∑ –ø—Ä–æ–≤–µ—Ä–æ–∫ –Ω–∞ —Ñ—É–ª—Å–∫—Ä–∏–Ω)
    refreshGridVisibility();
    
    if(!printMode) { 
        const grid = container.querySelector('.instruction-grid'); 
        if(grid) grid.style.transform = `scale(${document.getElementById('gridZoom').value / 100})`; 
    }
}

        function renderSingleGrid(container, sX, eX, sY, eY, isPrint) {
            const visW = eX - sX; 
            const grid = document.createElement('div'); 
            grid.className = 'instruction-grid'; 
            
            // –í–∫–ª—é—á–∞–µ–º GPU —Å—Ä–∞–∑—É –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏
            if (!isPrint) {
                grid.style.willChange = 'transform';
                grid.style.transformOrigin = '0 0';
            }
            
            const cellW = isPrint ? 25 : 20;
            grid.style.gridTemplateColumns = `25px repeat(${visW}, ${cellW}px) auto`;

            // –í–µ—Ä—Ö–Ω—è—è –ª–∏–Ω–µ–π–∫–∞
            grid.appendChild(createCell('ruler-cell', '')); 
            for(let x=sX; x<eX; x++) { 
                const c = createCell('ruler-cell', x+1); 
                c.setAttribute('data-x', x); 
                if(!isPrint) c.onclick = function() { toggleColVisibility(x); }; 
                grid.appendChild(c); 
            }
            const infoHeader = document.createElement('div'); 
            infoHeader.className = 'info-header'; 
            infoHeader.innerText = '–ò–ù–§–û (–°–ò–ú–í–û–õ : –ö–û–õ-–í–û)'; 
            grid.appendChild(infoHeader);

            // –û—Å–Ω–æ–≤–Ω–∞—è —Å–µ—Ç–∫–∞
            for(let y=sY; y<eY; y++) {
                const rC = createCell('ruler-cell', y+1); 
                rC.setAttribute('data-y', y); 
                if(!isPrint) rC.onclick = function() { toggleRowVisibility(y); }; 
                grid.appendChild(rC);

                let rowStats = {}; 

                for(let x=sX; x<eX; x++) { 
                    const idx = finalMatrix[y][x]; 
                    if (!rowStats[idx]) rowStats[idx] = 0;
                    rowStats[idx]++;

                    const palCol = displayPalette[idx] || currentPalette[idx] || '#000'; 
                    const sym = displaySymbols[idx] || "?"; 

                    const cell = createCell('cell', sym); 
                    cell.style.backgroundColor = palCol; 
                    
                    const hex = palCol.replace('#','');
                    const r = parseInt(hex.substr(0,2),16), g = parseInt(hex.substr(2,2),16), b = parseInt(hex.substr(4,2),16); 
                    cell.style.color = (r*0.299 + g*0.587 + b*0.114) > 186 ? '#000' : '#fff'; 
                    
                    if(!isPrint && isPencil) { 
                        cell.onclick = () => { 
                            pushHistory(); 
                            finalMatrix[y][x] = (finalMatrix[y][x] + 1) % currentPalette.length; 
                            drawPreview(finalMatrix[0].length, finalMatrix.length); 
                            updateStats(); 
                            drawGrid(); 
                        }; 
                    } 
                    grid.appendChild(cell); 
                }

                // –ò–Ω—Ñ–æ-–ø–∞–Ω–µ–ª—å
                const info = document.createElement('div'); 
                info.className = 'row-info'; 
                info.setAttribute('data-y', y); 
                
                const presentIndices = Object.keys(rowStats).map(Number).sort((a,b) => a-b);
                presentIndices.forEach(idx => {
                    const count = rowStats[idx];
                    const pCol = displayPalette[idx] || '#000';
                    const pSym = displaySymbols[idx] || '?';
                    const pHex = pCol.replace('#','');
                    const pR = parseInt(pHex.substr(0,2),16), pG = parseInt(pHex.substr(2,2),16), pB = parseInt(pHex.substr(4,2),16); 
                    const textCol = (pR*0.299 + pG*0.587 + pB*0.114) > 186 ? '#000' : '#fff';

                    info.innerHTML += `<span style="padding:0 3px; border-radius:3px; margin-right:2px; display:inline-block; font-size:9px; height:14px; line-height:14px; background:${pCol}; color:${textCol}; border:1px solid rgba(0,0,0,0.2);">${pSym}:${count}</span>`;
                });

                if(!isPrint) info.onclick = function() { toggleRowVisibility(y); }; 
                grid.appendChild(info);
            }
            
            container.appendChild(grid);
            
            // --- –í–ê–ñ–ù–û: –ó–ê–ü–û–ú–ò–ù–ê–ï–ú –†–ê–ó–ú–ï–†–´ –¢–£–¢ ---
            if (!isPrint) {
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –º–∞—Å—à—Ç–∞–± –ø–µ—Ä–µ–¥ –∏–∑–º–µ—Ä–µ–Ω–∏–µ–º, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å "—á–∏—Å—Ç—ã–π" —Ä–∞–∑–º–µ—Ä
                grid.style.transform = 'scale(1)';
                gridBaseWidth = grid.offsetWidth;
                gridBaseHeight = grid.offsetHeight;
                
                // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –º–∞—Å—à—Ç–∞–± –∫–∞–∫ –Ω–∞ –ø–æ–ª–∑—É–Ω–∫–µ
                const currentScale = parseInt(document.getElementById('gridZoom').value) / 100;
                grid.style.transform = `scale(${currentScale})`;
                
                // –°—Ä–∞–∑—É –ø—Ä–∏–º–µ–Ω—è–µ–º —Ä–∞–∑–º–µ—Ä –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—É
                container.style.width = (gridBaseWidth * currentScale) + 'px';
                container.style.height = (gridBaseHeight * currentScale) + 'px';
            }
        }

        function createCell(cls, txt) { const d=document.createElement('div'); d.className=cls; d.innerText=txt; return d; }
        
        /* --- –ù–û–í–ê–Ø –°–ò–°–¢–ï–ú–ê –£–ú–ù–û–ì–û –í–´–î–ï–õ–ï–ù–ò–Ø –ü–û –°–ï–ö–¢–û–†–ê–ú --- */

        /* --- –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –°–ò–°–¢–ï–ú–ê –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–ò –í–´–î–ï–õ–ï–ù–ò–ô --- */

/* --- –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –°–ò–°–¢–ï–ú–ê –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–ò (–°–ï–ì–ú–ï–ù–¢–ù–û–ï –í–´–î–ï–õ–ï–ù–ò–ï) --- */

function toggleRowVisibility(y) {
    // 1. –ë–µ—Ä–µ–º —Ç–µ–∫—É—â–∏–µ –≥—Ä–∞–Ω–∏—Ü—ã –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ (–∫–∞–∫–æ–π —Å–µ–π—á–∞—Å —Å–µ–∫—Ç–æ—Ä –∏–ª–∏ –≤—Å—è —Å—Ö–µ–º–∞)
    const { sX, eX } = currentGridBounds;
    
    // 2. –§–æ—Ä–º–∏—Ä—É–µ–º –£–ù–ò–ö–ê–õ–¨–ù–´–ô –∫–ª—é—á –¥–ª—è —ç—Ç–æ–≥–æ —Å–µ–≥–º–µ–Ω—Ç–∞
    // –ë—ã–ª–æ: "row_5" (–≥–ª—É–ø–æ, –∫—Ä–∞—Å–∏—Ç –≤—Å—ë)
    // –°—Ç–∞–ª–æ: "row_5_0_25" (—É–º–Ω–æ, –∫—Ä–∞—Å–∏—Ç —Ç–æ–ª—å–∫–æ —ç—Ç–æ—Ç –∫—É—Å–æ–∫)
    const key = `row_${y}_${sX}_${eX}`;

    if (hiddenRegions.has(key)) hiddenRegions.delete(key);
    else hiddenRegions.add(key);
    
    refreshGridVisibility(); 
}

function toggleColVisibility(x) {
    const { sY, eY } = currentGridBounds;
    // –¢–æ –∂–µ —Å–∞–º–æ–µ –¥–ª—è –∫–æ–ª–æ–Ω–æ–∫: –ø—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –∫ –≤—ã—Å–æ—Ç–µ —Ç–µ–∫—É—â–µ–≥–æ —Å–µ–∫—Ç–æ—Ä–∞
    const key = `col_${x}_${sY}_${eY}`;

    if (hiddenRegions.has(key)) hiddenRegions.delete(key);
    else hiddenRegions.add(key);
    
    refreshGridVisibility(); 
}

function refreshGridVisibility() {
    const grid = document.querySelector('.instruction-grid'); 
    if(!grid) return; 

    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ —Å–ª–æ–∏ –∑–∞—Ç–µ–º–Ω–µ–Ω–∏—è
    grid.querySelectorAll('.shade-layer').forEach(e => e.remove()); 

    const CELL_SIZE = 20; // –†–∞–∑–º–µ—Ä –∫–ª–µ—Ç–∫–∏ (–¥–ª—è –ø–µ—á–∞—Ç–∏ –º–æ–∂–µ—Ç –æ—Ç–ª–∏—á–∞—Ç—å—Å—è, –Ω–æ —Ç—É—Ç —ç–∫—Ä–∞–Ω)
    const HEADER_SIZE = 25; // –†–∞–∑–º–µ—Ä –ª–∏–Ω–µ–π–∫–∏ —Å —Ü–∏—Ñ—Ä–∞–º–∏

    // –¢–µ–∫—É—â–∏–µ –≤–∏–¥–∏–º—ã–µ –≥—Ä–∞–Ω–∏—Ü—ã (viewport —Å—Ö–µ–º—ã)
    const view = currentGridBounds; // { sX, eX, sY, eY }

    hiddenRegions.forEach(key => {
        const parts = key.split('_');
        const type = parts[0];
        const index = parseInt(parts[1]);
        const start = parseInt(parts[2]); // –ù–∞—á–∞–ª–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–≥–æ –∫—É—Å–∫–∞
        const end = parseInt(parts[3]);   // –ö–æ–Ω–µ—Ü —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–≥–æ –∫—É—Å–∫–∞

        // –õ–û–ì–ò–ö–ê –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–ò:
        // –ú—ã –ø—Ä–æ–≤–µ—Ä—è–µ–º, –ø–µ—Ä–µ—Å–µ–∫–∞–µ—Ç—Å—è –ª–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π –∫—É—Å–æ–∫ (start-end) 
        // —Å —Ç–µ–º, —á—Ç–æ –º—ã —Å–µ–π—á–∞—Å –≤–∏–¥–∏–º –Ω–∞ —ç–∫—Ä–∞–Ω–µ (view.sX - view.eX)

        if (type === 'row') {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤–∏–¥–µ–Ω –ª–∏ —ç—Ç–æ—Ç —Ä—è–¥ –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏
            if (index >= view.sY && index < view.eY) {
                
                // –í—ã—á–∏—Å–ª—è–µ–º –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ –ø–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏
                // (–ù–∞–ø—Ä–∏–º–µ—Ä: —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ 0-25, —Å–º–æ—Ç—Ä–∏–º 0-50 -> —Ä–∏—Å—É–µ–º 0-25)
                // (–ù–∞–ø—Ä–∏–º–µ—Ä: —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ 0-25, —Å–º–æ—Ç—Ä–∏–º 25-50 -> –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è –Ω–µ—Ç, –Ω–µ —Ä–∏—Å—É–µ–º)
                const drawStart = Math.max(view.sX, start);
                const drawEnd = Math.min(view.eX, end);

                if (drawEnd > drawStart) {
                    const shade = document.createElement('div');
                    shade.className = 'shade-layer';
                    
                    const relativeY = index - view.sY;
                    const relativeX = drawStart - view.sX; // –°–¥–≤–∏–≥ –≤–Ω—É—Ç—Ä–∏ —Ç–µ–∫—É—â–µ–≥–æ –≤–∏–¥–∞
                    const widthCells = drawEnd - drawStart;

                    shade.style.top = `${HEADER_SIZE + (relativeY * CELL_SIZE)}px`;
                    shade.style.height = `${CELL_SIZE}px`;
                    
                    shade.style.left = `${HEADER_SIZE + (relativeX * CELL_SIZE)}px`;
                    shade.style.width = `${widthCells * CELL_SIZE}px`; 
                    
                    grid.appendChild(shade);
                }
            }
        } 
        else if (type === 'col') {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤–∏–¥–Ω–∞ –ª–∏ —ç—Ç–∞ –∫–æ–ª–æ–Ω–∫–∞ –ø–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏
            if (index >= view.sX && index < view.eX) {
                
                // –í—ã—á–∏—Å–ª—è–µ–º –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏
                const drawStart = Math.max(view.sY, start);
                const drawEnd = Math.min(view.eY, end);

                if (drawEnd > drawStart) {
                    const shade = document.createElement('div');
                    shade.className = 'shade-layer';
                    
                    const relativeX = index - view.sX;
                    const relativeY = drawStart - view.sY;
                    const heightCells = drawEnd - drawStart;

                    shade.style.left = `${HEADER_SIZE + (relativeX * CELL_SIZE)}px`;
                    shade.style.width = `${CELL_SIZE}px`;
                    
                    shade.style.top = `${HEADER_SIZE + (relativeY * CELL_SIZE)}px`;
                    shade.style.height = `${heightCells * CELL_SIZE}px`; 
                    
                    grid.appendChild(shade);
                }
            }
        }
    });
}
        // --- –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –°–ò–°–¢–ï–ú–ê –ü–ï–ß–ê–¢–ò (FIX CYRILLIC) ---
        
        async function preparePrint() {
            if(!sourceImage) return;
            
            // 1. –ü–û–ö–ê–ó–´–í–ê–ï–ú –≠–ö–†–ê–ù –ó–ê–ì–†–£–ó–ö–ò
            const overlay = document.getElementById('loadingOverlay');
            overlay.style.display = 'flex';

            // –î–∞–µ–º –±—Ä–∞—É–∑–µ—Ä—É –º–≥–Ω–æ–≤–µ–Ω–∏–µ –Ω–∞ –æ—Ç—Ä–∏—Å–æ–≤–∫—É –∞–Ω–∏–º–∞—Ü–∏–∏ –ø–µ—Ä–µ–¥ —Ç—è–∂–µ–ª–æ–π —Ä–∞–±–æ—Ç–æ–π
            await new Promise(resolve => setTimeout(resolve, 100));

            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({
                    orientation: 'p',
                    unit: 'mm',
                    format: 'a4'
                });

                const margin = 20;
                const pageWidth = 210;
                const pageHeight = 297;
                const safeW = pageWidth - (margin * 2);
                
                // --- –°–¢–†–ê–ù–ò–¶–ê 1: –¢–ò–¢–£–õ–¨–ù–´–ô –õ–ò–°–¢ ---
                
                // –®–∞–ø–∫–∞
                const headerImg = await renderTitlePageHeader(safeW);
                const headerProps = doc.getImageProperties(headerImg);
                const headerPdfH = (headerProps.height * safeW) / headerProps.width;
                doc.addImage(headerImg, 'PNG', margin, margin, safeW, headerPdfH);

                // –ü—Ä–µ–≤—å—é (JPEG 0.8)
                const mainCanvas = document.getElementById('mainCanvas');
                const imgData = mainCanvas.toDataURL('image/jpeg', 0.8);
                
                const currentY = margin + headerPdfH + 10; 
                const hRem = pageHeight - margin - currentY; 
                
                if (hRem > 50) {
                    addImageFit(doc, imgData, margin, currentY, safeW, hRem);
                }

                // --- –°–¢–†–ê–ù–ò–¶–´ –°–ï–ö–¢–û–†–û–í ---
                const fullW = finalMatrix[0].length;
                const fullH = finalMatrix.length;
                const midX = Math.ceil(fullW / 2);
                const midY = Math.ceil(fullH / 2);

                const sectors = [
                    { name: '–õ–ï–í–´–ô –í–ï–†–•', sx: 0, ex: midX, sy: 0, ey: midY },
                    { name: '–ü–†–ê–í–´–ô –í–ï–†–•', sx: midX, ex: fullW, sy: 0, ey: midY },
                    { name: '–õ–ï–í–´–ô –ù–ò–ó', sx: 0, ex: midX, sy: midY, ey: fullH },
                    { name: '–ü–†–ê–í–´–ô –ù–ò–ó', sx: midX, ex: fullW, sy: midY, ey: fullH },
                    { name: '–û–ë–©–ò–ô –í–ò–î', sx: 0, ex: fullW, sy: 0, ey: fullH }
                ];

                for (let i = 0; i < sectors.length; i++) {
                    const s = sectors[i];
                    if (s.sx >= s.ex || s.sy >= s.ey) continue;

                    doc.addPage();

                    // –ó–∞–≥–æ–ª–æ–≤–æ–∫
                    const titleImg = await renderTextToImage(s.name, 24);
                    doc.addImage(titleImg, 'PNG', margin, 10, safeW, 10);

                    // –°—Ö–µ–º–∞ (Small Cells)
                    const sectorImg = await renderSectorToImage(s.sx, s.ex, s.sy, s.ey);
                    
                    const contentH = pageHeight - 25 - margin;
                    addImageFit(doc, sectorImg, margin, 25, safeW, contentH);
                }

                window.open(doc.output('bloburl'), '_blank');

            } catch (err) {
                console.error(err);
                alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ PDF");
            } finally {
                // 2. –°–ö–†–´–í–ê–ï–ú –≠–ö–†–ê–ù –í –õ–Æ–ë–û–ú –°–õ–£–ß–ê–ï (–î–ê–ñ–ï –ü–†–ò –û–®–ò–ë–ö–ï)
                overlay.style.display = 'none';
            }
        }

        // –†–µ–Ω–¥–µ—Ä —à–∞–ø–∫–∏ —Ç–∏—Ç—É–ª—å–Ω–æ–≥–æ –ª–∏—Å—Ç–∞ (–ó–∞–≥–æ–ª–æ–≤–æ–∫ + –ü–∞—Ä–∞–º–µ—Ç—Ä—ã + –õ–µ–≥–µ–Ω–¥–∞ —Ü–≤–µ—Ç–æ–≤)
        function renderTitlePageHeader(pdfWidthMm) {
            return new Promise((resolve) => {
                // --- –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø: Scale 2 –≤–º–µ—Å—Ç–æ 4 ---
                const scale = 2; 
                const w = pdfWidthMm * 3.78 * scale; 
                const h = 1000 * scale; 
                
                const cvs = document.createElement('canvas');
                cvs.width = w;
                cvs.height = h; 
                const ctx = cvs.getContext('2d');
                
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0,0,w,h);

                let cursorY = 50 * scale;
                const centerX = w / 2;

                // 1. –ì–ª–∞–≤–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫
                ctx.fillStyle = '#000000';
                ctx.font = `bold ${22 * scale}px sans-serif`;
                ctx.textAlign = 'center';
                ctx.fillText("–°–•–ï–ú–ê –°–ë–û–†–ö–ò –ò –ï–Å –ü–ê–†–ê–ú–ï–¢–†–´", centerX, cursorY);
                
                cursorY += 30 * scale;

                // 2. –ü–∞—Ä–∞–º–µ—Ç—Ä—ã
                ctx.font = `normal ${14 * scale}px sans-serif`;
                const flat = finalMatrix.flat();
                const dims = `${finalMatrix[0].length} x ${finalMatrix.length}`;
                const total = flat.length;
                
                ctx.fillText(`–†–∞–∑–º–µ—Ä: ${dims} (–±–ª–æ–∫–æ–≤)  |  –í—Å–µ–≥–æ –¥–µ—Ç–∞–ª–µ–π: ${total} —à—Ç.`, centerX, cursorY);
                cursorY += 40 * scale;

                // 3. –õ–µ–≥–µ–Ω–¥–∞ —Ü–≤–µ—Ç–æ–≤
                const counts = new Array(currentPalette.length).fill(0);
                flat.forEach(i => { if(counts[i] !== undefined) counts[i]++; });

                ctx.textAlign = 'left';
                const boxSize = 20 * scale;
                const fontSize = 12 * scale;
                ctx.font = `normal ${fontSize}px sans-serif`;
                
                let startX = 20 * scale; 
                let curX = startX;
                
                currentPalette.forEach((color, i) => {
                    if (counts[i] > 0) {
                        const sym = currentSymbolSet[i] || "?";
                        const txt = ` ${sym} = ${counts[i]} —à—Ç.`;
                        const textWidth = ctx.measureText(txt).width;
                        const itemWidth = boxSize + textWidth + (15 * scale);

                        if (curX + itemWidth > w - startX) {
                            curX = startX;
                            cursorY += boxSize + (15 * scale);
                        }

                        ctx.fillStyle = color;
                        ctx.fillRect(curX, cursorY, boxSize, boxSize);
                        ctx.strokeStyle = '#000000';
                        ctx.lineWidth = 1 * scale; // –ß—É—Ç—å —Ç–æ–Ω—å—à–µ –ª–∏–Ω–∏—è
                        ctx.strokeRect(curX, cursorY, boxSize, boxSize);

                        ctx.fillStyle = getContrastColor(color);
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.font = `bold ${fontSize}px sans-serif`;
                        ctx.fillText(sym, curX + boxSize/2, cursorY + boxSize/2);

                        ctx.fillStyle = '#000000';
                        ctx.textAlign = 'left';
                        ctx.font = `normal ${fontSize}px sans-serif`;
                        ctx.fillText(txt, curX + boxSize, cursorY + boxSize/2);

                        curX += itemWidth;
                    }
                });
                
                const finalH = cursorY + boxSize + (20 * scale);
                const finalCvs = document.createElement('canvas');
                finalCvs.width = w;
                finalCvs.height = finalH;
                const fCtx = finalCvs.getContext('2d');
                fCtx.drawImage(cvs, 0, 0);
                
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º JPEG 0.8 –¥–ª—è –ª–µ–≥–µ–Ω–¥—ã (—Ç–∞–º –º–Ω–æ–≥–æ —Ü–≤–µ—Ç–æ–≤) –∏–ª–∏ PNG
                resolve(finalCvs.toDataURL('image/png'));
            });
        }

        // –†–µ–Ω–¥–µ—Ä –ø—Ä–æ—Å—Ç–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ –≤ –∫–∞—Ä—Ç–∏–Ω–∫—É (–¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ —Å—Ç—Ä–∞–Ω–∏—Ü)
        function renderTextToImage(text, sizeMm) {
            return new Promise((resolve) => {
                // --- –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø: Scale 2 –≤–º–µ—Å—Ç–æ 4 ---
                const scale = 2;
                const w = 210 * 3.78 * scale; 
                const h = sizeMm * 3.78 * scale;
                
                const cvs = document.createElement('canvas');
                cvs.width = w;
                cvs.height = h;
                const ctx = cvs.getContext('2d');
                
                ctx.fillStyle = '#000000';
                ctx.font = `bold ${16 * scale}px sans-serif`; 
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                
                ctx.fillText(text, w/2, h/2);
                
                resolve(cvs.toDataURL('image/png'));
            });
        }

        function addImageFit(doc, imgData, x, y, w, h) {
            const props = doc.getImageProperties(imgData);
            const imgW = props.width;
            const imgH = props.height;
            const aspect = imgW / imgH;
            const boxAspect = w / h;
            let finalW, finalH;
            if (aspect > boxAspect) { finalW = w; finalH = w / aspect; } 
            else { finalH = h; finalW = h * aspect; }
            const offX = x + (w - finalW) / 2;
            const offY = y + (h - finalH) / 2;
            doc.addImage(imgData, 'PNG', offX, offY, finalW, finalH);
        }

        function renderSectorToImage(sx, ex, sy, ey) {
            return new Promise((resolve) => {
                // --- –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø: –†–∞–∑–º–µ—Ä —è—á–µ–π–∫–∏ 15px –≤–º–µ—Å—Ç–æ 30px ---
                const cellSize = 15; 
                const headerSize = 15; // –¢–æ–∂–µ —É–º–µ–Ω—å—à–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
                
                const cols = ex - sx;
                const rows = ey - sy;
                const cvs = document.createElement('canvas');
                cvs.width = headerSize + (cols * cellSize);
                cvs.height = headerSize + (rows * cellSize);
                const ctx = cvs.getContext('2d');
                
                // –ë–µ–ª—ã–π —Ñ–æ–Ω
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0, 0, cvs.width, cvs.height);
                
                // –®—Ä–∏—Ñ—Ç –ø–æ–º–µ–Ω—å—à–µ
                ctx.font = 'bold 8px sans-serif'; 
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                
                // –õ–∏–Ω–µ–π–∫–∏
                ctx.fillStyle = '#eeeeee';
                ctx.fillRect(0, 0, cvs.width, headerSize); 
                ctx.fillRect(0, 0, headerSize, cvs.height); 
                ctx.strokeStyle = '#cccccc';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.fillStyle = '#333333';
                
                for (let x = 0; x < cols; x++) {
                    const absX = sx + x + 1;
                    const pX = headerSize + (x * cellSize);
                    ctx.fillText(absX, pX + cellSize/2, headerSize/2);
                    ctx.rect(pX, 0, cellSize, headerSize);
                }
                for (let y = 0; y < rows; y++) {
                    const absY = sy + y + 1;
                    const pY = headerSize + (y * cellSize);
                    ctx.fillText(absY, headerSize/2, pY + cellSize/2);
                    ctx.rect(0, pY, headerSize, cellSize);
                }
                ctx.stroke();

                // –Ø—á–µ–π–∫–∏
                for (let y = 0; y < rows; y++) {
                    for (let x = 0; x < cols; x++) {
                        const idx = finalMatrix[sy + y][sx + x];
                        const color = currentPalette[idx];
                        const sym = currentSymbolSet[idx] || "?";
                        
                        const pX = headerSize + (x * cellSize);
                        const pY = headerSize + (y * cellSize);
                        
                        ctx.fillStyle = color;
                        ctx.fillRect(pX, pY, cellSize, cellSize);
                        ctx.strokeRect(pX, pY, cellSize, cellSize);
                        
                        const contrast = getContrastColor(color);
                        ctx.fillStyle = contrast;
                        ctx.font = 'bold 9px sans-serif'; // –ß—É—Ç—å –±–æ–ª—å—à–µ, —á—Ç–æ–±—ã —á–∏—Ç–∞–ª–æ—Å—å
                        ctx.fillText(sym, pX + cellSize/2, pY + cellSize/2);
                    }
                }
                resolve(cvs.toDataURL('image/png'));
            });
        }
function renderStockInputs() {
            const statsContainer = document.getElementById('statsContent');
            statsContainer.innerHTML = '';
            
            // –°—á–∏—Ç–∞–µ–º —Ñ–∞–∫—Ç (—Å —É—á–µ—Ç–æ–º —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–π –ø–∞–ª–∏—Ç—Ä—ã)
            const flat = finalMatrix.flat();
            const usageMap = {}; // displayIdx -> count
            flat.forEach(i => usageMap[i] = (usageMap[i]||0) + 1);

            // –•–µ–¥–µ—Ä
            const headerRow = document.createElement('div');
            headerRow.style.display = 'flex';
headerRow.style.justifyContent = 'space-between';
headerRow.style.alignItems = 'center';
            headerRow.style.marginBottom = '10px'; headerRow.style.paddingBottom = '5px';
            headerRow.style.borderBottom = '1px solid rgba(255,255,255,0.1)';
            
            const title = document.createElement('div');
            title.innerHTML = '–°–ö–õ–ê–î (PRO)'; title.style.fontWeight = 'bold'; title.style.fontSize = '11px'; title.style.color = 'var(--primary)';
            
            const mixLabel = document.createElement('label');
            mixLabel.style.display='flex'; mixLabel.style.gap='5px'; mixLabel.style.fontSize='10px';
            const mixInput = document.createElement('input'); mixInput.type='checkbox'; mixInput.checked = useMixMode;
            mixInput.onchange = (e) => { useMixMode = e.target.checked; processStockImage(); };
            mixLabel.appendChild(mixInput); mixLabel.appendChild(document.createTextNode('–ú–Ø–ì–ö–ò–ô –ú–ò–ö–°'));
            
            headerRow.appendChild(title); headerRow.appendChild(mixLabel);
            statsContainer.appendChild(headerRow);

            // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Ç—Ä–æ–∫
            let totalStockSum = 0;
            
            currentPalette.forEach((col, i) => {
                // --- –ì–õ–ê–í–ù–´–ô –¶–í–ï–¢ ---
                const row = document.createElement('div');
                row.className = 'stock-input-row';
                row.style.background = 'rgba(255,255,255,0.03)';
                
                // –õ–µ–≤–æ
                const info = document.createElement('div'); info.className = 'stock-info';
                const colorBox = document.createElement('div'); colorBox.className = 'stock-color-preview'; colorBox.style.background = col;
                const sym = document.createElement('span'); sym.innerText = currentSymbolSet[i] || "?"; sym.style.fontWeight = '900';
                info.appendChild(colorBox); info.appendChild(sym);

                // –ü—Ä–∞–≤–æ
                const rightGroup = document.createElement('div'); rightGroup.style.display = 'flex'; rightGroup.style.alignItems = 'center'; rightGroup.style.gap = '4px';

                // –ö–Ω–æ–ø–∫–∞ +
                const addBtn = document.createElement('button');
                addBtn.innerText = '+';
                addBtn.style.width = '20px'; addBtn.style.height = '20px'; addBtn.style.borderRadius = '50%';
                addBtn.style.border = '1px solid #555'; addBtn.style.background = 'transparent'; addBtn.style.color = '#fff'; addBtn.style.cursor = 'pointer';
                addBtn.onclick = () => triggerHelperPicker(i);

                // –§–∞–∫—Ç (i - —ç—Ç–æ –∏–Ω–¥–µ–∫—Å –≤ displayPalette, —Ä–∞–≤–Ω—ã–π i –¥–ª—è –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ü–≤–µ—Ç–æ–≤)
                const used = usageMap[i] || 0;
                const limit = stockQuantities[i] || 0;
                totalStockSum += limit;

                const factSpan = document.createElement('span'); factSpan.innerText = used; factSpan.style.fontSize='10px';
                factSpan.style.color = (limit > 0 && used >= limit) ? '#ff5555' : '#aaa';
                
                const input = document.createElement('input');
                input.type = 'number'; input.className = 'stock-input-field'; input.style.width='50px';
                input.value = limit; input.oninput = (e) => { 
    stockQuantities[i] = parseInt(e.target.value)||0; 
    processImage(); // –ó–∞–ø—É—Å–∫–∞–µ–º –ø–µ—Ä–µ—Å—á–µ—Ç –∫–∞—Ä—Ç–∏–Ω–∫–∏, –∞ –Ω–µ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫—É –∏–Ω–ø—É—Ç–æ–≤
};

                rightGroup.appendChild(addBtn);
                rightGroup.appendChild(factSpan);
                rightGroup.appendChild(document.createTextNode('/'));
                rightGroup.appendChild(input);
                
                row.appendChild(info); row.appendChild(rightGroup);
                statsContainer.appendChild(row);

                // --- –ü–û–ú–û–©–ù–ò–ö–ò ---
                if (stockAssists[i]) {
                    stockAssists[i].forEach((assist, aIdx) => {
                        const subRow = document.createElement('div');
                        subRow.className = 'stock-input-row';
                        subRow.style.marginLeft = '20px'; // –û—Ç—Å—Ç—É–ø
                        subRow.style.borderLeft = '2px solid ' + col; // –°–≤—è–∑—å —Å —Ä–æ–¥–∏—Ç–µ–ª–µ–º
                        subRow.style.background = 'transparent';

                        const sInfo = document.createElement('div'); sInfo.className = 'stock-info';
                        const sBox = document.createElement('div'); 
                        sBox.className = 'stock-color-preview'; 
                        sBox.style.background = assist.hex; 
                        sBox.style.width='14px'; 
                        sBox.style.height='14px';
                        sBox.style.cursor = 'pointer'; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º, —á—Ç–æ –º–æ–∂–Ω–æ –Ω–∞–∂–∞—Ç—å
                        sBox.title = '–ù–∞–∂–º–∏, —á—Ç–æ–±—ã –∏–∑–º–µ–Ω–∏—Ç—å —Ü–≤–µ—Ç';
                        sBox.style.border = '1px solid #fff';
                        sBox.onclick = () => triggerHelperPicker(i, assist.id)

                        const sSym = document.createElement('span'); sSym.innerText = '‚Ü≥'; sSym.style.fontSize='10px';
                        sInfo.appendChild(sSym); sInfo.appendChild(sBox);
                        
                        const sRight = document.createElement('div'); sRight.style.display = 'flex'; sRight.style.alignItems = 'center'; sRight.style.gap = '4px';
                        
                        // –£–¥–∞–ª–∏—Ç—å
                        const delBtn = document.createElement('button'); delBtn.innerText = '√ó';
                        delBtn.style.color = '#ff5555'; delBtn.style.background='none'; delBtn.style.border='none'; delBtn.style.cursor='pointer';
                        delBtn.onclick = () => removeAssistant(i, assist.id);

                        // –§–∞–∫—Ç –ø–æ–º–æ—â–Ω–∏–∫–∞ (–Ω—É–∂–Ω–æ –Ω–∞–π—Ç–∏ –µ–≥–æ displayIdx)
                        // –ú—ã –Ω–µ –∑–Ω–∞–µ–º –µ–≥–æ displayIdx –∑–¥–µ—Å—å –ª–µ–≥–∫–æ, –Ω–æ –º—ã –º–æ–∂–µ–º –ø–µ—Ä–µ–±—Ä–∞—Ç—å displayPalette
                        // –≠—Ç–æ –Ω–µ–º–Ω–æ–≥–æ –¥–æ—Ä–æ–≥–æ, –Ω–æ –¥–ª—è UI –ø–æ–π–¥–µ—Ç
                        let assistDisplayIdx = -1;
                        // –ò—â–µ–º –∏–Ω–¥–µ–∫—Å –≤ displayPalette, –Ω–∞—á–∏–Ω–∞—è —Å 12
                        for(let d=currentPalette.length; d<displayPalette.length; d++) {
                             if(displayPalette[d] === assist.hex && displaySymbols[d].startsWith(currentSymbolSet[i])) {
                                 // –≠—Ç–æ —É–ø—Ä–æ—â–µ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞. –í –∏–¥–µ–∞–ª–µ ID —Ö—Ä–∞–Ω–∏—Ç—å.
                                 // –ù–æ —Ç–∞–∫ –∫–∞–∫ –º—ã –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –≤—Å–µ, —Å—á–∏—Ç–∞–µ–º –ø–æ —Ü–≤–µ—Ç—É
                             }
                        }
                        // –î–ª—è —Ç–æ—á–Ω–æ—Å—Ç–∏, –¥–∞–≤–∞–π—Ç–µ –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∂–µ–º –ª–∏–º–∏—Ç. –§–∞–∫—Ç —Å–ª–æ–∂–Ω–æ –ø—Ä–∏–≤—è–∑–∞—Ç—å –±–µ–∑ ID –≤ displayPalette.
                        // –ò–ª–∏ –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∂–µ–º "Input"
                        
                        const sInput = document.createElement('input');
                        sInput.type = 'number'; sInput.className = 'stock-input-field'; sInput.style.width='45px';
                        sInput.value = assist.qty; 
                        sInput.oninput = (e) => { 
    assist.qty = parseInt(e.target.value)||0; 
    processImage(); // –¢–æ –∂–µ —Å–∞–º–æ–µ –∑–¥–µ—Å—å
};
                        totalStockSum += assist.qty;

                        sRight.appendChild(delBtn);
                        sRight.appendChild(sInput);
                        
                        subRow.appendChild(sInfo);
                        subRow.appendChild(sRight);
                        statsContainer.appendChild(subRow);
                    });
                }
            });

            document.getElementById('totalBricks').innerText = `${flat.length} / ${totalStockSum}`;
        }
// --- –ì–õ–ê–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –†–ï–ñ–ò–ú–ê "–°–í–û–ô AI" (v5.0 - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è) ---
        // --- –ì–õ–ê–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –†–ï–ñ–ò–ú–ê "–°–í–û–ô AI" (v6.0 - Helper Logic Update) ---
        function processStockImage() {
            if (!sourceImage || !isStockMode) return;

            // 1. –°–±—Ä–æ—Å –∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞
            const count = parseInt(document.getElementById('colorCount').value);
            
            // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –º–∞—Å—Å–∏–≤ –∫–æ–ª–∏—á–µ—Å—Ç–≤
            while(stockQuantities.length < count) stockQuantities.push(0);
            updateCustomColorCount(count); 
            
            displayPalette = [...currentPalette];
            displaySymbols = [...currentSymbolSet];

            // --- –ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê: –û–ü–†–ï–î–ï–õ–Ø–ï–ú, –ö–¢–û –Ø–í–õ–Ø–ï–¢–°–Ø –ü–û–ú–û–©–ù–ò–ö–û–ú ---
            const helperIndices = new Set(); // –ò–Ω–¥–µ–∫—Å—ã —Ü–≤–µ—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ —Å—Ç–∞–ª–∏ "—Ä–∞–±–∞–º–∏" (–ø–æ–º–æ—â–Ω–∏–∫–∞–º–∏)
            const mainToHelpersMap = {}; // –ö–∞—Ä—Ç–∞: –ì–ª–∞–≤–Ω—ã–π–ò–Ω–¥–µ–∫—Å -> [–ò–Ω–¥–µ–∫—Å–ü–æ–º–æ—â–Ω–∏–∫–∞1, –ò–Ω–¥–µ–∫—Å–ü–æ–º–æ—â–Ω–∏–∫–∞2...]

            // 1. –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –≤—Å–µ–º –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–º –ø–æ–º–æ—â–Ω–∏–∫–∞–º –∏ –∏—â–µ–º –∏—Ö –≤ –æ—Å–Ω–æ–≤–Ω–æ–π –ø–∞–ª–∏—Ç—Ä–µ
            for (let mainIdx in stockAssists) {
                stockAssists[mainIdx].forEach(assist => {
                    // –ò—â–µ–º, –µ—Å—Ç—å –ª–∏ hex —ç—Ç–æ–≥–æ –ø–æ–º–æ—â–Ω–∏–∫–∞ –≤ —Ç–µ–∫—É—â–µ–π –ø–∞–ª–∏—Ç—Ä–µ
                    // (–ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Ä–µ–≥–∏—Å—Ç—Ä —Å–∏–º–≤–æ–ª–æ–≤ –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏)
                    const idxInPalette = currentPalette.findIndex(c => c.toLowerCase() === assist.hex.toLowerCase());
                    
                    // –ï—Å–ª–∏ —Ü–≤–µ—Ç –Ω–∞–π–¥–µ–Ω –≤ –ø–∞–ª–∏—Ç—Ä–µ –∏ –æ–Ω –Ω–µ —è–≤–ª—è–µ—Ç—Å—è —Å–∞–º–∏–º —Å–æ–±–æ–π (–∑–∞—â–∏—Ç–∞ –æ—Ç —Ü–∏–∫–ª–æ–≤)
                    if (idxInPalette !== -1 && idxInPalette != mainIdx) {
                        helperIndices.add(idxInPalette);
                        
                        if (!mainToHelpersMap[mainIdx]) mainToHelpersMap[mainIdx] = [];
                        mainToHelpersMap[mainIdx].push(idxInPalette);
                    }
                });
            }

            // --- –°–û–ë–ò–†–ê–ï–ú –ò–ù–í–ï–ù–¢–ê–†–¨ (Inventory Groups) ---
            let inventoryGroups = [];
            
            for(let i=0; i<count; i++) {
                // –í–ê–ñ–ù–û: –ï—Å–ª–∏ —Ü–≤–µ—Ç —è–≤–ª—è–µ—Ç—Å—è –ø–æ–º–æ—â–Ω–∏–∫–æ–º (–µ—Å—Ç—å –≤ helperIndices), 
                // –º—ã –ù–ï —Å–æ–∑–¥–∞–µ–º –¥–ª—è –Ω–µ–≥–æ –æ—Ç–¥–µ–ª—å–Ω—É—é –≥—Ä—É–ø–ø—É. –û–Ω "–∏—Å—á–µ–∑–∞–µ—Ç" –∫–∞–∫ —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–∞—è –µ–¥–∏–Ω–∏—Ü–∞.
                if (helperIndices.has(i)) continue;

                const mainHex = currentPalette[i];
                if (!mainHex) continue;

                let group = {
                    mainIdx: i,
                    lum: getLum(mainHex), // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –±—É–¥–µ—Ç –ø–æ —è—Ä–∫–æ—Å—Ç–∏ –û–°–ù–û–í–ù–û–ì–û —Ü–≤–µ—Ç–∞
                    items: []
                };

                // 1. –î–æ–±–∞–≤–ª—è–µ–º "–•–æ–∑—è–∏–Ω–∞" (–û—Å–Ω–æ–≤–Ω–æ–π —Ü–≤–µ—Ç)
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ —Ä–æ–¥–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ stockQuantities[i]
                group.items.push({ 
                    type: 'main', 
                    hex: mainHex, 
                    qty: stockQuantities[i], 
                    displayIdx: i 
                });

                // 2. –î–æ–±–∞–≤–ª—è–µ–º "–ü–æ–º–æ—â–Ω–∏–∫–æ–≤" (–∫–æ—Ç–æ—Ä—ã–µ –µ—Å—Ç—å –≤ –ø–∞–ª–∏—Ç—Ä–µ)
                if (mainToHelpersMap[i]) {
                    mainToHelpersMap[i].forEach(hIdx => {
                        // –ë–µ—Ä–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–∑ –∑–∞–ø–∞—Å–∞ —Å–∞–º–æ–≥–æ –ø–æ–º–æ—â–Ω–∏–∫–∞!
                        const hQty = stockQuantities[hIdx];
                        const hHex = currentPalette[hIdx];
                        
                        group.items.push({ 
                            type: 'palette_assist', // –ù–æ–≤—ã–π —Ç–∏–ø: –ø–æ–º–æ—â–Ω–∏–∫ –∏–∑ –ø–∞–ª–∏—Ç—Ä—ã
                            hex: hHex, 
                            qty: hQty, 
                            displayIdx: hIdx // –°–æ—Ö—Ä–∞–Ω—è–µ–º –µ–≥–æ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
                        });
                    });
                }

                // 3. –î–æ–±–∞–≤–ª—è–µ–º "–í–Ω–µ—à–Ω–∏—Ö –ø–æ–º–æ—â–Ω–∏–∫–æ–≤" (–∫–æ—Ç–æ—Ä—ã—Ö –ù–ï–¢ –≤ –ø–∞–ª–∏—Ç—Ä–µ, –µ—Å–ª–∏ —Ç–∞–∫–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤—Ä—É—á–Ω—É—é —á–µ—Ä–µ–∑ –ø–∏–ø–µ—Ç–∫—É, –Ω–æ –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω—ã –∫ –±–∞–Ω–∫–∞–º)
                if (stockAssists[i]) {
                    stockAssists[i].forEach(assist => {
                         const idxInPalette = currentPalette.findIndex(c => c.toLowerCase() === assist.hex.toLowerCase());
                         // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ—Ö, –∫–æ–≥–æ –º—ã –ù–ï –æ–±—Ä–∞–±–æ—Ç–∞–ª–∏ –Ω–∞ —à–∞–≥–µ 2 (—Ç.–µ. –≤–Ω–µ—à–Ω–∏–µ —Ü–≤–µ—Ç–∞)
                         if (idxInPalette === -1) {
                            group.items.push({ 
                                type: 'external_assist', 
                                hex: assist.hex, 
                                qty: assist.qty, 
                                assistId: assist.id 
                            });
                         }
                    });
                }

                group.totalQty = group.items.reduce((sum, item) => sum + item.qty, 0);
                inventoryGroups.push(group);
            }

            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –≥—Ä—É–ø–ø—ã –ø–æ —è—Ä–∫–æ—Å—Ç–∏ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã –∞–ª–≥–æ—Ä–∏—Ç–º–∞ –ø–æ–¥–±–æ—Ä–∞
            inventoryGroups.sort((a, b) => a.lum - b.lum);
            
            const totalSystemStock = inventoryGroups.reduce((sum, grp) => sum + grp.totalQty, 0);
            if (totalSystemStock <= 0) return; // –ï—Å–ª–∏ —Å–∫–ª–∞–¥ –ø—É—Å—Ç, –Ω–µ—á–µ–≥–æ —Å—á–∏—Ç–∞—Ç—å

            // --- 2. –û–ë–†–ê–ë–û–¢–ö–ê –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–Ø (High Quality Filters) ---
            // ... (–î–∞–ª—å—à–µ –∫–æ–¥ –æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–æ –∫–æ–Ω—Ü–∞ —Ñ—É–Ω–∫—Ü–∏–∏) ...
            // --- 2. –û–ë–†–ê–ë–û–¢–ö–ê –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–Ø (High Quality Filters) ---
            // –ß—Ç–æ–±—ã —Ä–µ–∑–∫–æ—Å—Ç—å —Ä–∞–±–æ—Ç–∞–ª–∞ –∫–∞–∫ –Ω–∞–¥–æ, —Å–Ω–∞—á–∞–ª–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –±–æ–ª—å—à—É—é –∫–∞—Ä—Ç–∏–Ω–∫—É
            const processW = 800; 
            const imgAspect = sourceImage.width / sourceImage.height;
            const processH = Math.floor(processW / imgAspect);

            const workCanvas = document.createElement('canvas');
            workCanvas.width = processW; workCanvas.height = processH;
            const workCtx = workCanvas.getContext('2d', { willReadFrequently: true });

            // –ü—Ä–∏–º–µ–Ω—è–µ–º –∑—É–º –∏ —Å–¥–≤–∏–≥
            const zoom = document.getElementById('zoom').value / 100;
            const px = (document.getElementById('panX').value / 100) * processW;
            const py = (document.getElementById('panY').value / 100) * processH;
            
            let drawW, drawH;
            const canvasAspect = processW / processH;
            if(imgAspect > canvasAspect) {
                drawH = processH * zoom; drawW = processH * imgAspect * zoom;
            } else {
                drawW = processW * zoom; drawH = (processW / imgAspect) * zoom;
            }

            // –§–∏–ª—å—Ç—Ä—ã CSS (–±—ã—Å—Ç—Ä—ã–µ)
            const contrast = document.getElementById('contrast').value;
            const brightness = document.getElementById('brightness').value;
            workCtx.filter = `contrast(${contrast}%) brightness(${brightness}%)`;
            
            workCtx.drawImage(sourceImage, (processW - drawW) / 2 + px, (processH - drawH) / 2 + py, drawW, drawH);
            workCtx.filter = 'none';

            let imgData = workCtx.getImageData(0, 0, processW, processH);
            let data = imgData.data;

            // --- –ü–†–ò–ú–ï–ù–ï–ù–ò–ï JS –§–ò–õ–¨–¢–†–û–í (–†–µ–∑–∫–æ—Å—Ç—å, –ë–ª—é—Ä, –ü–æ—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—è) ---
            
            // A. Smart Blur
            const smartBlur = parseInt(document.getElementById('smartBlur').value);
            if(smartBlur > 0) { 
                const copy = new Uint8ClampedArray(data);
                const radius = 2; 
                for(let y=0; y<processH; y++) { 
                    for(let x=0; x<processW; x++) { 
                        let rSum=0, gSum=0, bSum=0, count=0; 
                        const idx = (y*processW+x)*4; const r0 = copy[idx], g0=copy[idx+1], b0=copy[idx+2]; 
                        for(let dy=-radius; dy<=radius; dy++) { 
                            for(let dx=-radius; dx<=radius; dx++) { 
                                const nx=x+dx; const ny=y+dy; 
                                if(nx>=0 && nx<processW && ny>=0 && ny<processH) { 
                                    const nIdx = (ny*processW+nx)*4; 
                                    const diff = Math.abs(copy[nIdx]-r0) + Math.abs(copy[nIdx+1]-g0) + Math.abs(copy[nIdx+2]-b0); 
                                    if(diff <= smartBlur * 2.5) { rSum+=copy[nIdx]; gSum+=copy[nIdx+1]; bSum+=copy[nIdx+2]; count++; } 
                                } 
                            } 
                        } 
                        if(count > 0) { data[idx] = rSum/count; data[idx+1] = gSum/count; data[idx+2] = bSum/count; } 
                    } 
                } 
            }

            // B. Sharpness (USM)
            const sharpAmount = parseInt(document.getElementById('sharpness').value);
            const usmRadius = parseInt(document.getElementById('usmRadius').value) || 0;
            if (sharpAmount > 0 && usmRadius > 0) {
                 const blurred = new Uint8ClampedArray(data);
                 const r = usmRadius; 
                 const w = processW; const h_ = processH;
                 const temp = new Uint8ClampedArray(data);
                 // Horz
                 for(let y=0; y<h_; y++) {
                     for(let x=0; x<w; x++) {
                         let rS=0, gS=0, bS=0, cnt=0;
                         for(let i = -r; i <= r; i++) {
                             let nx = x + i;
                             if(nx >= 0 && nx < w) {
                                 let idx = (y * w + nx) * 4;
                                 rS += temp[idx]; gS += temp[idx+1]; bS += temp[idx+2]; cnt++;
                             }
                         }
                         let idx = (y * w + x) * 4;
                         blurred[idx] = rS/cnt; blurred[idx+1] = gS/cnt; blurred[idx+2] = bS/cnt;
                     }
                 }
                 // Vert
                 const temp2 = new Uint8ClampedArray(blurred);
                 for(let x=0; x<w; x++) {
                     for(let y=0; y<h_; y++) {
                         let rS=0, gS=0, bS=0, cnt=0;
                         for(let i = -r; i <= r; i++) {
                             let ny = y + i;
                             if(ny >= 0 && ny < h_) {
                                 let idx = (ny * w + x) * 4;
                                 rS += temp2[idx]; gS += temp2[idx+1]; bS += temp2[idx+2]; cnt++;
                             }
                         }
                         let idx = (y * w + x) * 4;
                         blurred[idx] = rS/cnt; blurred[idx+1] = gS/cnt; blurred[idx+2] = bS/cnt;
                     }
                 }
                 // Mix
                 const amount = sharpAmount / 100;
                 for (let i = 0; i < data.length; i += 4) {
                     data[i] = Math.min(255, Math.max(0, data[i] + (data[i] - blurred[i]) * amount));
                     data[i+1] = Math.min(255, Math.max(0, data[i+1] + (data[i+1] - blurred[i+1]) * amount));
                     data[i+2] = Math.min(255, Math.max(0, data[i+2] + (data[i+2] - blurred[i+2]) * amount));
                 }
            }

            // C. Posterize
            const levels = parseInt(document.getElementById('posterize').value);
            if (levels > 0) {
                const step = 255 / levels;
                for(let i=0; i < data.length; i+=4) {
                    data[i] = Math.floor(data[i] / step) * step;
                    data[i+1] = Math.floor(data[i+1] / step) * step;
                    data[i+2] = Math.floor(data[i+2] / step) * step;
                }
            }
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—É—é –∫–∞—Ä—Ç–∏–Ω–∫—É
            workCtx.putImageData(imgData, 0, 0);

            // --- 3. –ü–û–î–ì–û–¢–û–í–ö–ê –ö –°–ò–ú–£–õ–Ø–¶–ò–ò (–î–∞—É–Ω—Å–∫–µ–π–ª) ---
            const maxSimW = 150; 
            const simH = Math.floor(maxSimW / imgAspect);
            const simCanvas = document.createElement('canvas');
            simCanvas.width = maxSimW; simCanvas.height = simH;
            const simCtx = simCanvas.getContext('2d', { willReadFrequently: true });
            
            simCtx.drawImage(workCanvas, 0, 0, maxSimW, simH);
            const loopData = simCtx.getImageData(0, 0, maxSimW, simH).data;

            // --- 4. –ê–õ–ì–û–†–ò–¢–ú –ü–û–î–ë–û–†–ê –ë–õ–û–ö–û–í ---
            let bestMatrix = [];
            let bestW = 10;
            let bestH = Math.floor(10 / imgAspect);
            const OVERLAP_THRESHOLD = 0.75; 

            // –ü–µ—Ä–µ–±–∏—Ä–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã –æ—Ç 15 –¥–æ 150
            for (let w = 15; w <= 150; w++) {
                let h = Math.floor(w / imgAspect);
                if(h < 15) continue;
                
                // –ë—ã—Å—Ç—Ä—ã–π —Ä–µ—Å–∞–π–∑ –¥–ª—è —Ç–µ–∫—É—â–µ–π –∏—Ç–µ—Ä–∞—Ü–∏–∏
                const tCanvas = document.createElement('canvas'); tCanvas.width = w; tCanvas.height = h;
                tCanvas.getContext('2d').drawImage(simCanvas, 0, 0, w, h);
                const currentData = tCanvas.getContext('2d').getImageData(0, 0, w, h).data;

                // –ö–ª–æ–Ω –∑–∞–ø–∞—Å–æ–≤
                let tempGroupCounts = inventoryGroups.map(g => g.totalQty);
                let currentMatrix = []; 
                let possible = true; 

                for (let y = 0; y < h; y++) {
                    let row = [];
                    for (let x = 0; x < w; x++) {
                        const i = (y * w + x) * 4;
                        const lum = (0.299 * currentData[i] + 0.587 * currentData[i+1] + 0.114 * currentData[i+2]) / 255; 
                        
                        let floatIdx = lum * (inventoryGroups.length - 1);
                        let primaryIdx;
                        
                        if (useMixMode) {
                            let idxFloor = Math.floor(floatIdx);
                            let chance = floatIdx - idxFloor; 
                            primaryIdx = (Math.random() < chance) ? idxFloor + 1 : idxFloor;
                        } else {
                            primaryIdx = Math.round(floatIdx);
                        }
                        
                        if (primaryIdx < 0) primaryIdx = 0;
                        if (primaryIdx >= inventoryGroups.length) primaryIdx = inventoryGroups.length - 1;

                        let chosenGrpIdx = -1;
                        if (tempGroupCounts[primaryIdx] > 0) {
                            chosenGrpIdx = primaryIdx;
                        } else {
                            // –ü—Ä–æ–±—É–µ–º —Å–æ—Å–µ–¥–µ–π
                            let neighborIdx = (floatIdx < primaryIdx) ? primaryIdx - 1 : primaryIdx + 1;
                            if (neighborIdx >= 0 && neighborIdx < inventoryGroups.length) {
                                let dist = Math.abs(floatIdx - neighborIdx);
                                if (dist <= OVERLAP_THRESHOLD && tempGroupCounts[neighborIdx] > 0) {
                                    chosenGrpIdx = neighborIdx;
                                }
                            }
                        }

                        if (chosenGrpIdx !== -1) {
                            tempGroupCounts[chosenGrpIdx]--;
                            row.push(chosenGrpIdx);
                        } else {
                            possible = false; break; 
                        }
                    }
                    if (!possible) break;
                    currentMatrix.push(row);
                }

                if (possible) {
                    bestMatrix = currentMatrix;
                    bestW = w;
                    bestH = h;
                } else {
                    break;
                }
            }

           // --- 5. –§–ò–ù–ê–õ–ò–ó–ê–¶–ò–Ø (–í–ï–†–°–ò–Ø: –†–ê–í–ù–û–ú–ï–†–ù–´–ô –ú–ò–ö–° –ü–†–ò –î–ï–§–ò–¶–ò–¢–ï) ---
            if (bestMatrix.length > 0) {
                document.getElementById('setSize').value = 'custom';
                document.getElementById('customSizeGroup').style.display = 'flex';
                document.getElementById('customWidth').value = bestW;
                document.getElementById('customHeight').value = bestH;

                let assistMap = {}; 
                // –°–æ–∑–¥–∞–µ–º –ø—É—Å—Ç—É—é –º–∞—Ç—Ä–∏—Ü—É —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
                let finalMatrixResult = Array.from({length: bestH}, () => new Array(bestW).fill(0));
                
                // 1. –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ø–æ –∏–Ω–¥–µ–∫—Å—É –≥—Ä—É–ø–ø—ã
                // map: groupIndex -> [ {x, y}, {x, y}, ... ]
                let groupCoords = {};
                for(let y=0; y<bestH; y++) {
                    for(let x=0; x<bestW; x++) {
                        let gIdx = bestMatrix[y][x];
                        if(!groupCoords[gIdx]) groupCoords[gIdx] = [];
                        groupCoords[gIdx].push({x, y});
                    }
                }

                // 2. –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∂–¥—É—é –≥—Ä—É–ø–ø—É
                for (let gIdx in groupCoords) {
                    let coords = groupCoords[gIdx];
                    let group = inventoryGroups[gIdx];
                    let demand = coords.length; // –°–∫–æ–ª—å–∫–æ –≤—Å–µ–≥–æ –Ω—É–∂–Ω–æ –∫—É–±–∏–∫–æ–≤ —ç—Ç–æ–≥–æ —Ü–≤–µ—Ç–∞

                    let bucket = []; // –í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –≤–µ–¥—Ä–æ —Å –∫—É–±–∏–∫–∞–º–∏ –¥–ª—è —ç—Ç–æ–π –∑–æ–Ω—ã

                    // –ê. –°–Ω–∞—á–∞–ª–∞ —á–µ—Ä–ø–∞–µ–º –û–°–ù–û–í–ù–£–Æ –∫—Ä–∞—Å–∫—É
                    const mainItem = group.items.find(it => it.type === 'main');
                    let mainQtyToUse = 0;
                    if (mainItem) {
                        mainQtyToUse = Math.min(demand, mainItem.qty);
                        // –î–æ–±–∞–≤–ª—è–µ–º –≤ –≤–µ–¥—Ä–æ —Å—Å—ã–ª–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–µ–¥–º–µ—Ç
                        for(let k=0; k<mainQtyToUse; k++) bucket.push(mainItem);
                        demand -= mainQtyToUse;
                    }

                    // –ë. –ï—Å–ª–∏ –Ω–µ —Ö–≤–∞—Ç–∏–ª–æ, —á–µ—Ä–ø–∞–µ–º –ü–û–ú–û–©–ù–ò–ö–û–í
                    if (demand > 0) {
                        const availableAssists = group.items.filter(it => it.type !== 'main' && it.qty > 0);
                        
                        for (let assist of availableAssists) {
                            if (demand <= 0) break;
                            let assistQtyToUse = Math.min(demand, assist.qty);
                            for(let k=0; k<assistQtyToUse; k++) bucket.push(assist);
                            demand -= assistQtyToUse;
                        }
                    }

                    // –í. –ï—Å–ª–∏ –≤—Å—ë —Ä–∞–≤–Ω–æ –Ω–µ —Ö–≤–∞—Ç–∏–ª–æ (–¥–µ—Ñ–∏—Ü–∏—Ç), –¥–æ–±–∏–≤–∞–µ–º –û–°–ù–û–í–ù–´–ú (–≤–∏–∑—É–∞–ª—å–Ω–æ, —Å—á–µ—Ç—á–∏–∫ —É–π–¥–µ—Ç –≤ –º–∏–Ω—É—Å –∏–ª–∏ –æ—Å—Ç–∞–Ω–µ—Ç—Å—è 0)
                    while (demand > 0) {
                        bucket.push(mainItem || group.items[0]);
                        demand--;
                    }

                    // –ì. –ü–ï–†–ï–ú–ï–®–ò–í–ê–ï–ú –í–ï–î–†–û (Fisher-Yates Shuffle)
                    // –ò–º–µ–Ω–Ω–æ —ç—Ç–æ —É–±–∏—Ä–∞–µ—Ç –ø–æ–ª–æ—Å—É –∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ø–æ–º–æ—â–Ω–∏–∫–æ–≤ —Ä–∞–Ω–¥–æ–º–Ω–æ
                    for (let i = bucket.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [bucket[i], bucket[j]] = [bucket[j], bucket[i]];
                    }

                    // –î. –†–∞—Å–∫–ª–∞–¥—ã–≤–∞–µ–º –∫—É–±–∏–∫–∏ –∏–∑ –≤–µ–¥—Ä–∞ –ø–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º
                    coords.forEach((coord, i) => {
                        let selectedItem = bucket[i];

                        // –°–ø–∏—Å—ã–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ (—Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—Ö–æ–¥)
                        if (selectedItem.qty > 0) selectedItem.qty--;

                        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å –¥–ª—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏
                        let finalIdx = 0;
                        if (selectedItem.type === 'main' || selectedItem.type === 'palette_assist') {
                            finalIdx = selectedItem.displayIdx;
                        } else {
                            // –í–Ω–µ—à–Ω–∏–π –ø–æ–º–æ—â–Ω–∏–∫
                            const key = group.mainIdx + '_' + selectedItem.assistId;
                            if (assistMap[key] !== undefined) {
                                finalIdx = assistMap[key];
                            } else {
                                displayPalette.push(selectedItem.hex);
                                const baseSym = currentSymbolSet[group.mainIdx];
                                const subIndex = Object.keys(assistMap).filter(k => k.startsWith(group.mainIdx+'_')).length + 1;
                                displaySymbols.push(baseSym + subIndex); 
                                finalIdx = displayPalette.length - 1;
                                assistMap[key] = finalIdx;
                            }
                        }
                        
                        finalMatrixResult[coord.y][coord.x] = finalIdx;
                    });
                }

                generatedMatrix = finalMatrixResult;
                finalizeMatrixWithBorder();
            } else {
                alert("–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –±–ª–æ–∫–æ–≤! –î–æ–±–∞–≤—å—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–ª–∏ –ø–æ–º–æ—â–Ω–∏–∫–æ–≤.");
            }
        } // –ö–û–ù–ï–¶ –§–£–ù–ö–¶–ò–ò PROCESS STOCK IMAGE

        // --- –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò (–¢–ï–ü–ï–†–¨ –û–ù–ò –°–ù–ê–†–£–ñ–ò –ò –í–ò–î–ù–´ –í–°–ï–ú) ---

        function getLum(hex) {
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            return 0.299 * r + 0.587 * g + 0.114 * b;
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ–º–æ—â–Ω–∏–∫–æ–≤
        function triggerHelperPicker(mainIdx, assistId = null) {
            activeHelperIdx = mainIdx;
            window.editingAssistId = assistId; 
            const modal = document.getElementById('helperSelectModal');
            const grid = document.getElementById('helperPaletteGrid');
            grid.innerHTML = '';
            currentPalette.forEach((col, i) => {
                const btn = document.createElement('div');
                btn.style.width = '30px'; btn.style.height = '30px';
                btn.style.borderRadius = '50%'; btn.style.background = col;
                btn.style.cursor = 'pointer'; btn.style.border = '2px solid var(--glass-border)';
                btn.style.boxShadow = '0 2px 5px rgba(0,0,0,0.2)';
                btn.style.display = 'flex'; btn.style.alignItems = 'center'; btn.style.justifyContent = 'center';
                btn.style.fontSize = '10px';
                btn.style.color = getContrastColor(col);
                btn.innerText = currentSymbolSet[i] || "";
                btn.onclick = () => onHelperColorPicked(col);
                grid.appendChild(btn);
            });
            modal.style.display = 'flex';
        }

        function closeHelperModal(e) {
            if(e.target.id === 'helperSelectModal') e.target.style.display = 'none';
        }

        function onHelperColorPicked(hex) {
            document.getElementById('helperSelectModal').style.display = 'none';
            if (activeHelperIdx !== -1 && hex) {
                if (window.editingAssistId) {
                    const arr = stockAssists[activeHelperIdx];
                    const assist = arr.find(a => a.id === window.editingAssistId);
                    if (assist) assist.hex = hex;
                    window.editingAssistId = null;
                } else {
                    if (!stockAssists[activeHelperIdx]) stockAssists[activeHelperIdx] = [];
                    stockAssists[activeHelperIdx].push({ hex: hex, qty: 0, id: Date.now() });
                }
                renderStockInputs(); 
                processStockImage(); 
            }
            activeHelperIdx = -1;
        }

        function removeAssistant(mainIdx, assistId) {
            if (stockAssists[mainIdx]) {
                stockAssists[mainIdx] = stockAssists[mainIdx].filter(a => a.id !== assistId);
                renderStockInputs();
                processStockImage();
            }
        }
// --- –°–ö–†–´–¢–û–ï –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–ï –†–ï–ñ–ò–ú–û–í –û–¢–û–ë–†–ê–ñ–ï–ù–ò–Ø ---
// 0 = Auto, 1 = Force Mobile, 2 = Force PC
let layoutModeState = 0; 
// –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å, —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –∫ –Ω–µ–º—É –≤–µ—Ä–Ω—É—Ç—å—Å—è
const ORIGINAL_MEDIA_QUERY = "(max-width: 768px) and (orientation: portrait)";

function cycleLayoutMode() {
    const sheets = document.styleSheets;
    let targetRule = null;

    // 1. –ò—â–µ–º –Ω–∞—à–µ –ø—Ä–∞–≤–∏–ª–æ @media –≤–æ –≤—Å–µ—Ö —Å—Ç–∏–ª—è—Ö
    for (let i = 0; i < sheets.length; i++) {
        try {
            const rules = sheets[i].cssRules;
            if (!rules) continue;
            for (let j = 0; j < rules.length; j++) {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —ç—Ç–æ –ª–∏ –Ω–∞—à–µ –ø—Ä–∞–≤–∏–ª–æ (–ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º –∏–ª–∏ —Ç–µ–∫—É—â–µ–º—É —Å–æ—Å—Ç–æ—è–Ω–∏—é)
                const txt = rules[j].conditionText;
                if (txt && (txt.includes("max-width: 768px") || txt === "all" || txt === "max-width: 0px")) {
                    targetRule = rules[j];
                    break;
                }
            }
        } catch (e) {
            // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –¥–æ—Å—Ç—É–ø–∞ –∫ –≤–Ω–µ—à–Ω–∏–º —Å—Ç–∏–ª—è–º (–µ—Å–ª–∏ –µ—Å—Ç—å)
        }
        if (targetRule) break;
    }

    if (!targetRule) {
        alert("–û—à–∏–±–∫–∞: –ù–µ –Ω–∞–π–¥–µ–Ω—ã –º–æ–±–∏–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏!");
        return;
    }

    // 2. –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    layoutModeState = (layoutModeState + 1) % 3;
    const label = document.getElementById('versionLabel');

    if (layoutModeState === 0) {
        // –ê–í–¢–û (–í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–∞–∫ –±—ã–ª–æ)
        targetRule.conditionText = ORIGINAL_MEDIA_QUERY;
        label.innerText = "PhotoBrick v2.3.5";
        label.style.color = "var(--text-sec)";
    } 
    else if (layoutModeState === 1) {
        // –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–û –ú–û–ë–ò–õ–¨–ù–´–ô (—É—Å–ª–æ–≤–∏–µ "all" —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—Å–µ–≥–¥–∞)
        targetRule.conditionText = "all";
        label.innerText = "PhotoBrick v2.3.5 (Mobile)";
        label.style.color = "var(--primary)"; // –ü–æ–¥—Å–≤–µ—Ç–∏–º –∂–µ–ª—Ç—ã–º/—Å–∏–Ω–∏–º
    } 
    else if (layoutModeState === 2) {
        // –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–û –ü–ö (—É—Å–ª–æ–≤–∏–µ "max-width: 0px" –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç)
        targetRule.conditionText = "max-width: 0px";
        label.innerText = "PhotoBrick v2.3.5 (PC)";
        label.style.color = "var(--primary)";
    }
}
// --- –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –≠–§–§–ï–ö–¢–ê PIXEL ART ---
function applyPixelArtFilter(data, width, height) {
    const output = new Uint8ClampedArray(data);
    const threshold = 30; // –ß—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∫—Ä–∞–µ–≤ (—á–µ–º –º–µ–Ω—å—à–µ, —Ç–µ–º –±–æ–ª—å—à–µ –ª–∏–Ω–∏–π)
    
    // 1. –£—Å–∏–ª–∏–≤–∞–µ–º –Ω–∞—Å—ã—â–µ–Ω–Ω–æ—Å—Ç—å (Saturation Boost) –¥–ª—è –º—É–ª—å—Ç—è—à–Ω–æ—Å—Ç–∏
    const saturation = 1.5; // +50% –Ω–∞—Å—ã—â–µ–Ω–Ω–æ—Å—Ç–∏
    for (let i = 0; i < data.length; i += 4) {
        const r = data[i], g = data[i+1], b = data[i+2];
        const gray = 0.299 * r + 0.587 * g + 0.114 * b;
        output[i] = Math.min(255, Math.max(0, gray + (r - gray) * saturation));
        output[i+1] = Math.min(255, Math.max(0, gray + (g - gray) * saturation));
        output[i+2] = Math.min(255, Math.max(0, gray + (b - gray) * saturation));
    }

    // 2. –†–∏—Å—É–µ–º —á–µ—Ä–Ω—ã–π –∫–æ–Ω—Ç—É—Ä (–∞–ª–≥–æ—Ä–∏—Ç–º –°–æ–±–µ–ª—è —É–ø—Ä–æ—â–µ–Ω–Ω—ã–π)
    // –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –∫–∞–∂–¥–æ–º—É –ø–∏–∫—Å–µ–ª—é
    for (let y = 0; y < height; y++) {
        for (let x = 0; x < width; x++) {
            const idx = (y * width + x) * 4;
            
            // –ë–µ—Ä–µ–º —è—Ä–∫–æ—Å—Ç—å —Ç–µ–∫—É—â–µ–≥–æ –ø–∏–∫—Å–µ–ª—è
            const lum = (output[idx] + output[idx+1] + output[idx+2]) / 3;

            // –ë–µ—Ä–µ–º —è—Ä–∫–æ—Å—Ç—å —Å–æ—Å–µ–¥–∞ —Å–ø—Ä–∞–≤–∞ –∏ —Å–Ω–∏–∑—É
            let rightLum = lum;
            let bottomLum = lum;

            if (x < width - 1) {
                const rIdx = (y * width + (x + 1)) * 4;
                rightLum = (output[rIdx] + output[rIdx+1] + output[rIdx+2]) / 3;
            }
            if (y < height - 1) {
                const bIdx = ((y + 1) * width + x) * 4;
                bottomLum = (output[bIdx] + output[bIdx+1] + output[bIdx+2]) / 3;
            }

            // –ï—Å–ª–∏ —Ä–∞–∑–Ω–∏—Ü–∞ –≤ —è—Ä–∫–æ—Å—Ç–∏ –±–æ–ª—å—à–∞—è ‚Äî –∑–Ω–∞—á–∏—Ç —ç—Ç–æ –∫—Ä–∞–π
            const diff = Math.abs(lum - rightLum) + Math.abs(lum - bottomLum);

            if (diff > threshold) {
                // –ö—Ä–∞—Å–∏–º –≤ –ß–ï–†–ù–´–ô (–ö–æ–Ω—Ç—É—Ä)
                data[idx] = 0;
                data[idx+1] = 0;
                data[idx+2] = 0;
            } else {
                // –û—Å—Ç–∞–≤–ª—è–µ–º –Ω–∞—Å—ã—â–µ–Ω–Ω—ã–π —Ü–≤–µ—Ç
                data[idx] = output[idx];
                data[idx+1] = output[idx+1];
                data[idx+2] = output[idx+2];
            }
        }
    }
}
// --- –§–£–ù–ö–¶–ò–Ø –£–ü–†–ê–í–õ–ï–ù–ò–Ø –ú–´–®–¨–Æ –í –°–•–ï–ú–ï (PC) ---
function setupGridMouseNavigation() {
    const el = document.getElementById('instructionView');
    
    // 1. –ó–£–ú –ö–û–õ–ï–°–ò–ö–û–ú
    el.addEventListener('wheel', (e) => {
        // –ë–ª–æ–∫–∏—Ä—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –ø—Ä–æ–∫—Ä—É—Ç–∫—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        e.preventDefault();

        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (–≤–≤–µ—Ä—Ö/–≤–Ω–∏–∑)
        const delta = Math.sign(e.deltaY) * -10; 
        
        // –ë–µ—Ä–µ–º —Ç–µ–∫—É—â–∏–π –∑—É–º
        let currentZoom = parseInt(document.getElementById('gridZoom').value) || 100;
        let newZoom = currentZoom + delta;

        // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º (–∫–∞–∫ –≤ –ø–æ–ª–∑—É–Ω–∫–µ: –æ—Ç 3 –¥–æ 800)
        newZoom = Math.max(3, Math.min(800, newZoom));

        // –ü—Ä–∏–º–µ–Ω—è–µ–º –∑—É–º
        updateGridScale(newZoom);
    }, { passive: false });

    // 2. –ü–ï–†–ï–¢–ê–°–ö–ò–í–ê–ù–ò–ï (LMB)
    let isDown = false;
    let startX, startY, scrollLeft, scrollTop;

    el.addEventListener('mousedown', (e) => {
        // –†–∞–±–æ—Ç–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–æ –ª–µ–≤–æ–π –∫–Ω–æ–ø–∫–µ –º—ã—à–∏
        if(e.button !== 0) return; 
        
        isDown = true;
        el.style.cursor = 'grabbing'; // –ú–µ–Ω—è–µ–º –∫—É—Ä—Å–æ—Ä –Ω–∞ "—Ä—É–∫—É"
        
        // –ó–∞–ø–æ–º–∏–Ω–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
        startX = e.pageX - el.offsetLeft;
        startY = e.pageY - el.offsetTop;
        scrollLeft = el.scrollLeft;
        scrollTop = el.scrollTop;
    });

    el.addEventListener('mouseleave', () => {
        isDown = false;
        el.style.cursor = 'default';
    });

    el.addEventListener('mouseup', () => {
        isDown = false;
        el.style.cursor = 'default'; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ–±—ã—á–Ω—ã–π –∫—É—Ä—Å–æ—Ä
    });

    el.addEventListener('mousemove', (e) => {
        if (!isDown) return; // –ï—Å–ª–∏ –∫–Ω–æ–ø–∫–∞ –Ω–µ –Ω–∞–∂–∞—Ç–∞, –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
        e.preventDefault();
        
        // –í—ã—á–∏—Å–ª—è–µ–º, –Ω–∞—Å–∫–æ–ª—å–∫–æ —Å–¥–≤–∏–Ω—É–ª–∞—Å—å –º—ã—à—å
        const x = e.pageX - el.offsetLeft;
        const y = e.pageY - el.offsetTop;
        const walkX = (x - startX); 
        const walkY = (y - startY);
        
        // –ö—Ä—É—Ç–∏–º —Å–∫—Ä–æ–ª–ª –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
        el.scrollLeft = scrollLeft - walkX;
        el.scrollTop = scrollTop - walkY;
    });
}

/* --- –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü–†–ê–í–ò–õ–¨–ù–û–ï –ò–ú–Ø –§–£–ù–ö–¶–ò–ò --- */

// –í–ê–ñ–ù–û: –ò–º—è —Ñ—É–Ω–∫—Ü–∏–∏ —Ç–µ–ø–µ—Ä—å resetGridVisibility, –∫–∞–∫ –ø—Ä–æ–ø–∏—Å–∞–Ω–æ —É –≤–∞—Å –≤ –∫–Ω–æ–ø–∫–µ HTML
function resetGridVisibility() {
    if (typeof hiddenRegions !== 'undefined') {
        hiddenRegions.clear(); // –û—á–∏—â–∞–µ–º –ø–∞–º—è—Ç—å –≤—ã–¥–µ–ª–µ–Ω–∏–π
        refreshGridVisibility(); // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Å–µ—Ç–∫—É —á–∏—Å—Ç–æ–π
        console.log("–°—Ö–µ–º–∞ –æ—á–∏—â–µ–Ω–∞ (resetGridVisibility)");
    }
}

// –≠—Ç–æ—Ç –∫—É—Å–æ–∫ –Ω–∏–∂–µ –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –∏–ª–∏ —É–¥–∞–ª–∏—Ç—å, –æ–Ω —Ç–µ–ø–µ—Ä—å –Ω–µ –∫—Ä–∏—Ç–∏—á–µ–Ω, 
// —Ç–∞–∫ –∫–∞–∫ –∫–Ω–æ–ø–∫–∞ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ onclick="resetGridVisibility()" –≤ HTML
const eyeButton = document.getElementById('reset-lines-btn'); 
if (eyeButton) {
    eyeButton.onclick = resetGridVisibility;
}

// --- PWA REGISTRATION ---
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
            .then(reg => console.log('PWA Service Worker registered'))
            .catch(err => console.log('PWA Service Worker failed', err));
    });
}
// --- –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –û–ö–†–ê–®–ò–í–ê–ù–ò–Ø –ë–†–ê–£–ó–ï–†–ê ---
function updateBrowserColor() {
    // 1. –ñ–¥–µ–º 1 –∫–∞–¥—Ä, —á—Ç–æ–±—ã CSS —É—Å–ø–µ–ª –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è
    requestAnimationFrame(() => {
        // 2. –£–∑–Ω–∞–µ–º —Ä–µ–∞–ª—å–Ω—ã–π —Ü–≤–µ—Ç —Ñ–æ–Ω–∞ body
        const color = getComputedStyle(document.body).backgroundColor;
        
        // 3. –ö—Ä–∞—Å–∏–º –º–µ—Ç–∞-—Ç–µ–≥
        const meta = document.querySelector('meta[name="theme-color"]');
        if (meta) {
            meta.setAttribute('content', color);
        }
    });
}

    </script>
<div id="loadingOverlay" class="loading-overlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div class="loading-text">–°–û–ó–î–ê–ï–ú –®–ï–î–ï–í–†...</div>
        </div>
    </div>
</body>
</html>
