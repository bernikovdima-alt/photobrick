<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PhotoBrick v2.1.9</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root {
            --bg-gradient: radial-gradient(circle at top left, #1e1e24, #121212);
            --glass-bg: rgba(30, 30, 30, 0.95);
            --glass-border: rgba(255, 255, 255, 0.15);
            --primary: #ffd700; /* Yellow for Dark Mode */
            --on-primary: #000;
            --text-main: #ffffff;
            --text-sec: #aaa;
            --radius-lg: 20px;
            --radius-md: 12px;
            --modal-bg: #1e1e24;
            --modal-text: #ddd;
            --btn-sec-bg: rgba(255,255,255,0.1);
            --option-bg: #2a2a2a;
            --option-text: #fff;
            --input-bg: rgba(0, 0, 0, 0.6);
            
            --btn-collapsed-bg: #ffd700;
            --btn-collapsed-text: #000;
            --btn-refresh-color: #d4a000;
            --btn-refresh-bg: rgba(255, 215, 0, 0.1);
        }

        [data-theme="light"] {
            --bg-gradient: #D3E3FD;
            --glass-bg: #E9EEF6;
            --glass-border: rgba(0, 0, 0, 0.05);
            --primary: #0b57d0; /* Blue for Light Mode */
            --on-primary: #fff;
            --text-main: #1f1f1f;
            --text-sec: #444746;
            --modal-bg: #E9EEF6;
            --modal-text: #1f1f1f;
            --btn-sec-bg: rgba(0, 0, 0, 0.05);
            --option-bg: #ffffff;
            --option-text: #000;
            --input-bg: rgba(255, 255, 255, 0.9);
            
            --btn-collapsed-bg: #0b57d0; 
            --btn-collapsed-text: #fff;
            --btn-refresh-color: #0b57d0;
            --btn-refresh-bg: rgba(11, 87, 208, 0.1);
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; touch-action: manipulation; }
        body { margin: 0; height: 100dvh; overflow: hidden; font-family: 'Inter', system-ui, sans-serif; background: var(--bg-gradient); color: var(--text-main); transition: 0.3s; }

        #dropOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 9999;
            display: none; align-items: center; justify-content: center;
            font-size: 24px; font-weight: bold; color: var(--primary);
            border: 5px dashed var(--primary);
            backdrop-filter: blur(5px);
        }

        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(128,128,128,0.4); border-radius: 3px; }

        .app-container { display: grid; grid-template-columns: 340px 1fr; height: 100dvh; padding: 15px; gap: 15px; }
        .sidebar { background: var(--glass-bg); backdrop-filter: blur(20px); border: 1px solid var(--glass-border); border-radius: var(--radius-lg); padding: 20px; display: flex; flex-direction: column; gap: 12px; overflow-y: auto; }
        
        .card { background: rgba(0, 0, 0, 0.05); border-radius: var(--radius-md); padding: 8px 10px; border: 1px solid var(--glass-border); }
        [data-theme="dark"] .card { background: rgba(0, 0, 0, 0.15); }

        .card-header { font-size: 10px; font-weight: 800; text-transform: uppercase; color: var(--text-sec); margin-bottom: 6px; display: flex; justify-content: space-between; align-items: center; }
        
        .modern-select, .modern-input { width: 100%; padding: 8px; background: var(--input-bg); border: 1px solid var(--glass-border); border-radius: 6px; color: var(--text-main); font-size: 13px; margin-bottom: 4px; }
        .modern-select option { background-color: var(--option-bg); color: var(--option-text); }

        .btn { width: 100%; padding: 12px; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; font-size: 11px; transition: 0.2s; text-align: center; text-transform: uppercase; display: block; }
        .btn-primary { background: var(--primary); color: var(--on-primary); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .btn-sec { background: var(--btn-sec-bg); color: var(--text-main); border: 1px solid var(--glass-border); }
        
        .btn-toggle-panel {
            width: 100%; padding: 8px; font-size: 10px; font-weight: 700; text-transform: uppercase;
            border-radius: 6px; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 5px;
            border: 1px solid var(--glass-border);
            background: var(--btn-collapsed-bg); 
            color: var(--btn-collapsed-text);
            transition: 0.3s;
        }
        .btn-toggle-panel.expanded {
            background: rgba(128,128,128,0.3);
            color: var(--text-main);
        }
        .panel-content { display: none; margin-top: 8px; background: rgba(0,0,0,0.1); padding: 8px; border-radius: 6px; border: 1px solid var(--glass-border); }

        .btn-active-state { background-color: var(--primary) !important; color: var(--on-primary) !important; border-color: var(--primary) !important; opacity: 1 !important; }

        .palette-actions { display: flex; gap: 10px; margin-top: 8px; }
        .btn-action { flex: 1; padding: 0; border-radius: 8px; font-size: 10px; font-weight: 700; text-transform: uppercase; cursor: pointer; display: flex; align-items: center; justify-content: center; height: 28px; border: 1px solid transparent; }
        
        .btn-refresh { background: var(--btn-refresh-bg); color: var(--btn-refresh-color); border-color: var(--btn-refresh-color); display: none; }
        
        .btn-danger-small { background: rgba(255, 50, 50, 0.1); color: #ff5555; border-color: rgba(255, 50, 50, 0.3); }

        .slider-group { margin-bottom: 6px; }
        .slider-group.locked input { opacity: 0.3; cursor: not-allowed; } 
        .slider-header-compact { display: flex; justify-content: space-between; font-size: 9px; font-weight: 700; text-transform: uppercase; color: var(--text-sec); margin-bottom: 2px; padding-left: 2px; align-items: center;}
        .val-display { color: var(--primary); }
        
        .smart-toggle-btn {
            font-size: 9px; padding: 1px 4px; border: 1px solid var(--glass-border); border-radius: 4px; cursor: pointer; margin-left: 5px; opacity: 0.5;
        }
        .smart-toggle-btn.active { opacity: 1; background: var(--primary); color: var(--on-primary); border-color: var(--primary); }

        .slider-row { display: flex; align-items: center; gap: 6px; }
        .icon-btn-side { width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; cursor: pointer; opacity: 0.7; font-size: 11px; border: 1px solid var(--glass-border); border-radius: 4px; background: rgba(0,0,0,0.1); flex-shrink: 0; color: var(--text-main); }
        .icon-btn-side:active { transform: scale(0.95); opacity: 1; }
        
        input[type="range"] { -webkit-appearance: none; flex: 1; background: transparent; height: 24px; cursor: pointer; width: 100%; }
        input[type="range"]::-webkit-slider-runnable-track { height: 4px; background: rgba(128,128,128,0.3); border-radius: 2px; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: var(--primary); margin-top: -6px; border: 2px solid var(--glass-border); box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
        
        .num-input-small { width: 40px; background: var(--input-bg); border: 1px solid var(--glass-border); color: var(--text-main); font-size: 11px; text-align: center; border-radius: 4px; padding: 2px; -moz-appearance: textfield; }
        .num-input-small::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .num-ctrl-btn { width: 20px; height: 20px; background: rgba(255,255,255,0.1); border: 1px solid var(--glass-border); color: var(--text-main); display: flex; align-items: center; justify-content: center; cursor: pointer; border-radius: 4px; font-weight: bold; }

        .palette-row { display: flex; align-items: center; gap: 10px; margin-top: 5px; }
        .palette-grid { display: flex; gap: 8px; flex-wrap: wrap; flex: 1; }
        
        .palette-item { position: relative; width: 32px; height: 32px; border-radius: 50%; border: 2px solid var(--glass-border); cursor: pointer; overflow: hidden; flex-shrink: 0; box-shadow: 0 2px 5px rgba(0,0,0,0.2); display:flex; align-items:center; justify-content:center; transition: transform 0.1s; }
        .palette-item.active-brush { border: 3px solid #fff !important; transform: scale(1.15); z-index: 10; box-shadow: 0 0 15px var(--primary); }
        .palette-item input { position: absolute; top:0; left:0; width:1px; height:1px; opacity:0; pointer-events:none; } 
        .pal-sym { position:relative; z-index:5; font-weight:900; font-size:11px; pointer-events:none; text-shadow: 0 0 2px rgba(0,0,0,0.5); color: #fff; }

        .stage { position: relative; background: var(--glass-bg); backdrop-filter: blur(20px); border: 1px solid var(--glass-border); border-radius: var(--radius-lg); display: flex; flex-direction: column; overflow: hidden; }
        .header-bar { display: flex; justify-content: space-between; padding: 10px; flex-shrink: 0; z-index: 100; background: transparent; }
        .header-left { display: flex; gap: 5px; align-items: center; overflow: visible !important; flex: 1; position: relative; }
        .header-right { display: flex; gap: 5px; flex-shrink: 0; }
        
        .viewport { flex: 1; display: flex; align-items: center; justify-content: center; overflow: hidden; padding: 20px; position: relative; touch-action: none; cursor: grab; }
        .viewport:active { cursor: grabbing; }
        .viewport.pencil-mode { cursor: crosshair !important; }
        
        #instructionView { display: none; flex: 1; width: 100%; overflow: auto; padding: 20px; text-align: center; position: relative; touch-action: pan-x pan-y; -webkit-overflow-scrolling: touch; }
        #gridContainer { display: inline-block; text-align: left; padding-bottom: 50px; transform-origin: top left; }
        
        .instruction-grid { display: inline-grid; background: white; color: black; border: 1px solid #999; transform-origin: top left; position: relative; }
        .cell, .ruler-cell { display: flex; justify-content: center; align-items: center; border-top: 1px solid #ccc; border-left: 1px solid #ccc; width: 20px !important; height: 20px !important; min-width: 20px; min-height: 20px; font-weight: bold; font-size: 9px; cursor: pointer; box-sizing: border-box; transition: opacity 0.2s, filter 0.2s; }
        
        .ruler-cell { background: #eee; color: #333; transition: background 0.2s; }
        .ruler-cell:hover { background: #ddd; }
        .info-header { background: #eee; color: #333; border-top: 1px solid #ccc; border-left: 1px solid #ccc; font-weight: bold; font-size: 10px; display: flex; justify-content: center; align-items: center; width: 280px; height: 25px; cursor:pointer; }
        .row-info { display: flex; align-items: center; padding-left: 10px; border-top: 1px solid #ccc; height: 20px; width: 280px; font-size: 10px; background: #f4f4f4; color: #111; font-family: monospace; cursor:pointer; transition: background 0.2s; }
        .row-info:hover { background: #e0e0e0; }
        
        .shade-layer { position: absolute; background: rgba(0,0,0,0.7); pointer-events: none; z-index: 50; left: 0; right: 0; }

        .preview-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            max-width: 100%;
            max-height: 100%;
            flex-wrap: nowrap;
        }

        #resultBox { 
            position: relative; 
            pointer-events: none; 
            line-height: 0; 
            flex: 0 1 auto; 
            display: flex; 
            justify-content: center;
            align-items: center;
        }

        #origBox { 
            max-width: 15%; 
            max-height: 100%; 
            position: relative; 
            pointer-events: none; 
            flex: 0 0 auto;
        }

        .preview-content {  
            max-width: 100%;  
            max-height: 65vh;  
            border-radius: 8px;  
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);  
            border: 1px solid var(--primary);
            padding: 1px;
            background: var(--glass-bg);
            object-fit: contain !important; /* –ö–∞—Ä—Ç–∏–Ω–∫–∞ –≤—Å–µ–≥–¥–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –ø—Ä–æ–ø–æ—Ä—Ü–∏–∏ */
            display: block;  
            pointer-events: none;
            aspect-ratio: auto; /* –ó–∞–ø—Ä–µ—â–∞–µ—Ç –±—Ä–∞—É–∑–µ—Ä—É –≤—ã–¥—É–º—ã–≤–∞—Ç—å —Å–≤–æ–∏ –ø—Ä–æ–ø–æ—Ä—Ü–∏–∏ */
            transition: transform 0.2s ease-out; 
        }

        .preview-label { margin: 0; background: rgba(0,0,0,0.6); padding: 4px 8px; border-radius: 6px; font-size: 9px; color: #fff; text-transform: uppercase; position: absolute; top: 10px; left: 50%; transform: translateX(-50%); z-index: 5; pointer-events: none; border: 1px solid rgba(255,255,255,0.2); white-space: nowrap; line-height: normal; }

        .mode-toggle { background: var(--glass-bg); padding: 2px; border-radius: 30px; border: 1px solid var(--glass-border); height: 28px; display: flex; align-items: center; flex-shrink: 0; }
        .toggle-opt { padding: 0 10px; height: 22px; display: flex; align-items: center; border-radius: 24px; cursor: pointer; font-size: 9px; font-weight: 700; color: var(--text-sec); text-transform: uppercase;}
        .toggle-opt.active { background: var(--primary); color: var(--on-primary); }
        
        .lock-btn { height: 28px; padding: 0 10px; border-radius: 20px; background: var(--glass-bg); border: 1px solid var(--glass-border); color: var(--text-sec); cursor: pointer; font-size: 9px; font-weight: 700; text-transform: uppercase; display: flex; align-items: center; gap: 4px; flex-shrink: 0; }
        .lock-btn.active { background-color: #28a745 !important; color: #fff !important; border-color: #28a745 !important; }
        
        .top-btn { height: 28px; padding: 0 10px; border-radius: 20px; background: var(--glass-bg); border: 1px solid var(--glass-border); color: var(--text-main); cursor: pointer; font-size: 9px; font-weight: 700; flex-shrink: 0;}
        
        .zoom-display-btn { height: 28px; padding: 0 10px; border-radius: 20px; border: 1px solid var(--glass-border); background: var(--glass-bg); color: var(--text-main); font-size: 9px; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; margin-left: 5px; }
        .zoom-display-btn span { color: var(--text-main); }
        .zoom-display-btn.btn-active-state span { color: var(--on-primary); }

        .floating-nav { position: absolute; top: 55px; left: 10px; background: transparent; backdrop-filter: none; border: none; box-shadow: none; padding: 8px; border-radius: 12px; display: none; z-index: 1000; width: 100px; height: 100px; }
        
        .nav-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; grid-template-rows: 1fr 1fr 1fr; width: 100%; height: 100%; gap: 4px; }
        .nav-btn { background: rgba(0, 0, 0, 0.6); border: 1px solid var(--glass-border); border-radius: 4px; color: var(--text-main); font-size: 14px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; padding: 0; }
        [data-theme="light"] .nav-btn { background: rgba(255, 255, 255, 0.8); color: #000; }
        .nav-btn.active { background: var(--primary); color: var(--on-primary); border-color: var(--primary); }
        .nav-all { grid-column: 2; grid-row: 2; background: rgba(0, 0, 0, 0.6); font-size: 9px; border-radius: 50%; box-shadow: 0 0 10px rgba(0,0,0,0.3); }

        .zoom-popup-unified {
            display: none; position: absolute; height: 40px; width: 140px; background: transparent; border: none; backdrop-filter: none; box-shadow: none; align-items: center; justify-content: center; padding: 0 10px; z-index: 9999;
        }
        .zoom-popup-unified.show { display: flex; }
        #zoomPopup { top: 45px; left: -30px; }
        #fsZoomPopup { top: 45px; left: 0; }
        .horizontal-range { width: 100%; height: 24px; cursor: pointer; background: transparent; }
        
        .settings-arrow { display:inline-block; transition: transform 0.3s; margin-left: 5px; }
        .settings-arrow.rotated { transform: rotate(180deg); }
        
        .custom-size-inputs { display:flex; gap: 5px; }

        .icon-small { width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 14px; background: var(--glass-bg); border-radius: 50%; border: 1px solid var(--glass-border); margin-left: 5px; color: var(--text-main); }
        [data-theme="light"] .icon-small { background: rgba(0,0,0,0.05); }
        
        .icon-small.active { background-color: var(--primary) !important; color: var(--on-primary) !important; border-color:var(--primary) !important; opacity: 1; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 9999; display: none; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal { background: var(--modal-bg); color: var(--modal-text); width: 90%; max-width: 600px; max-height: 85vh; border-radius: 12px; display: flex; flex-direction: column; overflow: hidden; border: 1px solid var(--glass-border); box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .modal-header { padding: 15px 20px; border-bottom: 1px solid var(--glass-border); display: flex; justify-content: space-between; align-items: center; background: rgba(128,128,128,0.1); }
        .modal-body { padding: 20px; overflow-y: auto; flex: 1; color: var(--modal-text); font-size: 14px; line-height: 1.6; }
        
        .algo-box { background: rgba(255, 215, 0, 0.1); border: 1px solid var(--primary); padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .algo-title { font-weight: bold; color: var(--primary); margin-bottom: 10px; display: block; font-size: 16px; }
        .algo-box ol { color: var(--modal-text) !important; }
        [data-theme="light"] .algo-box ol { color: #000 !important; }

        #fsGridControls { 
            display: none; position: fixed; top: 20px; left: 20px; background: transparent; padding: 0; border: none; z-index: 6000; flex-direction: row; align-items: flex-start; justify-content: flex-start; gap: 10px; height: auto; width: auto; 
            opacity: 1; pointer-events: auto;
        }
        .reset-vis-btn { 
            width: 30px; height: 30px; border-radius: 50%; background: var(--primary); color:var(--on-primary); border:none; margin: 0; display: flex; align-items: center; justify-content: center; cursor: pointer; font-weight: bold; font-size: 14px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); pointer-events: auto; 
        }

        body.fullscreen-mode #fsGridControls { display: flex; }
        
        @media (min-width: 1024px) {
            #gestureLockBtn { display: none !important; }
            .sidebar { padding: 30px; gap: 20px; }
            .header-bar { padding: 20px 30px; } 
            .mode-toggle { height: 40px; padding: 4px; border-radius: 40px; }
            .toggle-opt { height: 32px; padding: 0 20px; font-size: 12px; border-radius: 30px; }
            .top-btn, .zoom-display-btn { height: 40px; width: 40px; font-size: 18px; border-radius: 12px; }
            .zoom-display-btn { width: 60px; font-size: 12px; }
            .floating-nav { top: 70px; left: 30px; width: 120px; height: 120px; }
        }

        /* --- –ú–û–ë–ò–õ–¨–ù–´–ô –†–ï–ñ–ò–ú: "–ö–ê–ö –ù–ê –ü–ö" (–ö–ê–†–¢–û–ß–ö–ò) --- */
        @media (max-width: 768px) and (orientation: portrait) {
            /* 1. –ì–ª–∞–≤–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä: –î–µ–ª–∞–µ–º –æ—Ç—Å—Ç—É–ø—ã –æ—Ç –∫—Ä–∞–µ–≤ —ç–∫—Ä–∞–Ω–∞ –∏ –∑–∞–∑–æ—Ä –º–µ–∂–¥—É –æ–∫–Ω–∞–º–∏ */
            .app-container { 
                display: flex; 
                flex-direction: column; 
                height: 100dvh; 
                padding: 4px; /* –û—Ç—Å—Ç—É–ø –æ—Ç –∫—Ä–∞—è —ç–∫—Ä–∞–Ω–∞ */
                gap: 10px !important; /* –ó–ê–ó–û–† –ú–ï–ñ–î–£ –í–ï–†–•–ù–ò–ú –ò –ù–ò–ñ–ù–ò–ú –û–ö–ù–û–ú */
                overflow: hidden; 
            }
            
            /* 2. –í–µ—Ä—Ö–Ω—è—è –∫–∞—Ä—Ç–∞ (–°—Ü–µ–Ω–∞): –°–∫—Ä—É–≥–ª–µ–Ω–Ω–∞—è, —Å —Ä–∞–º–∫–æ–π, –≥–∏–±–∫–∞—è */
            .stage { 
                order: 1; 
                flex: 1; /* –ó–∞–Ω–∏–º–∞–µ—Ç –≤—Å—ë —Å–≤–æ–±–æ–¥–Ω–æ–µ –º–µ—Å—Ç–æ —Å–≤–µ—Ä—Ö—É */
                width: 100%; 
                border-radius: 20px; /* –í–û–ó–í–†–ê–©–ê–ï–ú –°–ö–†–£–ì–õ–ï–ù–ò–Ø */
                border: 1px solid var(--glass-border); 
                display: flex; 
                flex-direction: column; 
                overflow: hidden;
                min-height: 0; /* –ú–∞–≥–∏—è CSS: –ø–æ–∑–≤–æ–ª—è–µ—Ç –∫–∞—Ä—Ç–∏–Ω–∫–µ —Å–∂–∏–º–∞—Ç—å—Å—è, –∞ –Ω–µ —Ä–∞—Å–ø–∏—Ä–∞—Ç—å –±–ª–æ–∫ */
                background: var(--glass-bg);
            }
            
            /* 3. –®–∞–ø–∫–∞ —Å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–º–∏: –ë–æ–ª—å—à–µ –Ω–µ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞–µ—Ç –∫–∞—Ä—Ç–∏–Ω–∫—É! */
            .header-bar { 
                position: relative; /* –û–Ω–∞ —Ç–µ–ø–µ—Ä—å —á–∞—Å—Ç—å –ø–æ—Ç–æ–∫–∞ */
                width: 100%;
                padding: 6px 8px;
                background: rgba(0,0,0,0.1); /* –õ–µ–≥–∫–æ–µ –∑–∞—Ç–µ–º–Ω–µ–Ω–∏–µ –¥–ª—è —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è */
                flex-shrink: 0; /* –ù–µ —Å–∂–∏–º–∞—Ç—å —à–∞–ø–∫—É */
                z-index: 20;
            }
            
            /* 4. –û–±–ª–∞—Å—Ç—å –ø—Ä–æ—Å–º–æ—Ç—Ä–∞: –ó–∞–Ω–∏–º–∞–µ—Ç –æ—Å—Ç–∞—Ç–æ–∫ –º–µ—Å—Ç–∞ –≤ –∫–∞—Ä—Ç–µ */
            .viewport { 
                flex: 1; 
                width: 100%;
                height: 100%; /* –í–∞–∂–Ω–æ –¥–ª—è flex-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ */
                padding: 10px !important; /* –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –æ—Ç—Å—Ç—É–ø, —á—Ç–æ–±—ã –Ω–µ –ø—Ä–∏–ª–∏–ø–∞–ª–æ –∫ –∫—Ä–∞—è–º */
                display: flex; 
                align-items: center; 
                justify-content: center; 
                overflow: hidden; 
                position: relative;
            }

            /* 5. –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –ø—Ä–µ–≤—å—é */
            .preview-row {
                width: 100%;
                height: 100%; /* –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –≤—ã—Å–æ—Ç–æ–π —Ä–æ–¥–∏—Ç–µ–ª—è */
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 10px;
            }

            /* 1. –°—Ç–∏–ª–∏ –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ (–Ω–µ–º–Ω–æ–≥–æ —É–ø—Ä–æ—Å—Ç–∏–º) */
        #resultBox, #origBox {
            position: relative;
            pointer-events: none;
            flex: 0 1 auto;
            display: flex;
            justify-content: center;
            align-items: center;
            /* –£–±–∏—Ä–∞–µ–º line-height: 0 –æ—Ç—Å—é–¥–∞, –æ–Ω –º–µ—à–∞–µ—Ç */
        }
        #origBox { max-width: 15%; }
    .image-wrapper {
            position: relative;
            display: inline-block;
            line-height: 0;

            /* –°–¢–ò–õ–ò –†–ê–ú–ö–ò */
            border-radius: 8px;
            padding: 1px;
            background: var(--glass-bg);
            
            transition: transform 0.2s ease-out;
            transform-origin: center center;
            
            /* --- –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø –ú–û–ë–ò–õ–¨–ù–û–ì–û –í–ò–î–ê --- */
            border: 1px solid var(--primary) !important;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3) !important;
            padding: 0 !important;
            background: transparent !important;
            
            /* –î–û–ë–ê–í–¨ –í–û–¢ –≠–¢–£ –°–¢–†–û–ö–£: */
            overflow: hidden; /* –û–±—Ä–µ–∑–∞–µ—Ç —É–≥–ª—ã —Ñ–æ—Ç–æ –ø–æ —Ñ–æ—Ä–º–µ —Ä–∞–º–∫–∏ */
        }

            .preview-content {
            max-width: 100%;
            max-height: 65vh;
            /* –£–±—Ä–∞–ª–∏ border, padding, radius, shadow, background, transition */
            object-fit: contain !important;
            display: block;
            pointer-events: none;
            aspect-ratio: auto;
             
             /* --- –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø –ú–û–ë–ò–õ–¨–ù–û–ì–û –í–ò–î–ê --- */
             border: none !important;
             box-shadow: none !important;
             background: transparent !important;
             border-radius: 0 !important; /* –°–∫—Ä—É–≥–ª–µ–Ω–∏–µ –±–µ—Ä–µ—Ç—Å—è –æ—Ç –æ–±–µ—Ä—Ç–∫–∏ */
        }
        
.preview-label {
            margin: 0;
            background: rgba(0,0,0,0.6);
            padding: 4px 8px;
            border-radius: 4px; /* –ß—É—Ç—å –º–µ–Ω—å—à–µ —Ä–∞–¥–∏—É—Å, —á—Ç–æ–±—ã –≤–ø–∏—Å–∞—Ç—å—Å—è –≤ —É–≥–æ–ª */
            font-size: 9px;
            color: #fff;
            text-transform: uppercase;
            
            position: absolute;
            z-index: 5;
            pointer-events: none;
            border: 1px solid rgba(255,255,255,0.2);
            white-space: nowrap;
            line-height: normal;
            
            /* --- –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø –ú–û–ë–ò–õ–¨–ù–û–ì–û –í–ò–î–ê (–¶–µ–Ω—Ç—Ä–æ–≤–∫–∞) --- */
            left: 50% !important;        /* –°–¥–≤–∏–≥ –Ω–∞ —Å–µ—Ä–µ–¥–∏–Ω—É */
            transform: translateX(-50%) !important; /* –¢–æ—á–Ω–∞—è —Ü–µ–Ω—Ç—Ä–æ–≤–∫–∞ */
            top: 6px !important;         /* –û—Ç—Å—Ç—É–ø —Å–≤–µ—Ä—Ö—É */
            right: auto !important;      /* –°–±—Ä–æ—Å –ø—Ä–∏–≤—è–∑–∫–∏ –∫ –ø—Ä–∞–≤–æ–º—É –∫—Ä–∞—é */
            font-size: 7px !important;   /* –£–º–µ–Ω—å—à–µ–Ω–Ω—ã–π —à—Ä–∏—Ñ—Ç (–±—ã–ª–æ 9px) */
            padding: 2px 5px !important; /* –ë–æ–ª–µ–µ –∫–æ–º–ø–∞–∫—Ç–Ω–∞—è –ø–æ–¥–ª–æ–∂–∫–∞ */
            letter-spacing: 0.5px;       /* –ß—É—Ç—å —Ä–∞–∑—Ä—è–¥–∏–º –±—É–∫–≤—ã –¥–ª—è —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏ */
        }
            /* 7. –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è (–°—Ö–µ–º–∞) */
            #instructionView { 
                padding-top: 10px; 
                overflow: auto; 
                height: 100%; 
            }
            
            /* 8. –ù–∏–∂–Ω—è—è –ø–∞–Ω–µ–ª—å (–ù–∞—Å—Ç—Ä–æ–π–∫–∏): –¢–æ–∂–µ –∫–∞—Ä—Ç–æ—á–∫–∞ */
            .sidebar { 
                order: 2; 
                height: 40vh; /* –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤—ã—Å–æ—Ç–∞ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ */
                flex-shrink: 0; 
                border-radius: 20px; /* –°–∫—Ä—É–≥–ª–µ–Ω–∏—è */
                border: 1px solid var(--glass-border); 
                padding: 15px; 
                padding-bottom: 80px; 
                z-index: 20;
            }
            
            /* –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –ø–ª–∞–≤–∞—é—â–∏—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ */
            #resultBox { max-width: 75%; } 
            #origBox { max-width: 25%; }
            .floating-nav { top: 60px; left: 10px; }
            
            #sectorNav { display: none !important; }
            .stage.expanded-mode #sectorNav { display: block !important; }
            
            body.fullscreen-mode #sectorNav,
            body.fullscreen-mode .stage.expanded-mode #sectorNav { 
                display: none !important; 
            }
        }
        
        body.fullscreen-mode .app-container { display: block !important; padding: 0 !important; }
        body.fullscreen-mode .sidebar, body.fullscreen-mode .header-bar { display: none !important; }
        body.fullscreen-mode .stage { 
            height: 100dvh !important; width: 100vw !important; border-radius: 0 !important; border: none !important; position: fixed; top: 0; left: 0; z-index: 5000; background: var(--bg-gradient);
        }
        #fsExitBtn { display: none; position: fixed; top: 20px; right: 20px; width: 50px; height: 50px; border-radius: 50%; background: rgba(255, 50, 50, 0.9); color: white; font-size: 24px; border: 2px solid white; z-index: 6000; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.5); align-items: center; justify-content: center; }
        body.fullscreen-mode #fsExitBtn { display: flex; }
        body.fullscreen-mode #sectorNav, body.fullscreen-mode #gridZoomControl { display: none !important; }

        @media print {
            body { display: none; }
        }
/* --- –ê–ù–ò–ú–ê–¶–ò–Ø –ù–ê–ñ–ê–¢–ò–Ø –î–õ–Ø –í–°–ï–• –ö–ù–û–ü–û–ö --- */
        .btn:active,
        .btn-action:active,
        .btn-toggle-panel:active,
        .icon-small:active,
        .top-btn:active,
        .reset-vis-btn:active,
        .nav-btn:active,
        .zoom-display-btn:active,
        .lock-btn:active {
            transform: scale(0.95); /* –õ–µ–≥–∫–æ–µ —É–º–µ–Ω—å—à–µ–Ω–∏–µ –ø—Ä–∏ –∫–ª–∏–∫–µ */
            transition: transform 0.05s ease-out; /* –û—á–µ–Ω—å –±—ã—Å—Ç—Ä–∞—è —Ä–µ–∞–∫—Ü–∏—è */
        }
        
        /* –ü–ª–∞–≤–Ω–æ—Å—Ç—å –ø–æ–≤–æ—Ä–æ—Ç–∞ —Å—Ç—Ä–µ–ª–æ—á–∫–∏ –¥–ª—è —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞—é—â–∏—Ö—Å—è –º–µ–Ω—é */
        .settings-arrow {
            transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
        }
/* –°—Ç–∏–ª–∏ –¥–ª—è –≤–≤–æ–¥–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –±–ª–æ–∫–æ–≤ –≤ —Ä–µ–∂–∏–º–µ –°–≤–æ–π AI */
        .stock-input-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 6px;
            font-size: 11px;
            padding: 4px;
            background: rgba(0,0,0,0.1);
            border-radius: 4px;
            border: 1px solid var(--glass-border);
        }
        
        .stock-info {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
        }

        .stock-color-preview {
            width: 16px;
            height: 16px;
            border-radius: 4px;
            border: 1px solid rgba(255,255,255,0.3);
            flex-shrink: 0;
        }

        .stock-input-field {
            width: 60px;
            background: var(--input-bg);
            border: 1px solid var(--glass-border);
            color: var(--text-main);
            border-radius: 4px;
            padding: 4px;
            font-size: 11px;
            text-align: right;
        }

        .stock-input-field:focus {
            border-color: var(--primary);
        }

        /* –ö–æ–≥–¥–∞ –º—ã –≤ —Ä–µ–∂–∏–º–µ –≤–≤–æ–¥–∞, —Å–∫—Ä—ã–≤–∞–µ–º –æ–±—ã—á–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É */
        .algo-box.stock-mode-active {
            border-color: var(--primary);
            background: rgba(var(--primary-rgb), 0.1);
        }
    </style>
</head>
<body data-theme="dark">
    <div id="dropOverlay">–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª —Å—é–¥–∞</div>
    <div id="fsExitBtn" onclick="toggleFullscreen()">‚úñ</div>

    <div id="fsGridControls">
        <button class="reset-vis-btn" onclick="resetGridVisibility()" title="–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å—ë">üëÅ</button>
        <button id="fsZoomBtn" class="reset-vis-btn" onclick="toggleZoomPopupFS()" style="background:var(--glass-bg); border: 1px solid var(--glass-border);" title="–ú–∞—Å—à—Ç–∞–±">üîç</button>
        <div id="fsZoomPopup" class="zoom-popup-unified">
            <input type="range" class="horizontal-range" id="fsGridZoom" min="3" max="200" value="100" oninput="updateGridScale(this.value)">
        </div>
    </div>

    <div id="instructionModal" class="modal-overlay" onclick="closeInstruction(event)">
        <div class="modal">
            <div class="modal-header">
                <span>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –ü—Ä–∏—è—Ç–Ω–æ–π —Å–±–æ—Ä–∫–∏!</span>
                <button class="top-btn" onclick="document.getElementById('instructionModal').style.display='none'">‚úñ</button>
            </div>
            <div class="modal-body">
    <div class="algo-box" style="background: rgba(255, 215, 0, 0.15); border: 2px solid #ffd700; margin-bottom: 25px;">
        <span class="algo-title" style="color: #d4a000; font-size: 18px;">üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç:</span>
        [Image of pixel art mosaic generator interface]
        <ul style="margin-top: 5px; padding-left: 20px;">
            <li>–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ (–∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –µ–≥–æ –≤ –æ–∫–Ω–æ).</li>
            <li>–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–º–µ—Ä —Å—Ö–µ–º—ã (S, M, L, XL –∏–ª–∏ —Å–≤–æ–π). –û—Ç–º–∞—Å—à—Ç–∞–±–∏—Ä—É–π—Ç–µ –ø–æ —à–∏—Ä–∏–Ω–µ –∏ –≤—ã—Å–æ—Ç–µ.</li>
            <li>–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∏–ª—å –æ–±—Ä–∞–±–æ—Ç–∫–∏.</li>
            <li>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤ —Ä–µ–∂–∏–º–µ <b>–°—Ö–µ–º—ã</b>. 
–í –ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–º —Ä–µ–∂–∏–º–µ –Ω–∞–∂–∏–º–∞–π—Ç–µ –Ω–∞ —Ü–∏—Ñ—Ä—ã —Ä—è–¥–æ–≤ –∏–ª–∏ —Å—Ç—Ä–æ–∫ –¥–ª—è –æ—Ç–º–µ—Ç–∫–∏ –∏ —Å–æ–±–∏—Ä–∞–π—Ç–µ.</li>
        </ul>
    </div>

    <p>–≠—Ç–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å—Ö–µ–º —Å–±–æ—Ä–∫–∏ –∫–∞—Ä—Ç–∏–Ω –∏–∑ –±–ª–æ–∫–æ–≤ –ø–æ –ª—é–±–æ–π —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏.</p>

    <div class="algo-box">
        <span class="algo-title">üí° –°–æ–≤–µ—Ç 1: –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ</span>
        –ß–µ–º –º–µ–Ω—å—à–µ –±–ª–æ–∫–æ–≤/–ø–∏–∫—Å–µ–ª–µ–π –ø–æ —à–∏—Ä–∏–Ω–µ, —Ç–µ–º –∫—Ä—É–ø–Ω–µ–µ –∫–∞–¥—Ä–∏—Ä—É–π—Ç–µ –æ–±—ä–µ–∫—Ç (–ª–∏—Ü–æ, –º–æ—Ä–¥–∞ –∂–∏–≤–æ—Ç–Ω–æ–≥–æ –∏ —Ç. –¥.) ‚Äî –ø—Ä–∏ 50—Ö50 –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ –¥–µ–ª–∞—Ç—å –ª–∏—Ü–æ –ø–æ –≤—Å–µ–π —à–∏—Ä–∏–Ω–µ.
    </div>

    <h3>1. –û—Å–Ω–æ–≤–Ω–æ–π —Ä–∞–±–æ—á–∏–π –ø—Ä–æ—Ü–µ—Å—Å</h3>
    <p>–ü—Ä–æ—Ü–µ—Å—Å —Å–æ–∑–¥–∞–Ω–∏—è —à–µ–¥–µ–≤—Ä–∞ —Å–æ—Å—Ç–æ–∏—Ç –∏–∑ 5 –ø—Ä–æ—Å—Ç—ã—Ö —à–∞–≥–æ–≤:</p>
    <ul>
        <li><b>–ó–∞–≥—Ä—É–∑–∫–∞:</b> –ù–∞–∂–º–∏—Ç–µ ¬´–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ¬ª –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ –æ–∫–Ω–æ –±—Ä–∞—É–∑–µ—Ä–∞.</li>
        <li><b>–ì–µ–æ–º–µ—Ç—Ä–∏—è:</b> –í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–º–µ—Ä (S, M, L, XL) –∏ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ –∫–∞–¥—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ (–∑—É–º –∏ —Å–¥–≤–∏–≥), —á—Ç–æ–±—ã –≤ —Ñ–æ–∫—É—Å–µ –æ—Å—Ç–∞–ª–æ—Å—å —Å–∞–º–æ–µ –≤–∞–∂–Ω–æ–µ.</li>
        <li><b>–°—Ç–∏–ª—å:</b> –í—ã–±–µ—Ä–∏—Ç–µ —Ü–≤–µ—Ç–æ–≤—É—é —Å—Ö–µ–º—É. –î–ª—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ –ø–æ—Ä—Ç—Ä–µ—Ç–æ–≤ –∏–¥–µ–∞–ª—å–Ω–æ –ø–æ–¥—Ö–æ–¥–∏—Ç ¬´–ß–µ—Ä–Ω–æ-–±–µ–ª—ã–π¬ª –∏–ª–∏ ¬´–õ–ï–ì–û¬ª.</li>
        <li><b>–¢–æ–Ω–∫–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞:</b> –ü–æ–¥–∫—Ä—É—Ç–∏—Ç–µ –∫–æ–Ω—Ç—Ä–∞—Å—Ç, —Ä–µ–∑–∫–æ—Å—Ç—å –∏ —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ.</li>
        <li><b>–°–±–æ—Ä–∫–∞:</b> –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤–æ –≤–∫–ª–∞–¥–∫—É ¬´–°—Ö–µ–º–∞¬ª –∏ –≤–∫–ª—é—á–∏—Ç–µ –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º –¥–ª—è —É–¥–æ–±–Ω–æ–π —Ä–∞–±–æ—Ç—ã.</li>
    </ul>

    <h3>2. –û–ø–∏—Å–∞–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –∏ –ø–∞–Ω–µ–ª–µ–π</h3>

    <h4>üìç –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å (–ù–∞—Å—Ç—Ä–æ–π–∫–∏)</h4>
    <ul>
        <li><b>–†–ê–ó–ú–ï–†:</b>
            <ul><li><b>–ü—Ä–µ—Å–µ—Ç—ã:</b> –û—Ç 50x50 (S) –¥–æ 150x150 (XL) –∫—É–±–∏–∫–æ–≤.</li></ul>
        </li>
        <li><b>–†–∞–º–∫–∞:</b> –ü–æ–∑–≤–æ–ª—è–µ—Ç –¥–æ–±–∞–≤–∏—Ç—å –æ–∫–∞–Ω—Ç–æ–≤–∫—É (–æ—Ç 1 –¥–æ 5 —Ä—è–¥–æ–≤) –ª—é–±–æ–≥–æ —Ü–≤–µ—Ç–∞ –∏–∑ –ø–∞–ª–∏—Ç—Ä—ã.</li>
        <li><b>–ö–ê–î–†–ò–†–û–í–ê–ù–ò–ï:</b> –ü–æ–∑–≤–æ–ª—è–µ—Ç –ø—Ä–∏–±–ª–∏–∑–∏—Ç—å –ª–∏—Ü–æ –∏–ª–∏ –æ–±—ä–µ–∫—Ç –∏ —Å–¥–≤–∏–Ω—É—Ç—å –µ–≥–æ –ø–æ –æ—Å—è–º X –∏ Y, –Ω–µ –æ–±—Ä–µ–∑–∞—è –∏—Å—Ö–æ–¥–Ω—ã–π —Ñ–∞–π–ª –≤—Ä—É—á–Ω—É—é.</li>
        <li><b>–°–¢–ò–õ–ò –ü–ê–õ–ò–¢–†–´:</b> (–°–º. —Ä–∞–∑–¥–µ–ª 3).</li>
    </ul>

    <div class="algo-box" style="border-color: #28a745; background: rgba(40, 167, 69, 0.1);">
        <span class="algo-title" style="color: #28a745;">üí° –°–æ–≤–µ—Ç 2</span>
        –ù–µ –∑–∞–±—ã–≤–∞–π—Ç–µ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –ø—Ä–æ–µ–∫—Ç!
    </div>

    <ul>
        <li><b>–ù–ê–°–¢–†–û–ô–ö–ò –§–û–¢–û:</b>
            <ul>
                <li><i>–ü–æ—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—è:</i> –£–ø—Ä–æ—â–∞–µ—Ç –ø–µ—Ä–µ—Ö–æ–¥—ã —Ü–≤–µ—Ç–æ–≤, –¥–µ–ª–∞—è –∫–∞—Ä—Ç–∏–Ω–∫—É –±–æ–ª–µ–µ ¬´–ø–ª–∞–∫–∞—Ç–Ω–æ–π¬ª.</li>
                <li><i>–°–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ:</i> –£–±–∏—Ä–∞–µ—Ç –ª–∏—à–Ω–∏–π ¬´—à—É–º¬ª –∏ –º–µ–ª–∫–∏–µ —Ç–æ—á–∫–∏ –Ω–∞ –∫–æ–∂–µ.</li>
                <li><i>–†–µ–∑–∫–æ—Å—Ç—å:</i> <b>–°–∞–º—ã–π –≤–∞–∂–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç.</b> –í—ã—Å–æ–∫–∞—è —Ä–µ–∑–∫–æ—Å—Ç—å –¥–µ–ª–∞–µ—Ç –≥—Ä–∞–Ω–∏—Ü—ã –∫—É–±–∏–∫–æ–≤ —á–µ—Ç–∫–∏–º–∏. –í—ã –º–æ–∂–µ—Ç–µ –º–µ–Ω—è—Ç—å —Å–∏–ª—É (%) –∏ —Ä–∞–¥–∏—É—Å.</li>
                <li><i>–Ø—Ä–∫–æ—Å—Ç—å/–ö–æ–Ω—Ç—Ä–∞—Å—Ç:</i> –ë–∞–∑–æ–≤–∞—è –∫–æ—Ä—Ä–µ–∫—Ü–∏—è –æ—Å–≤–µ—â–µ–Ω–∏—è.</li>
            </ul>
        </li>
        <li><b>–î–ï–¢–ê–õ–ò –°–ë–û–†–ö–ò:</b>
            <ul>
                <li>–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–¥—Å—á–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∫—É–±–∏–∫–æ–≤ –∫–∞–∂–¥–æ–≥–æ —Ü–≤–µ—Ç–∞.</li>
                <li><b>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –±—é–¥–∂–µ—Ç–∞:</b> –≤–≤–µ–¥–∏—Ç–µ —Ü–µ–Ω—É –∑–∞ 1 –∫—É–±–∏–∫.</li>
            </ul>
        </li>
    </ul>

    <div class="algo-box" style="border-color: #ffd700;">
        <span class="algo-title">üí° –°–æ–≤–µ—Ç 3</span>
        –ù–µ –±–æ–π—Ç–µ—Å—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å <b>‚úèÔ∏è –ö–∞—Ä–∞–Ω–¥–∞—à</b> ‚Äî –¥–æ–±–∞–≤–ª—è–π—Ç–µ –∏–ª–∏ —É–¥–∞–ª—è–π—Ç–µ –ª–∏—à–Ω–∏–µ –ø–∏–∫—Å–µ–ª–∏ –Ω—É–∂–Ω—ã–º —Ü–≤–µ—Ç–æ–º.
    </div>

    <h4> –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å (–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ)</h4>
    <ul>
        <li><b>‚Ü∂ –û—Ç–º–µ–Ω–∞:</b> –û—Ç–º–µ–Ω—è–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 –¥–µ–π—Å—Ç–≤–∏–π (–≤–∫–ª—é—á–∞—è —Ä–∏—Å–æ–≤–∞–Ω–∏–µ –∫–∞—Ä–∞–Ω–¥–∞—à–æ–º).</li>
        <li><b>‚úèÔ∏è –ö–∞—Ä–∞–Ω–¥–∞—à:</b> –ü–æ–∑–≤–æ–ª—è–µ—Ç –≤—Ä—É—á–Ω—É—é –ø–µ—Ä–µ–∫—Ä–∞—à–∏–≤–∞—Ç—å –ø–∏–∫—Å–µ–ª–∏ –ø—Ä—è–º–æ –Ω–∞ –ø—Ä–µ–≤—å—é.</li>
        <li><b>üîì –ë–õ–û–ö:</b> –û—Ç–∫–ª—é—á–∞–µ—Ç –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —Å–¥–≤–∏–≥ —Ñ–æ—Ç–æ –ø–∞–ª—å—Ü–∞–º–∏ (–ø–æ–ª–µ–∑–Ω–æ –Ω–∞ —Å–º–∞—Ä—Ç—Ñ–æ–Ω–∞—Ö).</li>
        <li><b>üîç –ó—É–º —Å—Ö–µ–º—ã:</b> –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º–∞—Å—à—Ç–∞–±–∞ —Å–µ—Ç–∫–∏ –≤ —Ä–µ–∂–∏–º–µ ¬´–°—Ö–µ–º–∞¬ª.</li>
        <li><b>‚õ∂ –ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º:</b> –£–±–∏—Ä–∞–µ—Ç –≤—Å—ë –ª–∏—à–Ω–µ–µ. –í —ç—Ç–æ–º —Ä–µ–∂–∏–º–µ –Ω–∞–∂–∞—Ç–∏–µ –Ω–∞ —Ü–∏—Ñ—Ä—É —Ä—è–¥–∞ –∏–ª–∏ –∫–æ–ª–æ–Ω–∫–∏ –∑–∞–∫—Ä–∞—à–∏–≤–∞–µ—Ç –∏—Ö —Ç–µ–Ω—å—é.</li>
    </ul>

    <div class="algo-box">
        <span class="algo-title">üí° –°–æ–≤–µ—Ç 4</span>
        –ï—Å–ª–∏ –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –∫–Ω–æ–ø–∫–∏ <b>¬´–û–ë–ù–û–í–ò–¢–¨¬ª</b> –≤—ã –ø—Ä–æ—Å–∫–æ—á–∏–ª–∏ –ª—É—á—à—É—é –≥–µ–Ω–µ—Ä–∞—Ü–∏—é, –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É <b>¬´‚Ü∂ –û—Ç–º–µ–Ω–∞¬ª</b> ‚Äî –æ–Ω–∞ —Ö—Ä–∞–Ω–∏—Ç –≤ –ø–∞–º—è—Ç–∏ 10 –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —à–∞–≥–æ–≤.
    </div>

    <h3>3. –ì–∏–¥ –ø–æ —Å—Ç–∏–ª—è–º –ø–∞–ª–∏—Ç—Ä—ã</h3>
    <ul>
        <li><b>–ß–µ—Ä–Ω–æ-–±–µ–ª—ã–π:</b> –ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–µ 5 –æ—Ç—Ç–µ–Ω–∫–æ–≤ —Å–µ—Ä–æ–≥–æ. –ò–¥–µ–∞–ª—å–Ω–æ –¥–ª—è —Å—Ç–∏–ª—å–Ω—ã—Ö –ø–æ—Ä—Ç—Ä–µ—Ç–æ–≤.</li>
        <li><b>–õ–ï–ì–û:</b> 5 —è—Ä–∫–∏—Ö –±–∞–∑–æ–≤—ã—Ö —Ü–≤–µ—Ç–æ–≤. –î–ª—è –∫–æ–Ω—Ç—Ä–∞—Å—Ç–Ω—ã—Ö –∏ –≤–µ—Å–µ–ª—ã—Ö –∫–∞—Ä—Ç–∏–Ω–æ–∫.</li>
        <li><b>–û—Ä–∏–≥–∏–Ω–∞–ª (Smart AI):</b> –ü—Ä–æ–≥—Ä–∞–º–º–∞ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ñ–æ—Ç–æ –∏ –≤—ã–±–∏—Ä–∞–µ—Ç —Å–∞–º—ã–µ —á–∞—Å—Ç—ã–µ —Ü–≤–µ—Ç–∞.</li>
        <li><b>–£–º–Ω—ã–π –ù–µ–æ–Ω:</b> –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —è—Ä–∫—É—é —Å–≤–µ—Ç—è—â—É—é—Å—è –ø–∞–ª–∏—Ç—Ä—É —Å –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–≤–µ—Ä–µ–Ω–Ω–æ–π —è—Ä–∫–æ—Å—Ç—å—é.</li>
        <li><b>–°–≤–æ–π AI (–†–µ–∫–æ–ª–æ—Ä):</b> <small>!!!–ê–ª—å—Ñ–∞ –≤–µ—Ä—Å–∏—è!!!</small> (–í—ã –∑–∞–¥–∞–µ—Ç–µ —Å–≤–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–ª–æ–∫–æ–≤, –∞ –ø—Ä–æ–≥—Ä–∞–º–º–∞ –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –≤–∞—Ä–∏–∞–Ω—Ç).</li>
        <li><b>–°–ª—É—á–∞–π–Ω—ã–π (–•–∞–æ—Å):</b> –ü–æ–ª–Ω—ã–π —Ä–∞–Ω–¥–æ–º —Ü–≤–µ—Ç–æ–≤. –ù–µ –±–æ–π—Ç–µ—Å—å –µ–≥–æ ‚Äî –∏ –≤ –•–∞–æ—Å–µ –ø—Ä–æ—Å–∫–∞–∫–∏–≤–∞—é—Ç —à–µ–¥–µ–≤—Ä—ã!</li>
        <li><b>–°–≤–æ–π (–ì—Ä–∞–¥–∏–µ–Ω—Ç):</b> –í—ã —Å–∞–º–∏ –∑–∞–¥–∞—ë—Ç–µ –ø–∞–ª–∏—Ç—Ä—É —Ü–≤–µ—Ç–∞ –∏ –∂–º—ë—Ç–µ ¬´–û–ë–ù–û–í–ò–¢–¨¬ª (–æ—Ç —Ç–µ–º–Ω–æ–≥–æ –∫ —Å–≤–µ—Ç–ª–æ–º—É).</li>
    </ul>

    <h3>4. –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã "–•–∏—Ä—É—Ä–≥–∏—á–µ—Å–∫–æ–π" –ø—Ä–∞–≤–∫–∏</h3>
    <ul>
        <li><b>–†—É—á–Ω–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:</b> –ï—Å–ª–∏ –æ—Å—Ç–∞–ª—Å—è "–æ–¥–∏–Ω–æ–∫–∏–π" –∫—É–±–∏–∫ ‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ —Ü–≤–µ—Ç –∏ –∫–ª–∏–∫–Ω–∏—Ç–µ –ø–æ –Ω–µ–º—É –ö–∞—Ä–∞–Ω–¥–∞—à–æ–º.</li>
        <li><b>–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞–ª–∏—Ç—Ä—ã (‚Üª):</b> –í —Å—Ç–∏–ª—è—Ö AI –∫–Ω–æ–ø–∫–∞ ¬´–û–±–Ω–æ–≤–∏—Ç—å¬ª –ø–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç—Ç–µ–Ω–∫–∏, –Ω–µ –º–µ–Ω—è—è —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ñ–æ—Ç–æ.</li>
    </ul>

    <h3>5. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏ –ü–µ—á–∞—Ç—å</h3>
    <ul>
        <li><b>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ–µ–∫—Ç:</b> –°–∫–∞—á–∏–≤–∞–µ—Ç .json —Ñ–∞–π–ª —Å–æ –≤—Å–µ–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º.</li>
        <li><b>–ó–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ–µ–∫—Ç:</b> –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Ä–∞–±–æ—Ç—É —Å —Ç–æ–≥–æ –∂–µ –º–µ—Å—Ç–∞.</li>
        <li><b>–ü–µ—á–∞—Ç—å (üñ®):</b> –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç PDF —Å –æ–±—â–∏–º –≤–∏–¥–æ–º, —Å–ø–∏—Å–∫–æ–º —Ü–≤–µ—Ç–æ–≤ –∏ —Å–µ–∫—Ç–æ—Ä–∞–º–∏ —Å—Ö–µ–º—ã.</li>
    </ul>

    <div class="algo-box" style="border-color: #ff5555; background: rgba(255, 85, 85, 0.1);">
        <span class="algo-title" style="color: #ff5555;">üí° –°–æ–≤–µ—Ç 5</span>
        –ü–µ—Ä–µ–¥ –ø–µ—á–∞—Ç—å—é –∏–ª–∏ —Å–±–æ—Ä–∫–æ–π –≤—Å–µ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ ¬´–†–µ–∑–∫–æ—Å—Ç—å¬ª (–æ–ø—Ç–∏–º–∞–ª—å–Ω–æ 150-200%), —á—Ç–æ–±—ã –¥–µ—Ç–∞–ª–∏ –Ω–µ –ø—Ä–µ–≤—Ä–∞—Ç–∏–ª–∏—Å—å –≤ ¬´–∫–∞—à—É¬ª.
    </div>
</div>
        </div>
    </div>

    <div class="app-container">
        <aside class="sidebar">
            <button class="btn btn-sec" onclick="showInstruction()" style="margin-bottom:0px; font-weight:bold; border-color:var(--primary); color:var(--primary); border-width:1px; background: rgba(255, 215, 0, 0.05);">üìñ –ò–ù–°–¢–†–£–ö–¶–ò–Ø</button>
            
            <label class="btn btn-primary" for="upload">–ó–ê–ì–†–£–ó–ò–¢–¨ –§–û–¢–û</label>
            <input type="file" id="upload" accept="image/*" hidden>

            <div style="display:flex; gap:5px">
                <button class="btn btn-sec" onclick="saveProject()">–°–û–•–†–ê–ù–ò–¢–¨</button>
                <label class="btn btn-sec" for="loadProject" style="text-align:center; display:block; padding-top:12px;">–ó–ê–ì–†–£–ó–ò–¢–¨</label>
                <input type="file" id="loadProject" accept=".json" hidden>
            </div>

            <div class="card">
                <button class="btn-toggle-panel" id="sizeToggleBtn" onclick="togglePanel('sizePanel', 'sizeToggleBtn')">
                    –†–ê–ó–ú–ï–† <span class="settings-arrow">‚ñº</span>
                </button>
                <div id="sizePanel" class="panel-content">
    <div style="display:flex; gap:5px; margin-bottom:5px;">
        <select class="modern-select" id="setSize" style="margin:0;">
            <option value="50" selected>S (50x50)</option>
            <option value="75">M (75x75)</option>
            <option value="100">L (100x100)</option>
            <option value="150">XL (150x150)</option>
            <option value="custom">–°–≤–æ–π —Ä–∞–∑–º–µ—Ä...</option>
        </select>
        <button id="borderBtn" class="btn btn-sec" style="width:auto; padding:0 8px; white-space: nowrap;" onclick="toggleBorderControl()">–†–ê–ú–ö–ê</button>
    </div>
    
    <div id="borderControl" style="display: none; margin-top: 10px; padding: 8px; background: rgba(0,0,0,0.1); border-radius: 6px;">
        <div class="slider-header-compact"><span class="slider-label">–¢–æ–ª—â–∏–Ω–∞ —Ä–∞–º–∫–∏: <span class="val-display" id="borderWidthVal">0</span></span></div>
        <input type="range" id="borderWidth" min="0" max="5" value="0" oninput="updateBorderSettings()">
        <select class="modern-select" id="borderColor" style="margin-top:5px; padding:6px;" onchange="updateBorderSettings()"></select>
    </div>
    
    <div id="customSizeGroup" class="custom-size-inputs" style="display:none; margin-top: 5px;">
        <input type="number" id="customWidth" class="modern-input" placeholder="W" min="10" value="50">
        <input type="number" id="customHeight" class="modern-input" placeholder="H" min="10" value="50">
    </div>
</div>
            </div>

            <div class="card">
                <button class="btn-toggle-panel" id="cropToggleBtn" onclick="togglePanel('cropPanel', 'cropToggleBtn')">
                    –ö–ê–î–†–ò–†–û–í–ê–ù–ò–ï <span class="settings-arrow">‚ñº</span>
                </button>
                <div id="cropPanel" class="panel-content">
                    <div class="slider-group" id="group-zoom">
                        <div class="slider-header-compact">–ú–∞—Å—à—Ç–∞–± <span class="val-display" id="zoomVal">100%</span></div>
                        <div class="slider-row"><span class="icon-btn-side reset-btn" onclick="resetSlider('zoom', 100)">‚Ü∫</span><input type="range" id="zoom" min="1" max="300" value="100"><span class="icon-btn-side lock-toggle" onclick="toggleLock('group-zoom', 'zoom')">üîì</span></div>
                    </div>
                    <div class="slider-group" id="group-panX">
                        <div class="slider-header-compact">–°–¥–≤–∏–≥ X <span class="val-display" id="panXVal">0%</span></div>
                        <div class="slider-row"><span class="icon-btn-side reset-btn" onclick="resetSlider('panX', 0)">‚Ü∫</span><input type="range" id="panX" min="-100" max="100" value="0"><span class="icon-btn-side lock-toggle" onclick="toggleLock('group-panX', 'panX')">üîì</span></div>
                    </div>
                    <div class="slider-group" id="group-panY">
                        <div class="slider-header-compact">–°–¥–≤–∏–≥ Y <span class="val-display" id="panYVal">0%</span></div>
                        <div class="slider-row"><span class="icon-btn-side reset-btn" onclick="resetSlider('panY', 0)">‚Ü∫</span><input type="range" id="panY" min="-100" max="100" value="0"><span class="icon-btn-side lock-toggle" onclick="toggleLock('group-panY', 'panY')">üîì</span></div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">–°—Ç–∏–ª–∏ –ø–∞–ª–∏—Ç—Ä—ã</div>
                <select class="modern-select" id="palettePreset">
                    <option value="custom_ai">–°–≤–æ–π AI (–†–µ–∫–æ–ª–æ—Ä)</option>
                    <option value="original">–û—Ä–∏–≥–∏–Ω–∞–ª (Smart AI)</option>
                    <option value="bw" selected>–ß–µ—Ä–Ω–æ-–±–µ–ª—ã–π</option>
                    <option value="popart">–õ–ï–ì–û</option>
                    <option value="custom">–°–≤–æ–π (–ì—Ä–∞–¥–∏–µ–Ω—Ç)</option>
                    <option value="smart_neon">–£–º–Ω—ã–π –ù–µ–æ–Ω</option>
                    <option value="random_chaos">–°–ª—É—á–∞–π–Ω—ã–π (–•–∞–æ—Å)</option>
                </select>

                <div class="slider-group" id="colorCountGroup" style="display:none; margin-bottom:10px;">
                    <div class="slider-header-compact">
                        <span class="slider-label">–ö–æ–ª-–≤–æ —Ü–≤–µ—Ç–æ–≤: <span class="val-display" id="colorCountVal" style="margin-left:5px;">5</span></span>
                    </div>
                    <div class="slider-row">
                        <input type="range" id="colorCount" min="3" max="12" value="12">
                        <span class="icon-btn-side lock-toggle" onclick="toggleLock('colorCountGroup', 'colorCount')">üîì</span>
                    </div>
                </div>

                <div class="palette-row">
                    <div class="palette-grid" id="paletteContainer"></div>
                </div>
                
                <div class="palette-actions">
                    <button id="refreshPaletteBtn" class="btn-action btn-refresh" onclick="refreshSmartPalette()">‚Üª –û–±–Ω–æ–≤–∏—Ç—å</button>
                    <button class="btn-action btn-danger-small" onclick="resetStylesOnly()">‚Ü∫ –°–±—Ä–æ—Å</button>
                </div>
            </div>

            <div class="card">
                <button class="btn-toggle-panel" id="settingsToggleBtn" onclick="togglePanel('settingsPanel', 'settingsToggleBtn')">
                    –ù–ê–°–¢–†–û–ô–ö–ò –§–û–¢–û <span class="settings-arrow">‚ñº</span>
                </button>
                
                <div id="settingsPanel" class="panel-content">
                    
                    <div class="slider-group" id="group-posterize">
                        <div class="slider-header-compact">–ü–æ—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—è <span class="val-display" id="posterizeVal">0</span></div>
                        <div class="slider-row">
                            <span class="icon-btn-side reset-btn" onclick="resetSlider('posterize', 0)">‚Ü∫</span>
                            <input type="range" id="posterize" min="0" max="10" step="1" value="0">
                            <span class="icon-btn-side lock-toggle" onclick="toggleLock('group-posterize', 'posterize')">üîì</span>
                        </div>
                    </div>

                    <div class="slider-group" id="group-smartBlur">
                        <div class="slider-header-compact">–°–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ <span class="val-display" id="smartBlurVal">0</span></div>
                        <div class="slider-row">
                            <span class="icon-btn-side reset-btn" onclick="resetSlider('smartBlur', 0)">‚Ü∫</span>
                            <input type="range" id="smartBlur" min="0" max="60" value="0">
                            <span class="icon-btn-side lock-toggle" onclick="toggleLock('group-smartBlur', 'smartBlur')">üîì</span>
                        </div>
                    </div>

                    <div class="slider-group" id="group-sharpness">
                        <div class="slider-header-compact">
                            <span>–†–µ–∑–∫–æ—Å—Ç—å <span class="val-display" id="sharpnessVal">164%</span></span>
                            <div style="display:flex; align-items:center; gap:2px;">
                                <span style="font-size:9px; color:#aaa;">Radius:</span>
                                <div class="num-ctrl-btn" onclick="changeRadius(-1)">-</div>
                                <input type="number" id="usmRadius" class="num-input-small" value="23" min="0" max="50" onchange="processImage()">
                                <div class="num-ctrl-btn" onclick="changeRadius(1)">+</div>
                            </div>
                        </div>
                        <div class="slider-row">
                            <span class="icon-btn-side reset-btn" onclick="resetSlider('sharpness', 164)">‚Ü∫</span>
                            <input type="range" id="sharpness" min="0" max="500" value="164">
                            <span class="icon-btn-side lock-toggle" onclick="toggleLock('group-sharpness', 'sharpness')">üîì</span>
                        </div>
                    </div>

                    <div class="slider-group" id="group-contrast">
                        <div class="slider-header-compact">–ö–æ–Ω—Ç—Ä–∞—Å—Ç <span class="val-display" id="contrastVal">100%</span></div>
                        <div class="slider-row"><span class="icon-btn-side reset-btn" onclick="resetSlider('contrast', 100)">‚Ü∫</span><input type="range" id="contrast" min="0" max="250" value="100"><span class="icon-btn-side lock-toggle" onclick="toggleLock('group-contrast', 'contrast')">üîì</span></div>
                    </div>

                    <div class="slider-group" id="group-brightness">
                        <div class="slider-header-compact">–Ø—Ä–∫–æ—Å—Ç—å <span class="val-display" id="brightnessVal">100%</span></div>
                        <div class="slider-row"><span class="icon-btn-side reset-btn" onclick="resetSlider('brightness', 100)">‚Ü∫</span><input type="range" id="brightness" min="0" max="200" value="100"><span class="icon-btn-side lock-toggle" onclick="toggleLock('group-brightness', 'brightness')">üîì</span></div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">–î–µ—Ç–∞–ª–∏ —Å–±–æ—Ä–∫–∏</div>
                <select class="modern-select" id="symbolSet">
                    <option value="letters">–ë—É–∫–≤—ã (B, X, G...)</option>
                    <option value="numbers">–¶–∏—Ñ—Ä—ã (1, 2, 3...)</option>
                    <option value="shapes">–§–∏–≥—É—Ä—ã (‚ñ†, ‚ñ≤, ‚óè...)</option>
                    <option value="roman">–†–∏–º—Å–∫–∏–µ (I, II, III...)</option>
                </select>
                <div id="statsContent"></div>
                <div style="margin-top:5px;"><input type="number" id="brickPrice" class="modern-input" placeholder="–¶–µ–Ω–∞ –∑–∞ —à—Ç." oninput="updateStats()"></div>
                <div style="margin-top:8px; border-top:1px solid rgba(255,255,255,0.2); padding-top:5px; font-weight:bold; display:flex; justify-content:space-between; font-size:12px;"><span>–ò–¢–û–ì–û –®–¢:</span><span id="totalBricks">0</span></div>
                <div style="display:flex; justify-content:space-between; font-size:12px; margin-top:4px;"><span>–ë–Æ–î–ñ–ï–¢:</span><span id="totalCost">0 ‚ÇΩ</span></div>
            </div>
            
            <div id="versionLabel" onclick="cycleLayoutMode()" style="text-align:center; font-size:10px; color:var(--text-sec); margin-top:20px; opacity:0.6; cursor:pointer; user-select:none;" title="–ù–∞–∂–º–∏ –¥–ª—è —Å–º–µ–Ω—ã —Ä–µ–∂–∏–º–∞ (Auto/Mobile/PC)">
    PhotoBrick v2.1.9
</div>
        </aside>

        <main class="stage">
            <div class="header-bar">
                <div class="header-left">
                    <button class="icon-small" onclick="undo()" title="Undo">‚Ü∂</button>
                    <div class="mode-toggle">
                        <div class="toggle-opt active" id="tab-preview" onclick="switchTab('preview')">–í–∏–¥</div>
                        <div class="toggle-opt" id="tab-instruction" onclick="switchTab('instruction')">–°—Ö–µ–º–∞</div>
                    </div>
                    <button class="icon-small" id="pencilBtn" onclick="togglePencil()" title="–ö–∞—Ä–∞–Ω–¥–∞—à">‚úèÔ∏è</button>
                    <button id="gestureLockBtn" class="lock-btn" onclick="toggleGestureLock()">üîì –ë–õ–û–ö</button>
                    <div id="gridZoomControl" style="position:relative; display:none;">
                        <button class="zoom-display-btn" id="zoomDisplayBtn" onclick="toggleZoomPopup()"><span>üîç</span> <span id="zoomText">100%</span></button>
                        <div id="zoomPopup" class="zoom-popup-unified">
                             <input type="range" class="horizontal-range" id="gridZoom" min="3" max="200" value="100" oninput="updateGridScale(this.value)">
                        </div>
                    </div>
                </div>
                <div class="header-right">
                    <button class="top-btn" onclick="toggleFullscreen()">‚õ∂</button>
                    <button class="top-btn" onclick="toggleTheme()">‚òÄ</button>
                    <button class="top-btn" onclick="preparePrint()">üñ®</button>
                </div>
            </div>

            <div class="viewport" id="previewContainer">
                <div class="preview-row">
                    <div class="preview-box" id="resultBox" style="display:none">
                        <div class="image-wrapper">
                            <div class="preview-label" id="resultLabel">–†–ï–ó–£–õ–¨–¢–ê–¢</div>
                            <canvas id="mainCanvas" class="preview-content"></canvas>
                        </div>
                    </div>
                    
                    <div class="preview-box" id="origBox" style="display:none">
                         <div class="image-wrapper">
                             <div class="preview-label">–û–†–ò–ì–ò–ù–ê–õ</div>
                             <img id="originalImageThumb" class="preview-content">
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="sectorNav" class="floating-nav">
                <div class="nav-grid">
                    <button class="nav-btn nav-1" onclick="setSector(1)">‚ñõ</button><div></div><button class="nav-btn nav-2" onclick="setSector(2)">‚ñú</button>
                    <div></div><button class="nav-btn nav-all active" id="sec-all" onclick="setSector('all')">–í–ï–°–¨</button><div></div>
                    <button class="nav-btn nav-3" onclick="setSector(3)">‚ñô</button><div></div><button class="nav-btn nav-4" onclick="setSector(4)">‚ñü</button>
                </div>
            </div>

            <div id="instructionView">
                <div id="gridContainer"></div>
            </div>
        </main>
    </div>

    <canvas id="procCanvas" style="display:none"></canvas>
<div id="helperSelectModal" class="modal-overlay" onclick="closeHelperModal(event)">
        <div class="modal" style="max-width: 300px;">
            <div class="modal-header">
                <span>–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ç—Ç–µ–Ω–æ–∫</span>
                <button class="top-btn" onclick="document.getElementById('helperSelectModal').style.display='none'">‚úñ</button>
            </div>
            <div class="modal-body" style="text-align: center;">
                <p style="font-size: 12px; color: var(--text-sec); margin-top: 0;">–ù–∞–∂–º–∏—Ç–µ –Ω–∞ —Ü–≤–µ—Ç, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –µ–≥–æ –∫–∞–∫ –ø–æ–º–æ—â–Ω–∏–∫–∞ –¥–ª—è —Å–º–µ—à–∏–≤–∞–Ω–∏—è.</p>
                <div id="helperPaletteGrid" style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; padding: 10px;">
                    </div>
            </div>
        </div>
    </div>
    <script>
        const SYMBOL_SETS = { 
    letters: ["B", "X", "G", "H", "W", "A", "C", "D", "E", "F", "K", "L"], 
    numbers: ["1", "2", "3", "4", "5", "6", "7", "8", "9", "10", "11", "12"], 
    shapes: ["‚ñ†", "‚ñ≤", "‚óè", "‚óÜ", "‚òÖ", "‚úö", "‚ñº", "‚¨ü", "‚¨¢", "‚¨•", "‚¨¶", "‚¨ß"], 
    roman: ["I", "II", "III", "IV", "V", "VI", "VII", "VIII", "IX", "X", "XI", "XII"] 
};
        let currentSymbolSet = SYMBOL_SETS.letters;
        const PRESETS = { 'bw': ["#141414", "#484848", "#7e7e7e", "#b4b4b4", "#ffffff"] };
        const LEGO_PALETTE = ["#111111", "#004d99", "#b80000", "#fdb927", "#ffffff"];

        let stockQuantities = [150, 150, 150, 150, 150, 150, 150, 150, 150, 150, 150, 150]; // –•—Ä–∞–Ω–∏—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–ª–æ–∫–æ–≤ (–º–∞–∫—Å 12 —Ü–≤–µ—Ç–æ–≤)
        let stockAssists = {}; // –•—Ä–∞–Ω–∏–ª–∏—â–µ –ø–æ–º–æ—â–Ω–∏–∫–æ–≤: { primaryIndex: [ {hex, qty, id}, ... ] }
        let displayPalette = []; // –ü–∞–ª–∏—Ç—Ä–∞ –¥–ª—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ (–û—Å–Ω–æ–≤–Ω–∞—è + –ü–æ–º–æ—â–Ω–∏–∫–∏)
        let displaySymbols = []; // –°–∏–º–≤–æ–ª—ã –¥–ª—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏
        let isStockMode = false; // –§–ª–∞–≥, –≤–∫–ª—é—á–µ–Ω –ª–∏ —Ä–µ–∂–∏–º "–°–≤–æ–π AI"
        let useMixMode = false;
        let activeHelperIdx = -1;
        let currentPalette = []; 
        let aiBasePalette = []; 
        let sourceImage = null;
        let generatedMatrix = []; 
        let finalMatrix = []; 
        let currentSector = 'all';
        let gesturesLocked = false;
        
        let historyStack = [];
        let isPencil = false;
        let selectedBrushIndex = 0;
        
        let hiddenRegions = new Set(); // –•—Ä–∞–Ω–∏—Ç —Å—Ç—Ä–æ–∫–∏ –≤–∏–¥–∞ "row_Y_startX_endX" –∏–ª–∏ "col_X_startY_endY"
        let currentGridBounds = { sX: 0, eX: 0, sY: 0, eY: 0 }; // –¢–µ–∫—É—â–∏–µ –≥—Ä–∞–Ω–∏—Ü—ã –ø—Ä–æ—Å–º–æ—Ç—Ä–∞

        window.addEventListener('popstate', (event) => { if(sourceImage){ if(!confirm("–ü—Ä–æ–µ–∫—Ç –±—É–¥–µ—Ç –∑–∞–∫—Ä—ã—Ç. –í—ã —É–≤–µ—Ä–µ–Ω—ã?")){ history.pushState({page: 1}, document.title, location.href); } } });
        window.addEventListener('beforeunload', (event) => { if (sourceImage) { event.preventDefault(); event.returnValue = '–ü—Ä–æ–µ–∫—Ç –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω!'; return '–ü—Ä–æ–µ–∫—Ç –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω!'; } });
        
        function activateHistoryTrap() { history.pushState({page: 1}, document.title, location.href); }

        window.onload = () => { 
            document.getElementById('palettePreset').value = 'bw';
            currentPalette = [...PRESETS['bw']]; 
            aiBasePalette = [...PRESETS['bw']];

            renderPaletteUI(); setupEvents(); setupTouchGestures(); setupGridGestures(); setupMouseGestures(); setupDragDrop(); 
            document.getElementById('colorCountGroup').style.display = 'none'; 
            document.getElementById('refreshPaletteBtn').style.display = 'flex';
        };

        function showInstruction() { document.getElementById('instructionModal').style.display = 'flex'; }
        function closeInstruction(e) { if(e.target.id === 'instructionModal') document.getElementById('instructionModal').style.display = 'none'; }
        function pushHistory() { if(historyStack.length > 9) historyStack.shift(); historyStack.push(JSON.stringify({ mat: generatedMatrix, pal: [...currentPalette], ai: [...aiBasePalette] })); }
        function undo() { if(!historyStack.length) return; const state = JSON.parse(historyStack.pop()); generatedMatrix = state.mat; currentPalette = state.pal; aiBasePalette = state.ai; finalizeMatrixWithBorder(); renderPaletteUI(); }
        function setupDragDrop() { const body = document.body; const overlay = document.getElementById('dropOverlay'); body.addEventListener('dragover', (e) => { e.preventDefault(); overlay.style.display = 'flex'; }); body.addEventListener('dragleave', (e) => { if(e.target === overlay) overlay.style.display = 'none'; }); body.addEventListener('drop', (e) => { e.preventDefault(); overlay.style.display = 'none'; if (e.dataTransfer.files && e.dataTransfer.files[0]) { const file = e.dataTransfer.files[0]; if (file.type.match('image.*')) { const reader = new FileReader(); reader.onload = (ev) => { sourceImage = new Image(); sourceImage.onload = () => { activateHistoryTrap(); document.getElementById('origBox').style.display = 'flex'; document.getElementById('resultBox').style.display = 'flex'; document.getElementById('originalImageThumb').src = sourceImage.src; 
                    resetStylesOnly(); 
                }; sourceImage.src = ev.target.result; }; reader.readAsDataURL(file); } else if (file.name.endsWith('.json')) { const reader = new FileReader(); reader.onload = (ev) => processLoadedProject(ev.target.result); reader.readAsText(file); } } }); }

        function togglePanel(panelId, btnId) {
            const panel = document.getElementById(panelId);
            const btn = document.getElementById(btnId);
            const arrow = btn.querySelector('.settings-arrow');
            if(panel.style.display === 'block') { panel.style.display = 'none'; btn.classList.remove('expanded'); arrow.classList.remove('rotated'); } 
            else { panel.style.display = 'block'; btn.classList.add('expanded'); arrow.classList.add('rotated'); }
        }

        function changeRadius(delta) {
            const input = document.getElementById('usmRadius');
            let val = parseInt(input.value) || 23;
            val = Math.max(0, Math.min(50, val + delta));
            input.value = val;
            processImage();
        }

        function setupEvents() {
            document.getElementById('upload').onchange = handleUpload; document.getElementById('loadProject').onchange = loadProject;
            document.getElementById('symbolSet').onchange = (e) => { currentSymbolSet = SYMBOL_SETS[e.target.value]; updateStats(); renderPaletteUI(); if(document.getElementById('instructionView').style.display === 'block') drawGrid(); };
            ['zoom', 'contrast', 'brightness', 'panX', 'panY', 'smartBlur', 'sharpness', 'posterize'].forEach(id => { document.getElementById(id).oninput = (e) => { let suffix = '%'; if(id === 'smartBlur' || id === 'posterize') suffix = ''; document.getElementById(id+'Val').innerText = e.target.value + suffix; if(sourceImage) processImage(); }; });
            document.getElementById('palettePreset').onchange = (e) => { 
                pushHistory(); 
                const val = e.target.value; 
                const showCount = ['original', 'random_chaos', 'custom', 'custom_ai', 'smart_neon'].includes(val); 
                document.getElementById('colorCountGroup').style.display = showCount ? 'block' : 'none'; 
                const showRefresh = ['smart_neon', 'original', 'random_chaos', 'custom_ai', 'bw', 'popart', 'custom'].includes(val); 
                document.getElementById('refreshPaletteBtn').style.display = showRefresh ? 'flex' : 'none'; 
                applyPaletteLogic(val); 
            };
            document.getElementById('colorCount').oninput = (e) => { document.getElementById('colorCountVal').innerText = e.target.value; };
            document.getElementById('colorCount').onchange = () => { 
                pushHistory(); 
                const val = document.getElementById('palettePreset').value; 
                if(val === 'original') { extractPaletteQuantized(); } 
                else if (val === 'random_chaos') { generateChaosPalette(); } 
                else if (val === 'custom') { updateCustomColorCount(parseInt(document.getElementById('colorCount').value)); } 
                else if (val === 'custom_ai') { extractPaletteQuantized(); aiBasePalette=[...currentPalette]; } 
                else if (val === 'smart_neon') { 
                    updateCustomColorCount(parseInt(document.getElementById('colorCount').value));
                    extractPaletteQuantized(); 
                    aiBasePalette=[...currentPalette]; 
                    generateSmartPalette(true); 
                } 
                else if (val === 'popart') { refreshSmartPalette(); } 
                renderPaletteUI(); processImage(); 
            };
            const setSizeSelect = document.getElementById('setSize'); setSizeSelect.onchange = () => { document.getElementById('customSizeGroup').style.display = (setSizeSelect.value === 'custom') ? 'flex' : 'none'; if(sourceImage) processImage(); }; document.getElementById('customWidth').oninput = () => { if(sourceImage) processImage(); }; document.getElementById('customHeight').oninput = () => { if(sourceImage) processImage(); };
            const gridZoom = document.getElementById('gridZoom'); gridZoom.oninput = (e) => { updateGridScale(e.target.value); };
            document.addEventListener('click', (e) => { if(!document.body.classList.contains('fullscreen-mode')) return; if(window.innerWidth >= 1024) return; if(e.target.closest('#fsGridControls')) return; if(e.target.closest('#fsExitBtn')) return; });
        }

        function updateGridScale(val) {
            const scale = val / 100;
            const intVal = Math.round(val);
            
            // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –æ–±–∞ –ø–æ–ª–∑—É–Ω–∫–∞ (–≤ —à–∞–ø–∫–µ –∏ –≤ –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–º –º–µ–Ω—é)
            document.getElementById('gridZoom').value = intVal;
            document.getElementById('fsGridZoom').value = intVal;
            document.getElementById('zoomText').innerText = intVal + '%';

            // 1. –ú–ê–°–®–¢–ê–ë –î–õ–Ø –°–•–ï–ú–´ (–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è)
            const grid = document.querySelector('#gridContainer .instruction-grid');
            if (grid) {
                grid.style.transform = `scale(${scale})`;
                const container = document.getElementById('gridContainer');
                container.style.width = (grid.offsetWidth * scale) + 'px';
                container.style.height = (grid.offsetHeight * scale) + 'px';
            }

            // 2. –ú–ê–°–®–¢–ê–ë –î–õ–Ø –†–ï–ó–£–õ–¨–¢–ê–¢–ê (–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω: —Ä–∞–±–æ—Ç–∞–µ—Ç –∏ –≤ Fullscreen, –∏ –≤ –æ–±—ã—á–Ω–æ–º –í–∏–¥–µ)
            const resultWrapper = document.querySelector('#resultBox .image-wrapper');
            if (resultWrapper) {
                resultWrapper.style.transform = `scale(${scale})`;
            }
        }
        function toggleZoomPopup() { const p = document.getElementById('zoomPopup'); const btn = document.getElementById('zoomDisplayBtn'); p.classList.toggle('show'); btn.classList.toggle('btn-active-state'); }
        document.addEventListener('click', (e) => { const p = document.getElementById('zoomPopup'); const btn = document.getElementById('zoomDisplayBtn'); if(p.classList.contains('show') && !p.contains(e.target) && !btn.contains(e.target)) { p.classList.remove('show'); btn.classList.remove('btn-active-state'); } });
        function toggleZoomPopupFS() { const z = document.getElementById('fsZoomPopup'); if(z.classList.contains('show')) { z.classList.remove('show'); document.getElementById('fsZoomBtn').classList.remove('btn-active-state'); } else { z.classList.add('show'); document.getElementById('fsZoomBtn').classList.add('btn-active-state'); } }
        function toggleLock(groupId, inputId) { const group = document.getElementById(groupId); const input = document.getElementById(inputId); const btn = group.querySelector('.lock-toggle'); if(group.classList.contains('locked')) { group.classList.remove('locked'); input.disabled = false; btn.innerText = 'üîì'; } else { group.classList.add('locked'); input.disabled = true; btn.innerText = 'üîí'; } }
        function toggleGestureLock() { gesturesLocked = !gesturesLocked; const btn = document.getElementById('gestureLockBtn'); btn.classList.toggle('active'); btn.innerText = gesturesLocked ? 'üîí –ë–õ–û–ö' : 'üîì –ë–õ–û–ö'; }
        
        function setupTouchGestures() {
            const el = document.getElementById('previewContainer');
            let isDragging = false, startX, startY, startPanX, startPanY, initialDist = 0, startZoom = 100;
            
            // –ù–æ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –∑—É–º–∞ —Å–µ—Ç–∫–∏ –≤ —Ä–µ–∂–∏–º–µ –±–ª–æ–∫–∞
            let gridStartDist = 0, gridStartZoom = 100;

            const getCoord = (e) => { const r=document.getElementById('mainCanvas').getBoundingClientRect(); const sx=document.getElementById('mainCanvas').width/r.width; const sy=document.getElementById('mainCanvas').height/r.height; const cx=e.touches?e.touches[0].clientX:e.clientX; const cy=e.touches?e.touches[0].clientY:e.clientY; return {x:Math.floor((cx-r.left)*sx/10), y:Math.floor((cy-r.top)*sy/10)}; };
            
            const paint = (e) => { if(!finalMatrix.length)return; const {x,y}=getCoord(e); if(y>=0&&y<finalMatrix.length&&x>=0&&x<finalMatrix[0].length){ if(finalMatrix[y][x]!==selectedBrushIndex){ finalMatrix[y][x]=selectedBrushIndex; const bW=parseInt(document.getElementById('borderWidth').value); if(generatedMatrix.length && x>=bW && x<finalMatrix[0].length-bW && y>=bW && y<finalMatrix.length-bW){ generatedMatrix[y-bW][x-bW]=selectedBrushIndex; } drawPreview(finalMatrix[0].length,finalMatrix.length); updateStats(); } } };

            el.addEventListener('touchstart', (e) => {
                if(isPencil){pushHistory(); paint(e); return;}
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –∫–∞—Ä—Ç–∏–Ω–∫–∏
                if(!sourceImage) return;

                // --- –ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê: –ï–°–õ–ò –í–ö–õ–Æ–ß–ï–ù –ë–õ–û–ö ---
                if (gesturesLocked) {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º: 2 –ø–∞–ª—å—Ü–∞ –ò –º–æ–±–∏–ª—å–Ω—ã–π –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º
                    const isMobilePort = window.innerWidth <= 768 && window.innerHeight > window.innerWidth;
                    
                    if (e.touches.length === 2 && isMobilePort) {
                        e.preventDefault();
                        // –ó–∞–ø–æ–º–∏–Ω–∞–µ–º –Ω–∞—á–∞–ª—å–Ω–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –∏ —Ç–µ–∫—É—â–∏–π –∑—É–º –°–ï–¢–ö–ò
                        gridStartDist = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
                        gridStartZoom = parseInt(document.getElementById('gridZoom').value);
                    }
                    // –ï—Å–ª–∏ –±–ª–æ–∫ –∞–∫—Ç–∏–≤–µ–Ω, –ø—Ä–µ—Ä—ã–≤–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ (–∫–∞–¥—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç)
                    return; 
                }
                // ----------------------------------------

                // –°–¢–ê–ù–î–ê–†–¢–ù–û–ï –ö–ê–î–†–ò–†–û–í–ê–ù–ò–ï (–ï—Å–ª–∏ –±–ª–æ–∫ –≤—ã–∫–ª—é—á–µ–Ω)
                if (e.touches.length === 1) {
                    if(document.getElementById('group-panX').classList.contains('locked') && document.getElementById('group-panY').classList.contains('locked')) return;
                    isDragging = true;
                    startX = e.touches[0].clientX;
                    startY = e.touches[0].clientY;
                    startPanX = parseInt(document.getElementById('panX').value);
                    startPanY = parseInt(document.getElementById('panY').value);
                } else if (e.touches.length === 2) {
                    if(document.getElementById('group-zoom').classList.contains('locked')) return;
                    isDragging = false;
                    initialDist = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
                    startZoom = parseInt(document.getElementById('zoom').value);
                }
            }, {passive: false});

            el.addEventListener('touchmove', (e) => {
                if(isPencil){paint(e); e.preventDefault(); return;}
                if(!sourceImage) return;

                // --- –ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê: –ï–°–õ–ò –í–ö–õ–Æ–ß–ï–ù –ë–õ–û–ö ---
                if (gesturesLocked) {
                    const isMobilePort = window.innerWidth <= 768 && window.innerHeight > window.innerWidth;
                    
                    if (e.touches.length === 2 && isMobilePort && gridStartDist > 0) {
                        e.preventDefault();
                        const dist = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
                        const ratio = dist / gridStartDist;
                        
                        // –í—ã—á–∏—Å–ª—è–µ–º –Ω–æ–≤—ã–π –∑—É–º –¥–ª—è –°–ï–¢–ö–ò (–Ω–µ –¥–ª—è —Ñ–æ—Ç–æ)
                        let newGridZoom = gridStartZoom * ratio;
                        newGridZoom = Math.max(3, Math.min(200, newGridZoom)); // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è min/max –∫–∞–∫ –≤ HTML
                        
                        updateGridScale(newGridZoom);
                    }
                    return;
                }
                // ----------------------------------------

                // –°–¢–ê–ù–î–ê–†–¢–ù–û–ï –ö–ê–î–†–ò–†–û–í–ê–ù–ò–ï (–ï—Å–ª–∏ –±–ª–æ–∫ –≤—ã–∫–ª—é—á–µ–Ω)
                e.preventDefault();
                if (e.touches.length === 1 && isDragging) {
                    const dx = e.touches[0].clientX - startX;
                    const dy = e.touches[0].clientY - startY;
                    const scaleFactor = 0.5;
                    if(!document.getElementById('group-panX').classList.contains('locked')) {
                        let newPanX = startPanX + (dx * scaleFactor);
                        newPanX = Math.max(-100, Math.min(100, newPanX));
                        document.getElementById('panX').value = newPanX;
                        document.getElementById('panXVal').innerText = Math.round(newPanX) + '%';
                    }
                    if(!document.getElementById('group-panY').classList.contains('locked')) {
                        let newPanY = startPanY + (dy * scaleFactor);
                        newPanY = Math.max(-100, Math.min(100, newPanY));
                        document.getElementById('panY').value = newPanY;
                        document.getElementById('panYVal').innerText = Math.round(newPanY) + '%';
                    }
                    processImage();
                } else if (e.touches.length === 2) {
                    const dist = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
                    const ratio = dist / initialDist;
                    let newZoom = startZoom * ratio;
                    newZoom = Math.max(1, Math.min(300, newZoom));
                    document.getElementById('zoom').value = newZoom;
                    document.getElementById('zoomVal').innerText = Math.round(newZoom) + '%';
                    processImage();
                }
            }, {passive: false});

            el.addEventListener('touchend', () => { isDragging = false; });
        }

        function setupMouseGestures() { const el = document.getElementById('previewContainer'); const getCoord = (e) => { const r=document.getElementById('mainCanvas').getBoundingClientRect(); const sx=document.getElementById('mainCanvas').width/r.width; const sy=document.getElementById('mainCanvas').height/r.height; return {x:Math.floor((e.clientX-r.left)*sx/10), y:Math.floor((e.clientY-r.top)*sy/10)}; }; const paint = (e) => { if(!finalMatrix.length)return; const {x,y}=getCoord(e); if(y>=0&&y<finalMatrix.length&&x>=0&&x<finalMatrix[0].length){ if(finalMatrix[y][x]!==selectedBrushIndex){ finalMatrix[y][x]=selectedBrushIndex; const bW=parseInt(document.getElementById('borderWidth').value); if(generatedMatrix.length && x>=bW && x<finalMatrix[0].length-bW && y>=bW && y<finalMatrix.length-bW){ generatedMatrix[y-bW][x-bW]=selectedBrushIndex; } drawPreview(finalMatrix[0].length,finalMatrix.length); updateStats(); } } }; el.addEventListener('wheel', (e) => { if(isPencil || gesturesLocked || !sourceImage || document.getElementById('group-zoom').classList.contains('locked')) return; e.preventDefault(); const delta = Math.sign(e.deltaY) * -10; let val = parseInt(document.getElementById('zoom').value) + delta; val = Math.max(1, Math.min(300, val)); document.getElementById('zoom').value = val; document.getElementById('zoomVal').innerText = val + '%'; processImage(); }, {passive: false}); let isMouseDown = false, startX, startY, startPanX, startPanY; el.addEventListener('mousedown', (e) => { if(isPencil) { pushHistory(); isMouseDown=true; paint(e); return; } if(gesturesLocked || !sourceImage) return; if(document.getElementById('group-panX').classList.contains('locked') && document.getElementById('group-panY').classList.contains('locked')) return; isMouseDown = true; el.style.cursor = 'grabbing'; startX = e.clientX; startY = e.clientY; startPanX = parseFloat(document.getElementById('panX').value); startPanY = parseFloat(document.getElementById('panY').value); }); window.addEventListener('mousemove', (e) => { if(!isMouseDown || !sourceImage) return; e.preventDefault(); if(isPencil) { paint(e); return; } const dx = e.clientX - startX; const dy = e.clientY - startY; const sensitivity = 0.5; if(!document.getElementById('group-panX').classList.contains('locked')) { let nx = startPanX + (dx * sensitivity); nx = Math.max(-100, Math.min(100, nx)); document.getElementById('panX').value = nx; document.getElementById('panXVal').innerText = Math.round(nx) + '%'; } if(!document.getElementById('group-panY').classList.contains('locked')) { let ny = startPanY + (dy * sensitivity); ny = Math.max(-100, Math.min(100, ny)); document.getElementById('panY').value = ny; document.getElementById('panYVal').innerText = Math.round(ny) + '%'; } processImage(); }); window.addEventListener('mouseup', () => { isMouseDown = false; if(!isPencil) el.style.cursor = 'grab'; }); }
        function setupGridGestures() { const el = document.getElementById('instructionView'); let startDist = 0, startZoom = 100; el.addEventListener('touchstart', (e) => { if (e.touches.length === 2) { e.preventDefault(); startDist = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY); startZoom = parseInt(document.getElementById('gridZoom').value); } }, {passive: false}); el.addEventListener('touchmove', (e) => { if (e.touches.length === 2) { e.preventDefault(); const dist = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY); updateGridScale(startZoom * (dist/startDist)); } }, {passive: false}); }
        function resetSlider(id, defVal) { if(document.getElementById('group-'+id).classList.contains('locked')) return; document.getElementById(id).value = defVal; let suffix = '%'; if(id === 'smartBlur' || id === 'posterize') suffix = ''; document.getElementById(id+'Val').innerText = defVal + suffix; if(sourceImage) processImage(); }
        function toggleFullscreen() { 
            document.body.classList.toggle('fullscreen-mode'); 
            
            // –ù–û–í–ê–Ø –°–¢–†–û–ö–ê: –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º –º–∞—Å—à—Ç–∞–± –ø—Ä–∏ –≤—Ö–æ–¥–µ/–≤—ã—Ö–æ–¥–µ
            updateGridScale(document.getElementById('gridZoom').value);
            
            refreshGridVisibility(); 
        }
        
        function handleUpload(e) { 
            const file = e.target.files[0]; 
            if(!file) return; 
            const reader = new FileReader(); 
            reader.onload = (ev) => { 
                sourceImage = new Image(); 
                sourceImage.onload = () => { 
                    activateHistoryTrap(); 
                    document.getElementById('origBox').style.display = 'flex'; 
                    document.getElementById('resultBox').style.display = 'flex'; 
                    document.getElementById('originalImageThumb').src = sourceImage.src; 
                    resetStylesOnly(); 
                }; 
                sourceImage.src = ev.target.result; 
            }; 
            reader.readAsDataURL(file); 
        }

        function loadProject(e) { const file = e.target.files[0]; if(!file) return; if(file.type.match('image.*')) { alert("–û—à–∏–±–∫–∞: –í—ã –ø—ã—Ç–∞–µ—Ç–µ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É –≤ –º–µ–Ω—é –ø—Ä–æ–µ–∫—Ç–∞."); return; } const r = new FileReader(); r.onload = (ev) => processLoadedProject(ev.target.result); r.readAsText(file); }

        function processLoadedProject(jsonStr) {
            try { const d = JSON.parse(jsonStr); currentPalette = d.palette; if(d.aiBase) aiBasePalette = d.aiBase; document.getElementById('zoom').value = d.settings.zoom; document.getElementById('zoomVal').innerText = d.settings.zoom + '%'; document.getElementById('contrast').value = d.settings.contrast; document.getElementById('contrastVal').innerText = d.settings.contrast + '%'; document.getElementById('brightness').value = d.settings.brightness || 100; document.getElementById('brightnessVal').innerText = (d.settings.brightness || 100) + '%'; document.getElementById('panX').value = d.settings.panX; document.getElementById('panY').value = d.settings.panY; document.getElementById('setSize').value = d.settings.size; if(d.settings.size === 'custom') document.getElementById('customSizeGroup').style.display = 'flex'; document.getElementById('customWidth').value = d.settings.cW || 50; document.getElementById('customHeight').value = d.settings.cH || 50; document.getElementById('colorCount').value = d.settings.cc || 5; document.getElementById('colorCountVal').innerText = d.settings.cc || 5; if(d.settings.sharpness) { document.getElementById('sharpness').value = d.settings.sharpness; document.getElementById('sharpnessVal').innerText = d.settings.sharpness + '%'; } if(d.settings.smartBlur) { 
    document.getElementById('smartBlur').value = d.settings.smartBlur; 
    document.getElementById('smartBlurVal').innerText = d.settings.smartBlur; 
} 

if(d.stockAssists) stockAssists = d.stockAssists; else stockAssists = {};

if(d.hiddenRegions) {
    hiddenRegions = new Set(d.hiddenRegions);
} else {
    // –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Å—Ç–∞—Ä—ã—Ö —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–π (—Å–±—Ä–∞—Å—ã–≤–∞–µ–º, —Ç.–∫. —Ñ–æ—Ä–º–∞—Ç –Ω–µ—Å–æ–≤–º–µ—Å—Ç–∏–º)
    hiddenRegions = new Set();
}; const presetVal = d.settings.preset || 'custom_ai'; document.getElementById('palettePreset').value = presetVal; document.getElementById('colorCountGroup').style.display = (presetVal === 'original' || presetVal === 'random_chaos' || presetVal === 'custom' || presetVal === 'custom_ai' || presetVal === 'smart_neon') ? 'block' : 'none'; const showRefresh = ['smart_neon', 'original', 'random_chaos', 'custom_ai', 'bw', 'popart', 'custom'].includes(presetVal); document.getElementById('refreshPaletteBtn').style.display = showRefresh ? 'flex' : 'none'; renderPaletteUI(); sourceImage = new Image(); sourceImage.onload = () => { activateHistoryTrap(); document.getElementById('origBox').style.display = 'flex'; document.getElementById('resultBox').style.display = 'flex'; document.getElementById('originalImageThumb').src = sourceImage.src; processImage(); }; sourceImage.src = d.img; } catch (err) { alert("–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞ –ø—Ä–æ–µ–∫—Ç–∞."); console.error(err); }
        }

        function applyPaletteLogic(val) {
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ —Ä–µ–∂–∏–º–∞ —Å–∫–ª–∞–¥–∞
            isStockMode = false;
            
            // --- –†–ï–ñ–ò–ú: –°–í–û–ô AI (v4.0 Default Palette) ---
            if (val === 'custom_ai') {
    isStockMode = true;
    finalMatrix = [];
    generatedMatrix = [];
    const cvs = document.getElementById('mainCanvas');
    const ctx = cvs.getContext('2d');
    ctx.clearRect(0, 0, cvs.width, cvs.height); 

    // –£–°–¢–ê–ù–û–í–ö–ê –ü–ê–õ–ò–¢–†–´ (12 –¶–í–ï–¢–û–í)
    const targetCount = 12; // –ò–∑–º–µ–Ω–∏–ª–∏ —Å 8 –Ω–∞ 12
    document.getElementById('colorCount').value = targetCount;
    document.getElementById('colorCountVal').innerText = targetCount;

    // –ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–¥–µ–∞–ª—å–Ω—ã–π –≥—Ä–∞–¥–∏–µ–Ω—Ç –∏–∑ 12 –æ—Ç—Ç–µ–Ω–∫–æ–≤ (–æ—Ç —á–µ—Ä–Ω–æ–≥–æ –∫ –±–µ–ª–æ–º—É)
    const idealPalette = [
        "#000000", "#1A1A1A", "#333333", "#4D4D4D", 
        "#666666", "#808080", "#999999", "#B3B3B3", 
        "#CCCCCC", "#E6E6E6", "#F2F2F2", "#FFFFFF"
    ];

    currentPalette = [...idealPalette];
    aiBasePalette = [...idealPalette];

    // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –º–∞—Å—Å–∏–≤–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤
    while(stockQuantities.length < targetCount) stockQuantities.push(0);
    if (stockQuantities.length > targetCount) stockQuantities = stockQuantities.slice(0, targetCount);

    renderPaletteUI();
    renderStockInputs(); 
    return; 
}
            // ---------------------------------------------

            if (val === 'bw' || val === 'popart') {
                 document.getElementById('colorCount').value = 5;
                 document.getElementById('colorCountVal').innerText = 5;
            }

            if (val === 'custom') { 
                document.getElementById('colorCount').value = currentPalette.length; 
                document.getElementById('colorCountVal').innerText = currentPalette.length; 
                renderPaletteUI(); 
                return; 
            }
            
            if (val === 'random_chaos' || val === 'smart_neon' || val === 'popart' || val === 'bw') {
                if (aiBasePalette.length === 0) {
                    if(val === 'random_chaos') { generateChaosPalette(); } 
                    else if(val === 'smart_neon') { 
                        updateCustomColorCount(parseInt(document.getElementById('colorCount').value));
                        extractPaletteQuantized(); 
                        aiBasePalette = [...currentPalette]; 
                        generateSmartPalette(true); 
                    }
                    else { 
                        extractPaletteQuantized(); 
                        aiBasePalette = [...currentPalette];
                        if(val === 'bw') { currentPalette = [...PRESETS['bw']]; } 
                        else if(val === 'popart') { currentPalette = [...LEGO_PALETTE]; }
                    }
                }
                renderPaletteUI(); processImage(); return;
            }
            
            if (PRESETS[val]) { currentPalette = [...PRESETS[val]]; aiBasePalette=[]; } 
            else if (val === 'original') { extractPaletteQuantized(); aiBasePalette=[]; } 
            
            renderPaletteUI(); 
            if(sourceImage) processImage(); 
        }
        function updateCustomColorCount(newCount) { while(currentPalette.length < newCount) currentPalette.push('#' + Math.floor(Math.random()*16777215).toString(16).padStart(6, '0')); while(currentPalette.length > newCount) currentPalette.pop(); }

        function generateChaosPalette() { 
            const count = parseInt(document.getElementById('colorCount').value); currentPalette = []; 
            for(let i=0; i<count; i++) currentPalette.push('#' + Math.floor(Math.random()*16777215).toString(16).padStart(6, '0')); 
            currentPalette.sort((a,b) => { const getLum = (hex) => { const r = parseInt(hex.slice(1,3), 16); const g = parseInt(hex.slice(3,5), 16); const b = parseInt(hex.slice(5,7), 16); return r+g+b; }; return getLum(a) - getLum(b); });
        }
        function extractPaletteQuantized() {
            if(!sourceImage) return; const count = parseInt(document.getElementById('colorCount').value); const canvas = document.getElementById('procCanvas'); const ctx = canvas.getContext('2d', { willReadFrequently: true }); const pixels = ctx.getImageData(0, 0, canvas.width, canvas.height).data; let pixelArray = []; for(let i=0; i<pixels.length; i+=40) pixelArray.push([pixels[i], pixels[i+1], pixels[i+2]]); if(pixelArray.length === 0) return; let centroids = []; for(let k=0; k<count; k++) centroids.push(pixelArray[Math.floor(Math.random()*pixelArray.length)]);
            for(let iter=0; iter<5; iter++) { let buckets = Array(count).fill().map(()=>[]); pixelArray.forEach(p => { let minDist = Infinity, idx = 0; centroids.forEach((c, i) => { const d = Math.sqrt((p[0]-c[0])**2 + (p[1]-c[1])**2 + (p[2]-c[2])**2); if(d < minDist) { minDist = d; idx = i; } }); buckets[idx].push(p); }); centroids = buckets.map(bucket => { if(bucket.length === 0) return [Math.random()*255, Math.random()*255, Math.random()*255]; let r=0, g=0, b=0; bucket.forEach(p => { r+=p[0]; g+=p[1]; b+=p[2]; }); return [Math.round(r/bucket.length), Math.round(g/bucket.length), Math.round(b/bucket.length)]; }); }
            centroids.sort((a,b) => (a[0]+a[1]+a[2]) - (b[0]+b[1]+b[2])); currentPalette = centroids.map(c => rgbToHex(c[0], c[1], c[2]));
        }

        function toggleBorderControl() {
    const panel = document.getElementById('borderControl');
    const btn = document.getElementById('borderBtn');
    
    if (panel.style.display === 'none') {
        panel.style.display = 'block';
        // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è (—Ü–≤–µ—Ç –ø–æ–¥—Å—Ç—Ä–æ–∏—Ç—Å—è –ø–æ–¥ —Ç–µ–º—É —Å–∞–º)
        btn.classList.add('btn-active-state');
    } else {
        panel.style.display = 'none';
        btn.classList.remove('btn-active-state');
    }
}
        function updateBorderSettings() { document.getElementById('borderWidthVal').innerText = document.getElementById('borderWidth').value; finalizeMatrixWithBorder(); }
        function finalizeMatrixWithBorder() {
            if(!generatedMatrix.length) return; 
            const bWidth = parseInt(document.getElementById('borderWidth').value); 
            const bColorIdx = parseInt(document.getElementById('borderColor').value || 0);
            
            let newMat = []; 
            const h = generatedMatrix.length; 
            const w = generatedMatrix[0].length;
            
            for(let y=0; y<h; y++) { 
                let row = []; 
                for(let x=0; x<w; x++) { 
                    if(x < bWidth || x >= w - bWidth || y < bWidth || y >= h - bWidth) { 
                        row.push(bColorIdx); 
                    } else { 
                        row.push(generatedMatrix[y][x]); 
                    }
                } 
                newMat.push(row); 
            }
            finalMatrix = newMat; 

            // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞–¥–ø–∏—Å—å —Å —Ä–∞–∑–º–µ—Ä–æ–º
            const finalH = finalMatrix.length;
            const finalW = finalMatrix.length > 0 ? finalMatrix[0].length : 0;
            const label = document.getElementById('resultLabel');
            if (label) {
                label.innerText = `–†–ï–ó–£–õ–¨–¢–ê–¢ ${finalW}x${finalH}`;
            }

            // –ï—Å–ª–∏ –ø–∞–ª–∏—Ç—Ä–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—É—Å—Ç–∞—è –ò–õ–ò –º—ã –≤—ã—à–ª–∏ –∏–∑ —Ä–µ–∂–∏–º–∞ —Å–∫–ª–∞–¥–∞ ‚Äî —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –Ω–∞ –¥–µ—Ñ–æ–ª—Ç
            if(displayPalette.length === 0 || !isStockMode) {
                displayPalette = [...currentPalette];
                displaySymbols = [...currentSymbolSet];
            }
            
            drawPreview(finalMatrix[0].length, finalMatrix.length); 
            updateStats(); 
            if(document.getElementById('instructionView').style.display === 'block') drawGrid();
        }

        function processImage() {
            // –†–µ–∂–∏–º "–°–≤–æ–π AI"
            if (isStockMode) {
                if (window.stockTimeout) clearTimeout(window.stockTimeout);
                window.stockTimeout = setTimeout(processStockImage, 50); 
                return;
            }

            if(!sourceImage) return; 
            const preset = document.getElementById('palettePreset').value; let w, h; if(document.getElementById('setSize').value === 'custom') { w = parseInt(document.getElementById('customWidth').value) || 50; h = parseInt(document.getElementById('customHeight').value) || 50; } else { w = h = parseInt(document.getElementById('setSize').value); }
            
            const resolutionFactor = 4;
            const workW = w * resolutionFactor; const workH = h * resolutionFactor; 
            const workCanvas = document.createElement('canvas'); workCanvas.width = workW; workCanvas.height = workH; const workCtx = workCanvas.getContext('2d', { willReadFrequently: true });
            
            const zoom = document.getElementById('zoom').value / 100; const contrast = document.getElementById('contrast').value; const brightness = document.getElementById('brightness').value;
            workCtx.filter = `contrast(${contrast}%) brightness(${brightness}%)`; const px = (document.getElementById('panX').value / 100) * workW; const py = (document.getElementById('panY').value / 100) * workH; 
            
            const imgAspect = sourceImage.width / sourceImage.height;
            const canvasAspect = workW / workH;
            let drawW, drawH;
            if(imgAspect > canvasAspect) {
                drawH = workH * zoom;
                drawW = workH * imgAspect * zoom;
            } else {
                drawW = workW * zoom;
                drawH = (workW / imgAspect) * zoom;
            }
            
            workCtx.drawImage(sourceImage, (workW - drawW) / 2 + px, (workH - drawH) / 2 + py, drawW, drawH);
            
            let workImgData = workCtx.getImageData(0,0,workW,workH); let data = workImgData.data;
            const smartBlur = parseInt(document.getElementById('smartBlur').value);
            
            // Smart Blur
            if(smartBlur > 0) { 
                const copy = new Uint8ClampedArray(data); 
                const radius = 2; 
                for(let y=0; y<workH; y++) { 
                    for(let x=0; x<workW; x++) { 
                        let rSum=0, gSum=0, bSum=0, count=0; 
                        const idx = (y*workW+x)*4; const r0 = copy[idx], g0=copy[idx+1], b0=copy[idx+2]; 
                        for(let dy=-radius; dy<=radius; dy++) { 
                            for(let dx=-radius; dx<=radius; dx++) { 
                                const nx=x+dx; const ny=y+dy; 
                                if(nx>=0 && nx<workW && ny>=0 && ny<workH) { 
                                    const nIdx = (ny*workW+nx)*4; 
                                    const r=copy[nIdx], g=copy[nIdx+1], b=copy[nIdx+2]; 
                                    const diff = Math.abs(r-r0) + Math.abs(g-g0) + Math.abs(b-b0); 
                                    if(diff <= smartBlur * 2.5) { rSum+=r; gSum+=g; bSum+=b; count++; } 
                                } 
                            } 
                        } 
                        if(count > 0) { data[idx] = rSum/count; data[idx+1] = gSum/count; data[idx+2] = bSum/count; } 
                    } 
                } 
            }

            // USM Algorithm
            const sharpAmount = parseInt(document.getElementById('sharpness').value);
            const usmRadius = parseInt(document.getElementById('usmRadius').value) || 0;

            if (sharpAmount > 0 && usmRadius > 0) {
                 const blurred = new Uint8ClampedArray(data);
                 const r = usmRadius; 
                 const w = workW;
                 const h_ = workH;
                 
                 const temp = new Uint8ClampedArray(data);
                 for(let y=0; y<h_; y++) {
                     for(let x=0; x<w; x++) {
                         let rS=0, gS=0, bS=0, cnt=0;
                         for(let i = -r; i <= r; i++) {
                             let nx = x + i;
                             if(nx >= 0 && nx < w) {
                                 let idx = (y * w + nx) * 4;
                                 rS += temp[idx]; gS += temp[idx+1]; bS += temp[idx+2]; cnt++;
                             }
                         }
                         let idx = (y * w + x) * 4;
                         blurred[idx] = rS/cnt; blurred[idx+1] = gS/cnt; blurred[idx+2] = bS/cnt;
                     }
                 }
                 const temp2 = new Uint8ClampedArray(blurred);
                 for(let x=0; x<w; x++) {
                     for(let y=0; y<h_; y++) {
                         let rS=0, gS=0, bS=0, cnt=0;
                         for(let i = -r; i <= r; i++) {
                             let ny = y + i;
                             if(ny >= 0 && ny < h_) {
                                 let idx = (ny * w + x) * 4;
                                 rS += temp2[idx]; gS += temp2[idx+1]; bS += temp2[idx+2]; cnt++;
                             }
                         }
                         let idx = (y * w + x) * 4;
                         blurred[idx] = rS/cnt; blurred[idx+1] = gS/cnt; blurred[idx+2] = bS/cnt;
                     }
                 }

                 const amount = sharpAmount / 100;
                 for (let i = 0; i < data.length; i += 4) {
                     data[i] = Math.min(255, Math.max(0, data[i] + (data[i] - blurred[i]) * amount));
                     data[i+1] = Math.min(255, Math.max(0, data[i+1] + (data[i+1] - blurred[i+1]) * amount));
                     data[i+2] = Math.min(255, Math.max(0, data[i+2] + (data[i+2] - blurred[i+2]) * amount));
                 }
            }
            
            // Posterize
            const levels = parseInt(document.getElementById('posterize').value);
            if (levels > 0) {
                const step = 255 / (levels); // Divide range
                for(let i=0; i < data.length; i+=4) {
                    data[i] = Math.floor(data[i] / step) * step;
                    data[i+1] = Math.floor(data[i+1] / step) * step;
                    data[i+2] = Math.floor(data[i+2] / step) * step;
                }
            }

            workCtx.putImageData(workImgData, 0, 0);

            const canvas = document.getElementById('procCanvas'); const ctx = canvas.getContext('2d', { willReadFrequently: true }); canvas.width = w; canvas.height = h; 
            ctx.drawImage(workCanvas, 0, 0, w, h);
            
            const imgData = ctx.getImageData(0,0,w,h); const finalData = imgData.data; 
            
            if (preset === 'custom' || preset === 'popart' || preset === 'bw' || preset === 'smart_neon') { 
                 if (aiBasePalette.length > 0) {
                      const structurePalette = aiBasePalette;
                      const paletteRGB = structurePalette.map(hex => { const r = parseInt(hex.slice(1,3), 16); const g = parseInt(hex.slice(3,5), 16); const b = parseInt(hex.slice(5,7), 16); return {r,g,b}; });
                      generatedMatrix = [];
                      for(let y=0; y<h; y++) {
                        let row = [];
                        for(let x=0; x<w; x++) {
                            const i = (y*w+x)*4; 
                            let r = finalData[i], g = finalData[i+1], b = finalData[i+2];
                            let bestIdx = 0, minDist = Infinity;
                            paletteRGB.forEach((c, idx) => { const dist = Math.sqrt(Math.pow(c.r-r,2) + Math.pow(c.g-g,2) + Math.pow(c.b-b,2)); if(dist < minDist) { minDist = dist; bestIdx = idx; } });
                            if (bestIdx >= currentPalette.length) bestIdx = currentPalette.length - 1;
                            row.push(bestIdx);
                        }
                        generatedMatrix.push(row);
                      }
                 } else {
                     generatedMatrix = []; const steps = currentPalette.length; const thresholdStep = 255 / steps; 
                     for(let y=0; y<h; y++) { let row = []; for(let x=0; x<w; x++) { const i = (y*w+x)*4; const r = finalData[i], g = finalData[i+1], b = finalData[i+2]; let lum = 0.299*r + 0.587*g + 0.114*b; let idx = Math.floor(lum / thresholdStep); if (idx >= steps) idx = steps - 1; if(idx < 0) idx = 0; row.push(idx); } generatedMatrix.push(row); }
                 }
            } else { 
                const structurePalette = (['custom_ai', 'random_chaos'].includes(preset) && aiBasePalette.length > 0) ? aiBasePalette : currentPalette; const paletteRGB = structurePalette.map(hex => { const r = parseInt(hex.slice(1,3), 16); const g = parseInt(hex.slice(3,5), 16); const b = parseInt(hex.slice(5,7), 16); return {r,g,b}; }); generatedMatrix = []; for(let y=0; y<h; y++) { let row = []; for(let x=0; x<w; x++) { const i = (y*w+x)*4; let oldR = finalData[i], oldG = finalData[i+1], oldB = finalData[i+2]; let bestIdx = 0, minDist = Infinity; paletteRGB.forEach((c, idx) => { const dist = Math.sqrt(Math.pow(c.r-oldR,2) + Math.pow(c.g-oldG,2) + Math.pow(c.b-oldB,2)); if(dist < minDist) { minDist = dist; bestIdx = idx; } }); row.push(bestIdx); } generatedMatrix.push(row); } }
            finalizeMatrixWithBorder();
        }
        function drawPreview() { 
            const cvs = document.getElementById('mainCanvas'); 
            const ctx = cvs.getContext('2d'); 
            const h = finalMatrix.length;
            const w = finalMatrix[0].length;
            const scale = 10; 
            cvs.width = w * scale; 
            cvs.height = h * scale; 
            finalMatrix.forEach((row, y) => { 
                row.forEach((idx, x) => { 
                    ctx.fillStyle = displayPalette[idx] || currentPalette[idx] || '#000'; 
                    ctx.fillRect(x*scale, y*scale, scale, scale); 
                }); 
            }); 
        }
        function renderPaletteUI() { const c = document.getElementById('paletteContainer'); c.innerHTML = ''; currentPalette.forEach((col, i) => { const d = document.createElement('div'); const isActive = (selectedBrushIndex === i) && isPencil; const preset = document.getElementById('palettePreset').value; const isRestricted = ['bw', 'popart'].includes(preset); const isEditable = !isRestricted; d.className = 'palette-item' + (isActive ? ' active-brush' : '') + (isEditable ? ' editable' : ' disabled'); d.style.background = col; d.innerHTML = `<span class="pal-sym" style="color:${getContrastColor(col)}">${currentSymbolSet[i] || "?"}</span>`; d.onclick = (e) => { if(e.target.tagName === 'INPUT') return; if (isPencil) { selectedBrushIndex = i; renderPaletteUI(); } else { if(isEditable) { const inp = d.querySelector('input'); if(inp) inp.click(); } } }; if(isEditable) { const inp = document.createElement('input'); inp.type = 'color'; inp.value = col; inp.onclick = (e) => { if(isPencil) { e.preventDefault(); e.stopPropagation(); selectedBrushIndex = i; renderPaletteUI(); return false; } e.stopPropagation(); }; inp.oninput = (e) => { e.stopPropagation(); currentPalette[i] = e.target.value; d.style.background = e.target.value; drawPreview(finalMatrix[0].length, finalMatrix.length); if(document.getElementById('instructionView').style.display === 'block') drawGrid(); updateStats(); }; inp.onchange = (e) => pushHistory(); d.appendChild(inp); } c.appendChild(d); }); }
        function hexToRgb(hex) { const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex); return result ? { r: parseInt(result[1], 16), g: parseInt(result[2], 16), b: parseInt(result[3], 16) } : {r:0,g:0,b:0}; }
        function toggleTheme() { const b = document.body; b.setAttribute('data-theme', b.getAttribute('data-theme')==='light'?'dark':'light'); }
        function saveProject() { if(!sourceImage) return; 
const data = { palette: currentPalette, stockAssists: stockAssists, aiBase: aiBasePalette, hiddenRegions: Array.from(hiddenRegions), settings: { zoom: document.getElementById('zoom').value, contrast: document.getElementById('contrast').value, brightness: document.getElementById('brightness').value, panX: document.getElementById('panX').value, panY: document.getElementById('panY').value, size: document.getElementById('setSize').value, cW: document.getElementById('customWidth').value, cH: document.getElementById('customHeight').value, cc: document.getElementById('colorCount').value, preset: document.getElementById('palettePreset').value, sharpness: document.getElementById('sharpness').value, smartBlur: document.getElementById('smartBlur').value, posterize: document.getElementById('posterize').value, usmRadius: document.getElementById('usmRadius').value }, img: sourceImage.src }; let name = prompt("–í–≤–µ–¥–∏—Ç–µ –∏–º—è —Ñ–∞–π–ª–∞:", "photobrick_project"); if (name === null) return; if (!name) name = "photobrick_project"; if (!name.endsWith(".json")) name += ".json"; const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([JSON.stringify(data)],{type:'application/json'})); a.download = name; a.click(); }

        function resetStylesOnly() { 
            pushHistory(); 
            document.getElementById('palettePreset').value = 'bw'; 
            document.getElementById('refreshPaletteBtn').style.display = 'flex'; 
            
            aiBasePalette = []; 
            currentPalette = []; 
            
            if(sourceImage) { 
                extractPaletteQuantized(); 
                aiBasePalette = [...PRESETS['bw']]; 
                currentPalette = [...PRESETS['bw']]; 
            } else { 
                currentPalette = [...PRESETS['bw']]; 
                aiBasePalette = [...PRESETS['bw']]; 
            } 
            
            // RESET TO NEUTRAL
            document.getElementById('borderWidth').value = 0; 
            document.getElementById('borderWidthVal').innerText = 0; 
            
            document.getElementById('contrast').value = 100; 
            document.getElementById('contrastVal').innerText = "100%"; 
            document.getElementById('brightness').value = 100; 
            document.getElementById('brightnessVal').innerText = "100%"; 
            
            document.getElementById('sharpness').value = 164; 
            document.getElementById('sharpnessVal').innerText = "164%"; 
            document.getElementById('usmRadius').value = 23;

            document.getElementById('posterize').value = 0;
            document.getElementById('posterizeVal').innerText = "0";

            document.getElementById('smartBlur').value = 0; 
            document.getElementById('smartBlurVal').innerText = "0"; 

            document.getElementById('zoom').value = 100; 
            document.getElementById('zoomVal').innerText = "100%"; 
            document.getElementById('panX').value = 0;
            document.getElementById('panXVal').innerText = "0%";
            document.getElementById('panY').value = 0;
            document.getElementById('panYVal').innerText = "0%";
            document.getElementById('setSize').value = 50; 
            document.getElementById('customSizeGroup').style.display = 'none';

            document.getElementById('colorCountGroup').style.display = 'none'; 
            
            isPencil = false; 
            document.getElementById('pencilBtn').classList.remove('active'); 
            document.querySelector('.viewport').classList.remove('pencil-mode'); 
            renderPaletteUI(); 
            if(sourceImage) processImage(); 
        }
        function refreshSmartPalette() { 
            pushHistory(); 
            const val = document.getElementById('palettePreset').value; 

            // --- –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –î–õ–Ø "–°–≤–æ–π AI" ---
            if (val === 'custom_ai') {
                isStockMode = true; 
                // –ü—Ä–æ—Å—Ç–æ –∑–∞–ø—É—Å–∫–∞–µ–º –ø–µ—Ä–µ—Å—á–µ—Ç –∫–∞—Ä—Ç–∏–Ω–∫–∏ —Å –¢–ï–ö–£–©–ò–ú–ò –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
                processStockImage(); 
                return;
            }
            // ----------------------------------

            const shift = (val, range) => Math.max(0, Math.min(200, val + (Math.random() * range * 2 - range)));
            
            if (val === 'bw') {
                 extractPaletteQuantized(); aiBasePalette = [...currentPalette]; currentPalette = [...PRESETS['bw']];
            }
            else if(val === 'custom') { 
                document.getElementById('colorCount').value = currentPalette.length;
                const savedColors = [...currentPalette];
                extractPaletteQuantized();
                aiBasePalette = [...currentPalette];
                currentPalette = savedColors;
            } 
            else if(val === 'original') extractPaletteQuantized(); 
            else if (val === 'random_chaos') { generateChaosPalette(); } 
            else if (val === 'smart_neon') { 
                updateCustomColorCount(parseInt(document.getElementById('colorCount').value));
                extractPaletteQuantized(); 
                aiBasePalette = [...currentPalette]; 
                generateSmartPalette(true); 
            } 
            else if (val === 'popart') { 
                extractPaletteQuantized(); aiBasePalette = [...currentPalette]; currentPalette = [...LEGO_PALETTE]; 
            }
            renderPaletteUI(); 
            if(sourceImage) processImage(); 
        }
        function rgbToHex(r, g, b) { return "#" + [r, g, b].map(x => Math.round(x).toString(16).padStart(2, '0')).join(''); }
        function getContrastColor(hex) { const r = parseInt(hex.substr(1,2),16), g = parseInt(hex.substr(3,2),16), b = parseInt(hex.substr(5,2),16); return (r*0.299 + g*0.587 + b*0.114) > 186 ? '#000' : '#fff'; }
        function hslToHex(h, s, l) { l /= 100; const a = s * Math.min(l, 1 - l) / 100; const f = n => { const k = (n + h / 30) % 12; const color = l - a * Math.max(Math.min(k - 3, 9 - k, 1), -1); return Math.round(255 * color).toString(16).padStart(2, '0'); }; return `#${f(0)}${f(8)}${f(4)}`; }
        
        function generateSmartPalette(isNeon) { 
            const count = isNeon ? parseInt(document.getElementById('colorCount').value) : 5; 
            const hue = Math.floor(Math.random() * 360); 
            currentPalette = []; 
            for(let i=0; i<count; i++) {
                currentPalette.push(hslToHex((isNeon ? (hue + i*30)%360 : hue), isNeon ? 90 : 40, 10 + (i * (85 / (count > 1 ? count - 1 : 1))))); 
            }
        }
        
        function updateStats() {
            // –ï—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω —Ä–µ–∂–∏–º –°–≤–æ–π AI, —Ä–∏—Å—É–µ–º –ø–æ–ª—è –≤–≤–æ–¥–∞, –∞ –Ω–µ –æ–±—ã—á–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            if (isStockMode) {
                // –ï—Å–ª–∏ –º—ã —Å–µ–π—á–∞—Å –ø–µ—á–∞—Ç–∞–µ–º –≤ –∏–Ω–ø—É—Ç–µ, –Ω–µ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º DOM, —á—Ç–æ–±—ã –Ω–µ —Å–ª–µ—Ç–∞–ª —Ñ–æ–∫—É—Å
                if (document.activeElement && document.activeElement.classList.contains('stock-input-field')) {
                    return; 
                }
                
                renderStockInputs();
                return;
            }

            const flat = finalMatrix.flat(); 
            const counts = new Array(currentPalette.length).fill(0); 
            flat.forEach(i => { if(counts[i] !== undefined) counts[i]++; });
            
            const preset = document.getElementById('palettePreset').value; 
            const isRestricted = ['bw', 'popart'].includes(preset); 
            const isEditable = !isRestricted; 
            const borderSel = document.getElementById('borderColor'); 
            const oldBorder = borderSel.value; 
            borderSel.innerHTML = '';
            
            const statsContainer = document.getElementById('statsContent'); 
            
            statsContainer.innerHTML = ''; // –í—Å–µ–≥–¥–∞ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –¥–ª—è —á–∏—Å—Ç–æ—Ç—ã
            
            counts.forEach((c, i) => { 
                const sym = currentSymbolSet[i] || "?"; 
                const row = document.createElement('div'); 
                row.className = 'stat-row'; 
                row.style.display = 'flex'; 
                row.style.justifyContent = 'space-between'; 
                row.style.marginBottom = '2px'; 
                row.style.fontSize = '11px'; 
                
                const colorSpan = document.createElement('span'); 
                colorSpan.id = `stat-circle-${i}`; 
                colorSpan.style.display = 'inline-flex'; 
                colorSpan.style.justifyContent = 'center'; 
                colorSpan.style.alignItems = 'center'; 
                colorSpan.style.width = '14px'; 
                colorSpan.style.height = '14px'; 
                colorSpan.style.borderRadius = '50%'; 
                colorSpan.style.background = currentPalette[i]; 
                colorSpan.style.marginRight = '5px'; 
                colorSpan.style.position = 'relative'; 
                colorSpan.style.fontSize = '9px'; 
                colorSpan.style.fontWeight = '900'; 
                colorSpan.style.color = getContrastColor(currentPalette[i]); 
                colorSpan.innerText = sym; 
                
                if(isEditable) { 
                    const inp = document.createElement('input'); 
                    inp.type = 'color'; 
                    inp.value = currentPalette[i]; 
                    inp.style.position = 'absolute'; 
                    inp.style.top = '0'; 
                    inp.style.left = '0'; 
                    inp.style.opacity = '0'; 
                    inp.style.width = '100%'; 
                    inp.style.height = '100%'; 
                    inp.style.cursor = 'pointer'; 
                    inp.oninput = (e) => handleStatColorChange(i, e.target.value); 
                    inp.onchange = () => pushHistory(); 
                    colorSpan.appendChild(inp); 
                } 
                
                const textSpan = document.createElement('span'); 
                textSpan.appendChild(colorSpan); 
                const symText = document.createElement('span'); 
                symText.id = `stat-sym-text-${i}`; 
                symText.innerText = sym; 
                textSpan.appendChild(symText); 
                
                const countBold = document.createElement('b'); 
                countBold.id = `stat-count-${i}`; 
                countBold.innerText = c; 
                
                row.appendChild(textSpan); 
                row.appendChild(countBold); 
                statsContainer.appendChild(row); 
                
                const opt = document.createElement('option'); 
                opt.value = i; 
                opt.innerText = `–¶–≤–µ—Ç ${sym}`; 
                opt.style.background = currentPalette[i]; 
                opt.style.color = getContrastColor(currentPalette[i]); 
                borderSel.appendChild(opt); 
            });

            const total = flat.length; 
            document.getElementById('totalBricks').innerText = total; 
            const price = parseFloat(document.getElementById('brickPrice').value) || 0; 
            document.getElementById('totalCost').innerText = (total * price).toFixed(2) + " ‚ÇΩ"; 
            borderSel.value = oldBorder || 0;
        }

        function handleStatColorChange(i, val) { 
            currentPalette[i] = val; 
            drawPreview(finalMatrix[0].length, finalMatrix.length); 
            if(document.getElementById('instructionView').style.display === 'block') drawGrid(); 
            renderPaletteUI(); 
            const circleEl = document.getElementById(`stat-circle-${i}`); 
            if(circleEl) { 
                circleEl.style.background = val; 
                circleEl.style.color = getContrastColor(val); 
            } 
        }

        function switchTab(t) {
            document.querySelectorAll('.toggle-opt').forEach(b => b.classList.remove('active')); 
            document.getElementById('tab-'+t).classList.add('active');
            updateGridScale(document.getElementById('gridZoom').value);
            

            const isPreview = t === 'preview'; document.getElementById('previewContainer').style.display = isPreview ? 'flex' : 'none'; document.getElementById('instructionView').style.display = isPreview ? 'none' : 'block';
            const pencilBtn = document.getElementById('pencilBtn'); const lockBtn = document.getElementById('gestureLockBtn');
            if(isPreview) { pencilBtn.style.display = 'flex'; if(lockBtn) lockBtn.style.display = 'flex'; } else { pencilBtn.style.display = 'none'; if(lockBtn) lockBtn.style.display = 'none'; if(isPencil) togglePencil(); }
            const nav = document.getElementById('sectorNav'); const zoomControl = document.getElementById('gridZoomControl'); nav.style.display = isPreview ? 'none' : 'block'; zoomControl.style.display = isPreview ? 'none' : 'block';
            const stage = document.querySelector('.stage'); if(t === 'instruction') { stage.classList.add('expanded-mode'); } else { stage.classList.remove('expanded-mode'); }
            if(!isPreview) drawGrid();
        }

        function togglePencil() { isPencil = !isPencil; document.getElementById('pencilBtn').classList.toggle('active', isPencil); document.querySelector('.viewport').classList.toggle('pencil-mode', isPencil); renderPaletteUI(); }
        function setSector(s) { currentSector = s; document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active')); if(s === 'all') document.getElementById('sec-all').classList.add('active'); else document.querySelector(`.nav-${s}`).classList.add('active'); drawGrid(); }
        
        function drawGrid(targetContainer = null, printMode = false) {
            const container = targetContainer || document.getElementById('gridContainer'); 
            if(!printMode) container.innerHTML = ''; 
            if(finalMatrix.length === 0) return;

            const fullH = finalMatrix.length; 
            const fullW = finalMatrix[0].length; 
            let sX = 0, eX = fullW, sY = 0, eY = fullH; 
            const midX = Math.ceil(fullW / 2); 
            const midY = Math.ceil(fullH / 2);

            if(currentSector === 1) { eX = midX; eY = midY; } 
            else if(currentSector === 2) { sX = midX; eY = midY; } 
            else if(currentSector === 3) { eX = midX; sY = midY; } 
            else if(currentSector === 4) { sX = midX; sY = midY; }

            // –ó–ê–ü–û–ú–ò–ù–ê–ï–ú –ì–†–ê–ù–ò–¶–´
            currentGridBounds = { sX, eX, sY, eY };

            renderSingleGrid(container, sX, eX, sY, eY, printMode);
            
            if(document.body.classList.contains('fullscreen-mode')) { refreshGridVisibility(); }
            
            if(!printMode) { 
                const grid = container.querySelector('.instruction-grid'); 
                if(grid) grid.style.transform = `scale(${document.getElementById('gridZoom').value / 100})`; 
            }
        }

        function renderSingleGrid(container, sX, eX, sY, eY, isPrint) {
            const visW = eX - sX; 
            const grid = document.createElement('div'); 
            grid.className = 'instruction-grid'; 
            // –ü–æ–¥—Å—Ç—Ä–∞–∏–≤–∞–µ–º —à–∏—Ä–∏–Ω—É: –µ—Å–ª–∏ –ø–µ—á–∞—Ç—å - —á—É—Ç—å —à–∏—Ä–µ —è—á–µ–π–∫–∏
            const cellW = isPrint ? 25 : 20;
            grid.style.gridTemplateColumns = `25px repeat(${visW}, ${cellW}px) 280px`;

            // –í–µ—Ä—Ö–Ω—è—è –ª–∏–Ω–µ–π–∫–∞
            grid.appendChild(createCell('ruler-cell', '')); 
            for(let x=sX; x<eX; x++) { 
                const c = createCell('ruler-cell', x+1); 
                c.setAttribute('data-x', x); 
                if(!isPrint) c.onclick = function() { toggleColVisibility(x); }; 
                grid.appendChild(c); 
            }
            const infoHeader = document.createElement('div'); 
            infoHeader.className = 'info-header'; 
            infoHeader.innerText = '–ò–ù–§–û (–°–ò–ú–í–û–õ : –ö–û–õ-–í–û)'; 
            grid.appendChild(infoHeader);

            // –û—Å–Ω–æ–≤–Ω–∞—è —Å–µ—Ç–∫–∞
            for(let y=sY; y<eY; y++) {
                // –ù–æ–º–µ—Ä —Ä—è–¥–∞
                const rC = createCell('ruler-cell', y+1); 
                rC.setAttribute('data-y', y); 
                if(!isPrint) rC.onclick = function() { toggleRowVisibility(y); }; 
                grid.appendChild(rC);

                let rowStats = {}; 

                for(let x=sX; x<eX; x++) { 
                    const idx = finalMatrix[y][x]; 
                    
                    // –°—á–∏—Ç–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                    if (!rowStats[idx]) rowStats[idx] = 0;
                    rowStats[idx]++;

                    const palCol = displayPalette[idx] || currentPalette[idx] || '#000'; 
                    const sym = displaySymbols[idx] || "?"; 

                    const cell = createCell('cell', sym); 
                    cell.style.backgroundColor = palCol; 
                    
                    // –¶–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞ (–∫–æ–Ω—Ç—Ä–∞—Å—Ç)
                    const hex = palCol.replace('#','');
                    const r = parseInt(hex.substr(0,2),16), g = parseInt(hex.substr(2,2),16), b = parseInt(hex.substr(4,2),16); 
                    cell.style.color = (r*0.299 + g*0.587 + b*0.114) > 186 ? '#000' : '#fff'; 
                    
                    if(!isPrint && isPencil) { 
                        cell.onclick = () => { 
                            pushHistory(); 
                            // –í —Ä–µ–∂–∏–º–µ –∫–∞—Ä–∞–Ω–¥–∞—à–∞ –ø–µ—Ä–µ–±–∏—Ä–∞–µ–º —Ç–æ–ª—å–∫–æ –æ—Å–Ω–æ–≤–Ω—ã–µ —Ü–≤–µ—Ç–∞
                            finalMatrix[y][x] = (finalMatrix[y][x] + 1) % currentPalette.length; 
                            drawPreview(finalMatrix[0].length, finalMatrix.length); 
                            updateStats(); 
                            drawGrid(); 
                        }; 
                    } 
                    grid.appendChild(cell); 
                }

                // –ò–Ω—Ñ–æ-–ø–∞–Ω–µ–ª—å —Å–ø—Ä–∞–≤–∞
                const info = document.createElement('div'); 
                info.className = 'row-info'; 
                info.setAttribute('data-y', y); 
                
                // –°–æ—Ä—Ç–∏—Ä—É–µ–º –∏–Ω–¥–µ–∫—Å—ã, —á—Ç–æ–±—ã –ø–æ—Ä—è–¥–æ–∫ –±—ã–ª –∫—Ä–∞—Å–∏–≤—ã–º
                const presentIndices = Object.keys(rowStats).map(Number).sort((a,b) => a-b);
                
                presentIndices.forEach(idx => {
                    const count = rowStats[idx];
                    const pCol = displayPalette[idx] || '#000';
                    const pSym = displaySymbols[idx] || '?';
                    
                    // –ö–æ–Ω—Ç—Ä–∞—Å—Ç –¥–ª—è —Ç–µ–∫—Å—Ç–∞ –≤ –∏–Ω—Ñ–æ
                    const pHex = pCol.replace('#','');
                    const pR = parseInt(pHex.substr(0,2),16), pG = parseInt(pHex.substr(2,2),16), pB = parseInt(pHex.substr(4,2),16); 
                    const textCol = (pR*0.299 + pG*0.587 + pB*0.114) > 186 ? '#000' : '#fff';

                    info.innerHTML += `<span style="padding:1px 4px; border-radius:3px; margin-right:4px; display:inline-block; margin-bottom:2px; background:${pCol}; color:${textCol}; border:1px solid rgba(0,0,0,0.2);">${pSym}:${count}</span>`;
                });

                if(!isPrint) info.onclick = function() { toggleRowVisibility(y); }; 
                grid.appendChild(info);
            }
            container.appendChild(grid);
        }

        function createCell(cls, txt) { const d=document.createElement('div'); d.className=cls; d.innerText=txt; return d; }
        
        /* --- –ù–û–í–ê–Ø –°–ò–°–¢–ï–ú–ê –£–ú–ù–û–ì–û –í–´–î–ï–õ–ï–ù–ò–Ø –ü–û –°–ï–ö–¢–û–†–ê–ú --- */

        function toggleRowVisibility(y) {
            if (!document.body.classList.contains('fullscreen-mode')) return; 
            
            // –§–æ—Ä–º–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–ª—é—á –¥–ª—è –≠–¢–û–ì–û —É—á–∞—Å—Ç–∫–∞ (—Å—Ç—Ä–æ–∫–∞ Y, –æ—Ç X1 –¥–æ X2)
            const key = `row_${y}_${currentGridBounds.sX}_${currentGridBounds.eX}`;
            
            if (hiddenRegions.has(key)) {
                hiddenRegions.delete(key);
            } else {
                hiddenRegions.add(key);
            }
            refreshGridVisibility();
        }

        function toggleColVisibility(x) {
            if (!document.body.classList.contains('fullscreen-mode')) return; 
            
            const key = `col_${x}_${currentGridBounds.sY}_${currentGridBounds.eY}`;
            
            if (hiddenRegions.has(key)) {
                hiddenRegions.delete(key);
            } else {
                hiddenRegions.add(key);
            }
            refreshGridVisibility();
        }

        function refreshGridVisibility() {
            const grid = document.querySelector('.instruction-grid'); 
            if(!grid) return; 
            if (!document.body.classList.contains('fullscreen-mode')) return;

            // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –∑–∞—Ç–µ–º–Ω–µ–Ω–∏—è
            document.querySelectorAll('.shade-layer').forEach(e => e.remove()); 

            const CELL_SIZE = 20;
            const HEADER_SIZE = 25;

            // –ü–µ—Ä–µ–±–∏—Ä–∞–µ–º –≤—Å–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∑–æ–Ω—ã –∑–∞—Ç–µ–º–Ω–µ–Ω–∏—è
            hiddenRegions.forEach(key => {
                const parts = key.split('_');
                const type = parts[0];
                const index = parseInt(parts[1]);
                const start = parseInt(parts[2]);
                const end = parseInt(parts[3]);

                if (type === 'row') {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º: –ø–æ–ø–∞–¥–∞–µ—Ç –ª–∏ –∑–∞–∫—Ä–∞—à–µ–Ω–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ –≤ —Ç–µ–∫—É—â–∏–π —ç–∫—Ä–∞–Ω –ø–æ –≤—ã—Å–æ—Ç–µ?
                    if (index >= currentGridBounds.sY && index < currentGridBounds.eY) {
                        // –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è –æ—Ç—Ä–µ–∑–∫–æ–≤ (–°–ª–æ–∂–Ω–∞—è —á–∞—Å—Ç—å: –≤—ã—á–∏—Å–ª—è–µ–º –≤–∏–¥–∏–º—É—é —á–∞—Å—Ç—å –∑–∞–∫—Ä–∞—Å–∫–∏)
                        const drawStart = Math.max(start, currentGridBounds.sX);
                        const drawEnd = Math.min(end, currentGridBounds.eX);

                        if (drawStart < drawEnd) {
                            // –ï—Å–ª–∏ –µ—Å—Ç—å –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ ‚Äî —Ä–∏—Å—É–µ–º
                            const shade = document.createElement('div');
                            shade.className = 'shade-layer';
                            // –ü–æ–∑–∏—Ü–∏—è Y –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Ç–µ–∫—É—â–µ–≥–æ –≤–∏–¥–∞
                            const relativeY = index - currentGridBounds.sY;
                            shade.style.top = `${HEADER_SIZE + (relativeY * CELL_SIZE)}px`;
                            shade.style.height = `${CELL_SIZE}px`;
                            
                            // –ü–æ–∑–∏—Ü–∏—è X –∏ —à–∏—Ä–∏–Ω–∞
                            const relativeX = drawStart - currentGridBounds.sX;
                            const widthCells = drawEnd - drawStart;
                            
                            shade.style.left = `${HEADER_SIZE + (relativeX * CELL_SIZE)}px`;
                            shade.style.width = `${widthCells * CELL_SIZE}px`;
                            
                            grid.appendChild(shade);
                        }
                    }
                } 
                else if (type === 'col') {
                    // –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ –¥–ª—è –∫–æ–ª–æ–Ω–æ–∫
                    if (index >= currentGridBounds.sX && index < currentGridBounds.eX) {
                        const drawStart = Math.max(start, currentGridBounds.sY);
                        const drawEnd = Math.min(end, currentGridBounds.eY);

                        if (drawStart < drawEnd) {
                            const shade = document.createElement('div');
                            shade.className = 'shade-layer';
                            
                            const relativeX = index - currentGridBounds.sX;
                            shade.style.left = `${HEADER_SIZE + (relativeX * CELL_SIZE)}px`;
                            shade.style.width = `${CELL_SIZE}px`;
                            
                            const relativeY = drawStart - currentGridBounds.sY;
                            const heightCells = drawEnd - drawStart;
                            
                            shade.style.top = `${HEADER_SIZE + (relativeY * CELL_SIZE)}px`;
                            shade.style.height = `${heightCells * CELL_SIZE}px`;
                            
                            grid.appendChild(shade);
                        }
                    }
                }
            });
        }

        function resetGridVisibility() { 
            hiddenRegions.clear(); 
            refreshGridVisibility(); 
        }
        
        // --- –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –°–ò–°–¢–ï–ú–ê –ü–ï–ß–ê–¢–ò (FIX CYRILLIC) ---
        
        async function preparePrint() {
            if(!sourceImage) return;
            
            document.body.style.cursor = 'wait';

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({
                orientation: 'p',
                unit: 'mm',
                format: 'a4'
            });

            const margin = 20;
            const pageWidth = 210;
            const pageHeight = 297;
            const safeW = pageWidth - (margin * 2);
            
            // --- –°–¢–†–ê–ù–ò–¶–ê 1: –¢–ò–¢–£–õ–¨–ù–´–ô –õ–ò–°–¢ ---
            
            // 1. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —à–∞–ø–∫—É —Å —Ç–µ–∫—Å—Ç–æ–º –∏ –ª–µ–≥–µ–Ω–¥–æ–π –∫–∞–∫ –∫–∞—Ä—Ç–∏–Ω–∫—É (—á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –ø—Ä–æ–±–ª–µ–º —Å –∫–æ–¥–∏—Ä–æ–≤–∫–æ–π)
            const headerImg = await renderTitlePageHeader(safeW);
            
            // –í—Å—Ç–∞–≤–ª—è–µ–º —à–∞–ø–∫—É
            // –í—ã—á–∏—Å–ª—è–µ–º –≤—ã—Å–æ—Ç—É —à–∞–ø–∫–∏ –≤ PDF –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞—Ö (—Å–æ—Ö—Ä–∞–Ω—è—è –ø—Ä–æ–ø–æ—Ä—Ü–∏–∏)
            const headerProps = doc.getImageProperties(headerImg);
            const headerPdfH = (headerProps.height * safeW) / headerProps.width;
            
            doc.addImage(headerImg, 'PNG', margin, margin, safeW, headerPdfH);

            // 2. –í—Å—Ç–∞–≤–ª—è–µ–º –æ—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–µ–≤—å—é –Ω–∏–∂–µ —à–∞–ø–∫–∏
            const mainCanvas = document.getElementById('mainCanvas');
            const imgData = mainCanvas.toDataURL('image/png');
            
            const currentY = margin + headerPdfH + 10; // 10–º–º –æ—Ç—Å—Ç—É–ø –æ—Ç —à–∞–ø–∫–∏
            const hRem = pageHeight - margin - currentY; // –û—Å—Ç–∞–≤—à–µ–µ—Å—è –º–µ—Å—Ç–æ
            
            if (hRem > 50) {
                addImageFit(doc, imgData, margin, currentY, safeW, hRem);
            }

            // --- –°–¢–†–ê–ù–ò–¶–´ –°–ï–ö–¢–û–†–û–í ---
            const fullW = finalMatrix[0].length;
            const fullH = finalMatrix.length;
            const midX = Math.ceil(fullW / 2);
            const midY = Math.ceil(fullH / 2);

            // –°–ø–∏—Å–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü —Å –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏
            const sectors = [
                { name: '–õ–ï–í–´–ô –í–ï–†–•', sx: 0, ex: midX, sy: 0, ey: midY },
                { name: '–ü–†–ê–í–´–ô –í–ï–†–•', sx: midX, ex: fullW, sy: 0, ey: midY },
                { name: '–õ–ï–í–´–ô –ù–ò–ó', sx: 0, ex: midX, sy: midY, ey: fullH },
                { name: '–ü–†–ê–í–´–ô –ù–ò–ó', sx: midX, ex: fullW, sy: midY, ey: fullH },
                { name: '–û–ë–©–ò–ô –í–ò–î', sx: 0, ex: fullW, sy: 0, ey: fullH }
            ];

            for (let i = 0; i < sectors.length; i++) {
                const s = sectors[i];
                if (s.sx >= s.ex || s.sy >= s.ey) continue;

                doc.addPage();

                // 1. –†–∏—Å—É–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã (–∫–∞–∫ –∫–∞—Ä—Ç–∏–Ω–∫—É)
                const titleImg = await renderTextToImage(s.name, 24);
                doc.addImage(titleImg, 'PNG', margin, 10, safeW, 10); // –í—ã—Å–æ—Ç–∞ –∑–∞–≥–æ–ª–æ–≤–∫–∞ –æ–∫–æ–ª–æ 10–º–º

                // 2. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∏ –≤—Å—Ç–∞–≤–ª—è–µ–º —Å—Ö–µ–º—É
                const sectorImg = await renderSectorToImage(s.sx, s.ex, s.sy, s.ey);
                
                // –í—Å—Ç–∞–≤–ª—è–µ–º –Ω–∏–∂–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞ (y = 25–º–º), —É—á–∏—Ç—ã–≤–∞—è –ø–æ–ª—è
                const contentH = pageHeight - 25 - margin;
                addImageFit(doc, sectorImg, margin, 25, safeW, contentH);
            }

            document.body.style.cursor = 'default';
            window.open(doc.output('bloburl'), '_blank');
        }

        // –†–µ–Ω–¥–µ—Ä —à–∞–ø–∫–∏ —Ç–∏—Ç—É–ª—å–Ω–æ–≥–æ –ª–∏—Å—Ç–∞ (–ó–∞–≥–æ–ª–æ–≤–æ–∫ + –ü–∞—Ä–∞–º–µ—Ç—Ä—ã + –õ–µ–≥–µ–Ω–¥–∞ —Ü–≤–µ—Ç–æ–≤)
        function renderTitlePageHeader(pdfWidthMm) {
            return new Promise((resolve) => {
                const scale = 4; // –í—ã—Å–æ–∫–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ
                const w = pdfWidthMm * 3.78 * scale; // –ø–µ—Ä–µ–≤–æ–¥ –º–º –≤ –ø–∏–∫—Å–µ–ª–∏
                // –ü—Ä–∏–º–µ—Ä–Ω–∞—è –≤—ã—Å–æ—Ç–∞, –±—É–¥–µ–º —É–≤–µ–ª–∏—á–∏–≤–∞—Ç—å –µ—Å–ª–∏ —Ü–≤–µ—Ç–æ–≤ –º–Ω–æ–≥–æ, –Ω–æ –¥–ª—è —Å—Ç–∞—Ä—Ç–∞ —Ö–≤–∞—Ç–∏—Ç
                const h = 1000 * scale; 
                
                const cvs = document.createElement('canvas');
                cvs.width = w;
                cvs.height = h; 
                const ctx = cvs.getContext('2d');
                
                // –§–æ–Ω –±–µ–ª—ã–π
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0,0,w,h);

                let cursorY = 50 * scale;
                const centerX = w / 2;

                // 1. –ì–ª–∞–≤–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫
                ctx.fillStyle = '#000000';
                ctx.font = `bold ${22 * scale}px sans-serif`;
                ctx.textAlign = 'center';
                ctx.fillText("–°–•–ï–ú–ê –°–ë–û–†–ö–ò –ò –ï–Å –ü–ê–†–ê–ú–ï–¢–†–´", centerX, cursorY);
                
                cursorY += 30 * scale;

                // 2. –ü–∞—Ä–∞–º–µ—Ç—Ä—ã
                ctx.font = `normal ${14 * scale}px sans-serif`;
                const flat = finalMatrix.flat();
                const dims = `${finalMatrix[0].length} x ${finalMatrix.length}`;
                const total = flat.length;
                
                ctx.fillText(`–†–∞–∑–º–µ—Ä: ${dims} (–±–ª–æ–∫–æ–≤)  |  –í—Å–µ–≥–æ –¥–µ—Ç–∞–ª–µ–π: ${total} —à—Ç.`, centerX, cursorY);
                cursorY += 40 * scale;

                // 3. –õ–µ–≥–µ–Ω–¥–∞ —Ü–≤–µ—Ç–æ–≤
                // –°—á–∏—Ç–∞–µ–º —Ü–≤–µ—Ç–∞
                const counts = new Array(currentPalette.length).fill(0);
                flat.forEach(i => { if(counts[i] !== undefined) counts[i]++; });

                ctx.textAlign = 'left';
                const boxSize = 20 * scale;
                const fontSize = 12 * scale;
                ctx.font = `normal ${fontSize}px sans-serif`;
                
                let startX = 20 * scale; // –û—Ç—Å—Ç—É–ø —Å–ª–µ–≤–∞ –≤–Ω—É—Ç—Ä–∏ –∫–∞—Ä—Ç–∏–Ω–∫–∏
                let curX = startX;
                
                // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –±–ª–æ–∫ –ª–µ–≥–µ–Ω–¥—ã
                // –ü—Ä–æ—Å—Ç–∞—è —Ä–∞—Å–∫–ª–∞–¥–∫–∞: –∏–¥–µ–º —Å–ª–µ–≤–∞ –Ω–∞–ø—Ä–∞–≤–æ, –µ—Å–ª–∏ –Ω–µ –≤–ª–µ–∑–∞–µ–º - –Ω–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞
                
                currentPalette.forEach((color, i) => {
                    if (counts[i] > 0) {
                        const sym = currentSymbolSet[i] || "?";
                        const txt = ` ${sym} = ${counts[i]} —à—Ç.`;
                        const textWidth = ctx.measureText(txt).width;
                        const itemWidth = boxSize + textWidth + (15 * scale); // 15px –æ—Ç—Å—Ç—É–ø

                        // –ï—Å–ª–∏ –Ω–µ –≤–ª–µ–∑–∞–µ—Ç –≤ —à–∏—Ä–∏–Ω—É, –ø–µ—Ä–µ–Ω–æ—Å —Å—Ç—Ä–æ–∫–∏
                        if (curX + itemWidth > w - startX) {
                            curX = startX;
                            cursorY += boxSize + (15 * scale);
                        }

                        // –†–∏—Å—É–µ–º –∫–≤–∞–¥—Ä–∞—Ç —Ü–≤–µ—Ç–∞
                        ctx.fillStyle = color;
                        ctx.fillRect(curX, cursorY, boxSize, boxSize);
                        ctx.strokeStyle = '#000000';
                        ctx.lineWidth = 2;
                        ctx.strokeRect(curX, cursorY, boxSize, boxSize);

                        // –†–∏—Å—É–µ–º —Å–∏–º–≤–æ–ª –≤–Ω—É—Ç—Ä–∏ –∫–≤–∞–¥—Ä–∞—Ç–∞
                        ctx.fillStyle = getContrastColor(color);
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.font = `bold ${fontSize}px sans-serif`; // –ñ–∏—Ä–Ω—ã–π –¥–ª—è —Å–∏–º–≤–æ–ª–∞
                        ctx.fillText(sym, curX + boxSize/2, cursorY + boxSize/2);

                        // –†–∏—Å—É–µ–º —Ç–µ–∫—Å—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
                        ctx.fillStyle = '#000000';
                        ctx.textAlign = 'left';
                        ctx.font = `normal ${fontSize}px sans-serif`;
                        ctx.fillText(txt, curX + boxSize, cursorY + boxSize/2);

                        curX += itemWidth;
                    }
                });
                
                // –û–±—Ä–µ–∑–∞–µ–º –ª–∏—à–Ω—é—é –≤—ã—Å–æ—Ç—É –∫–∞–Ω–≤–∞—Å–∞
                const finalH = cursorY + boxSize + (20 * scale);
                const finalCvs = document.createElement('canvas');
                finalCvs.width = w;
                finalCvs.height = finalH;
                const fCtx = finalCvs.getContext('2d');
                fCtx.drawImage(cvs, 0, 0);
                
                resolve(finalCvs.toDataURL('image/png'));
            });
        }

        // –†–µ–Ω–¥–µ—Ä –ø—Ä–æ—Å—Ç–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ –≤ –∫–∞—Ä—Ç–∏–Ω–∫—É (–¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ —Å—Ç—Ä–∞–Ω–∏—Ü)
        function renderTextToImage(text, sizeMm) {
            return new Promise((resolve) => {
                const scale = 4;
                // –®–∏—Ä–∏–Ω–∞ —É—Å–ª–æ–≤–Ω–æ –ê4 (–ø–∏–∫—Å–µ–ª–∏)
                const w = 210 * 3.78 * scale; 
                const h = sizeMm * 3.78 * scale;
                
                const cvs = document.createElement('canvas');
                cvs.width = w;
                cvs.height = h;
                const ctx = cvs.getContext('2d');
                
                // –ë–µ–ª—ã–π —Ñ–æ–Ω –Ω–µ –Ω—É–∂–µ–Ω, –ø—É—Å—Ç—å –±—É–¥–µ—Ç –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π –∏–ª–∏ –±–µ–ª—ã–π
                // ctx.fillStyle = '#ffffff'; ctx.fillRect(0,0,w,h); 
                
                ctx.fillStyle = '#000000';
                ctx.font = `bold ${16 * scale}px sans-serif`; // –†–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                
                ctx.fillText(text, w/2, h/2);
                
                resolve(cvs.toDataURL('image/png'));
            });
        }

        function addImageFit(doc, imgData, x, y, w, h) {
            const props = doc.getImageProperties(imgData);
            const imgW = props.width;
            const imgH = props.height;
            const aspect = imgW / imgH;
            const boxAspect = w / h;
            let finalW, finalH;
            if (aspect > boxAspect) { finalW = w; finalH = w / aspect; } 
            else { finalH = h; finalW = h * aspect; }
            const offX = x + (w - finalW) / 2;
            const offY = y + (h - finalH) / 2;
            doc.addImage(imgData, 'PNG', offX, offY, finalW, finalH);
        }

        function renderSectorToImage(sx, ex, sy, ey) {
            return new Promise((resolve) => {
                const cellSize = 30; 
                const headerSize = 30;
                const cols = ex - sx;
                const rows = ey - sy;
                const cvs = document.createElement('canvas');
                cvs.width = headerSize + (cols * cellSize);
                cvs.height = headerSize + (rows * cellSize);
                const ctx = cvs.getContext('2d');
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0, 0, cvs.width, cvs.height);
                ctx.font = 'bold 14px sans-serif';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillStyle = '#eeeeee';
                ctx.fillRect(0, 0, cvs.width, headerSize); 
                ctx.fillRect(0, 0, headerSize, cvs.height); 
                ctx.strokeStyle = '#cccccc';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.fillStyle = '#333333';
                for (let x = 0; x < cols; x++) {
                    const absX = sx + x + 1;
                    const pX = headerSize + (x * cellSize);
                    ctx.fillText(absX, pX + cellSize/2, headerSize/2);
                    ctx.rect(pX, 0, cellSize, headerSize);
                }
                for (let y = 0; y < rows; y++) {
                    const absY = sy + y + 1;
                    const pY = headerSize + (y * cellSize);
                    ctx.fillText(absY, headerSize/2, pY + cellSize/2);
                    ctx.rect(0, pY, headerSize, cellSize);
                }
                ctx.stroke();
                for (let y = 0; y < rows; y++) {
                    for (let x = 0; x < cols; x++) {
                        const idx = finalMatrix[sy + y][sx + x];
                        const color = currentPalette[idx];
                        const sym = currentSymbolSet[idx] || "?";
                        const pX = headerSize + (x * cellSize);
                        const pY = headerSize + (y * cellSize);
                        ctx.fillStyle = color;
                        ctx.fillRect(pX, pY, cellSize, cellSize);
                        ctx.strokeRect(pX, pY, cellSize, cellSize);
                        const contrast = getContrastColor(color);
                        ctx.fillStyle = contrast;
                        ctx.font = 'bold 16px sans-serif'; 
                        ctx.fillText(sym, pX + cellSize/2, pY + cellSize/2);
                    }
                }
                resolve(cvs.toDataURL('image/png'));
            });
        }
function renderStockInputs() {
            const statsContainer = document.getElementById('statsContent');
            statsContainer.innerHTML = '';
            
            // –°—á–∏—Ç–∞–µ–º —Ñ–∞–∫—Ç (—Å —É—á–µ—Ç–æ–º —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–π –ø–∞–ª–∏—Ç—Ä—ã)
            const flat = finalMatrix.flat();
            const usageMap = {}; // displayIdx -> count
            flat.forEach(i => usageMap[i] = (usageMap[i]||0) + 1);

            // –•–µ–¥–µ—Ä
            const headerRow = document.createElement('div');
            headerRow.style.display = 'flex';
headerRow.style.justifyContent = 'space-between';
headerRow.style.alignItems = 'center';
            headerRow.style.marginBottom = '10px'; headerRow.style.paddingBottom = '5px';
            headerRow.style.borderBottom = '1px solid rgba(255,255,255,0.1)';
            
            const title = document.createElement('div');
            title.innerHTML = '–°–ö–õ–ê–î (PRO)'; title.style.fontWeight = 'bold'; title.style.fontSize = '11px'; title.style.color = 'var(--primary)';
            
            const mixLabel = document.createElement('label');
            mixLabel.style.display='flex'; mixLabel.style.gap='5px'; mixLabel.style.fontSize='10px';
            const mixInput = document.createElement('input'); mixInput.type='checkbox'; mixInput.checked = useMixMode;
            mixInput.onchange = (e) => { useMixMode = e.target.checked; processStockImage(); };
            mixLabel.appendChild(mixInput); mixLabel.appendChild(document.createTextNode('–ú–Ø–ì–ö–ò–ô –ú–ò–ö–°'));
            
            headerRow.appendChild(title); headerRow.appendChild(mixLabel);
            statsContainer.appendChild(headerRow);

            // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Ç—Ä–æ–∫
            let totalStockSum = 0;
            
            currentPalette.forEach((col, i) => {
                // --- –ì–õ–ê–í–ù–´–ô –¶–í–ï–¢ ---
                const row = document.createElement('div');
                row.className = 'stock-input-row';
                row.style.background = 'rgba(255,255,255,0.03)';
                
                // –õ–µ–≤–æ
                const info = document.createElement('div'); info.className = 'stock-info';
                const colorBox = document.createElement('div'); colorBox.className = 'stock-color-preview'; colorBox.style.background = col;
                const sym = document.createElement('span'); sym.innerText = currentSymbolSet[i] || "?"; sym.style.fontWeight = '900';
                info.appendChild(colorBox); info.appendChild(sym);

                // –ü—Ä–∞–≤–æ
                const rightGroup = document.createElement('div'); rightGroup.style.display = 'flex'; rightGroup.style.alignItems = 'center'; rightGroup.style.gap = '4px';

                // –ö–Ω–æ–ø–∫–∞ +
                const addBtn = document.createElement('button');
                addBtn.innerText = '+';
                addBtn.style.width = '20px'; addBtn.style.height = '20px'; addBtn.style.borderRadius = '50%';
                addBtn.style.border = '1px solid #555'; addBtn.style.background = 'transparent'; addBtn.style.color = '#fff'; addBtn.style.cursor = 'pointer';
                addBtn.onclick = () => triggerHelperPicker(i);

                // –§–∞–∫—Ç (i - —ç—Ç–æ –∏–Ω–¥–µ–∫—Å –≤ displayPalette, —Ä–∞–≤–Ω—ã–π i –¥–ª—è –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ü–≤–µ—Ç–æ–≤)
                const used = usageMap[i] || 0;
                const limit = stockQuantities[i] || 0;
                totalStockSum += limit;

                const factSpan = document.createElement('span'); factSpan.innerText = used; factSpan.style.fontSize='10px';
                factSpan.style.color = (limit > 0 && used >= limit) ? '#ff5555' : '#aaa';
                
                const input = document.createElement('input');
                input.type = 'number'; input.className = 'stock-input-field'; input.style.width='50px';
                input.value = limit; input.oninput = (e) => { 
    stockQuantities[i] = parseInt(e.target.value)||0; 
    processImage(); // –ó–∞–ø—É—Å–∫–∞–µ–º –ø–µ—Ä–µ—Å—á–µ—Ç –∫–∞—Ä—Ç–∏–Ω–∫–∏, –∞ –Ω–µ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫—É –∏–Ω–ø—É—Ç–æ–≤
};

                rightGroup.appendChild(addBtn);
                rightGroup.appendChild(factSpan);
                rightGroup.appendChild(document.createTextNode('/'));
                rightGroup.appendChild(input);
                
                row.appendChild(info); row.appendChild(rightGroup);
                statsContainer.appendChild(row);

                // --- –ü–û–ú–û–©–ù–ò–ö–ò ---
                if (stockAssists[i]) {
                    stockAssists[i].forEach((assist, aIdx) => {
                        const subRow = document.createElement('div');
                        subRow.className = 'stock-input-row';
                        subRow.style.marginLeft = '20px'; // –û—Ç—Å—Ç—É–ø
                        subRow.style.borderLeft = '2px solid ' + col; // –°–≤—è–∑—å —Å —Ä–æ–¥–∏—Ç–µ–ª–µ–º
                        subRow.style.background = 'transparent';

                        const sInfo = document.createElement('div'); sInfo.className = 'stock-info';
                        const sBox = document.createElement('div'); 
                        sBox.className = 'stock-color-preview'; 
                        sBox.style.background = assist.hex; 
                        sBox.style.width='14px'; 
                        sBox.style.height='14px';
                        sBox.style.cursor = 'pointer'; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º, —á—Ç–æ –º–æ–∂–Ω–æ –Ω–∞–∂–∞—Ç—å
                        sBox.title = '–ù–∞–∂–º–∏, —á—Ç–æ–±—ã –∏–∑–º–µ–Ω–∏—Ç—å —Ü–≤–µ—Ç';
                        sBox.style.border = '1px solid #fff';
                        sBox.onclick = () => triggerHelperPicker(i, assist.id)

                        const sSym = document.createElement('span'); sSym.innerText = '‚Ü≥'; sSym.style.fontSize='10px';
                        sInfo.appendChild(sSym); sInfo.appendChild(sBox);
                        
                        const sRight = document.createElement('div'); sRight.style.display = 'flex'; sRight.style.alignItems = 'center'; sRight.style.gap = '4px';
                        
                        // –£–¥–∞–ª–∏—Ç—å
                        const delBtn = document.createElement('button'); delBtn.innerText = '√ó';
                        delBtn.style.color = '#ff5555'; delBtn.style.background='none'; delBtn.style.border='none'; delBtn.style.cursor='pointer';
                        delBtn.onclick = () => removeAssistant(i, assist.id);

                        // –§–∞–∫—Ç –ø–æ–º–æ—â–Ω–∏–∫–∞ (–Ω—É–∂–Ω–æ –Ω–∞–π—Ç–∏ –µ–≥–æ displayIdx)
                        // –ú—ã –Ω–µ –∑–Ω–∞–µ–º –µ–≥–æ displayIdx –∑–¥–µ—Å—å –ª–µ–≥–∫–æ, –Ω–æ –º—ã –º–æ–∂–µ–º –ø–µ—Ä–µ–±—Ä–∞—Ç—å displayPalette
                        // –≠—Ç–æ –Ω–µ–º–Ω–æ–≥–æ –¥–æ—Ä–æ–≥–æ, –Ω–æ –¥–ª—è UI –ø–æ–π–¥–µ—Ç
                        let assistDisplayIdx = -1;
                        // –ò—â–µ–º –∏–Ω–¥–µ–∫—Å –≤ displayPalette, –Ω–∞—á–∏–Ω–∞—è —Å 12
                        for(let d=currentPalette.length; d<displayPalette.length; d++) {
                             if(displayPalette[d] === assist.hex && displaySymbols[d].startsWith(currentSymbolSet[i])) {
                                 // –≠—Ç–æ —É–ø—Ä–æ—â–µ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞. –í –∏–¥–µ–∞–ª–µ ID —Ö—Ä–∞–Ω–∏—Ç—å.
                                 // –ù–æ —Ç–∞–∫ –∫–∞–∫ –º—ã –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –≤—Å–µ, —Å—á–∏—Ç–∞–µ–º –ø–æ —Ü–≤–µ—Ç—É
                             }
                        }
                        // –î–ª—è —Ç–æ—á–Ω–æ—Å—Ç–∏, –¥–∞–≤–∞–π—Ç–µ –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∂–µ–º –ª–∏–º–∏—Ç. –§–∞–∫—Ç —Å–ª–æ–∂–Ω–æ –ø—Ä–∏–≤—è–∑–∞—Ç—å –±–µ–∑ ID –≤ displayPalette.
                        // –ò–ª–∏ –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∂–µ–º "Input"
                        
                        const sInput = document.createElement('input');
                        sInput.type = 'number'; sInput.className = 'stock-input-field'; sInput.style.width='45px';
                        sInput.value = assist.qty; 
                        sInput.oninput = (e) => { 
    assist.qty = parseInt(e.target.value)||0; 
    processImage(); // –¢–æ –∂–µ —Å–∞–º–æ–µ –∑–¥–µ—Å—å
};
                        totalStockSum += assist.qty;

                        sRight.appendChild(delBtn);
                        sRight.appendChild(sInput);
                        
                        subRow.appendChild(sInfo);
                        subRow.appendChild(sRight);
                        statsContainer.appendChild(subRow);
                    });
                }
            });

            document.getElementById('totalBricks').innerText = `${flat.length} / ${totalStockSum}`;
        }
// --- –ì–õ–ê–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –†–ï–ñ–ò–ú–ê "–°–í–û–ô AI" (v5.0 - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è) ---
        // --- –ì–õ–ê–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –†–ï–ñ–ò–ú–ê "–°–í–û–ô AI" (v6.0 - Helper Logic Update) ---
        function processStockImage() {
            if (!sourceImage || !isStockMode) return;

            // 1. –°–±—Ä–æ—Å –∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞
            const count = parseInt(document.getElementById('colorCount').value);
            
            // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –º–∞—Å—Å–∏–≤ –∫–æ–ª–∏—á–µ—Å—Ç–≤
            while(stockQuantities.length < count) stockQuantities.push(0);
            updateCustomColorCount(count); 
            
            displayPalette = [...currentPalette];
            displaySymbols = [...currentSymbolSet];

            // --- –ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê: –û–ü–†–ï–î–ï–õ–Ø–ï–ú, –ö–¢–û –Ø–í–õ–Ø–ï–¢–°–Ø –ü–û–ú–û–©–ù–ò–ö–û–ú ---
            const helperIndices = new Set(); // –ò–Ω–¥–µ–∫—Å—ã —Ü–≤–µ—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ —Å—Ç–∞–ª–∏ "—Ä–∞–±–∞–º–∏" (–ø–æ–º–æ—â–Ω–∏–∫–∞–º–∏)
            const mainToHelpersMap = {}; // –ö–∞—Ä—Ç–∞: –ì–ª–∞–≤–Ω—ã–π–ò–Ω–¥–µ–∫—Å -> [–ò–Ω–¥–µ–∫—Å–ü–æ–º–æ—â–Ω–∏–∫–∞1, –ò–Ω–¥–µ–∫—Å–ü–æ–º–æ—â–Ω–∏–∫–∞2...]

            // 1. –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –≤—Å–µ–º –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–º –ø–æ–º–æ—â–Ω–∏–∫–∞–º –∏ –∏—â–µ–º –∏—Ö –≤ –æ—Å–Ω–æ–≤–Ω–æ–π –ø–∞–ª–∏—Ç—Ä–µ
            for (let mainIdx in stockAssists) {
                stockAssists[mainIdx].forEach(assist => {
                    // –ò—â–µ–º, –µ—Å—Ç—å –ª–∏ hex —ç—Ç–æ–≥–æ –ø–æ–º–æ—â–Ω–∏–∫–∞ –≤ —Ç–µ–∫—É—â–µ–π –ø–∞–ª–∏—Ç—Ä–µ
                    // (–ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Ä–µ–≥–∏—Å—Ç—Ä —Å–∏–º–≤–æ–ª–æ–≤ –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏)
                    const idxInPalette = currentPalette.findIndex(c => c.toLowerCase() === assist.hex.toLowerCase());
                    
                    // –ï—Å–ª–∏ —Ü–≤–µ—Ç –Ω–∞–π–¥–µ–Ω –≤ –ø–∞–ª–∏—Ç—Ä–µ –∏ –æ–Ω –Ω–µ —è–≤–ª—è–µ—Ç—Å—è —Å–∞–º–∏–º —Å–æ–±–æ–π (–∑–∞—â–∏—Ç–∞ –æ—Ç —Ü–∏–∫–ª–æ–≤)
                    if (idxInPalette !== -1 && idxInPalette != mainIdx) {
                        helperIndices.add(idxInPalette);
                        
                        if (!mainToHelpersMap[mainIdx]) mainToHelpersMap[mainIdx] = [];
                        mainToHelpersMap[mainIdx].push(idxInPalette);
                    }
                });
            }

            // --- –°–û–ë–ò–†–ê–ï–ú –ò–ù–í–ï–ù–¢–ê–†–¨ (Inventory Groups) ---
            let inventoryGroups = [];
            
            for(let i=0; i<count; i++) {
                // –í–ê–ñ–ù–û: –ï—Å–ª–∏ —Ü–≤–µ—Ç —è–≤–ª—è–µ—Ç—Å—è –ø–æ–º–æ—â–Ω–∏–∫–æ–º (–µ—Å—Ç—å –≤ helperIndices), 
                // –º—ã –ù–ï —Å–æ–∑–¥–∞–µ–º –¥–ª—è –Ω–µ–≥–æ –æ—Ç–¥–µ–ª—å–Ω—É—é –≥—Ä—É–ø–ø—É. –û–Ω "–∏—Å—á–µ–∑–∞–µ—Ç" –∫–∞–∫ —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–∞—è –µ–¥–∏–Ω–∏—Ü–∞.
                if (helperIndices.has(i)) continue;

                const mainHex = currentPalette[i];
                if (!mainHex) continue;

                let group = {
                    mainIdx: i,
                    lum: getLum(mainHex), // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –±—É–¥–µ—Ç –ø–æ —è—Ä–∫–æ—Å—Ç–∏ –û–°–ù–û–í–ù–û–ì–û —Ü–≤–µ—Ç–∞
                    items: []
                };

                // 1. –î–æ–±–∞–≤–ª—è–µ–º "–•–æ–∑—è–∏–Ω–∞" (–û—Å–Ω–æ–≤–Ω–æ–π —Ü–≤–µ—Ç)
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ —Ä–æ–¥–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ stockQuantities[i]
                group.items.push({ 
                    type: 'main', 
                    hex: mainHex, 
                    qty: stockQuantities[i], 
                    displayIdx: i 
                });

                // 2. –î–æ–±–∞–≤–ª—è–µ–º "–ü–æ–º–æ—â–Ω–∏–∫–æ–≤" (–∫–æ—Ç–æ—Ä—ã–µ –µ—Å—Ç—å –≤ –ø–∞–ª–∏—Ç—Ä–µ)
                if (mainToHelpersMap[i]) {
                    mainToHelpersMap[i].forEach(hIdx => {
                        // –ë–µ—Ä–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–∑ –∑–∞–ø–∞—Å–∞ —Å–∞–º–æ–≥–æ –ø–æ–º–æ—â–Ω–∏–∫–∞!
                        const hQty = stockQuantities[hIdx];
                        const hHex = currentPalette[hIdx];
                        
                        group.items.push({ 
                            type: 'palette_assist', // –ù–æ–≤—ã–π —Ç–∏–ø: –ø–æ–º–æ—â–Ω–∏–∫ –∏–∑ –ø–∞–ª–∏—Ç—Ä—ã
                            hex: hHex, 
                            qty: hQty, 
                            displayIdx: hIdx // –°–æ—Ö—Ä–∞–Ω—è–µ–º –µ–≥–æ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
                        });
                    });
                }

                // 3. –î–æ–±–∞–≤–ª—è–µ–º "–í–Ω–µ—à–Ω–∏—Ö –ø–æ–º–æ—â–Ω–∏–∫–æ–≤" (–∫–æ—Ç–æ—Ä—ã—Ö –ù–ï–¢ –≤ –ø–∞–ª–∏—Ç—Ä–µ, –µ—Å–ª–∏ —Ç–∞–∫–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤—Ä—É—á–Ω—É—é —á–µ—Ä–µ–∑ –ø–∏–ø–µ—Ç–∫—É, –Ω–æ –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω—ã –∫ –±–∞–Ω–∫–∞–º)
                if (stockAssists[i]) {
                    stockAssists[i].forEach(assist => {
                         const idxInPalette = currentPalette.findIndex(c => c.toLowerCase() === assist.hex.toLowerCase());
                         // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ—Ö, –∫–æ–≥–æ –º—ã –ù–ï –æ–±—Ä–∞–±–æ—Ç–∞–ª–∏ –Ω–∞ —à–∞–≥–µ 2 (—Ç.–µ. –≤–Ω–µ—à–Ω–∏–µ —Ü–≤–µ—Ç–∞)
                         if (idxInPalette === -1) {
                            group.items.push({ 
                                type: 'external_assist', 
                                hex: assist.hex, 
                                qty: assist.qty, 
                                assistId: assist.id 
                            });
                         }
                    });
                }

                group.totalQty = group.items.reduce((sum, item) => sum + item.qty, 0);
                inventoryGroups.push(group);
            }

            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –≥—Ä—É–ø–ø—ã –ø–æ —è—Ä–∫–æ—Å—Ç–∏ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã –∞–ª–≥–æ—Ä–∏—Ç–º–∞ –ø–æ–¥–±–æ—Ä–∞
            inventoryGroups.sort((a, b) => a.lum - b.lum);
            
            const totalSystemStock = inventoryGroups.reduce((sum, grp) => sum + grp.totalQty, 0);
            if (totalSystemStock <= 0) return; // –ï—Å–ª–∏ —Å–∫–ª–∞–¥ –ø—É—Å—Ç, –Ω–µ—á–µ–≥–æ —Å—á–∏—Ç–∞—Ç—å

            // --- 2. –û–ë–†–ê–ë–û–¢–ö–ê –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–Ø (High Quality Filters) ---
            // ... (–î–∞–ª—å—à–µ –∫–æ–¥ –æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–æ –∫–æ–Ω—Ü–∞ —Ñ—É–Ω–∫—Ü–∏–∏) ...
            // --- 2. –û–ë–†–ê–ë–û–¢–ö–ê –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–Ø (High Quality Filters) ---
            // –ß—Ç–æ–±—ã —Ä–µ–∑–∫–æ—Å—Ç—å —Ä–∞–±–æ—Ç–∞–ª–∞ –∫–∞–∫ –Ω–∞–¥–æ, —Å–Ω–∞—á–∞–ª–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –±–æ–ª—å—à—É—é –∫–∞—Ä—Ç–∏–Ω–∫—É
            const processW = 800; 
            const imgAspect = sourceImage.width / sourceImage.height;
            const processH = Math.floor(processW / imgAspect);

            const workCanvas = document.createElement('canvas');
            workCanvas.width = processW; workCanvas.height = processH;
            const workCtx = workCanvas.getContext('2d', { willReadFrequently: true });

            // –ü—Ä–∏–º–µ–Ω—è–µ–º –∑—É–º –∏ —Å–¥–≤–∏–≥
            const zoom = document.getElementById('zoom').value / 100;
            const px = (document.getElementById('panX').value / 100) * processW;
            const py = (document.getElementById('panY').value / 100) * processH;
            
            let drawW, drawH;
            const canvasAspect = processW / processH;
            if(imgAspect > canvasAspect) {
                drawH = processH * zoom; drawW = processH * imgAspect * zoom;
            } else {
                drawW = processW * zoom; drawH = (processW / imgAspect) * zoom;
            }

            // –§–∏–ª—å—Ç—Ä—ã CSS (–±—ã—Å—Ç—Ä—ã–µ)
            const contrast = document.getElementById('contrast').value;
            const brightness = document.getElementById('brightness').value;
            workCtx.filter = `contrast(${contrast}%) brightness(${brightness}%)`;
            
            workCtx.drawImage(sourceImage, (processW - drawW) / 2 + px, (processH - drawH) / 2 + py, drawW, drawH);
            workCtx.filter = 'none';

            let imgData = workCtx.getImageData(0, 0, processW, processH);
            let data = imgData.data;

            // --- –ü–†–ò–ú–ï–ù–ï–ù–ò–ï JS –§–ò–õ–¨–¢–†–û–í (–†–µ–∑–∫–æ—Å—Ç—å, –ë–ª—é—Ä, –ü–æ—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—è) ---
            
            // A. Smart Blur
            const smartBlur = parseInt(document.getElementById('smartBlur').value);
            if(smartBlur > 0) { 
                const copy = new Uint8ClampedArray(data);
                const radius = 2; 
                for(let y=0; y<processH; y++) { 
                    for(let x=0; x<processW; x++) { 
                        let rSum=0, gSum=0, bSum=0, count=0; 
                        const idx = (y*processW+x)*4; const r0 = copy[idx], g0=copy[idx+1], b0=copy[idx+2]; 
                        for(let dy=-radius; dy<=radius; dy++) { 
                            for(let dx=-radius; dx<=radius; dx++) { 
                                const nx=x+dx; const ny=y+dy; 
                                if(nx>=0 && nx<processW && ny>=0 && ny<processH) { 
                                    const nIdx = (ny*processW+nx)*4; 
                                    const diff = Math.abs(copy[nIdx]-r0) + Math.abs(copy[nIdx+1]-g0) + Math.abs(copy[nIdx+2]-b0); 
                                    if(diff <= smartBlur * 2.5) { rSum+=copy[nIdx]; gSum+=copy[nIdx+1]; bSum+=copy[nIdx+2]; count++; } 
                                } 
                            } 
                        } 
                        if(count > 0) { data[idx] = rSum/count; data[idx+1] = gSum/count; data[idx+2] = bSum/count; } 
                    } 
                } 
            }

            // B. Sharpness (USM)
            const sharpAmount = parseInt(document.getElementById('sharpness').value);
            const usmRadius = parseInt(document.getElementById('usmRadius').value) || 0;
            if (sharpAmount > 0 && usmRadius > 0) {
                 const blurred = new Uint8ClampedArray(data);
                 const r = usmRadius; 
                 const w = processW; const h_ = processH;
                 const temp = new Uint8ClampedArray(data);
                 // Horz
                 for(let y=0; y<h_; y++) {
                     for(let x=0; x<w; x++) {
                         let rS=0, gS=0, bS=0, cnt=0;
                         for(let i = -r; i <= r; i++) {
                             let nx = x + i;
                             if(nx >= 0 && nx < w) {
                                 let idx = (y * w + nx) * 4;
                                 rS += temp[idx]; gS += temp[idx+1]; bS += temp[idx+2]; cnt++;
                             }
                         }
                         let idx = (y * w + x) * 4;
                         blurred[idx] = rS/cnt; blurred[idx+1] = gS/cnt; blurred[idx+2] = bS/cnt;
                     }
                 }
                 // Vert
                 const temp2 = new Uint8ClampedArray(blurred);
                 for(let x=0; x<w; x++) {
                     for(let y=0; y<h_; y++) {
                         let rS=0, gS=0, bS=0, cnt=0;
                         for(let i = -r; i <= r; i++) {
                             let ny = y + i;
                             if(ny >= 0 && ny < h_) {
                                 let idx = (ny * w + x) * 4;
                                 rS += temp2[idx]; gS += temp2[idx+1]; bS += temp2[idx+2]; cnt++;
                             }
                         }
                         let idx = (y * w + x) * 4;
                         blurred[idx] = rS/cnt; blurred[idx+1] = gS/cnt; blurred[idx+2] = bS/cnt;
                     }
                 }
                 // Mix
                 const amount = sharpAmount / 100;
                 for (let i = 0; i < data.length; i += 4) {
                     data[i] = Math.min(255, Math.max(0, data[i] + (data[i] - blurred[i]) * amount));
                     data[i+1] = Math.min(255, Math.max(0, data[i+1] + (data[i+1] - blurred[i+1]) * amount));
                     data[i+2] = Math.min(255, Math.max(0, data[i+2] + (data[i+2] - blurred[i+2]) * amount));
                 }
            }

            // C. Posterize
            const levels = parseInt(document.getElementById('posterize').value);
            if (levels > 0) {
                const step = 255 / levels;
                for(let i=0; i < data.length; i+=4) {
                    data[i] = Math.floor(data[i] / step) * step;
                    data[i+1] = Math.floor(data[i+1] / step) * step;
                    data[i+2] = Math.floor(data[i+2] / step) * step;
                }
            }
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—É—é –∫–∞—Ä—Ç–∏–Ω–∫—É
            workCtx.putImageData(imgData, 0, 0);

            // --- 3. –ü–û–î–ì–û–¢–û–í–ö–ê –ö –°–ò–ú–£–õ–Ø–¶–ò–ò (–î–∞—É–Ω—Å–∫–µ–π–ª) ---
            const maxSimW = 150; 
            const simH = Math.floor(maxSimW / imgAspect);
            const simCanvas = document.createElement('canvas');
            simCanvas.width = maxSimW; simCanvas.height = simH;
            const simCtx = simCanvas.getContext('2d', { willReadFrequently: true });
            
            simCtx.drawImage(workCanvas, 0, 0, maxSimW, simH);
            const loopData = simCtx.getImageData(0, 0, maxSimW, simH).data;

            // --- 4. –ê–õ–ì–û–†–ò–¢–ú –ü–û–î–ë–û–†–ê –ë–õ–û–ö–û–í ---
            let bestMatrix = [];
            let bestW = 10;
            let bestH = Math.floor(10 / imgAspect);
            const OVERLAP_THRESHOLD = 0.75; 

            // –ü–µ—Ä–µ–±–∏—Ä–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã –æ—Ç 15 –¥–æ 150
            for (let w = 15; w <= 150; w++) {
                let h = Math.floor(w / imgAspect);
                if(h < 15) continue;
                
                // –ë—ã—Å—Ç—Ä—ã–π —Ä–µ—Å–∞–π–∑ –¥–ª—è —Ç–µ–∫—É—â–µ–π –∏—Ç–µ—Ä–∞—Ü–∏–∏
                const tCanvas = document.createElement('canvas'); tCanvas.width = w; tCanvas.height = h;
                tCanvas.getContext('2d').drawImage(simCanvas, 0, 0, w, h);
                const currentData = tCanvas.getContext('2d').getImageData(0, 0, w, h).data;

                // –ö–ª–æ–Ω –∑–∞–ø–∞—Å–æ–≤
                let tempGroupCounts = inventoryGroups.map(g => g.totalQty);
                let currentMatrix = []; 
                let possible = true; 

                for (let y = 0; y < h; y++) {
                    let row = [];
                    for (let x = 0; x < w; x++) {
                        const i = (y * w + x) * 4;
                        const lum = (0.299 * currentData[i] + 0.587 * currentData[i+1] + 0.114 * currentData[i+2]) / 255; 
                        
                        let floatIdx = lum * (inventoryGroups.length - 1);
                        let primaryIdx;
                        
                        if (useMixMode) {
                            let idxFloor = Math.floor(floatIdx);
                            let chance = floatIdx - idxFloor; 
                            primaryIdx = (Math.random() < chance) ? idxFloor + 1 : idxFloor;
                        } else {
                            primaryIdx = Math.round(floatIdx);
                        }
                        
                        if (primaryIdx < 0) primaryIdx = 0;
                        if (primaryIdx >= inventoryGroups.length) primaryIdx = inventoryGroups.length - 1;

                        let chosenGrpIdx = -1;
                        if (tempGroupCounts[primaryIdx] > 0) {
                            chosenGrpIdx = primaryIdx;
                        } else {
                            // –ü—Ä–æ–±—É–µ–º —Å–æ—Å–µ–¥–µ–π
                            let neighborIdx = (floatIdx < primaryIdx) ? primaryIdx - 1 : primaryIdx + 1;
                            if (neighborIdx >= 0 && neighborIdx < inventoryGroups.length) {
                                let dist = Math.abs(floatIdx - neighborIdx);
                                if (dist <= OVERLAP_THRESHOLD && tempGroupCounts[neighborIdx] > 0) {
                                    chosenGrpIdx = neighborIdx;
                                }
                            }
                        }

                        if (chosenGrpIdx !== -1) {
                            tempGroupCounts[chosenGrpIdx]--;
                            row.push(chosenGrpIdx);
                        } else {
                            possible = false; break; 
                        }
                    }
                    if (!possible) break;
                    currentMatrix.push(row);
                }

                if (possible) {
                    bestMatrix = currentMatrix;
                    bestW = w;
                    bestH = h;
                } else {
                    break;
                }
            }

           // --- 5. –§–ò–ù–ê–õ–ò–ó–ê–¶–ò–Ø (–í–ï–†–°–ò–Ø: –†–ê–í–ù–û–ú–ï–†–ù–´–ô –ú–ò–ö–° –ü–†–ò –î–ï–§–ò–¶–ò–¢–ï) ---
            if (bestMatrix.length > 0) {
                document.getElementById('setSize').value = 'custom';
                document.getElementById('customSizeGroup').style.display = 'flex';
                document.getElementById('customWidth').value = bestW;
                document.getElementById('customHeight').value = bestH;

                let assistMap = {}; 
                // –°–æ–∑–¥–∞–µ–º –ø—É—Å—Ç—É—é –º–∞—Ç—Ä–∏—Ü—É —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
                let finalMatrixResult = Array.from({length: bestH}, () => new Array(bestW).fill(0));
                
                // 1. –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ø–æ –∏–Ω–¥–µ–∫—Å—É –≥—Ä—É–ø–ø—ã
                // map: groupIndex -> [ {x, y}, {x, y}, ... ]
                let groupCoords = {};
                for(let y=0; y<bestH; y++) {
                    for(let x=0; x<bestW; x++) {
                        let gIdx = bestMatrix[y][x];
                        if(!groupCoords[gIdx]) groupCoords[gIdx] = [];
                        groupCoords[gIdx].push({x, y});
                    }
                }

                // 2. –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∂–¥—É—é –≥—Ä—É–ø–ø—É
                for (let gIdx in groupCoords) {
                    let coords = groupCoords[gIdx];
                    let group = inventoryGroups[gIdx];
                    let demand = coords.length; // –°–∫–æ–ª—å–∫–æ –≤—Å–µ–≥–æ –Ω—É–∂–Ω–æ –∫—É–±–∏–∫–æ–≤ —ç—Ç–æ–≥–æ —Ü–≤–µ—Ç–∞

                    let bucket = []; // –í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –≤–µ–¥—Ä–æ —Å –∫—É–±–∏–∫–∞–º–∏ –¥–ª—è —ç—Ç–æ–π –∑–æ–Ω—ã

                    // –ê. –°–Ω–∞—á–∞–ª–∞ —á–µ—Ä–ø–∞–µ–º –û–°–ù–û–í–ù–£–Æ –∫—Ä–∞—Å–∫—É
                    const mainItem = group.items.find(it => it.type === 'main');
                    let mainQtyToUse = 0;
                    if (mainItem) {
                        mainQtyToUse = Math.min(demand, mainItem.qty);
                        // –î–æ–±–∞–≤–ª—è–µ–º –≤ –≤–µ–¥—Ä–æ —Å—Å—ã–ª–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–µ–¥–º–µ—Ç
                        for(let k=0; k<mainQtyToUse; k++) bucket.push(mainItem);
                        demand -= mainQtyToUse;
                    }

                    // –ë. –ï—Å–ª–∏ –Ω–µ —Ö–≤–∞—Ç–∏–ª–æ, —á–µ—Ä–ø–∞–µ–º –ü–û–ú–û–©–ù–ò–ö–û–í
                    if (demand > 0) {
                        const availableAssists = group.items.filter(it => it.type !== 'main' && it.qty > 0);
                        
                        for (let assist of availableAssists) {
                            if (demand <= 0) break;
                            let assistQtyToUse = Math.min(demand, assist.qty);
                            for(let k=0; k<assistQtyToUse; k++) bucket.push(assist);
                            demand -= assistQtyToUse;
                        }
                    }

                    // –í. –ï—Å–ª–∏ –≤—Å—ë —Ä–∞–≤–Ω–æ –Ω–µ —Ö–≤–∞—Ç–∏–ª–æ (–¥–µ—Ñ–∏—Ü–∏—Ç), –¥–æ–±–∏–≤–∞–µ–º –û–°–ù–û–í–ù–´–ú (–≤–∏–∑—É–∞–ª—å–Ω–æ, —Å—á–µ—Ç—á–∏–∫ —É–π–¥–µ—Ç –≤ –º–∏–Ω—É—Å –∏–ª–∏ –æ—Å—Ç–∞–Ω–µ—Ç—Å—è 0)
                    while (demand > 0) {
                        bucket.push(mainItem || group.items[0]);
                        demand--;
                    }

                    // –ì. –ü–ï–†–ï–ú–ï–®–ò–í–ê–ï–ú –í–ï–î–†–û (Fisher-Yates Shuffle)
                    // –ò–º–µ–Ω–Ω–æ —ç—Ç–æ —É–±–∏—Ä–∞–µ—Ç –ø–æ–ª–æ—Å—É –∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ø–æ–º–æ—â–Ω–∏–∫–æ–≤ —Ä–∞–Ω–¥–æ–º–Ω–æ
                    for (let i = bucket.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [bucket[i], bucket[j]] = [bucket[j], bucket[i]];
                    }

                    // –î. –†–∞—Å–∫–ª–∞–¥—ã–≤–∞–µ–º –∫—É–±–∏–∫–∏ –∏–∑ –≤–µ–¥—Ä–∞ –ø–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º
                    coords.forEach((coord, i) => {
                        let selectedItem = bucket[i];

                        // –°–ø–∏—Å—ã–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ (—Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—Ö–æ–¥)
                        if (selectedItem.qty > 0) selectedItem.qty--;

                        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å –¥–ª—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏
                        let finalIdx = 0;
                        if (selectedItem.type === 'main' || selectedItem.type === 'palette_assist') {
                            finalIdx = selectedItem.displayIdx;
                        } else {
                            // –í–Ω–µ—à–Ω–∏–π –ø–æ–º–æ—â–Ω–∏–∫
                            const key = group.mainIdx + '_' + selectedItem.assistId;
                            if (assistMap[key] !== undefined) {
                                finalIdx = assistMap[key];
                            } else {
                                displayPalette.push(selectedItem.hex);
                                const baseSym = currentSymbolSet[group.mainIdx];
                                const subIndex = Object.keys(assistMap).filter(k => k.startsWith(group.mainIdx+'_')).length + 1;
                                displaySymbols.push(baseSym + subIndex); 
                                finalIdx = displayPalette.length - 1;
                                assistMap[key] = finalIdx;
                            }
                        }
                        
                        finalMatrixResult[coord.y][coord.x] = finalIdx;
                    });
                }

                generatedMatrix = finalMatrixResult;
                finalizeMatrixWithBorder();
            } else {
                alert("–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –±–ª–æ–∫–æ–≤! –î–æ–±–∞–≤—å—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–ª–∏ –ø–æ–º–æ—â–Ω–∏–∫–æ–≤.");
            }
        } // –ö–û–ù–ï–¶ –§–£–ù–ö–¶–ò–ò PROCESS STOCK IMAGE

        // --- –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò (–¢–ï–ü–ï–†–¨ –û–ù–ò –°–ù–ê–†–£–ñ–ò –ò –í–ò–î–ù–´ –í–°–ï–ú) ---

        function getLum(hex) {
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            return 0.299 * r + 0.587 * g + 0.114 * b;
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ–º–æ—â–Ω–∏–∫–æ–≤
        function triggerHelperPicker(mainIdx, assistId = null) {
            activeHelperIdx = mainIdx;
            window.editingAssistId = assistId; 
            const modal = document.getElementById('helperSelectModal');
            const grid = document.getElementById('helperPaletteGrid');
            grid.innerHTML = '';
            currentPalette.forEach((col, i) => {
                const btn = document.createElement('div');
                btn.style.width = '30px'; btn.style.height = '30px';
                btn.style.borderRadius = '50%'; btn.style.background = col;
                btn.style.cursor = 'pointer'; btn.style.border = '2px solid var(--glass-border)';
                btn.style.boxShadow = '0 2px 5px rgba(0,0,0,0.2)';
                btn.style.display = 'flex'; btn.style.alignItems = 'center'; btn.style.justifyContent = 'center';
                btn.style.fontSize = '10px';
                btn.style.color = getContrastColor(col);
                btn.innerText = currentSymbolSet[i] || "";
                btn.onclick = () => onHelperColorPicked(col);
                grid.appendChild(btn);
            });
            modal.style.display = 'flex';
        }

        function closeHelperModal(e) {
            if(e.target.id === 'helperSelectModal') e.target.style.display = 'none';
        }

        function onHelperColorPicked(hex) {
            document.getElementById('helperSelectModal').style.display = 'none';
            if (activeHelperIdx !== -1 && hex) {
                if (window.editingAssistId) {
                    const arr = stockAssists[activeHelperIdx];
                    const assist = arr.find(a => a.id === window.editingAssistId);
                    if (assist) assist.hex = hex;
                    window.editingAssistId = null;
                } else {
                    if (!stockAssists[activeHelperIdx]) stockAssists[activeHelperIdx] = [];
                    stockAssists[activeHelperIdx].push({ hex: hex, qty: 0, id: Date.now() });
                }
                renderStockInputs(); 
                processStockImage(); 
            }
            activeHelperIdx = -1;
        }

        function removeAssistant(mainIdx, assistId) {
            if (stockAssists[mainIdx]) {
                stockAssists[mainIdx] = stockAssists[mainIdx].filter(a => a.id !== assistId);
                renderStockInputs();
                processStockImage();
            }
        }
// --- –°–ö–†–´–¢–û–ï –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–ï –†–ï–ñ–ò–ú–û–í –û–¢–û–ë–†–ê–ñ–ï–ù–ò–Ø ---
// 0 = Auto, 1 = Force Mobile, 2 = Force PC
let layoutModeState = 0; 
// –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å, —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –∫ –Ω–µ–º—É –≤–µ—Ä–Ω—É—Ç—å—Å—è
const ORIGINAL_MEDIA_QUERY = "(max-width: 768px) and (orientation: portrait)";

function cycleLayoutMode() {
    const sheets = document.styleSheets;
    let targetRule = null;

    // 1. –ò—â–µ–º –Ω–∞—à–µ –ø—Ä–∞–≤–∏–ª–æ @media –≤–æ –≤—Å–µ—Ö —Å—Ç–∏–ª—è—Ö
    for (let i = 0; i < sheets.length; i++) {
        try {
            const rules = sheets[i].cssRules;
            if (!rules) continue;
            for (let j = 0; j < rules.length; j++) {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —ç—Ç–æ –ª–∏ –Ω–∞—à–µ –ø—Ä–∞–≤–∏–ª–æ (–ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º –∏–ª–∏ —Ç–µ–∫—É—â–µ–º—É —Å–æ—Å—Ç–æ—è–Ω–∏—é)
                const txt = rules[j].conditionText;
                if (txt && (txt.includes("max-width: 768px") || txt === "all" || txt === "max-width: 0px")) {
                    targetRule = rules[j];
                    break;
                }
            }
        } catch (e) {
            // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –¥–æ—Å—Ç—É–ø–∞ –∫ –≤–Ω–µ—à–Ω–∏–º —Å—Ç–∏–ª—è–º (–µ—Å–ª–∏ –µ—Å—Ç—å)
        }
        if (targetRule) break;
    }

    if (!targetRule) {
        alert("–û—à–∏–±–∫–∞: –ù–µ –Ω–∞–π–¥–µ–Ω—ã –º–æ–±–∏–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏!");
        return;
    }

    // 2. –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    layoutModeState = (layoutModeState + 1) % 3;
    const label = document.getElementById('versionLabel');

    if (layoutModeState === 0) {
        // –ê–í–¢–û (–í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–∞–∫ –±—ã–ª–æ)
        targetRule.conditionText = ORIGINAL_MEDIA_QUERY;
        label.innerText = "PhotoBrick v2.1.9";
        label.style.color = "var(--text-sec)";
    } 
    else if (layoutModeState === 1) {
        // –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–û –ú–û–ë–ò–õ–¨–ù–´–ô (—É—Å–ª–æ–≤–∏–µ "all" —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—Å–µ–≥–¥–∞)
        targetRule.conditionText = "all";
        label.innerText = "PhotoBrick v2.1.9 (Mobile)";
        label.style.color = "var(--primary)"; // –ü–æ–¥—Å–≤–µ—Ç–∏–º –∂–µ–ª—Ç—ã–º/—Å–∏–Ω–∏–º
    } 
    else if (layoutModeState === 2) {
        // –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–û –ü–ö (—É—Å–ª–æ–≤–∏–µ "max-width: 0px" –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç)
        targetRule.conditionText = "max-width: 0px";
        label.innerText = "PhotoBrick v2.1.9 (PC)";
        label.style.color = "var(--primary)";
    }
}

    </script>
</body>
</html>

